<!doctype html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Animator其是Android3.0之后加入的作用于对象属性的动画,Animator是所有属性动画的基类，其下有ValueAnimator,AnimatorSet,由ValueAnimator再拓展出ObjectAnimator,TimeAnimator
其整体结构图

ValueAnimator为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的Handler里面以确保所有的">
<meta property="og:type" content="article">
<meta property="og:title" content="Animator at Android">
<meta property="og:url" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="Animator其是Android3.0之后加入的作用于对象属性的动画,Animator是所有属性动画的基类，其下有ValueAnimator,AnimatorSet,由ValueAnimator再拓展出ObjectAnimator,TimeAnimator
其整体结构图

ValueAnimator为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的Handler里面以确保所有的">
<meta property="og:image" content="http://xu6148152.github.io/./animator.png">
<meta property="og:image" content="http://xu6148152.github.io/./ValueAnimator.png">
<meta property="og:image" content="http://xu6148152.github.io/./interpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/./LinearInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/./AccelerateDecelerateInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/./AccelerateInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/./AnticipateInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/./AnticipateOvershootinterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/./TypeEvaluator.png">
<meta property="og:image" content="http://xu6148152.github.io/./transition.png">
<meta property="og:image" content="http://xu6148152.github.io/./autotransition.gif">
<meta property="og:image" content="http://xu6148152.github.io/./changetext.gif">
<meta property="og:image" content="http://xu6148152.github.io/./changebound.gif">
<meta property="og:image" content="http://xu6148152.github.io/./changebound_pathmotion.gif">
<meta property="og:image" content="http://xu6148152.github.io/./slide.gif">
<meta property="og:image" content="http://xu6148152.github.io/./scale.gif">
<meta property="og:image" content="http://xu6148152.github.io/./scale_alpha.gif">
<meta property="og:image" content="http://xu6148152.github.io/./explode.gif">
<meta property="og:image" content="http://xu6148152.github.io/./transition_name.gif">
<meta property="og:image" content="http://xu6148152.github.io/./ImageTransform.gif">
<meta property="og:image" content="http://xu6148152.github.io/./recolor.gif">
<meta property="og:image" content="http://xu6148152.github.io/./rotate.gif">
<meta property="og:image" content="http://xu6148152.github.io/./progress.gif">
<meta property="og:image" content="http://xu6148152.github.io/./change_scene.gif">
<meta property="og:updated_time" content="2016-12-25T10:33:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Animator at Android">
<meta name="twitter:description" content="Animator其是Android3.0之后加入的作用于对象属性的动画,Animator是所有属性动画的基类，其下有ValueAnimator,AnimatorSet,由ValueAnimator再拓展出ObjectAnimator,TimeAnimator
其整体结构图

ValueAnimator为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的Handler里面以确保所有的">
<meta name="twitter:image" content="http://xu6148152.github.io/./animator.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://xu6148152.github.io/2016/12/04/Animator-at-Android/"/>





  <title> Animator at Android | Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/12/04/Animator-at-Android/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Binea">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/upload_file/tmp.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Animator at Android
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-04T21:17:02+08:00">
                2016-12-04
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Animator"><a href="#Animator" class="headerlink" title="Animator"></a>Animator</h3><p>其是<code>Android3.0</code>之后加入的作用于对象属性的动画,<code>Animator</code>是所有属性动画的基类，其下有<code>ValueAnimator</code>,<code>AnimatorSet</code>,由<code>ValueAnimator</code>再拓展出<code>ObjectAnimator</code>,<code>TimeAnimator</code></p>
<p>其整体结构图</p>
<p><img src="./animator.png" alt="animator"></p>
<h4 id="ValueAnimator"><a href="#ValueAnimator" class="headerlink" title="ValueAnimator"></a>ValueAnimator</h4><p>为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的<code>Handler</code>里面以确保所有的属性改变都会在<code>UI</code>线程。主要<code>API</code>:</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">ValueAnimator <span class="title">ofInt</span><span class="params">(<span class="keyword">int</span>... values)</span> </span></div><div class="line">ValueAnimator <span class="title">ofArgb</span><span class="params">(<span class="keyword">int</span>... values)</span> <span class="comment">//颜色值变化</span></div><div class="line">ValueAnimator <span class="title">ofFloat</span><span class="params">(<span class="keyword">float</span>... values)</span> </div><div class="line">ValueAnimator <span class="title">ofPropertyValuesHolder</span><span class="params">(PropertyValuesHolder... values)</span></div><div class="line">ValueAnimator <span class="title">ofObject</span><span class="params">(TypeEvaluator evaluator, Object... values)</span></div></pre></td></tr></table></figure>
</p>
<p>这些方法里面都是进行值得初始化</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValues</span><span class="params">(<span class="keyword">int</span>... values)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (values == <span class="keyword">null</span> || values.length == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mValues == <span class="keyword">null</span> || mValues.length == <span class="number">0</span>) &#123;</div><div class="line">            setValues(PropertyValuesHolder.ofInt(<span class="string">""</span>, values));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            PropertyValuesHolder valuesHolder = mValues[<span class="number">0</span>];</div><div class="line">            valuesHolder.setIntValues(values);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// New property/values/target should cause re-initialization prior to starting</span></div><div class="line">        mInitialized = <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p>都是重新封装转化成<code>PropertyValuesHolder</code>，这是封装动画属性和值得对象，之后会详细介绍</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEvaluator</span><span class="params">(TypeEvaluator value)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; mValues != <span class="keyword">null</span> &amp;&amp; mValues.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            mValues[<span class="number">0</span>].setEvaluator(value);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p>设置估值器，最后也是由<code>PropertyValuesHolder</code>保存</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//参数代表是否反转动画</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">boolean</span> playBackwards)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Looper.myLooper() == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(<span class="string">"Animators may only be run on Looper threads"</span>);</div><div class="line">        &#125;</div><div class="line">        mReversing = playBackwards;</div><div class="line">        mPlayingBackwards = playBackwards;</div><div class="line">        <span class="comment">//需要反转动画</span></div><div class="line">        <span class="keyword">if</span> (playBackwards &amp;&amp; mSeekFraction != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mSeekFraction == <span class="number">0</span> &amp;&amp; mCurrentIteration == <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// special case: reversing from seek-to-0 should act as if not seeked at all</span></div><div class="line">                mSeekFraction = <span class="number">0</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mRepeatCount == INFINITE) &#123;</div><div class="line">                mSeekFraction = <span class="number">1</span> - (mSeekFraction % <span class="number">1</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mSeekFraction = <span class="number">1</span> + mRepeatCount - (mCurrentIteration + mSeekFraction);</div><div class="line">            &#125;</div><div class="line">            mCurrentIteration = (<span class="keyword">int</span>) mSeekFraction;</div><div class="line">            mSeekFraction = mSeekFraction % <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mCurrentIteration &gt; <span class="number">0</span> &amp;&amp; mRepeatMode == REVERSE &amp;&amp;</div><div class="line">                (mCurrentIteration &lt; (mRepeatCount + <span class="number">1</span>) || mRepeatCount == INFINITE)) &#123;</div><div class="line">            <span class="comment">// if we were seeked to some other iteration in a reversing animator,</span></div><div class="line">            <span class="comment">// figure out the correct direction to start playing based on the iteration</span></div><div class="line">            <span class="keyword">if</span> (playBackwards) &#123;</div><div class="line">                mPlayingBackwards = (mCurrentIteration % <span class="number">2</span>) == <span class="number">0</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mPlayingBackwards = (mCurrentIteration % <span class="number">2</span>) != <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> prevPlayingState = mPlayingState;</div><div class="line">        mPlayingState = STOPPED;</div><div class="line">        mStarted = <span class="keyword">true</span>;</div><div class="line">        mStartedDelay = <span class="keyword">false</span>;</div><div class="line">        mPaused = <span class="keyword">false</span>;</div><div class="line">        updateScaledDuration(); <span class="comment">// in case the scale factor has changed since creation time</span></div><div class="line">        <span class="comment">//创建AnimatorHandler</span></div><div class="line">        AnimationHandler animationHandler = getOrCreateAnimationHandler();</div><div class="line">        animationHandler.mPendingAnimations.add(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (mStartDelay == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// This sets the initial value of the animation, prior to actually starting it running</span></div><div class="line">            <span class="keyword">if</span> (prevPlayingState != SEEKED) &#123;</div><div class="line">                setCurrentPlayTime(<span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            mPlayingState = STOPPED;</div><div class="line">            mRunning = <span class="keyword">true</span>;</div><div class="line">            notifyStartListeners();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//开始动画</span></div><div class="line">        animationHandler.start();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p>开始动画的逻辑其实很简单，主要是判断动画是否需要反转。最终动画的更新交给<code>AnimationHandler</code></p>
<h5 id="AnimationHandler"><a href="#AnimationHandler" class="headerlink" title="AnimationHandler"></a>AnimationHandler</h5><p>处理所有运行中的动画的定时脉冲，这个机制能确保所有的动画都运行在<code>UI</code>线程，其使用<code>Choreograhper(用于调整动画输入和绘制的时机)</code>来执行周期的回调</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">AnimationHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    mChoreographer = Choreographer.getInstance();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">    scheduleAnimation();</div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (!mAnimationScheduled) &#123;</div><div class="line">               <span class="comment">//动画未执行过，由Choreographer回调执行</span></div><div class="line">               mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, mAnimate, <span class="keyword">null</span>);</div><div class="line">               mAnimationScheduled = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">   <span class="keyword">final</span> Runnable mAnimate = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               mAnimationScheduled = <span class="keyword">false</span>;</div><div class="line">               doAnimationFrame(mChoreographer.getFrameTime());</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">       </div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</div><div class="line">   <span class="comment">//参数代表执行哪一帧动画</span></div><div class="line">           mLastFrameTime = frameTime;</div><div class="line"></div><div class="line">           <span class="comment">// mPendingAnimations holds any animations that have requested to be started</span></div><div class="line">           <span class="comment">// We're going to clear mPendingAnimations, but starting animation may</span></div><div class="line">           <span class="comment">// cause more to be added to the pending list (for example, if one animation</span></div><div class="line">           <span class="comment">// starting triggers another starting). So we loop until mPendingAnimations</span></div><div class="line">           <span class="comment">// is empty.</span></div><div class="line">           <span class="keyword">while</span> (mPendingAnimations.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">           <span class="comment">//如果有等待执行的动画，清除并优先执行这些动画</span></div><div class="line">               ArrayList&lt;ValueAnimator&gt; pendingCopy =</div><div class="line">                       (ArrayList&lt;ValueAnimator&gt;) mPendingAnimations.clone();</div><div class="line">               mPendingAnimations.clear();</div><div class="line">               <span class="keyword">int</span> count = pendingCopy.size();</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">                   ValueAnimator anim = pendingCopy.get(i);</div><div class="line">                   <span class="comment">// If the animation has a startDelay, place it on the delayed list</span></div><div class="line">                   <span class="keyword">if</span> (anim.mStartDelay == <span class="number">0</span>) &#123;</div><div class="line">                       anim.startAnimation(<span class="keyword">this</span>);</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       mDelayedAnims.add(anim);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// Next, process animations currently sitting on the delayed queue, adding</span></div><div class="line">           <span class="comment">// them to the active animations if they are ready</span></div><div class="line">           <span class="comment">//将延时队列中的动画加入到准备完成队列，开始执行动画，清空队列</span></div><div class="line">           <span class="keyword">int</span> numDelayedAnims = mDelayedAnims.size();</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numDelayedAnims; ++i) &#123;</div><div class="line">               ValueAnimator anim = mDelayedAnims.get(i);</div><div class="line">               <span class="keyword">if</span> (anim.delayedAnimationFrame(frameTime)) &#123;</div><div class="line">                   mReadyAnims.add(anim);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">int</span> numReadyAnims = mReadyAnims.size();</div><div class="line">           <span class="keyword">if</span> (numReadyAnims &gt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numReadyAnims; ++i) &#123;</div><div class="line">                   ValueAnimator anim = mReadyAnims.get(i);</div><div class="line">                   anim.startAnimation(<span class="keyword">this</span>);</div><div class="line">                   anim.mRunning = <span class="keyword">true</span>;</div><div class="line">                   mDelayedAnims.remove(anim);</div><div class="line">               &#125;</div><div class="line">               mReadyAnims.clear();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// Now process all active animations. The return value from animationFrame()</span></div><div class="line">           <span class="comment">// tells the handler whether it should now be ended</span></div><div class="line">           <span class="keyword">int</span> numAnims = mAnimations.size();</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</div><div class="line">               mTmpAnimations.add(mAnimations.get(i));</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</div><div class="line">               ValueAnimator anim = mTmpAnimations.get(i);</div><div class="line">               <span class="keyword">if</span> (mAnimations.contains(anim) &amp;&amp; anim.doAnimationFrame(frameTime)) &#123;</div><div class="line">                   mEndingAnims.add(anim);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           mTmpAnimations.clear();</div><div class="line">           <span class="keyword">if</span> (mEndingAnims.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mEndingAnims.size(); ++i) &#123;</div><div class="line">                   mEndingAnims.get(i).endAnimation(<span class="keyword">this</span>);</div><div class="line">               &#125;</div><div class="line">               mEndingAnims.clear();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// Schedule final commit for the frame.</span></div><div class="line">           mChoreographer.postCallback(Choreographer.CALLBACK_COMMIT, mCommit, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">           <span class="comment">// If there are still active or delayed animations, schedule a future call to</span></div><div class="line">           <span class="comment">// onAnimate to process the next frame of the animations.</span></div><div class="line">           <span class="keyword">if</span> (!mAnimations.isEmpty() || !mDelayedAnims.isEmpty()) &#123;</div><div class="line">               scheduleAnimation();</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
</p>
<p>流程图</p>
<p><img src="./ValueAnimator.png" alt="ValueAnimator"></p>
<h4 id="插值器"><a href="#插值器" class="headerlink" title="插值器"></a>插值器</h4><p>插值器是描述动画变化的频率。其主要方法是  </p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//输入动画基准值，得到计算后的某个时刻的值</span></div><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> input)</span></span>;</div></pre></td></tr></table></figure>
</p>
<p>类关系图:<br><img src="./interpolator.png" alt="interpolator"></p>
<p>系统已经为开发者准备了一些默认的插值器，我们来简单看下这些插值器的算法</p>
<h5 id="LinearInterpolator-线性插值器"><a href="#LinearInterpolator-线性插值器" class="headerlink" title="LinearInterpolator(线性插值器)"></a>LinearInterpolator(线性插值器)</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//输入既是输出</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> input)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> input;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</p>
<p><img src="./LinearInterpolator.png" alt=""></p>
<h5 id="AccelerateDecelerateInterpolator-加减速插值器"><a href="#AccelerateDecelerateInterpolator-加减速插值器" class="headerlink" title="AccelerateDecelerateInterpolator(加减速插值器)"></a>AccelerateDecelerateInterpolator(加减速插值器)</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> input)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">float</span>)(Math.cos((input + <span class="number">1</span>) * Math.PI) / <span class="number">2.0f</span>) + <span class="number">0.5f</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p><img src="./AccelerateDecelerateInterpolator.png" alt="">  </p>
<p>其特性是在动画开始和结束阶段变化缓慢，中间阶段变化迅速</p>
<h5 id="AccelerateInterpolator-加速插值器"><a href="#AccelerateInterpolator-加速插值器" class="headerlink" title="AccelerateInterpolator(加速插值器)"></a>AccelerateInterpolator(加速插值器)</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> input)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mFactor == <span class="number">1.0f</span>) &#123;</div><div class="line">            <span class="keyword">return</span> input * input;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">float</span>)Math.pow(input, mDoubleFactor);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p><img src="./AccelerateInterpolator.png" alt=""><br>其特点是动画变化速度一直加快，有个加速因子，默认为1。</p>
<h5 id="AnticipateInterpolator"><a href="#AnticipateInterpolator" class="headerlink" title="AnticipateInterpolator"></a>AnticipateInterpolator</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> t)</span> </span>&#123;</div><div class="line">        <span class="comment">// a(t) = t * t * ((tension + 1) * t - tension)</span></div><div class="line">        <span class="keyword">return</span> t * t * ((mTension + <span class="number">1</span>) * t - mTension);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p><img src="./AnticipateInterpolator.png" alt=""></p>
<h5 id="AnticipateOvershootInterpolator"><a href="#AnticipateOvershootInterpolator" class="headerlink" title="AnticipateOvershootInterpolator"></a>AnticipateOvershootInterpolator</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getInterpolation</span><span class="params">(<span class="keyword">float</span> t)</span> </span>&#123;</div><div class="line">        <span class="comment">// a(t, s) = t * t * ((s + 1) * t - s)</span></div><div class="line">        <span class="comment">// o(t, s) = t * t * ((s + 1) * t + s)</span></div><div class="line">        <span class="comment">// f(t) = 0.5 * a(t * 2, tension * extraTension), when t &lt; 0.5</span></div><div class="line">        <span class="comment">// f(t) = 0.5 * (o(t * 2 - 2, tension * extraTension) + 2), when t &lt;= 1.0</span></div><div class="line">        <span class="keyword">if</span> (t &lt; <span class="number">0.5f</span>) <span class="keyword">return</span> <span class="number">0.5f</span> * a(t * <span class="number">2.0f</span>, mTension);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0.5f</span> * (o(t * <span class="number">2.0f</span> - <span class="number">2.0f</span>, mTension) + <span class="number">2.0f</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p><img src="./AnticipateOvershootinterpolator.png" alt=""></p>
<p>还有很多别的插值器。这里就不多加赘述了。只要将相应的算法写入<code>getInterpolation</code>中即可</p>
<p>使用的地方</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">animateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</div><div class="line"><span class="comment">//计算动画值</span></div><div class="line">        fraction = mInterpolator.getInterpolation(fraction);</div><div class="line">        mCurrentFraction = fraction;</div><div class="line">        <span class="keyword">int</span> numValues = mValues.length;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</div><div class="line">            mValues[i].calculateValue(fraction);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mUpdateListeners != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">int</span> numListeners = mUpdateListeners.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">                mUpdateListeners.get(i).onAnimationUpdate(<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<h4 id="TypeEvaluator-估值器"><a href="#TypeEvaluator-估值器" class="headerlink" title="TypeEvaluator(估值器)"></a>TypeEvaluator(估值器)</h4><p>根据当前的动画频率，起始值，结束值计算当前值</p>
<p><img src="./TypeEvaluator.png" alt=""></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">evaluate</span><span class="params">(<span class="keyword">float</span> fraction, T startValue, T endValue)</span></span>;</div></pre></td></tr></table></figure>
</p>
<h5 id="ArgbEvaluator"><a href="#ArgbEvaluator" class="headerlink" title="ArgbEvaluator"></a>ArgbEvaluator</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">evaluate</span><span class="params">(<span class="keyword">float</span> fraction, Object startValue, Object endValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> startInt = (Integer) startValue;</div><div class="line">        <span class="keyword">int</span> startA = (startInt &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>;</div><div class="line">        <span class="keyword">int</span> startR = (startInt &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</div><div class="line">        <span class="keyword">int</span> startG = (startInt &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</div><div class="line">        <span class="keyword">int</span> startB = startInt &amp; <span class="number">0xff</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> endInt = (Integer) endValue;</div><div class="line">        <span class="keyword">int</span> endA = (endInt &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>;</div><div class="line">        <span class="keyword">int</span> endR = (endInt &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</div><div class="line">        <span class="keyword">int</span> endG = (endInt &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</div><div class="line">        <span class="keyword">int</span> endB = endInt &amp; <span class="number">0xff</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)((startA + (<span class="keyword">int</span>)(fraction * (endA - startA))) &lt;&lt; <span class="number">24</span>) |</div><div class="line">                (<span class="keyword">int</span>)((startR + (<span class="keyword">int</span>)(fraction * (endR - startR))) &lt;&lt; <span class="number">16</span>) |</div><div class="line">                (<span class="keyword">int</span>)((startG + (<span class="keyword">int</span>)(fraction * (endG - startG))) &lt;&lt; <span class="number">8</span>) |</div><div class="line">                (<span class="keyword">int</span>)((startB + (<span class="keyword">int</span>)(fraction * (endB - startB))));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p>算法是线性函数，主要因子<code>fraction</code>来自插值器的计算, <code>y= a + kx</code></p>
<h5 id="IntEvaluator"><a href="#IntEvaluator" class="headerlink" title="IntEvaluator"></a>IntEvaluator</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">evaluate</span><span class="params">(<span class="keyword">float</span> fraction, Integer startValue, Integer endValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> startInt = startValue;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)(startInt + fraction * (endValue - startInt));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<p>估值器主要实在<code>KeyFrames</code>中使用，而<code>KeyFrames</code>存在<code>PropertyValuesHolder</code>当中，最终<code>Choreographer</code>来更新动画使用</p>
<h4 id="Choreograhper"><a href="#Choreograhper" class="headerlink" title="Choreograhper"></a>Choreograhper</h4><p>协调动画，输入和绘制的时间。其会收到来自显示系统的定时脉冲，然后安排工作作为下一帧渲染的一部分。</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">Choreographer</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">        mLooper = looper;</div><div class="line">        mHandler = <span class="keyword">new</span> FrameHandler(looper);</div><div class="line">        mDisplayEventReceiver = USE_VSYNC ? <span class="keyword">new</span> FrameDisplayEventReceiver(looper) : <span class="keyword">null</span>;</div><div class="line">        mLastFrameTimeNanos = Long.MIN_VALUE;</div><div class="line"></div><div class="line">        mFrameIntervalNanos = (<span class="keyword">long</span>)(<span class="number">1000000000</span> / getRefreshRate());</div><div class="line"></div><div class="line">        mCallbackQueues = <span class="keyword">new</span> CallbackQueue[CALLBACK_LAST + <span class="number">1</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= CALLBACK_LAST; i++) &#123;</div><div class="line">            mCallbackQueues[i] = <span class="keyword">new</span> CallbackQueue();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>初始化，创建<code>FrameHandler</code>，创建回调队列</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallback</span><span class="params">(<span class="keyword">int</span> callbackType, Runnable action, Object token)</span> </span>&#123;</div><div class="line">        postCallbackDelayed(callbackType, action, token, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></div><div class="line">        Object action, Object token, <span class="keyword">long</span> delayMillis) &#123;</div><div class="line">    <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"PostCallback: type="</span> + callbackType</div><div class="line">                + <span class="string">", action="</span> + action + <span class="string">", token="</span> + token</div><div class="line">                + <span class="string">", delayMillis="</span> + delayMillis);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</div><div class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</div><div class="line">            scheduleFrameLocked(now);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</div><div class="line">            msg.arg1 = callbackType;</div><div class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">            mHandler.sendMessageAtTime(msg, dueTime);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>将回调加入回调队列，如果没有延时，锁定当前帧，如果使用<code>VSYNC</code>，诺当前运行在相同的线程，直接通过<code>FrameDisplayEventReceiver</code>要求同步，其他情况发送消息到<code>Handler</code>中执行。<code>Handler</code>处理三种消息,<code>MSG_DO_FRAME</code>,<code>MSG_DO_SCHEDULE_VSYNC</code>, <code>MSG_DO_SCHEDULE_CALLBACK</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">doCallbacks</span><span class="params">(<span class="keyword">int</span> callbackType, <span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</div><div class="line">        CallbackRecord callbacks;</div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            <span class="comment">// We use "now" to determine when callbacks become due because it's possible</span></div><div class="line">            <span class="comment">// for earlier processing phases in a frame to post callbacks that should run</span></div><div class="line">            <span class="comment">// in a following phase, such as an input event that causes an animation to start.</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = System.nanoTime();</div><div class="line">            callbacks = mCallbackQueues[callbackType].extractDueCallbacksLocked(</div><div class="line">                    now / TimeUtils.NANOS_PER_MS);</div><div class="line">            <span class="keyword">if</span> (callbacks == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            mCallbacksRunning = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Update the frame time if necessary when committing the frame.</span></div><div class="line">            <span class="comment">// We only update the frame time if we are more than 2 frames late reaching</span></div><div class="line">            <span class="comment">// the commit phase.  This ensures that the frame time which is observed by the</span></div><div class="line">            <span class="comment">// callbacks will always increase from one frame to the next and never repeat.</span></div><div class="line">            <span class="comment">// We never want the next frame's starting frame time to end up being less than</span></div><div class="line">            <span class="comment">// or equal to the previous frame's commit frame time.  Keep in mind that the</span></div><div class="line">            <span class="comment">// next frame has most likely already been scheduled by now so we play it</span></div><div class="line">            <span class="comment">// safe by ensuring the commit time is always at least one frame behind.</span></div><div class="line">            <span class="keyword">if</span> (callbackType == Choreographer.CALLBACK_COMMIT) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">long</span> jitterNanos = now - frameTimeNanos;</div><div class="line">                Trace.traceCounter(Trace.TRACE_TAG_VIEW, <span class="string">"jitterNanos"</span>, (<span class="keyword">int</span>) jitterNanos);</div><div class="line">                <span class="keyword">if</span> (jitterNanos &gt;= <span class="number">2</span> * mFrameIntervalNanos) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> lastFrameOffset = jitterNanos % mFrameIntervalNanos</div><div class="line">                            + mFrameIntervalNanos;</div><div class="line">                    <span class="keyword">if</span> (DEBUG_JANK) &#123;</div><div class="line">                        Log.d(TAG, <span class="string">"Commit callback delayed by "</span> + (jitterNanos * <span class="number">0.000001f</span>)</div><div class="line">                                + <span class="string">" ms which is more than twice the frame interval of "</span></div><div class="line">                                + (mFrameIntervalNanos * <span class="number">0.000001f</span>) + <span class="string">" ms!  "</span></div><div class="line">                                + <span class="string">"Setting frame time to "</span> + (lastFrameOffset * <span class="number">0.000001f</span>)</div><div class="line">                                + <span class="string">" ms in the past."</span>);</div><div class="line">                        mDebugPrintNextFrameTimeDelta = <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                    frameTimeNanos = now - lastFrameOffset;</div><div class="line">                    mLastFrameTimeNanos = frameTimeNanos;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, CALLBACK_TRACE_TITLES[callbackType]);</div><div class="line">            <span class="keyword">for</span> (CallbackRecord c = callbacks; c != <span class="keyword">null</span>; c = c.next) &#123;</div><div class="line">                <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</div><div class="line">                    Log.d(TAG, <span class="string">"RunCallback: type="</span> + callbackType</div><div class="line">                            + <span class="string">", action="</span> + c.action + <span class="string">", token="</span> + c.token</div><div class="line">                            + <span class="string">", latencyMillis="</span> + (SystemClock.uptimeMillis() - c.dueTime));</div><div class="line">                &#125;</div><div class="line">                c.run(frameTimeNanos);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            <span class="comment">//执行所有的回调</span></div><div class="line">                mCallbacksRunning = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">do</span> &#123;</div><div class="line">                    <span class="keyword">final</span> CallbackRecord next = callbacks.next;</div><div class="line">                    recycleCallbackLocked(callbacks);</div><div class="line">                    callbacks = next;</div><div class="line">                &#125; <span class="keyword">while</span> (callbacks != <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li><code>MSG_DO_FRAME</code>:判断当前帧时间，低于上次绘制时间，要求同步。否则调用<code>doCallbacks</code>，执行回调队列中的回调</li>
</ul>
<h5 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h5><h4 id="ObjectAnimator"><a href="#ObjectAnimator" class="headerlink" title="ObjectAnimator"></a>ObjectAnimator</h4><p>支持对目标对象的属性做动画，对<code>ValueAnimator</code>的拓展</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//可以直接设置target,propertyName</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ObjectAnimator <span class="title">ofInt</span><span class="params">(Object target, String propertyName, <span class="keyword">int</span>... values)</span> </span>&#123;</div><div class="line">        ObjectAnimator anim = <span class="keyword">new</span> ObjectAnimator(target, propertyName);</div><div class="line">        anim.setIntValues(values);</div><div class="line">        <span class="keyword">return</span> anim;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTarget</span><span class="params">(@Nullable Object target)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Object oldTarget = getTarget();</div><div class="line">        <span class="comment">//老的目标与当前目标不同，取消。设置弱引用目标对象</span></div><div class="line">        <span class="keyword">if</span> (oldTarget != target) &#123;</div><div class="line">            <span class="keyword">if</span> (isStarted()) &#123;</div><div class="line">                cancel();</div><div class="line">            &#125;</div><div class="line">            mTarget = target == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> WeakReference&lt;Object&gt;(target);</div><div class="line">            <span class="comment">// New target should cause re-initialization prior to starting</span></div><div class="line">            mInitialized = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// See if any of the current active/pending animators need to be canceled</span></div><div class="line">        AnimationHandler handler = sAnimationHandler.get();</div><div class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">int</span> numAnims = handler.mAnimations.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">if</span> (handler.mAnimations.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</div><div class="line">                    ObjectAnimator anim = (ObjectAnimator) handler.mAnimations.get(i);</div><div class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</div><div class="line">                    <span class="comment">//相同的目标和属性，取消之前的动画</span></div><div class="line">                        anim.cancel();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">//等待的动画也一样</span></div><div class="line">            numAnims = handler.mPendingAnimations.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">if</span> (handler.mPendingAnimations.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</div><div class="line">                    ObjectAnimator anim = (ObjectAnimator) handler.mPendingAnimations.get(i);</div><div class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</div><div class="line">                        anim.cancel();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">//延时的动画也一样</span></div><div class="line">            numAnims = handler.mDelayedAnims.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">if</span> (handler.mDelayedAnims.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</div><div class="line">                    ObjectAnimator anim = (ObjectAnimator) handler.mDelayedAnims.get(i);</div><div class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</div><div class="line">                        anim.cancel();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (DBG) &#123;</div><div class="line">            Log.d(LOG_TAG, <span class="string">"Anim target, duration: "</span> + getTarget() + <span class="string">", "</span> + getDuration());</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mValues.length; ++i) &#123;</div><div class="line">                PropertyValuesHolder pvh = mValues[i];</div><div class="line">                Log.d(LOG_TAG, <span class="string">"   Values["</span> + i + <span class="string">"]: "</span> +</div><div class="line">                    pvh.getPropertyName() + <span class="string">", "</span> + pvh.mKeyframes.getValue(<span class="number">0</span>) + <span class="string">", "</span> +</div><div class="line">                    pvh.mKeyframes.getValue(<span class="number">1</span>));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.start();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">animateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Object target = getTarget();</div><div class="line">        <span class="keyword">if</span> (mTarget != <span class="keyword">null</span> &amp;&amp; target == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// We lost the target reference, cancel and clean up.</span></div><div class="line">            cancel();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.animateValue(fraction);</div><div class="line">        <span class="keyword">int</span> numValues = mValues.length;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</div><div class="line">            mValues[i].setAnimatedValue(target);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setupStartValues</span><span class="params">()</span> </span>&#123;</div><div class="line">		  <span class="comment">//初始化动画</span></div><div class="line">        initAnimation();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Object target = getTarget();</div><div class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> numValues = mValues.length;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</div><div class="line">                mValues[i].setupStartValue(target);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mInitialized) &#123;</div><div class="line">            <span class="comment">// mValueType may change due to setter/getter setup; do this before calling super.init(),</span></div><div class="line">            <span class="comment">// which uses mValueType to set up the default type evaluator.</span></div><div class="line">            <span class="keyword">final</span> Object target = getTarget();</div><div class="line">            <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> numValues = mValues.length;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</div><div class="line">                <span class="comment">//初始化getter setter</span></div><div class="line">                   mValues[i].setupSetterAndGetter(target);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">super</span>.initAnimation();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li><code>ObjectAnimator</code>比<code>ValueAnimator</code>多了<code>target</code>和<code>Property</code>，这些信息都在<code>PropertyValuesHolder</code>,必须要要有getter/setter才能更新目标对象</li>
</ul>
<h4 id="PropertyValuesHolder-处理setter-getter的寻找"><a href="#PropertyValuesHolder-处理setter-getter的寻找" class="headerlink" title="PropertyValuesHolder 处理setter, getter的寻找"></a>PropertyValuesHolder 处理setter, getter的寻找</h4><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupSetterAndGetter</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">        mKeyframes.invalidateCache();</div><div class="line">        <span class="comment">//属性不为空时,从Propery拿值，并设置到keyFrame</span></div><div class="line">        <span class="keyword">if</span> (mProperty != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// check to make sure that mProperty is on the class of target</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Object testValue = <span class="keyword">null</span>;</div><div class="line">                List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();</div><div class="line">                <span class="keyword">int</span> keyframeCount = keyframes == <span class="keyword">null</span> ? <span class="number">0</span> : keyframes.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; keyframeCount; i++) &#123;</div><div class="line">                    Keyframe kf = keyframes.get(i);</div><div class="line">                    <span class="keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;</div><div class="line">                        <span class="keyword">if</span> (testValue == <span class="keyword">null</span>) &#123;</div><div class="line">                            testValue = convertBack(mProperty.get(target));</div><div class="line">                        &#125;</div><div class="line">                        kf.setValue(testValue);</div><div class="line">                        kf.setValueWasSetOnStart(<span class="keyword">true</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">                Log.w(<span class="string">"PropertyValuesHolder"</span>,<span class="string">"No such property ("</span> + mProperty.getName() +</div><div class="line">                        <span class="string">") on target object "</span> + target + <span class="string">". Trying reflection instead"</span>);</div><div class="line">                mProperty = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// We can't just say 'else' here because the catch statement sets mProperty to null.</span></div><div class="line">        <span class="comment">//如果property为空，从目标对象中寻找getter setter</span></div><div class="line">        <span class="keyword">if</span> (mProperty == <span class="keyword">null</span>) &#123;</div><div class="line">            Class targetClass = target.getClass();</div><div class="line">            <span class="keyword">if</span> (mSetter == <span class="keyword">null</span>) &#123;</div><div class="line">                setupSetter(targetClass);</div><div class="line">            &#125;</div><div class="line">            List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();</div><div class="line">            <span class="keyword">int</span> keyframeCount = keyframes == <span class="keyword">null</span> ? <span class="number">0</span> : keyframes.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; keyframeCount; i++) &#123;</div><div class="line">                Keyframe kf = keyframes.get(i);</div><div class="line">                <span class="keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;</div><div class="line">                    <span class="keyword">if</span> (mGetter == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">//getter没找到，再次寻找</span></div><div class="line">                        setupGetter(targetClass);</div><div class="line">                        <span class="comment">//依然没找到</span></div><div class="line">                        <span class="keyword">if</span> (mGetter == <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// Already logged the error - just return to avoid NPE</span></div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Object value = convertBack(mGetter.invoke(target));</div><div class="line">                        <span class="comment">//找到getter，将值传给keyFrame</span></div><div class="line">                        kf.setValue(value);</div><div class="line">                        kf.setValueWasSetOnStart(<span class="keyword">true</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">                        Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</div><div class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">                        Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAnimatedValue</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mProperty != <span class="keyword">null</span>) &#123;</div><div class="line">            mProperty.set(target, getAnimatedValue());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mSetter != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//setter不为空，会调用目标对象的setter</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mTmpValueArray[<span class="number">0</span>] = getAnimatedValue();</div><div class="line">                mSetter.invoke(target, mTmpValueArray);</div><div class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">                Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">                Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li><code>PropertyValuesHolder</code>主要持有动画的相关属性信息，包括关键帧集，插值器，估值器等</li>
</ul>
<h4 id="KeyFrame"><a href="#KeyFrame" class="headerlink" title="KeyFrame"></a>KeyFrame</h4><p>动画关键帧，保存动画某一帧的时间/值。被<code>ValueAnimator</code>使用来计算两个值之间的动画值。<code>PropertyValuesHolder</code>保存了<code>KeyFrames</code>其保存了多个<code>KeyFrame</code>。简单来说<code>KeyFrame</code>就是我们做动画的起始值，中间值，结束值，这些都是由开发者定义。</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIntValues</span><span class="params">(<span class="keyword">int</span>... values)</span> </span>&#123;</div><div class="line">        mValueType = <span class="keyword">int</span>.class;</div><div class="line">        mKeyframes = KeyframeSet.ofInt(values);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">keyFrameSet:</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> KeyframeSet <span class="title">ofInt</span><span class="params">(<span class="keyword">int</span>... values)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> numKeyframes = values.length;</div><div class="line">        IntKeyframe keyframes[] = <span class="keyword">new</span> IntKeyframe[Math.max(numKeyframes,<span class="number">2</span>)];</div><div class="line">        <span class="keyword">if</span> (numKeyframes == <span class="number">1</span>) &#123;</div><div class="line">        <span class="comment">//当只设置了一个值时，会有两个关键帧，起始关键这和结束关键帧</span></div><div class="line">            keyframes[<span class="number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">0f</span>);</div><div class="line">            keyframes[<span class="number">1</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">1f</span>, values[<span class="number">0</span>]);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//起始关键帧</span></div><div class="line">            keyframes[<span class="number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">0f</span>, values[<span class="number">0</span>]);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; numKeyframes; ++i) &#123;</div><div class="line">            <span class="comment">//计算每个阶段的关键帧</span></div><div class="line">                keyframes[i] =</div><div class="line">                        (IntKeyframe) Keyframe.ofInt((<span class="keyword">float</span>) i / (numKeyframes - <span class="number">1</span>), values[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IntKeyframeSet(keyframes);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>动画至少会包含两个关键帧，一个起始关键帧，一个结束关键帧。中间有多少关键帧由开发者自行定义</li>
</ul>
<h4 id="AnimatorSet"><a href="#AnimatorSet" class="headerlink" title="AnimatorSet"></a>AnimatorSet</h4><p>允许同时播放多个动画或者定义动画的播放顺序</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        mTerminated = <span class="keyword">false</span>;</div><div class="line">        mStarted = <span class="keyword">true</span>;</div><div class="line">        mPaused = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Node node : mNodes) &#123;</div><div class="line">            <span class="comment">//禁止异步运行node.animation.setAllowRunningAsynchronously(false);</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//设置所有动画的长度</span></div><div class="line">        <span class="keyword">if</span> (mDuration &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// If the duration was set on this AnimatorSet, pass it along to all child animations</span></div><div class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> don't set the duration of the timing-only nodes created by AnimatorSet to</span></div><div class="line">                <span class="comment">// insert "play-after" delays</span></div><div class="line">                node.animation.setDuration(mDuration);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//设置所有动画的插值器</span></div><div class="line">        <span class="keyword">if</span> (mInterpolator != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</div><div class="line">                node.animation.setInterpolator(mInterpolator);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// First, sort the nodes (if necessary). This will ensure that sortedNodes</span></div><div class="line">        <span class="comment">// contains the animation nodes in the correct order.</span></div><div class="line">        <span class="comment">//对所有的动画节点进行排序</span></div><div class="line">        sortNodes();</div><div class="line"></div><div class="line">		  <span class="comment">//清除老的动画监听	</span></div><div class="line">        <span class="keyword">int</span> numSortedNodes = mSortedNodes.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</div><div class="line">            Node node = mSortedNodes.get(i);</div><div class="line">            <span class="comment">// First, clear out the old listeners</span></div><div class="line">            ArrayList&lt;AnimatorListener&gt; oldListeners = node.animation.getListeners();</div><div class="line">            <span class="keyword">if</span> (oldListeners != <span class="keyword">null</span> &amp;&amp; oldListeners.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">final</span> ArrayList&lt;AnimatorListener&gt; clonedListeners = <span class="keyword">new</span></div><div class="line">                        ArrayList&lt;AnimatorListener&gt;(oldListeners);</div><div class="line"></div><div class="line">                <span class="keyword">for</span> (AnimatorListener listener : clonedListeners) &#123;</div><div class="line">                    <span class="keyword">if</span> (listener <span class="keyword">instanceof</span> DependencyListener ||</div><div class="line">                            listener <span class="keyword">instanceof</span> AnimatorSetListener) &#123;</div><div class="line">                        node.animation.removeListener(listener);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// nodesToStart holds the list of nodes to be started immediately. We don't want to</span></div><div class="line">        <span class="comment">// start the animations in the loop directly because we first need to set up</span></div><div class="line">        <span class="comment">// dependencies on all of the nodes. For example, we don't want to start an animation</span></div><div class="line">        <span class="comment">// when some other animation also wants to start when the first animation begins.</span></div><div class="line">        <span class="keyword">final</span> ArrayList&lt;Node&gt; nodesToStart = <span class="keyword">new</span> ArrayList&lt;Node&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</div><div class="line">            Node node = mSortedNodes.get(i);</div><div class="line">            <span class="keyword">if</span> (mSetListener == <span class="keyword">null</span>) &#123;</div><div class="line">                mSetListener = <span class="keyword">new</span> AnimatorSetListener(<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//动画节点没有依赖别的节点，添加到即将开始的队列中</span></div><div class="line">            <span class="keyword">if</span> (node.dependencies == <span class="keyword">null</span> || node.dependencies.size() == <span class="number">0</span>) &#123;</div><div class="line">                nodesToStart.add(node);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//如果有依赖的话，添加依赖监听，并把依赖添加到临时依赖链中</span></div><div class="line">                <span class="keyword">int</span> numDependencies = node.dependencies.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; numDependencies; ++j) &#123;</div><div class="line">                    Dependency dependency = node.dependencies.get(j);</div><div class="line">                    dependency.node.animation.addListener(</div><div class="line">                            <span class="keyword">new</span> DependencyListener(<span class="keyword">this</span>, node, dependency.rule));</div><div class="line">                &#125;</div><div class="line">                node.tmpDependencies = (ArrayList&lt;Dependency&gt;) node.dependencies.clone();</div><div class="line">            &#125;</div><div class="line">            node.animation.addListener(mSetListener);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Now that all dependencies are set up, start the animations that should be started.</span></div><div class="line">        <span class="comment">//开始动画</span></div><div class="line">        <span class="keyword">if</span> (mStartDelay &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Node node : nodesToStart) &#123;</div><div class="line">                node.animation.start();</div><div class="line">                mPlayingSet.add(node.animation);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mDelayAnim = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>);</div><div class="line">            mDelayAnim.setDuration(mStartDelay);</div><div class="line">            mDelayAnim.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                <span class="keyword">boolean</span> canceled = <span class="keyword">false</span>;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator anim)</span> </span>&#123;</div><div class="line">                    canceled = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator anim)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (!canceled) &#123;</div><div class="line">                        <span class="keyword">int</span> numNodes = nodesToStart.size();</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</div><div class="line">                            Node node = nodesToStart.get(i);</div><div class="line">                            node.animation.start();</div><div class="line">                            mPlayingSet.add(node.animation);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    mDelayAnim = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            mDelayAnim.start();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//动画开始回调</span></div><div class="line">        <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</div><div class="line">            ArrayList&lt;AnimatorListener&gt; tmpListeners =</div><div class="line">                    (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</div><div class="line">            <span class="keyword">int</span> numListeners = tmpListeners.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">                tmpListeners.get(i).onAnimationStart(<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//如果没有动画，动画结束回调</span></div><div class="line">        <span class="keyword">if</span> (mNodes.size() == <span class="number">0</span> &amp;&amp; mStartDelay == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Handle unusual case where empty AnimatorSet is started - should send out</span></div><div class="line">            <span class="comment">// end event immediately since the event will not be sent out at all otherwise</span></div><div class="line">            mStarted = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</div><div class="line">                ArrayList&lt;AnimatorListener&gt; tmpListeners =</div><div class="line">                        (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</div><div class="line">                <span class="keyword">int</span> numListeners = tmpListeners.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">                    tmpListeners.get(i).onAnimationEnd(<span class="keyword">this</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>流程: <ol>
<li>首先禁止异步运行动画，设置所有动画的时间和插值器。</li>
<li>对所有的动画进行排序(根据依赖关系),取消所有老的监听。如果动画没有依赖，加入即将开始的动画队列，否则创建依赖监听，创建临时依赖</li>
<li>没有延时，启动动画。否则创建延时动画，延时动画结束后，后续动画开始</li>
<li>动画开始监听回调，如果没有动画，动画结束监听回调</li>
</ol>
</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">动画排序</div><div class="line">private void sortNodes() &#123;</div><div class="line">        if (mNeedsSort) &#123;</div><div class="line">            mSortedNodes.clear();</div><div class="line">            ArrayList&lt;Node&gt; roots = new ArrayList&lt;Node&gt;();</div><div class="line">            int numNodes = mNodes.size();</div><div class="line">            //没有依赖的动画变成根节点</div><div class="line">            for (int i = 0; i &lt; numNodes; ++i) &#123;</div><div class="line">                Node node = mNodes.get(i);</div><div class="line">                if (node.dependencies == null || node.dependencies.size() == 0) &#123;</div><div class="line">                    roots.add(node);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            ArrayList&lt;Node&gt; tmpRoots = new ArrayList&lt;Node&gt;();</div><div class="line">            while (roots.size() &gt; 0) &#123;</div><div class="line">            //遍历每个根节点</div><div class="line">                int numRoots = roots.size();</div><div class="line">                for (int i = 0; i &lt; numRoots; ++i) &#123;</div><div class="line">                    Node root = roots.get(i);</div><div class="line">                    mSortedNodes.add(root);</div><div class="line">                    if (root.nodeDependents != null) &#123;</div><div class="line">                        int numDependents = root.nodeDependents.size();</div><div class="line">                        //根节点有依赖</div><div class="line">                        for (int j = 0; j &lt; numDependents; ++j) &#123;</div><div class="line">                            Node node = root.nodeDependents.get(j);</div><div class="line">                            //将此根节点从依赖中移除node.nodeDependencies.remove(root);</div><div class="line">                            if (node.nodeDependencies.size() == 0) &#123;</div><div class="line">                                tmpRoots.add(node);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                roots.clear();</div><div class="line">                roots.addAll(tmpRoots);</div><div class="line">                tmpRoots.clear();</div><div class="line">            &#125;</div><div class="line">            mNeedsSort = false;</div><div class="line">            if (mSortedNodes.size() != mNodes.size()) &#123;</div><div class="line">                throw new IllegalStateException("Circular dependencies cannot exist"</div><div class="line">                        + " in AnimatorSet");</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            // Doesn't need sorting, but still need to add in the nodeDependencies list</div><div class="line">            // because these get removed as the event listeners fire and the dependencies</div><div class="line">            // are satisfied</div><div class="line">            int numNodes = mNodes.size();</div><div class="line">            for (int i = 0; i &lt; numNodes; ++i) &#123;</div><div class="line">                Node node = mNodes.get(i);</div><div class="line">                if (node.dependencies != null &amp;&amp; node.dependencies.size() &gt; 0) &#123;</div><div class="line">                    int numDependencies = node.dependencies.size();</div><div class="line">                    for (int j = 0; j &lt; numDependencies; ++j) &#123;</div><div class="line">                        Dependency dependency = node.dependencies.get(j);</div><div class="line">                        if (node.nodeDependencies == null) &#123;</div><div class="line">                            node.nodeDependencies = new ArrayList&lt;Node&gt;();</div><div class="line">                        &#125;</div><div class="line">                        if (!node.nodeDependencies.contains(dependency.node)) &#123;</div><div class="line">                            node.nodeDependencies.add(dependency.node);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                // nodes are 'done' by default; they become un-done when started, and done</div><div class="line">                // again when ended</div><div class="line">                node.done = false;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">```  </div><div class="line">* 动画排序规则: </div><div class="line">  * 如果需要排序</div><div class="line">      1. 没有依赖的动画变成根节点.</div><div class="line">      2. 循环遍历所有根节点，将根节点从依赖节点中移除</div><div class="line">  * 不需要排序</div><div class="line">      1. 添加回依赖</div><div class="line"></div><div class="line">##### Node</div><div class="line">代表动画和其依赖。其包含一个动画信息，节点动画依赖集合，独立节点集合</div><div class="line"></div><div class="line">##### Dependency</div><div class="line">动画节点与节点之间的依赖描述</div><div class="line"></div><div class="line">```java</div><div class="line">static final int WITH = 0; // dependent node must start with this dependency node</div><div class="line">        static final int AFTER = 1; // dependent node must start when this dependency node finishes</div></pre></td></tr></table></figure>
</p>
<ul>
<li>包含两个规则，一起，后续</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">//多个动画一起播放，添加动画``WITH``依赖</div><div class="line">public void playTogether(Animator... items) &#123;</div><div class="line">        if (items != null) &#123;</div><div class="line">            mNeedsSort = true;</div><div class="line">            Builder builder = play(items[0]);</div><div class="line">            for (int i = 1; i &lt; items.length; ++i) &#123;</div><div class="line">                builder.with(items[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">public Builder with(Animator anim) &#123;</div><div class="line">            Node node = mNodeMap.get(anim);</div><div class="line">            if (node == null) &#123;</div><div class="line">                node = new Node(anim);</div><div class="line">                mNodeMap.put(anim, node);</div><div class="line">                mNodes.add(node);</div><div class="line">            &#125;</div><div class="line">            Dependency dependency = new Dependency(mCurrentNode, Dependency.WITH);</div><div class="line">            node.addDependency(dependency);</div><div class="line">            return this;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">//多个动画串行播放        </div><div class="line">public void playSequentially(Animator... items) &#123;</div><div class="line">        if (items != null) &#123;</div><div class="line">            mNeedsSort = true;</div><div class="line">            if (items.length == 1) &#123;</div><div class="line">                play(items[0]);</div><div class="line">            &#125; else &#123;</div><div class="line">                mReversible = false;</div><div class="line">                for (int i = 0; i &lt; items.length - 1; ++i) &#123;</div><div class="line">                    play(items[i]).before(items[i+1]);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">//在某个动画之前播放，添加``AFTER``依赖</div><div class="line">public Builder before(Animator anim) &#123;</div><div class="line">            mReversible = false;</div><div class="line">            Node node = mNodeMap.get(anim);</div><div class="line">            if (node == null) &#123;</div><div class="line">                node = new Node(anim);</div><div class="line">                mNodeMap.put(anim, node);</div><div class="line">                mNodes.add(node);</div><div class="line">            &#125;</div><div class="line">            Dependency dependency = new Dependency(mCurrentNode, Dependency.AFTER);</div><div class="line">            node.addDependency(dependency);</div><div class="line">            return this;</div><div class="line">        &#125;                </div><div class="line">``` </div><div class="line"></div><div class="line">#### LayoutTransition</div><div class="line">``ViewGroup``布局发生改变时播放动画。这个动画的核心概念是两个类型的改变会引起四种不同的动画运行。这两种改变时``appearing``和``disappearing``。</div><div class="line"></div><div class="line">```java</div><div class="line">ViewGroup</div><div class="line">setLayoutTransition(LayoutTransition transition)</div></pre></td></tr></table></figure>
</p>
<p>动画类型，用一个字节表示</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_APPEARING             = <span class="number">0x01</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_DISAPPEARING          = <span class="number">0x02</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_CHANGE_APPEARING      = <span class="number">0x04</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_CHANGE_DISAPPEARING   = <span class="number">0x08</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_CHANGING              = <span class="number">0x10</span>;</div><div class="line">    </div><div class="line">    </div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mTransitionTypes = FLAG_CHANGE_APPEARING | FLAG_CHANGE_DISAPPEARING |</div><div class="line">            FLAG_APPEARING | FLAG_DISAPPEARING;</div><div class="line">            </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChangeAnimation</span><span class="params">(<span class="keyword">final</span> ViewGroup parent, <span class="keyword">final</span> <span class="keyword">int</span> changeReason,</span></span></div><div class="line">            Animator baseAnimator, <span class="keyword">final</span> <span class="keyword">long</span> duration, <span class="keyword">final</span> View child) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// If we already have a listener for this child, then we've already set up the</span></div><div class="line">        <span class="comment">// changing animation we need. Multiple calls for a child may occur when several</span></div><div class="line">        <span class="comment">// add/remove operations are run at once on a container; each one will trigger</span></div><div class="line">        <span class="comment">// changes for the existing children in the container.</span></div><div class="line">        <span class="keyword">if</span> (layoutChangeListenerMap.get(child) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Don't animate items up from size(0,0); this is likely because the objects</span></div><div class="line">        <span class="comment">// were offscreen/invisible or otherwise measured to be infinitely small. We don't</span></div><div class="line">        <span class="comment">// want to see them animate into their real size; just ignore animation requests</span></div><div class="line">        <span class="comment">// on these views</span></div><div class="line">        <span class="keyword">if</span> (child.getWidth() == <span class="number">0</span> &amp;&amp; child.getHeight() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make a copy of the appropriate animation</span></div><div class="line">        <span class="keyword">final</span> Animator anim = baseAnimator.clone();</div><div class="line"></div><div class="line">        <span class="comment">// Set the target object for the animation</span></div><div class="line">        anim.setTarget(child);</div><div class="line"></div><div class="line">        <span class="comment">// A ObjectAnimator (or AnimatorSet of them) can extract start values from</span></div><div class="line">        <span class="comment">// its target object</span></div><div class="line">        anim.setupStartValues();</div><div class="line"></div><div class="line">        <span class="comment">// If there's an animation running on this view already, cancel it</span></div><div class="line">        Animator currentAnimation = pendingAnimations.get(child);</div><div class="line">        <span class="keyword">if</span> (currentAnimation != <span class="keyword">null</span>) &#123;</div><div class="line">            currentAnimation.cancel();</div><div class="line">            pendingAnimations.remove(child);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Cache the animation in case we need to cancel it later</span></div><div class="line">        pendingAnimations.put(child, anim);</div><div class="line"></div><div class="line">        <span class="comment">// For the animations which don't get started, we have to have a means of</span></div><div class="line">        <span class="comment">// removing them from the cache, lest we leak them and their target objects.</span></div><div class="line">        <span class="comment">// We run an animator for the default duration+100 (an arbitrary time, but one</span></div><div class="line">        <span class="comment">// which should far surpass the delay between setting them up here and</span></div><div class="line">        <span class="comment">// handling layout events which start them.</span></div><div class="line">        ValueAnimator pendingAnimRemover = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>).</div><div class="line">                setDuration(duration + <span class="number">100</span>);</div><div class="line">        pendingAnimRemover.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                pendingAnimations.remove(child);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        pendingAnimRemover.start();</div><div class="line"></div><div class="line">        <span class="comment">// Add a listener to track layout changes on this view. If we don't get a callback,</span></div><div class="line">        <span class="comment">// then there's nothing to animate.</span></div><div class="line">        <span class="keyword">final</span> View.OnLayoutChangeListener listener = <span class="keyword">new</span> View.OnLayoutChangeListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChange</span><span class="params">(View v, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></div><div class="line">                    <span class="keyword">int</span> oldLeft, <span class="keyword">int</span> oldTop, <span class="keyword">int</span> oldRight, <span class="keyword">int</span> oldBottom) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// Tell the animation to extract end values from the changed object</span></div><div class="line">                anim.setupEndValues();</div><div class="line">                <span class="keyword">if</span> (anim <span class="keyword">instanceof</span> ValueAnimator) &#123;</div><div class="line">                    <span class="keyword">boolean</span> valuesDiffer = <span class="keyword">false</span>;</div><div class="line">                    ValueAnimator valueAnim = (ValueAnimator)anim;</div><div class="line">                    PropertyValuesHolder[] oldValues = valueAnim.getValues();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oldValues.length; ++i) &#123;</div><div class="line">                        PropertyValuesHolder pvh = oldValues[i];</div><div class="line">                        <span class="keyword">if</span> (pvh.mKeyframes <span class="keyword">instanceof</span> KeyframeSet) &#123;</div><div class="line">                            KeyframeSet keyframeSet = (KeyframeSet) pvh.mKeyframes;</div><div class="line">                            <span class="keyword">if</span> (keyframeSet.mFirstKeyframe == <span class="keyword">null</span> ||</div><div class="line">                                    keyframeSet.mLastKeyframe == <span class="keyword">null</span> ||</div><div class="line">                                    !keyframeSet.mFirstKeyframe.getValue().equals(</div><div class="line">                                            keyframeSet.mLastKeyframe.getValue())) &#123;</div><div class="line">                                valuesDiffer = <span class="keyword">true</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pvh.mKeyframes.getValue(<span class="number">0</span>).equals(pvh.mKeyframes.getValue(<span class="number">1</span>))) &#123;</div><div class="line">                            valuesDiffer = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (!valuesDiffer) &#123;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">long</span> startDelay = <span class="number">0</span>;</div><div class="line">                <span class="keyword">switch</span> (changeReason) &#123;</div><div class="line">                    <span class="keyword">case</span> APPEARING:</div><div class="line">                        startDelay = mChangingAppearingDelay + staggerDelay;</div><div class="line">                        staggerDelay += mChangingAppearingStagger;</div><div class="line">                        <span class="keyword">if</span> (mChangingAppearingInterpolator != sChangingAppearingInterpolator) &#123;</div><div class="line">                            anim.setInterpolator(mChangingAppearingInterpolator);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> DISAPPEARING:</div><div class="line">                        startDelay = mChangingDisappearingDelay + staggerDelay;</div><div class="line">                        staggerDelay += mChangingDisappearingStagger;</div><div class="line">                        <span class="keyword">if</span> (mChangingDisappearingInterpolator !=</div><div class="line">                                sChangingDisappearingInterpolator) &#123;</div><div class="line">                            anim.setInterpolator(mChangingDisappearingInterpolator);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> CHANGING:</div><div class="line">                        startDelay = mChangingDelay + staggerDelay;</div><div class="line">                        staggerDelay += mChangingStagger;</div><div class="line">                        <span class="keyword">if</span> (mChangingInterpolator != sChangingInterpolator) &#123;</div><div class="line">                            anim.setInterpolator(mChangingInterpolator);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                anim.setStartDelay(startDelay);</div><div class="line">                anim.setDuration(duration);</div><div class="line"></div><div class="line">                Animator prevAnimation = currentChangingAnimations.get(child);</div><div class="line">                <span class="keyword">if</span> (prevAnimation != <span class="keyword">null</span>) &#123;</div><div class="line">                    prevAnimation.cancel();</div><div class="line">                &#125;</div><div class="line">                Animator pendingAnimation = pendingAnimations.get(child);</div><div class="line">                <span class="keyword">if</span> (pendingAnimation != <span class="keyword">null</span>) &#123;</div><div class="line">                    pendingAnimations.remove(child);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Cache the animation in case we need to cancel it later</span></div><div class="line">                currentChangingAnimations.put(child, anim);</div><div class="line"></div><div class="line">                parent.requestTransitionStart(LayoutTransition.<span class="keyword">this</span>);</div><div class="line"></div><div class="line">                <span class="comment">// this only removes listeners whose views changed - must clear the</span></div><div class="line">                <span class="comment">// other listeners later</span></div><div class="line">                child.removeOnLayoutChangeListener(<span class="keyword">this</span>);</div><div class="line">                layoutChangeListenerMap.remove(child);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="comment">// Remove the animation from the cache when it ends</span></div><div class="line">        anim.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animator)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (hasListeners()) &#123;</div><div class="line">                    ArrayList&lt;TransitionListener&gt; listeners =</div><div class="line">                            (ArrayList&lt;TransitionListener&gt;) mListeners.clone();</div><div class="line">                    <span class="keyword">for</span> (TransitionListener listener : listeners) &#123;</div><div class="line">                        listener.startTransition(LayoutTransition.<span class="keyword">this</span>, parent, child,</div><div class="line">                                changeReason == APPEARING ?</div><div class="line">                                        CHANGE_APPEARING : changeReason == DISAPPEARING ?</div><div class="line">                                        CHANGE_DISAPPEARING : CHANGING);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animator)</span> </span>&#123;</div><div class="line">                child.removeOnLayoutChangeListener(listener);</div><div class="line">                layoutChangeListenerMap.remove(child);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animator)</span> </span>&#123;</div><div class="line">                currentChangingAnimations.remove(child);</div><div class="line">                <span class="keyword">if</span> (hasListeners()) &#123;</div><div class="line">                    ArrayList&lt;TransitionListener&gt; listeners =</div><div class="line">                            (ArrayList&lt;TransitionListener&gt;) mListeners.clone();</div><div class="line">                    <span class="keyword">for</span> (TransitionListener listener : listeners) &#123;</div><div class="line">                        listener.endTransition(LayoutTransition.<span class="keyword">this</span>, parent, child,</div><div class="line">                                changeReason == APPEARING ?</div><div class="line">                                        CHANGE_APPEARING : changeReason == DISAPPEARING ?</div><div class="line">                                        CHANGE_DISAPPEARING : CHANGING);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        child.addOnLayoutChangeListener(listener);</div><div class="line">        <span class="comment">// cache the listener for later removal</span></div><div class="line">        layoutChangeListenerMap.put(child, listener);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>主要流程<ol>
<li>启动一个延时动画来移除为执行的动画</li>
<li>监听布局变化,如果是<code>ValueAnimator</code>，判断起始帧和结束帧是否一样，如果一样表示结束.否则根据布局改变的原因设置动画类型，开始动画</li>
<li>移除缓存动画</li>
</ol>
</li>
</ul>
<h4 id="ViewPropertyAnimator"><a href="#ViewPropertyAnimator" class="headerlink" title="ViewPropertyAnimator"></a>ViewPropertyAnimator</h4><p>自动优化<code>View</code>对象的属性动画。如果想做1个或者两个属性动画，使用<code>ObjectAnimator</code>，其也可以设置属性值，合理的刷新视图。但是如果有多个属性要同时动画，或者想要使用更简洁的语法，那么可以使用<code>ViewPropertyAnimator</code></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">animateProperty</span><span class="params">(<span class="keyword">int</span> constantName, <span class="keyword">float</span> toValue)</span> </span>&#123;</div><div class="line">        <span class="keyword">float</span> fromValue = getValue(constantName);</div><div class="line">        <span class="keyword">float</span> deltaValue = toValue - fromValue;</div><div class="line">        animatePropertyBy(constantName, fromValue, deltaValue);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">animatePropertyBy</span><span class="params">(<span class="keyword">int</span> constantName, <span class="keyword">float</span> startValue, <span class="keyword">float</span> byValue)</span> </span>&#123;</div><div class="line">        <span class="comment">// First, cancel any existing animations on this property</span></div><div class="line">        <span class="keyword">if</span> (mAnimatorMap.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            Animator animatorToCancel = <span class="keyword">null</span>;</div><div class="line">            Set&lt;Animator&gt; animatorSet = mAnimatorMap.keySet();</div><div class="line">            <span class="keyword">for</span> (Animator runningAnim : animatorSet) &#123;</div><div class="line">                PropertyBundle bundle = mAnimatorMap.get(runningAnim);</div><div class="line">                <span class="keyword">if</span> (bundle.cancel(constantName)) &#123;</div><div class="line">                    <span class="comment">// property was canceled - cancel the animation if it's now empty</span></div><div class="line">                    <span class="comment">// Note that it's safe to break out here because every new animation</span></div><div class="line">                    <span class="comment">// on a property will cancel a previous animation on that property, so</span></div><div class="line">                    <span class="comment">// there can only ever be one such animation running.</span></div><div class="line">                    <span class="keyword">if</span> (bundle.mPropertyMask == NONE) &#123;</div><div class="line">                        <span class="comment">// the animation is no longer changing anything - cancel it</span></div><div class="line">                        animatorToCancel = runningAnim;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (animatorToCancel != <span class="keyword">null</span>) &#123;</div><div class="line">                animatorToCancel.cancel();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        NameValuesHolder nameValuePair = <span class="keyword">new</span> NameValuesHolder(constantName, startValue, byValue);</div><div class="line">        mPendingAnimations.add(nameValuePair);</div><div class="line">        mView.removeCallbacks(mAnimationStarter);</div><div class="line">        mView.postOnAnimation(mAnimationStarter);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>上述流程, 做属性动画都会调用<code>animateProperty</code>，其内部会调用<code>animatePropertyBy</code><ol>
<li>首先会取消这个属性上存在的动画</li>
<li>构建<code>NameValuesHolder</code></li>
<li>调用<code>removeCallbacks(runnable)</code>，取消之前动画</li>
<li>调用<code>postOnAnimation(runnable)</code>，开始动画</li>
</ol>
</li>
</ul>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>主要用于做转场动画，其会保存场景转变的信息。任何转变有两个主要工作: 1. 捕获属性值 2. 基于捕获的属性值改变做动画。**无法与<code>TextureView</code>和<code>SurfaceView</code>一起使用。对于<code>SurfaceView</code>，由于其是从非UI线程更新UI，因此会造成不同步。对于<code>TextureView</code>，由于转场动画依赖<code>ViewOverlay</code>，而其又无法与<code>TextureView</code>一起工作。</p>
<h4 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h4><p><img src="./transition.png" alt="transition"></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Transition.java</div><div class="line"></div><div class="line"><span class="comment">//捕获开始场景的属性</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//捕获结束场景的属性</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">captureEndValues</span><span class="params">(TransitionValues transitionValues)</span></span>;</div></pre></td></tr></table></figure>
</p>
<h5 id="开始转场动画"><a href="#开始转场动画" class="headerlink" title="开始转场动画"></a>开始转场动画</h5><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beginDelayedTransition</span><span class="params">(<span class="keyword">final</span> ViewGroup sceneRoot, Transition transition)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!sPendingTransitions.contains(sceneRoot) &amp;&amp; sceneRoot.isLaidOut()) &#123;</div><div class="line">            <span class="keyword">if</span> (Transition.DBG) &#123;</div><div class="line">                Log.d(LOG_TAG, <span class="string">"beginDelayedTransition: root, transition = "</span> +</div><div class="line">                        sceneRoot + <span class="string">", "</span> + transition);</div><div class="line">            &#125;</div><div class="line">            sPendingTransitions.add(sceneRoot);</div><div class="line">            <span class="keyword">if</span> (transition == <span class="keyword">null</span>) &#123;</div><div class="line">                transition = sDefaultTransition;<span class="comment">//使用默认转场</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">final</span> Transition transitionClone = transition.clone();</div><div class="line">            sceneChangeSetup(sceneRoot, transitionClone);</div><div class="line">            Scene.setCurrentScene(sceneRoot, <span class="keyword">null</span>);</div><div class="line">            sceneChangeRunTransition(sceneRoot, transitionClone);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sceneChangeSetup</span><span class="params">(ViewGroup sceneRoot, Transition transition)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Capture current values</span></div><div class="line">        ArrayList&lt;Transition&gt; runningTransitions = getRunningTransitions().get(sceneRoot);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (runningTransitions != <span class="keyword">null</span> &amp;&amp; runningTransitions.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (Transition runningTransition : runningTransitions) &#123;</div><div class="line">                runningTransition.pause(sceneRoot);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (transition != <span class="keyword">null</span>) &#123;</div><div class="line">            transition.captureValues(sceneRoot, <span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify previous scene that it is being exited</span></div><div class="line">        Scene previousScene = Scene.getCurrentScene(sceneRoot);</div><div class="line">        <span class="keyword">if</span> (previousScene != <span class="keyword">null</span>) &#123;</div><div class="line">            previousScene.exit();</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sceneChangeRunTransition</span><span class="params">(<span class="keyword">final</span> ViewGroup sceneRoot,</span></span></div><div class="line">            <span class="keyword">final</span> Transition transition) &#123;</div><div class="line">        <span class="keyword">if</span> (transition != <span class="keyword">null</span> &amp;&amp; sceneRoot != <span class="keyword">null</span>) &#123;</div><div class="line">            MultiListener listener = <span class="keyword">new</span> MultiListener(transition, sceneRoot);</div><div class="line">            sceneRoot.addOnAttachStateChangeListener(listener);</div><div class="line">            <span class="comment">//设置绘制前监听</span></div><div class="line">            sceneRoot.getViewTreeObserver().addOnPreDrawListener(listener);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>流程<ol>
<li>未设置<code>Transition</code>，使用默认<code>Transition</code>，也就是<code>AutoTransition</code></li>
<li>暂停当前正在运行的转场动画，捕获当前场景，取消之前的转场动画</li>
<li>设置当前场景</li>
<li>设置绘制(<code>preDraw</code>)监听，在其当中捕获场景和开始转场动画</li>
</ol>
</li>
</ul>
<h5 id="AutoTransition"><a href="#AutoTransition" class="headerlink" title="AutoTransition"></a>AutoTransition</h5><p>组合转场动画，包括渐变和区域改变。<code>Transition</code>由<code>TransitionManger</code>管理。一般可以使用<code>beginDelayedTransition</code>开始一个转场动画，默认的转场动画为<code>AutoTransition</code>:</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(transitionGroup);</div><div class="line"></div><div class="line">textView.setVisibility(visible ? View.VISIBLE : View.GONE);</div></pre></td></tr></table></figure>
</p>
<p>效果如下:</p>
<p>
<img src="./autotransition.gif" alt="autotransition" width="200">

</p>
<h6 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h6><blockquote>
<p>继承自TransitionSet</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        setOrdering(ORDERING_SEQUENTIAL);</div><div class="line">        addTransition(<span class="keyword">new</span> Fade(Fade.OUT)).</div><div class="line">                addTransition(<span class="keyword">new</span> ChangeBounds()).</div><div class="line">                addTransition(<span class="keyword">new</span> Fade(Fade.IN));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>顺序播放渐出，区域变化，渐入动画</li>
</ul>
<h5 id="TransitionSet"><a href="#TransitionSet" class="headerlink" title="TransitionSet"></a>TransitionSet</h5><blockquote>
<p>继承自Transition</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isValidTarget(transitionValues.view)) &#123;</div><div class="line">            <span class="keyword">for</span> (Transition childTransition : mTransitions) &#123;</div><div class="line">                <span class="keyword">if</span> (childTransition.isValidTarget(transitionValues.view)) &#123;</div><div class="line">                    childTransition.captureStartValues(transitionValues);</div><div class="line">                    transitionValues.targetedTransitions.add(childTransition);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">captureEndValues</span><span class="params">(TransitionValues transitionValues)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isValidTarget(transitionValues.view)) &#123;</div><div class="line">            <span class="keyword">for</span> (Transition childTransition : mTransitions) &#123;</div><div class="line">                <span class="keyword">if</span> (childTransition.isValidTarget(transitionValues.view)) &#123;</div><div class="line">                    childTransition.captureEndValues(transitionValues);</div><div class="line">                    transitionValues.targetedTransitions.add(childTransition);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>调用各个<code>Transition</code>的方法</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createAnimators</span><span class="params">(ViewGroup sceneRoot, TransitionValuesMaps startValues,</span></span></div><div class="line">            TransitionValuesMaps endValues, ArrayList&lt;TransitionValues&gt; startValuesList,</div><div class="line">            ArrayList&lt;TransitionValues&gt; endValuesList) &#123;</div><div class="line">        <span class="keyword">long</span> startDelay = getStartDelay();</div><div class="line">        <span class="keyword">int</span> numTransitions = mTransitions.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numTransitions; i++) &#123;</div><div class="line">            Transition childTransition = mTransitions.get(i);</div><div class="line">            <span class="comment">// We only set the start delay on the first transition if we are playing</span></div><div class="line">            <span class="comment">// the transitions sequentially.</span></div><div class="line">            <span class="keyword">if</span> (startDelay &gt; <span class="number">0</span> &amp;&amp; (mPlayTogether || i == <span class="number">0</span>)) &#123;</div><div class="line">                <span class="keyword">long</span> childStartDelay = childTransition.getStartDelay();</div><div class="line">                <span class="keyword">if</span> (childStartDelay &gt; <span class="number">0</span>) &#123;</div><div class="line">                    childTransition.setStartDelay(startDelay + childStartDelay);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    childTransition.setStartDelay(startDelay);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            childTransition.createAnimators(sceneRoot, startValues, endValues, startValuesList,</div><div class="line">                    endValuesList);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>使用各自<code>Transition</code>创建动画。为第一个转场动画设置必要的延时</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runAnimators</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mTransitions.isEmpty()) &#123;</div><div class="line">            start();</div><div class="line">            end();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        setupStartEndListeners();</div><div class="line">        <span class="keyword">int</span> numTransitions = mTransitions.size();</div><div class="line">        <span class="keyword">if</span> (!mPlayTogether) &#123;</div><div class="line">        <span class="comment">//串行播放动画</span></div><div class="line">            <span class="comment">// Setup sequence with listeners</span></div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> Need to add listeners in such a way that we can remove them later if canceled</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; numTransitions; ++i) &#123;</div><div class="line">                Transition previousTransition = mTransitions.get(i - <span class="number">1</span>);</div><div class="line">                <span class="keyword">final</span> Transition nextTransition = mTransitions.get(i);</div><div class="line">                previousTransition.addListener(<span class="keyword">new</span> TransitionListenerAdapter() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTransitionEnd</span><span class="params">(Transition transition)</span> </span>&#123;</div><div class="line">                        nextTransition.runAnimators();</div><div class="line">                        transition.removeListener(<span class="keyword">this</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            Transition firstTransition = mTransitions.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">if</span> (firstTransition != <span class="keyword">null</span>) &#123;</div><div class="line">                firstTransition.runAnimators();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//并行播放动画</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numTransitions; ++i) &#123;</div><div class="line">                mTransitions.get(i).runAnimators();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>动画开始，由各个<code>Transition</code>开始动画，在这里会区分动画是串行播放，还是并行播放。</li>
</ul>
<h5 id="ChangeText-自定义transition"><a href="#ChangeText-自定义transition" class="headerlink" title="ChangeText(自定义transition)"></a>ChangeText(自定义transition)</h5><p>
<img src="./changetext.gif" alt="autotransition" width="200">

</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">textView.animate().alpha(<span class="number">0f</span>).setListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                       textView.setText(mSecondText ? TEXT_2 : TEXT_1);</div><div class="line">                       textView.animate().setListener(<span class="keyword">null</span>);</div><div class="line">                       textView.animate().alpha(<span class="number">1f</span>).start();</div><div class="line">                   &#125;</div><div class="line">               &#125;).start();</div></pre></td></tr></table></figure>
</p>
<ul>
<li>上述代码也能实现相同的功能，<code>ChangeText</code>只是对其进行了进一步的封装。这里不分析其源码</li>
</ul>
<h5 id="ChangeBound"><a href="#ChangeBound" class="headerlink" title="ChangeBound"></a>ChangeBound</h5><p>
<img src="./changebound.gif" alt="autotransition" width="200">

</p>
<h6 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h6><blockquote>
<p>继承<code>Transition</code></p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">captureValues</span><span class="params">(TransitionValues values)</span> </span>&#123;</div><div class="line">        View view = values.view;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (view.isLaidOut() || view.getWidth() != <span class="number">0</span> || view.getHeight() != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//view已经布局完毕，保存当前view边界状态</span></div><div class="line">            values.values.put(PROPNAME_BOUNDS, <span class="keyword">new</span> Rect(view.getLeft(), view.getTop(),</div><div class="line">                    view.getRight(), view.getBottom()));</div><div class="line">            values.values.put(PROPNAME_PARENT, values.view.getParent());</div><div class="line">            <span class="keyword">if</span> (mReparent) &#123;</div><div class="line">            <span class="comment">//如果动画scene的parent一样，记录当前屏幕位置</span></div><div class="line">                values.view.getLocationInWindow(tempLocation);</div><div class="line">                values.values.put(PROPNAME_WINDOW_X, tempLocation[<span class="number">0</span>]);</div><div class="line">                values.values.put(PROPNAME_WINDOW_Y, tempLocation[<span class="number">1</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mResizeClip) &#123;</div><div class="line">                values.values.put(PROPNAME_CLIP, view.getClipBounds());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>保存当前<code>View</code>的边界状态</li>
</ul>
<blockquote>
<p>创建动画，代码很长，核心代码</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (numChanges &gt; <span class="number">0</span>) &#123;</div><div class="line">                Animator anim;</div><div class="line">                <span class="keyword">if</span> (!mResizeClip) &#123;</div><div class="line">                    view.setLeftTopRightBottom(startLeft, startTop, startRight, startBottom);</div><div class="line">                    <span class="keyword">if</span> (numChanges == <span class="number">2</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (startWidth == endWidth &amp;&amp; startHeight == endHeight) &#123;</div><div class="line">                            Path topLeftPath = getPathMotion().getPath(startLeft, startTop, endLeft,</div><div class="line">                                    endTop);</div><div class="line">                            anim = ObjectAnimator.ofObject(view, POSITION_PROPERTY, <span class="keyword">null</span>,</div><div class="line">                                    topLeftPath);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">final</span> ViewBounds viewBounds = <span class="keyword">new</span> ViewBounds(view);</div><div class="line">                            Path topLeftPath = getPathMotion().getPath(startLeft, startTop,</div><div class="line">                                    endLeft, endTop);</div><div class="line">                            ObjectAnimator topLeftAnimator = ObjectAnimator</div><div class="line">                                    .ofObject(viewBounds, TOP_LEFT_PROPERTY, <span class="keyword">null</span>, topLeftPath);</div><div class="line"></div><div class="line">                            Path bottomRightPath = getPathMotion().getPath(startRight, startBottom,</div><div class="line">                                    endRight, endBottom);</div><div class="line">                            ObjectAnimator bottomRightAnimator = ObjectAnimator.ofObject(viewBounds,</div><div class="line">                                    BOTTOM_RIGHT_PROPERTY, <span class="keyword">null</span>, bottomRightPath);</div><div class="line">                            AnimatorSet set = <span class="keyword">new</span> AnimatorSet();</div><div class="line">                            set.playTogether(topLeftAnimator, bottomRightAnimator);</div><div class="line">                            anim = set;</div><div class="line">                            set.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                                <span class="comment">// We need a strong reference to viewBounds until the</span></div><div class="line">                                <span class="comment">// animator ends.</span></div><div class="line">                                <span class="keyword">private</span> ViewBounds mViewBounds = viewBounds;</div><div class="line">                            &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (startLeft != endLeft || startTop != endTop) &#123;</div><div class="line">                        Path topLeftPath = getPathMotion().getPath(startLeft, startTop,</div><div class="line">                                endLeft, endTop);</div><div class="line">                        anim = ObjectAnimator.ofObject(view, TOP_LEFT_ONLY_PROPERTY, <span class="keyword">null</span>,</div><div class="line">                                topLeftPath);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        Path bottomRight = getPathMotion().getPath(startRight, startBottom,</div><div class="line">                                endRight, endBottom);</div><div class="line">                        anim = ObjectAnimator.ofObject(view, BOTTOM_RIGHT_ONLY_PROPERTY, <span class="keyword">null</span>,</div><div class="line">                                bottomRight);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">int</span> maxWidth = Math.max(startWidth, endWidth);</div><div class="line">                    <span class="keyword">int</span> maxHeight = Math.max(startHeight, endHeight);</div><div class="line"></div><div class="line">                    view.setLeftTopRightBottom(startLeft, startTop, startLeft + maxWidth,</div><div class="line">                            startTop + maxHeight);</div><div class="line"></div><div class="line">                    ObjectAnimator positionAnimator = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">if</span> (startLeft != endLeft || startTop != endTop) &#123;</div><div class="line">                        Path topLeftPath = getPathMotion().getPath(startLeft, startTop, endLeft,</div><div class="line">                                endTop);</div><div class="line">                        positionAnimator = ObjectAnimator.ofObject(view, POSITION_PROPERTY, <span class="keyword">null</span>,</div><div class="line">                                topLeftPath);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">final</span> Rect finalClip = endClip;</div><div class="line">                    <span class="keyword">if</span> (startClip == <span class="keyword">null</span>) &#123;</div><div class="line">                        startClip = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, startWidth, startHeight);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (endClip == <span class="keyword">null</span>) &#123;</div><div class="line">                        endClip = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, endWidth, endHeight);</div><div class="line">                    &#125;</div><div class="line">                    ObjectAnimator clipAnimator = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">if</span> (!startClip.equals(endClip)) &#123;</div><div class="line">                        view.setClipBounds(startClip);</div><div class="line">                        clipAnimator = ObjectAnimator.ofObject(view, <span class="string">"clipBounds"</span>, sRectEvaluator,</div><div class="line">                                startClip, endClip);</div><div class="line">                        clipAnimator.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                            <span class="keyword">private</span> <span class="keyword">boolean</span> mIsCanceled;</div><div class="line"></div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                                mIsCanceled = <span class="keyword">true</span>;</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                                <span class="keyword">if</span> (!mIsCanceled) &#123;</div><div class="line">                                    view.setClipBounds(finalClip);</div><div class="line">                                    view.setLeftTopRightBottom(endLeft, endTop, endRight,</div><div class="line">                                            endBottom);</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                    anim = TransitionUtils.mergeAnimators(positionAnimator,</div><div class="line">                            clipAnimator);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (view.getParent() <span class="keyword">instanceof</span> ViewGroup) &#123;</div><div class="line">                    <span class="keyword">final</span> ViewGroup parent = (ViewGroup) view.getParent();</div><div class="line">                    parent.suppressLayout(<span class="keyword">true</span>);</div><div class="line">                    TransitionListener transitionListener = <span class="keyword">new</span> TransitionListenerAdapter() &#123;</div><div class="line">                        <span class="keyword">boolean</span> mCanceled = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTransitionCancel</span><span class="params">(Transition transition)</span> </span>&#123;</div><div class="line">                            parent.suppressLayout(<span class="keyword">false</span>);</div><div class="line">                            mCanceled = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTransitionEnd</span><span class="params">(Transition transition)</span> </span>&#123;</div><div class="line">                            <span class="keyword">if</span> (!mCanceled) &#123;</div><div class="line">                                parent.suppressLayout(<span class="keyword">false</span>);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTransitionPause</span><span class="params">(Transition transition)</span> </span>&#123;</div><div class="line">                            parent.suppressLayout(<span class="keyword">false</span>);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTransitionResume</span><span class="params">(Transition transition)</span> </span>&#123;</div><div class="line">                            parent.suppressLayout(<span class="keyword">true</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;;</div><div class="line">                    addListener(transitionListener);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> anim;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sceneRoot.getLocationInWindow(tempLocation);</div><div class="line">            <span class="keyword">int</span> startX = (Integer) startValues.values.get(PROPNAME_WINDOW_X) - tempLocation[<span class="number">0</span>];</div><div class="line">            <span class="keyword">int</span> startY = (Integer) startValues.values.get(PROPNAME_WINDOW_Y) - tempLocation[<span class="number">1</span>];</div><div class="line">            <span class="keyword">int</span> endX = (Integer) endValues.values.get(PROPNAME_WINDOW_X) - tempLocation[<span class="number">0</span>];</div><div class="line">            <span class="keyword">int</span> endY = (Integer) endValues.values.get(PROPNAME_WINDOW_Y) - tempLocation[<span class="number">1</span>];</div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> also handle size changes: check bounds and animate size changes</span></div><div class="line">            <span class="keyword">if</span> (startX != endX || startY != endY) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> width = view.getWidth();</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> height = view.getHeight();</div><div class="line">                Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</div><div class="line">                Canvas canvas = <span class="keyword">new</span> Canvas(bitmap);</div><div class="line">                view.draw(canvas);</div><div class="line">                <span class="keyword">final</span> BitmapDrawable drawable = <span class="keyword">new</span> BitmapDrawable(bitmap);</div><div class="line">                drawable.setBounds(startX, startY, startX + width, startY + height);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> transitionAlpha = view.getTransitionAlpha();</div><div class="line">                view.setTransitionAlpha(<span class="number">0</span>);</div><div class="line">                sceneRoot.getOverlay().add(drawable);</div><div class="line">                Path topLeftPath = getPathMotion().getPath(startX, startY, endX, endY);</div><div class="line">                PropertyValuesHolder origin = PropertyValuesHolder.ofObject(</div><div class="line">                        DRAWABLE_ORIGIN_PROPERTY, <span class="keyword">null</span>, topLeftPath);</div><div class="line">                ObjectAnimator anim = ObjectAnimator.ofPropertyValuesHolder(drawable, origin);</div><div class="line">                anim.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                        sceneRoot.getOverlay().remove(drawable);</div><div class="line">                        view.setTransitionAlpha(transitionAlpha);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">                <span class="keyword">return</span> anim;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>主要功能是判断<code>View</code>的边界有没有发生改变，如果发生改变，使用对应的位置变化动画，主要包括<code>topLeft, bottomRight, position</code>。如果没有发生改变，则在<code>View</code>上绘制<code>Overlay</code>并对其做<code>path</code>动画。</li>
</ul>
<p>设置<code>pathMotion</code></p>
<blockquote>
<p>其是一个抽象类，用于描述<code>Transition</code>的<code>Path</code>信息</p>
</blockquote>
<p>
<img src="./changebound_pathmotion.gif" alt="autotransition" width="200">

</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PathMotion</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathMotion</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathMotion</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Provide a Path to interpolate between two points &lt;code&gt;(startX, startY)&lt;/code&gt; and</div><div class="line">     * &lt;code&gt;(endX, endY)&lt;/code&gt;. This allows controlled curved motion along two dimensions.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> startX The x coordinate of the starting point.</div><div class="line">     * <span class="doctag">@param</span> startY The y coordinate of the starting point.</div><div class="line">     * <span class="doctag">@param</span> endX   The x coordinate of the ending point.</div><div class="line">     * <span class="doctag">@param</span> endY   The y coordinate of the ending point.</div><div class="line">     * <span class="doctag">@return</span> A Path along which the points should be interpolated. The returned Path</div><div class="line">     * must start at point &lt;code&gt;(startX, startY)&lt;/code&gt;, typically using</div><div class="line">     * &#123;<span class="doctag">@link</span> android.graphics.Path#moveTo(float, float)&#125; and end at &lt;code&gt;(endX, endY)&lt;/code&gt;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Path <span class="title">getPath</span><span class="params">(<span class="keyword">float</span> startX, <span class="keyword">float</span> startY, <span class="keyword">float</span> endX, <span class="keyword">float</span> endY)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>实现<code>getPath</code>以便提供两点之间的变化频率</li>
</ul>
<h5 id="Slide"><a href="#Slide" class="headerlink" title="Slide"></a>Slide</h5><blockquote>
<p>继承自<code>Visibility</code></p>
</blockquote>
<p>
<img src="./slide.gif" alt="autotransition" width="200">

</p>
<h6 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h6><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">captureValues</span><span class="params">(TransitionValues transitionValues)</span> </span>&#123;</div><div class="line">        View view = transitionValues.view;</div><div class="line">        <span class="keyword">int</span>[] position = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">        view.getLocationOnScreen(position);</div><div class="line">        transitionValues.values.put(PROPNAME_SCREEN_POSITION, position);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>保存当前<code>View</code>位置</li>
</ul>
<blockquote>
<p>其<code>createAnimator</code>在父类<code>Visibility</code>中被重写，当中调用<code>onAppear</code>和<code>onDisappear</code>，这两个方法分别有各自的重载方法，由子类提供具体的实现，默认无动画</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span></div><div class="line">            TransitionValues startValues, TransitionValues endValues) &#123;</div><div class="line">        <span class="keyword">if</span> (endValues == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span>[] position = (<span class="keyword">int</span>[]) endValues.values.get(PROPNAME_SCREEN_POSITION);</div><div class="line">        <span class="keyword">float</span> endX = view.getTranslationX();</div><div class="line">        <span class="keyword">float</span> endY = view.getTranslationY();</div><div class="line">        <span class="keyword">float</span> startX = mSlideCalculator.getGoneX(sceneRoot, view);</div><div class="line">        <span class="keyword">float</span> startY = mSlideCalculator.getGoneY(sceneRoot, view);</div><div class="line">        <span class="keyword">return</span> TranslationAnimationCreator</div><div class="line">                .createAnimation(view, endValues, position[<span class="number">0</span>], position[<span class="number">1</span>],</div><div class="line">                        startX, startY, endX, endY, sDecelerate, <span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>使用<code>CalculateSlide</code>接口的实现计算<code>View</code>离开或者进入场景时的位置，最后由<code>TranslationAnimationCreator</code>创建动画</li>
</ul>
<h5 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h5><p>
<img src="./scale.gif" alt="autotransition" width="200">

</p>
<p>设置<code>alpha</code></p>
<p>
<img src="./scale_alpha.gif" alt="autotransition" width="200">

</p>
<h6 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h6><p>private Animator createAnimation(final View view, float startScale, float endScale, TransitionValues values) {<br>        final float initialScaleX = view.getScaleX();<br>        final float initialScaleY = view.getScaleY();<br>        float startScaleX = initialScaleX <em> startScale;<br>        float endScaleX = initialScaleX </em> endScale;<br>        float startScaleY = initialScaleY <em> startScale;<br>        float endScaleY = initialScaleY </em> endScale;</p>
<pre><code>if (values != null) {
    Float savedScaleX = (Float) values.values.get(PROPNAME_SCALE_X);
    Float savedScaleY = (Float) values.values.get(PROPNAME_SCALE_Y);
    // if saved value is not equal initial value it means that previous
    // transition was interrupted and in the onTransitionEnd
    // we&apos;ve applied endScale. we should apply proper value to
    // continue animation from the interrupted state
    if (savedScaleX != null &amp;&amp; savedScaleX != initialScaleX) {
        startScaleX = savedScaleX;
    }
    if (savedScaleY != null &amp;&amp; savedScaleY != initialScaleY) {
        startScaleY = savedScaleY;
    }
}

view.setScaleX(startScaleX);
view.setScaleY(startScaleY);

Animator animator = TransitionUtils.mergeAnimators(
        ObjectAnimator.ofFloat(view, View.SCALE_X, startScaleX, endScaleX),
        ObjectAnimator.ofFloat(view, View.SCALE_Y, startScaleY, endScaleY));
addListener(new TransitionListenerAdapter() {
    @Override
    public void onTransitionEnd(Transition transition) {
        view.setScaleX(initialScaleX);
        view.setScaleY(initialScaleY);
    }
});
return animator;

</code></pre><p>}</p>
<ul>
<li>合并<code>x, y</code>缩放的动画，合并是采用<code>TransitionSet</code>，如下</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transition <span class="title">mergeTransitions</span><span class="params">(Transition... transitions)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> nonNullIndex = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transitions.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (transitions[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                count++;</div><div class="line">                nonNullIndex = i;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> transitions[nonNullIndex];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        TransitionSet transitionSet = <span class="keyword">new</span> TransitionSet();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; transitions.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (transitions[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                transitionSet.addTransition(transitions[i]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> transitionSet;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<h5 id="Explode"><a href="#Explode" class="headerlink" title="Explode"></a>Explode</h5><blockquote>
<p>继承自Visibility</p>
</blockquote>
<p>
<img src="./explode.gif" alt="autotransition" width="200">

</p>
<h6 id="源码分析-4"><a href="#源码分析-4" class="headerlink" title="源码分析"></a>源码分析</h6><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span></div><div class="line">            TransitionValues startValues, TransitionValues endValues) &#123;</div><div class="line">        <span class="keyword">if</span> (endValues == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        Rect bounds = (Rect) endValues.values.get(PROPNAME_SCREEN_BOUNDS);</div><div class="line">        <span class="keyword">float</span> endX = view.getTranslationX();</div><div class="line">        <span class="keyword">float</span> endY = view.getTranslationY();</div><div class="line">        calculateOut(sceneRoot, bounds, mTempLoc);</div><div class="line">        <span class="keyword">float</span> startX = endX + mTempLoc[<span class="number">0</span>];</div><div class="line">        <span class="keyword">float</span> startY = endY + mTempLoc[<span class="number">1</span>];</div><div class="line"></div><div class="line">        <span class="keyword">return</span> TranslationAnimationCreator.createAnimation(view, endValues, bounds.left, bounds.top,</div><div class="line">                startX, startY, endX, endY, sDecelerate, <span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>通过<code>calculateOut</code>计算扩散的距离，使用<code>TranslationAnimationCreator</code>创建动画</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">calculateOut</span><span class="params">(View sceneRoot, Rect bounds, <span class="keyword">int</span>[] outVector)</span> </span>&#123;</div><div class="line">        sceneRoot.getLocationOnScreen(mTempLoc);</div><div class="line">        <span class="keyword">int</span> sceneRootX = mTempLoc[<span class="number">0</span>];</div><div class="line">        <span class="keyword">int</span> sceneRootY = mTempLoc[<span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> focalX;</div><div class="line">        <span class="keyword">int</span> focalY;</div><div class="line"></div><div class="line">        Rect epicenter = getEpicenter();</div><div class="line">        <span class="keyword">if</span> (epicenter == <span class="keyword">null</span>) &#123;</div><div class="line">            focalX = sceneRootX + (sceneRoot.getWidth() / <span class="number">2</span>)</div><div class="line">                    + Math.round(sceneRoot.getTranslationX());</div><div class="line">            focalY = sceneRootY + (sceneRoot.getHeight() / <span class="number">2</span>)</div><div class="line">                    + Math.round(sceneRoot.getTranslationY());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            focalX = epicenter.centerX();</div><div class="line">            focalY = epicenter.centerY();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> centerX = bounds.centerX();</div><div class="line">        <span class="keyword">int</span> centerY = bounds.centerY();</div><div class="line">        <span class="keyword">double</span> xVector = centerX - focalX;</div><div class="line">        <span class="keyword">double</span> yVector = centerY - focalY;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (xVector == <span class="number">0</span> &amp;&amp; yVector == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Random direction when View is centered on focal View.</span></div><div class="line">            xVector = (Math.random() * <span class="number">2</span>) - <span class="number">1</span>;</div><div class="line">            yVector = (Math.random() * <span class="number">2</span>) - <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">double</span> vectorSize = Math.hypot(xVector, yVector);</div><div class="line">        xVector /= vectorSize;</div><div class="line">        yVector /= vectorSize;</div><div class="line"></div><div class="line">        <span class="keyword">double</span> maxDistance =</div><div class="line">                calculateMaxDistance(sceneRoot, focalX - sceneRootX, focalY - sceneRootY);</div><div class="line"></div><div class="line">        outVector[<span class="number">0</span>] = (<span class="keyword">int</span>) Math.round(maxDistance * xVector);</div><div class="line">        outVector[<span class="number">1</span>] = (<span class="keyword">int</span>) Math.round(maxDistance * yVector);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>计算场景动画的偏移量，如果为0，随机算出偏移量，算出x, y偏移量的平方根，求出最大距离<h5 id="TransitionName"><a href="#TransitionName" class="headerlink" title="TransitionName"></a>TransitionName</h5></li>
</ul>
<blockquote>
<p>设置要做动画的标识，在之后的动画中会对这些标识的<code>View</code>做动画</p>
</blockquote>
<p>
<img src="./transition_name.gif" alt="autotransition" width="200">

</p>
<h5 id="ImageTransform"><a href="#ImageTransform" class="headerlink" title="ImageTransform"></a>ImageTransform</h5><p>
<img src="./ImageTransform.gif" alt="autotransition" width="200">

</p>
<h5 id="ReColor"><a href="#ReColor" class="headerlink" title="ReColor"></a>ReColor</h5><p>
<img src="./recolor.gif" alt="autotransition" width="200">

</p>
<h5 id="Rotate"><a href="#Rotate" class="headerlink" title="Rotate"></a>Rotate</h5><blockquote>
<p>继承自Transition的旋转动画</p>
</blockquote>
<p>
<img src="./rotate.gif" alt="autotransition" width="200">

</p>
<h6 id="源码分析-5"><a href="#源码分析-5" class="headerlink" title="源码分析"></a>源码分析</h6><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Animator <span class="title">createAnimator</span><span class="params">(ViewGroup sceneRoot, TransitionValues startValues,</span></span></div><div class="line">            TransitionValues endValues) &#123;</div><div class="line">        <span class="keyword">if</span> (startValues == <span class="keyword">null</span> || endValues == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> View view = endValues.view;</div><div class="line">        <span class="keyword">float</span> startRotation = (Float) startValues.values.get(PROPNAME_ROTATION);</div><div class="line">        <span class="keyword">float</span> endRotation = (Float) endValues.values.get(PROPNAME_ROTATION);</div><div class="line">        <span class="keyword">if</span> (startRotation != endRotation) &#123;</div><div class="line">            view.setRotation(startRotation);</div><div class="line">            <span class="keyword">return</span> ObjectAnimator.ofFloat(view, View.ROTATION,</div><div class="line">                    startRotation, endRotation);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>创建旋转动画</li>
</ul>
<h5 id="Progress"><a href="#Progress" class="headerlink" title="Progress"></a>Progress</h5><p>
<img src="./progress.gif" alt="autotransition" width="200">

</p>
<h5 id="Change-Scene"><a href="#Change-Scene" class="headerlink" title="Change Scene"></a>Change Scene</h5><p>
<img src="./change_scene.gif" alt="autotransition" width="200">

</p>
<h6 id="源码分析-6"><a href="#源码分析-6" class="headerlink" title="源码分析"></a>源码分析</h6><p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        setOrdering(ORDERING_SEQUENTIAL);</div><div class="line">        addTransition(<span class="keyword">new</span> Fade(Fade.OUT)).</div><div class="line">                addTransition(<span class="keyword">new</span> ChangeBounds()).</div><div class="line">                addTransition(<span class="keyword">new</span> Fade(Fade.IN));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>先淡出效果(<code>Fade</code>)，改变区域(<code>ChangeBound</code>)，淡入效果(<code>Fade</code>)</li>
</ul>
<h5 id="Fade"><a href="#Fade" class="headerlink" title="Fade"></a>Fade</h5><p>渐变转场动画，继承自<code>Visibility</code></p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.captureStartValues(transitionValues);</div><div class="line">        transitionValues.values.put(PROPNAME_TRANSITION_ALPHA,</div><div class="line">                transitionValues.view.getTransitionAlpha());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>捕获初始场景的<code>alpha</code>值</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Animator <span class="title">createAnimation</span><span class="params">(<span class="keyword">final</span> View view, <span class="keyword">float</span> startAlpha, <span class="keyword">final</span> <span class="keyword">float</span> endAlpha)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (startAlpha == endAlpha) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        view.setTransitionAlpha(startAlpha);</div><div class="line">        <span class="comment">//创建渐变属性动画</span></div><div class="line">        <span class="keyword">final</span> ObjectAnimator anim = ObjectAnimator.ofFloat(view, <span class="string">"transitionAlpha"</span>, endAlpha);</div><div class="line">        <span class="keyword">if</span> (DBG) &#123;</div><div class="line">            Log.d(LOG_TAG, <span class="string">"Created animator "</span> + anim);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> FadeAnimatorListener listener = <span class="keyword">new</span> FadeAnimatorListener(view);</div><div class="line">        anim.addListener(listener);</div><div class="line">        anim.addPauseListener(listener);</div><div class="line">        addListener(<span class="keyword">new</span> TransitionListenerAdapter() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTransitionEnd</span><span class="params">(Transition transition)</span> </span>&#123;</div><div class="line">                view.setTransitionAlpha(<span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> anim;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>创建渐变属性动画，其会由<code>onAppear()</code>和<code>onDisAppear</code>调用</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span></div><div class="line">            TransitionValues startValues,</div><div class="line">            TransitionValues endValues) &#123;</div><div class="line">        <span class="keyword">if</span> (DBG) &#123;</div><div class="line">            View startView = (startValues != <span class="keyword">null</span>) ? startValues.view : <span class="keyword">null</span>;</div><div class="line">            Log.d(LOG_TAG, <span class="string">"Fade.onAppear: startView, startVis, endView, endVis = "</span> +</div><div class="line">                    startView + <span class="string">", "</span> + view);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//创建渐入动画</span></div><div class="line">        <span class="keyword">return</span> createAnimation(view, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">onDisappear</span><span class="params">(ViewGroup sceneRoot, <span class="keyword">final</span> View view, TransitionValues startValues,</span></span></div><div class="line">            TransitionValues endValues) &#123;</div><div class="line">            <span class="comment">//创建渐出动画</span></div><div class="line">        <span class="keyword">return</span> createAnimation(view, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li>这两个方法由<code>Visibility</code>的<code>createAnimator</code>调用</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Animator <span class="title">createAnimator</span><span class="params">(ViewGroup sceneRoot, TransitionValues startValues,</span></span></div><div class="line">            TransitionValues endValues) &#123;</div><div class="line">        VisibilityInfo visInfo = getVisibilityChangeInfo(startValues, endValues);</div><div class="line">        <span class="keyword">if</span> (visInfo.visibilityChange</div><div class="line">                &amp;&amp; (visInfo.startParent != <span class="keyword">null</span> || visInfo.endParent != <span class="keyword">null</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (visInfo.fadeIn) &#123;</div><div class="line">                <span class="keyword">return</span> onAppear(sceneRoot, startValues, visInfo.startVisibility,</div><div class="line">                        endValues, visInfo.endVisibility);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> onDisappear(sceneRoot, startValues, visInfo.startVisibility,</div><div class="line">                        endValues, visInfo.endVisibility</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</p>
<ul>
<li><code>View</code>显示或隐藏时会创建对应的渐变动画。<code>Transition</code>的<code>playTransition</code>会调用<code>createAnimators</code>，其内部会调用<code>createAnimator</code>。</li>
<li>整体流程是启动<code>Transition</code>-&gt;创建动画(<code>createAnimators</code>)-&gt;创建单个动画(<code>createAnimator</code>由<code>Transition</code>子类实现,默认空)-&gt;<code>Visibility</code>的<code>onAppear()</code>/<code>onDisappear</code>-&gt;子类<code>createAnimator</code></li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结:"></a>总结:</h3><blockquote>
<p><code>Transition</code>动画其实是对属性动画的一种高级封装。其主要流程是<code>TransitionManager</code>调用<code>beginDelayedTransition</code>,内部监听了<code>OnPreDrawListener</code>，其在<code>onPreDraw</code>调用<code>captureView</code>用于获取当前<code>View</code>的状态,调用<code>playTransition</code>开始转场动画。之后创建动画<code>createAnimator</code>。这其中<code>captureView</code>都是由子类实现，而<code>createAnimator</code>则可以由子类选择重写。最终动画的开始还有调用<code>animator.start()</code></p>
</blockquote>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/03/Picasso解析/" rel="next" title="Picasso解析">
                <i class="fa fa-chevron-left"></i> Picasso解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/31/2016总结/" rel="prev" title="2016总结">
                2016总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/upload_file/tmp.jpg"
               alt="Binea" />
          <p class="site-author-name" itemprop="name">Binea</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Animator"><span class="nav-number">1.</span> <span class="nav-text">Animator</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ValueAnimator"><span class="nav-number">1.1.</span> <span class="nav-text">ValueAnimator</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#AnimationHandler"><span class="nav-number">1.1.1.</span> <span class="nav-text">AnimationHandler</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插值器"><span class="nav-number">1.2.</span> <span class="nav-text">插值器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LinearInterpolator-线性插值器"><span class="nav-number">1.2.1.</span> <span class="nav-text">LinearInterpolator(线性插值器)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AccelerateDecelerateInterpolator-加减速插值器"><span class="nav-number">1.2.2.</span> <span class="nav-text">AccelerateDecelerateInterpolator(加减速插值器)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AccelerateInterpolator-加速插值器"><span class="nav-number">1.2.3.</span> <span class="nav-text">AccelerateInterpolator(加速插值器)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AnticipateInterpolator"><span class="nav-number">1.2.4.</span> <span class="nav-text">AnticipateInterpolator</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AnticipateOvershootInterpolator"><span class="nav-number">1.2.5.</span> <span class="nav-text">AnticipateOvershootInterpolator</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TypeEvaluator-估值器"><span class="nav-number">1.3.</span> <span class="nav-text">TypeEvaluator(估值器)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ArgbEvaluator"><span class="nav-number">1.3.1.</span> <span class="nav-text">ArgbEvaluator</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#IntEvaluator"><span class="nav-number">1.3.2.</span> <span class="nav-text">IntEvaluator</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Choreograhper"><span class="nav-number">1.4.</span> <span class="nav-text">Choreograhper</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#流程图"><span class="nav-number">1.4.1.</span> <span class="nav-text">流程图</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ObjectAnimator"><span class="nav-number">1.5.</span> <span class="nav-text">ObjectAnimator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PropertyValuesHolder-处理setter-getter的寻找"><span class="nav-number">1.6.</span> <span class="nav-text">PropertyValuesHolder 处理setter, getter的寻找</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KeyFrame"><span class="nav-number">1.7.</span> <span class="nav-text">KeyFrame</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AnimatorSet"><span class="nav-number">1.8.</span> <span class="nav-text">AnimatorSet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ViewPropertyAnimator"><span class="nav-number">1.9.</span> <span class="nav-text">ViewPropertyAnimator</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transition"><span class="nav-number">2.</span> <span class="nav-text">Transition</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#结构图"><span class="nav-number">2.1.</span> <span class="nav-text">结构图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#开始转场动画"><span class="nav-number">2.1.1.</span> <span class="nav-text">开始转场动画</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AutoTransition"><span class="nav-number">2.1.2.</span> <span class="nav-text">AutoTransition</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#源码分析"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TransitionSet"><span class="nav-number">2.1.3.</span> <span class="nav-text">TransitionSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ChangeText-自定义transition"><span class="nav-number">2.1.4.</span> <span class="nav-text">ChangeText(自定义transition)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ChangeBound"><span class="nav-number">2.1.5.</span> <span class="nav-text">ChangeBound</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#源码分析-1"><span class="nav-number">2.1.5.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Slide"><span class="nav-number">2.1.6.</span> <span class="nav-text">Slide</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#源码分析-2"><span class="nav-number">2.1.6.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Scale"><span class="nav-number">2.1.7.</span> <span class="nav-text">Scale</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#源码分析-3"><span class="nav-number">2.1.7.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Explode"><span class="nav-number">2.1.8.</span> <span class="nav-text">Explode</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#源码分析-4"><span class="nav-number">2.1.8.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TransitionName"><span class="nav-number">2.1.9.</span> <span class="nav-text">TransitionName</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ImageTransform"><span class="nav-number">2.1.10.</span> <span class="nav-text">ImageTransform</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ReColor"><span class="nav-number">2.1.11.</span> <span class="nav-text">ReColor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Rotate"><span class="nav-number">2.1.12.</span> <span class="nav-text">Rotate</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#源码分析-5"><span class="nav-number">2.1.12.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Progress"><span class="nav-number">2.1.13.</span> <span class="nav-text">Progress</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Change-Scene"><span class="nav-number">2.1.14.</span> <span class="nav-text">Change Scene</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#源码分析-6"><span class="nav-number">2.1.14.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Fade"><span class="nav-number">2.1.15.</span> <span class="nav-text">Fade</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结:</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Binea</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  

  


</body>
</html>
