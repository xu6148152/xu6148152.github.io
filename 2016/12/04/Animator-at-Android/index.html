<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xu6148152.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Animator其是Android3.0之后加入的作用于对象属性的动画,Animator是所有属性动画的基类，其下有ValueAnimator,AnimatorSet,由ValueAnimator再拓展出ObjectAnimator,TimeAnimator 其整体结构图   ValueAnimator为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的Handler里面以确保所有">
<meta property="og:type" content="article">
<meta property="og:title" content="Animator at Android">
<meta property="og:url" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="Animator其是Android3.0之后加入的作用于对象属性的动画,Animator是所有属性动画的基类，其下有ValueAnimator,AnimatorSet,由ValueAnimator再拓展出ObjectAnimator,TimeAnimator 其整体结构图   ValueAnimator为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的Handler里面以确保所有">
<meta property="og:locale">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/animator.png">
<meta property="og:image" content="http://xu6148152.github.io/ValueAnimator.png">
<meta property="og:image" content="http://xu6148152.github.io/interpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/LinearInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/AccelerateDecelerateInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/AccelerateInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/AnticipateInterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/AnticipateOvershootinterpolator.png">
<meta property="og:image" content="http://xu6148152.github.io/TypeEvaluator.png">
<meta property="og:image" content="http://xu6148152.github.io/transition.png">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/autotransition.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/changetext.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/changebound.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/changebound_pathmotion.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/slide.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/scale.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/scale_alpha.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/explode.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/transition_name.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/ImageTransform.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/recolor.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/rotate.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/progress.gif">
<meta property="og:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/change_scene.gif">
<meta property="article:published_time" content="2016-12-04T13:17:02.000Z">
<meta property="article:modified_time" content="2022-06-08T10:14:04.884Z">
<meta property="article:author" content="Binea">
<meta property="article:tag" content="View, Animation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://xu6148152.github.io/2016/12/04/Animator-at-Android/animator.png">


<link rel="canonical" href="http://xu6148152.github.io/2016/12/04/Animator-at-Android/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"default","comments":true,"permalink":"http://xu6148152.github.io/2016/12/04/Animator-at-Android/","path":"2016/12/04/Animator-at-Android/","title":"Animator at Android"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Animator at Android | Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Animator"><span class="nav-number">1.</span> <span class="nav-text">Animator</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ValueAnimator"><span class="nav-number">1.1.</span> <span class="nav-text">ValueAnimator</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#AnimationHandler"><span class="nav-number">1.1.1.</span> <span class="nav-text">AnimationHandler</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%92%E5%80%BC%E5%99%A8"><span class="nav-number">1.2.</span> <span class="nav-text">插值器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LinearInterpolator-%E7%BA%BF%E6%80%A7%E6%8F%92%E5%80%BC%E5%99%A8"><span class="nav-number">1.2.1.</span> <span class="nav-text">LinearInterpolator(线性插值器)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AccelerateDecelerateInterpolator-%E5%8A%A0%E5%87%8F%E9%80%9F%E6%8F%92%E5%80%BC%E5%99%A8"><span class="nav-number">1.2.2.</span> <span class="nav-text">AccelerateDecelerateInterpolator(加减速插值器)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AccelerateInterpolator-%E5%8A%A0%E9%80%9F%E6%8F%92%E5%80%BC%E5%99%A8"><span class="nav-number">1.2.3.</span> <span class="nav-text">AccelerateInterpolator(加速插值器)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AnticipateInterpolator"><span class="nav-number">1.2.4.</span> <span class="nav-text">AnticipateInterpolator</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AnticipateOvershootInterpolator"><span class="nav-number">1.2.5.</span> <span class="nav-text">AnticipateOvershootInterpolator</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TypeEvaluator-%E4%BC%B0%E5%80%BC%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">TypeEvaluator(估值器)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ArgbEvaluator"><span class="nav-number">1.3.1.</span> <span class="nav-text">ArgbEvaluator</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#IntEvaluator"><span class="nav-number">1.3.2.</span> <span class="nav-text">IntEvaluator</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Choreograhper"><span class="nav-number">1.4.</span> <span class="nav-text">Choreograhper</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.4.1.</span> <span class="nav-text">流程图</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ObjectAnimator"><span class="nav-number">1.5.</span> <span class="nav-text">ObjectAnimator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PropertyValuesHolder-%E5%A4%84%E7%90%86setter-getter%E7%9A%84%E5%AF%BB%E6%89%BE"><span class="nav-number">1.6.</span> <span class="nav-text">PropertyValuesHolder 处理setter, getter的寻找</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KeyFrame"><span class="nav-number">1.7.</span> <span class="nav-text">KeyFrame</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AnimatorSet"><span class="nav-number">1.8.</span> <span class="nav-text">AnimatorSet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LayoutTransition"><span class="nav-number">1.9.</span> <span class="nav-text">LayoutTransition</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ViewPropertyAnimator"><span class="nav-number">1.10.</span> <span class="nav-text">ViewPropertyAnimator</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transition"><span class="nav-number">2.</span> <span class="nav-text">Transition</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">2.1.</span> <span class="nav-text">结构图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E8%BD%AC%E5%9C%BA%E5%8A%A8%E7%94%BB"><span class="nav-number">2.1.1.</span> <span class="nav-text">开始转场动画</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AutoTransition"><span class="nav-number">2.1.2.</span> <span class="nav-text">AutoTransition</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TransitionSet"><span class="nav-number">2.1.3.</span> <span class="nav-text">TransitionSet</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ChangeText-%E8%87%AA%E5%AE%9A%E4%B9%89transition"><span class="nav-number">2.1.4.</span> <span class="nav-text">ChangeText(自定义transition)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ChangeBound"><span class="nav-number">2.1.5.</span> <span class="nav-text">ChangeBound</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="nav-number">2.1.5.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Slide"><span class="nav-number">2.1.6.</span> <span class="nav-text">Slide</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2"><span class="nav-number">2.1.6.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Scale"><span class="nav-number">2.1.7.</span> <span class="nav-text">Scale</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-3"><span class="nav-number">2.1.7.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Explode"><span class="nav-number">2.1.8.</span> <span class="nav-text">Explode</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-4"><span class="nav-number">2.1.8.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TransitionName"><span class="nav-number">2.1.9.</span> <span class="nav-text">TransitionName</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ImageTransform"><span class="nav-number">2.1.10.</span> <span class="nav-text">ImageTransform</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ReColor"><span class="nav-number">2.1.11.</span> <span class="nav-text">ReColor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Rotate"><span class="nav-number">2.1.12.</span> <span class="nav-text">Rotate</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-5"><span class="nav-number">2.1.12.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Progress"><span class="nav-number">2.1.13.</span> <span class="nav-text">Progress</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Change-Scene"><span class="nav-number">2.1.14.</span> <span class="nav-text">Change Scene</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-6"><span class="nav-number">2.1.14.1.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Fade"><span class="nav-number">2.1.15.</span> <span class="nav-text">Fade</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结:</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Binea</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="default">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/12/04/Animator-at-Android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Animator at Android | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Animator at Android
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-04 21:17:02" itemprop="dateCreated datePublished" datetime="2016-12-04T21:17:02+08:00">2016-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-08 18:14:04" itemprop="dateModified" datetime="2022-06-08T18:14:04+08:00">2022-06-08</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="Animator"><a href="#Animator" class="headerlink" title="Animator"></a>Animator</h3><p>其是<code>Android3.0</code>之后加入的作用于对象属性的动画,<code>Animator</code>是所有属性动画的基类，其下有<code>ValueAnimator</code>,<code>AnimatorSet</code>,由<code>ValueAnimator</code>再拓展出<code>ObjectAnimator</code>,<code>TimeAnimator</code></p>
<p>其整体结构图</p>
<img data-src="/2016/12/04/Animator-at-Android/animator.png" class="" title="animator">

<h4 id="ValueAnimator"><a href="#ValueAnimator" class="headerlink" title="ValueAnimator"></a>ValueAnimator</h4><p>为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的<code>Handler</code>里面以确保所有的属性改变都会在<code>UI</code>线程。主要<code>API</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ValueAnimator <span class="title function_">ofInt</span><span class="params">(<span class="type">int</span>... values)</span> </span><br><span class="line">ValueAnimator <span class="title function_">ofArgb</span><span class="params">(<span class="type">int</span>... values)</span> <span class="comment">//颜色值变化</span></span><br><span class="line">ValueAnimator <span class="title function_">ofFloat</span><span class="params">(<span class="type">float</span>... values)</span> </span><br><span class="line">ValueAnimator <span class="title function_">ofPropertyValuesHolder</span><span class="params">(PropertyValuesHolder... values)</span></span><br><span class="line">ValueAnimator <span class="title function_">ofObject</span><span class="params">(TypeEvaluator evaluator, Object... values)</span></span><br></pre></td></tr></table></figure>

<p>这些方法里面都是进行值得初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIntValues</span><span class="params">(<span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (values == <span class="literal">null</span> || values.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mValues == <span class="literal">null</span> || mValues.length == <span class="number">0</span>) &#123;</span><br><span class="line">            setValues(PropertyValuesHolder.ofInt(<span class="string">&quot;&quot;</span>, values));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">PropertyValuesHolder</span> <span class="variable">valuesHolder</span> <span class="operator">=</span> mValues[<span class="number">0</span>];</span><br><span class="line">            valuesHolder.setIntValues(values);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// New property/values/target should cause re-initialization prior to starting</span></span><br><span class="line">        mInitialized = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>都是重新封装转化成<code>PropertyValuesHolder</code>，这是封装动画属性和值得对象，之后会详细介绍</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEvaluator</span><span class="params">(TypeEvaluator value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; mValues != <span class="literal">null</span> &amp;&amp; mValues.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mValues[<span class="number">0</span>].setEvaluator(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>设置估值器，最后也是由<code>PropertyValuesHolder</code>保存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数代表是否反转动画</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">boolean</span> playBackwards)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Looper.myLooper() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AndroidRuntimeException</span>(<span class="string">&quot;Animators may only be run on Looper threads&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mReversing = playBackwards;</span><br><span class="line">        mPlayingBackwards = playBackwards;</span><br><span class="line">        <span class="comment">//需要反转动画</span></span><br><span class="line">        <span class="keyword">if</span> (playBackwards &amp;&amp; mSeekFraction != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSeekFraction == <span class="number">0</span> &amp;&amp; mCurrentIteration == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// special case: reversing from seek-to-0 should act as if not seeked at all</span></span><br><span class="line">                mSeekFraction = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mRepeatCount == INFINITE) &#123;</span><br><span class="line">                mSeekFraction = <span class="number">1</span> - (mSeekFraction % <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mSeekFraction = <span class="number">1</span> + mRepeatCount - (mCurrentIteration + mSeekFraction);</span><br><span class="line">            &#125;</span><br><span class="line">            mCurrentIteration = (<span class="type">int</span>) mSeekFraction;</span><br><span class="line">            mSeekFraction = mSeekFraction % <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentIteration &gt; <span class="number">0</span> &amp;&amp; mRepeatMode == REVERSE &amp;&amp;</span><br><span class="line">                (mCurrentIteration &lt; (mRepeatCount + <span class="number">1</span>) || mRepeatCount == INFINITE)) &#123;</span><br><span class="line">            <span class="comment">// if we were seeked to some other iteration in a reversing animator,</span></span><br><span class="line">            <span class="comment">// figure out the correct direction to start playing based on the iteration</span></span><br><span class="line">            <span class="keyword">if</span> (playBackwards) &#123;</span><br><span class="line">                mPlayingBackwards = (mCurrentIteration % <span class="number">2</span>) == <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mPlayingBackwards = (mCurrentIteration % <span class="number">2</span>) != <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">prevPlayingState</span> <span class="operator">=</span> mPlayingState;</span><br><span class="line">        mPlayingState = STOPPED;</span><br><span class="line">        mStarted = <span class="literal">true</span>;</span><br><span class="line">        mStartedDelay = <span class="literal">false</span>;</span><br><span class="line">        mPaused = <span class="literal">false</span>;</span><br><span class="line">        updateScaledDuration(); <span class="comment">// in case the scale factor has changed since creation time</span></span><br><span class="line">        <span class="comment">//创建AnimatorHandler</span></span><br><span class="line">        <span class="type">AnimationHandler</span> <span class="variable">animationHandler</span> <span class="operator">=</span> getOrCreateAnimationHandler();</span><br><span class="line">        animationHandler.mPendingAnimations.add(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// This sets the initial value of the animation, prior to actually starting it running</span></span><br><span class="line">            <span class="keyword">if</span> (prevPlayingState != SEEKED) &#123;</span><br><span class="line">                setCurrentPlayTime(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mPlayingState = STOPPED;</span><br><span class="line">            mRunning = <span class="literal">true</span>;</span><br><span class="line">            notifyStartListeners();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//开始动画</span></span><br><span class="line">        animationHandler.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>开始动画的逻辑其实很简单，主要是判断动画是否需要反转。最终动画的更新交给<code>AnimationHandler</code></p>
<h5 id="AnimationHandler"><a href="#AnimationHandler" class="headerlink" title="AnimationHandler"></a>AnimationHandler</h5><p>处理所有运行中的动画的定时脉冲，这个机制能确保所有的动画都运行在<code>UI</code>线程，其使用<code>Choreograhper(用于调整动画输入和绘制的时机)</code>来执行周期的回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">AnimationHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    mChoreographer = Choreographer.getInstance();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    scheduleAnimation();</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleAnimation</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (!mAnimationScheduled) &#123;</span><br><span class="line">               <span class="comment">//动画未执行过，由Choreographer回调执行</span></span><br><span class="line">               mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, mAnimate, <span class="literal">null</span>);</span><br><span class="line">               mAnimationScheduled = <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">mAnimate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">               mAnimationScheduled = <span class="literal">false</span>;</span><br><span class="line">               doAnimationFrame(mChoreographer.getFrameTime());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">doAnimationFrame</span><span class="params">(<span class="type">long</span> frameTime)</span> &#123;</span><br><span class="line">   <span class="comment">//参数代表执行哪一帧动画</span></span><br><span class="line">           mLastFrameTime = frameTime;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// mPendingAnimations holds any animations that have requested to be started</span></span><br><span class="line">           <span class="comment">// We&#x27;re going to clear mPendingAnimations, but starting animation may</span></span><br><span class="line">           <span class="comment">// cause more to be added to the pending list (for example, if one animation</span></span><br><span class="line">           <span class="comment">// starting triggers another starting). So we loop until mPendingAnimations</span></span><br><span class="line">           <span class="comment">// is empty.</span></span><br><span class="line">           <span class="keyword">while</span> (mPendingAnimations.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">//如果有等待执行的动画，清除并优先执行这些动画</span></span><br><span class="line">               ArrayList&lt;ValueAnimator&gt; pendingCopy =</span><br><span class="line">                       (ArrayList&lt;ValueAnimator&gt;) mPendingAnimations.clone();</span><br><span class="line">               mPendingAnimations.clear();</span><br><span class="line">               <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> pendingCopy.size();</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">                   <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> pendingCopy.get(i);</span><br><span class="line">                   <span class="comment">// If the animation has a startDelay, place it on the delayed list</span></span><br><span class="line">                   <span class="keyword">if</span> (anim.mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">                       anim.startAnimation(<span class="built_in">this</span>);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       mDelayedAnims.add(anim);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Next, process animations currently sitting on the delayed queue, adding</span></span><br><span class="line">           <span class="comment">// them to the active animations if they are ready</span></span><br><span class="line">           <span class="comment">//将延时队列中的动画加入到准备完成队列，开始执行动画，清空队列</span></span><br><span class="line">           <span class="type">int</span> <span class="variable">numDelayedAnims</span> <span class="operator">=</span> mDelayedAnims.size();</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numDelayedAnims; ++i) &#123;</span><br><span class="line">               <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> mDelayedAnims.get(i);</span><br><span class="line">               <span class="keyword">if</span> (anim.delayedAnimationFrame(frameTime)) &#123;</span><br><span class="line">                   mReadyAnims.add(anim);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="type">int</span> <span class="variable">numReadyAnims</span> <span class="operator">=</span> mReadyAnims.size();</span><br><span class="line">           <span class="keyword">if</span> (numReadyAnims &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numReadyAnims; ++i) &#123;</span><br><span class="line">                   <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> mReadyAnims.get(i);</span><br><span class="line">                   anim.startAnimation(<span class="built_in">this</span>);</span><br><span class="line">                   anim.mRunning = <span class="literal">true</span>;</span><br><span class="line">                   mDelayedAnims.remove(anim);</span><br><span class="line">               &#125;</span><br><span class="line">               mReadyAnims.clear();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Now process all active animations. The return value from animationFrame()</span></span><br><span class="line">           <span class="comment">// tells the handler whether it should now be ended</span></span><br><span class="line">           <span class="type">int</span> <span class="variable">numAnims</span> <span class="operator">=</span> mAnimations.size();</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">               mTmpAnimations.add(mAnimations.get(i));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">               <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> mTmpAnimations.get(i);</span><br><span class="line">               <span class="keyword">if</span> (mAnimations.contains(anim) &amp;&amp; anim.doAnimationFrame(frameTime)) &#123;</span><br><span class="line">                   mEndingAnims.add(anim);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           mTmpAnimations.clear();</span><br><span class="line">           <span class="keyword">if</span> (mEndingAnims.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mEndingAnims.size(); ++i) &#123;</span><br><span class="line">                   mEndingAnims.get(i).endAnimation(<span class="built_in">this</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               mEndingAnims.clear();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Schedule final commit for the frame.</span></span><br><span class="line">           mChoreographer.postCallback(Choreographer.CALLBACK_COMMIT, mCommit, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If there are still active or delayed animations, schedule a future call to</span></span><br><span class="line">           <span class="comment">// onAnimate to process the next frame of the animations.</span></span><br><span class="line">           <span class="keyword">if</span> (!mAnimations.isEmpty() || !mDelayedAnims.isEmpty()) &#123;</span><br><span class="line">               scheduleAnimation();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;         </span><br><span class="line">       </span><br></pre></td></tr></table></figure>

<p>流程图</p>
<p><img data-src="/./ValueAnimator.png" alt="ValueAnimator"></p>
<h4 id="插值器"><a href="#插值器" class="headerlink" title="插值器"></a>插值器</h4><p>插值器是描述动画变化的频率。其主要方法是  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入动画基准值，得到计算后的某个时刻的值</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span>;</span><br></pre></td></tr></table></figure>

<p>类关系图:<br><img data-src="/./interpolator.png" alt="interpolator"></p>
<p>系统已经为开发者准备了一些默认的插值器，我们来简单看下这些插值器的算法</p>
<h5 id="LinearInterpolator-线性插值器"><a href="#LinearInterpolator-线性插值器" class="headerlink" title="LinearInterpolator(线性插值器)"></a>LinearInterpolator(线性插值器)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入既是输出</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./LinearInterpolator.png"></p>
<h5 id="AccelerateDecelerateInterpolator-加减速插值器"><a href="#AccelerateDecelerateInterpolator-加减速插值器" class="headerlink" title="AccelerateDecelerateInterpolator(加减速插值器)"></a>AccelerateDecelerateInterpolator(加减速插值器)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">float</span>)(Math.cos((input + <span class="number">1</span>) * Math.PI) / <span class="number">2.0f</span>) + <span class="number">0.5f</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AccelerateDecelerateInterpolator.png">  </p>
<p>其特性是在动画开始和结束阶段变化缓慢，中间阶段变化迅速</p>
<h5 id="AccelerateInterpolator-加速插值器"><a href="#AccelerateInterpolator-加速插值器" class="headerlink" title="AccelerateInterpolator(加速插值器)"></a>AccelerateInterpolator(加速插值器)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFactor == <span class="number">1.0f</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> input * input;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">float</span>)Math.pow(input, mDoubleFactor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AccelerateInterpolator.png"><br>其特点是动画变化速度一直加快，有个加速因子，默认为1。</p>
<h5 id="AnticipateInterpolator"><a href="#AnticipateInterpolator" class="headerlink" title="AnticipateInterpolator"></a>AnticipateInterpolator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> t)</span> &#123;</span><br><span class="line">        <span class="comment">// a(t) = t * t * ((tension + 1) * t - tension)</span></span><br><span class="line">        <span class="keyword">return</span> t * t * ((mTension + <span class="number">1</span>) * t - mTension);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AnticipateInterpolator.png"></p>
<h5 id="AnticipateOvershootInterpolator"><a href="#AnticipateOvershootInterpolator" class="headerlink" title="AnticipateOvershootInterpolator"></a>AnticipateOvershootInterpolator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> t)</span> &#123;</span><br><span class="line">        <span class="comment">// a(t, s) = t * t * ((s + 1) * t - s)</span></span><br><span class="line">        <span class="comment">// o(t, s) = t * t * ((s + 1) * t + s)</span></span><br><span class="line">        <span class="comment">// f(t) = 0.5 * a(t * 2, tension * extraTension), when t &lt; 0.5</span></span><br><span class="line">        <span class="comment">// f(t) = 0.5 * (o(t * 2 - 2, tension * extraTension) + 2), when t &lt;= 1.0</span></span><br><span class="line">        <span class="keyword">if</span> (t &lt; <span class="number">0.5f</span>) <span class="keyword">return</span> <span class="number">0.5f</span> * a(t * <span class="number">2.0f</span>, mTension);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0.5f</span> * (o(t * <span class="number">2.0f</span> - <span class="number">2.0f</span>, mTension) + <span class="number">2.0f</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AnticipateOvershootinterpolator.png"></p>
<p>还有很多别的插值器。这里就不多加赘述了。只要将相应的算法写入<code>getInterpolation</code>中即可</p>
<p>使用的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">animateValue</span><span class="params">(<span class="type">float</span> fraction)</span> &#123;</span><br><span class="line"><span class="comment">//计算动画值</span></span><br><span class="line">        fraction = mInterpolator.getInterpolation(fraction);</span><br><span class="line">        mCurrentFraction = fraction;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">            mValues[i].calculateValue(fraction);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mUpdateListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">numListeners</span> <span class="operator">=</span> mUpdateListeners.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                mUpdateListeners.get(i).onAnimationUpdate(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="TypeEvaluator-估值器"><a href="#TypeEvaluator-估值器" class="headerlink" title="TypeEvaluator(估值器)"></a>TypeEvaluator(估值器)</h4><p>根据当前的动画频率，起始值，结束值计算当前值</p>
<p><img data-src="/./TypeEvaluator.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">evaluate</span><span class="params">(<span class="type">float</span> fraction, T startValue, T endValue)</span>;</span><br></pre></td></tr></table></figure>

<h5 id="ArgbEvaluator"><a href="#ArgbEvaluator" class="headerlink" title="ArgbEvaluator"></a>ArgbEvaluator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">evaluate</span><span class="params">(<span class="type">float</span> fraction, Object startValue, Object endValue)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startInt</span> <span class="operator">=</span> (Integer) startValue;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startA</span> <span class="operator">=</span> (startInt &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startR</span> <span class="operator">=</span> (startInt &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startG</span> <span class="operator">=</span> (startInt &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startB</span> <span class="operator">=</span> startInt &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">endInt</span> <span class="operator">=</span> (Integer) endValue;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endA</span> <span class="operator">=</span> (endInt &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endR</span> <span class="operator">=</span> (endInt &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endG</span> <span class="operator">=</span> (endInt &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endB</span> <span class="operator">=</span> endInt &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)((startA + (<span class="type">int</span>)(fraction * (endA - startA))) &lt;&lt; <span class="number">24</span>) |</span><br><span class="line">                (<span class="type">int</span>)((startR + (<span class="type">int</span>)(fraction * (endR - startR))) &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                (<span class="type">int</span>)((startG + (<span class="type">int</span>)(fraction * (endG - startG))) &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">                (<span class="type">int</span>)((startB + (<span class="type">int</span>)(fraction * (endB - startB))));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>算法是线性函数，主要因子<code>fraction</code>来自插值器的计算, <code>y= a + kx</code></p>
<h5 id="IntEvaluator"><a href="#IntEvaluator" class="headerlink" title="IntEvaluator"></a>IntEvaluator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Integer <span class="title function_">evaluate</span><span class="params">(<span class="type">float</span> fraction, Integer startValue, Integer endValue)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startInt</span> <span class="operator">=</span> startValue;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)(startInt + fraction * (endValue - startInt));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>估值器主要实在<code>KeyFrames</code>中使用，而<code>KeyFrames</code>存在<code>PropertyValuesHolder</code>当中，最终<code>Choreographer</code>来更新动画使用</p>
<h4 id="Choreograhper"><a href="#Choreograhper" class="headerlink" title="Choreograhper"></a>Choreograhper</h4><p>协调动画，输入和绘制的时间。其会收到来自显示系统的定时脉冲，然后安排工作作为下一帧渲染的一部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Choreographer</span><span class="params">(Looper looper)</span> &#123;</span><br><span class="line">        mLooper = looper;</span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="title class_">FrameHandler</span>(looper);</span><br><span class="line">        mDisplayEventReceiver = USE_VSYNC ? <span class="keyword">new</span> <span class="title class_">FrameDisplayEventReceiver</span>(looper) : <span class="literal">null</span>;</span><br><span class="line">        mLastFrameTimeNanos = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">        mFrameIntervalNanos = (<span class="type">long</span>)(<span class="number">1000000000</span> / getRefreshRate());</span><br><span class="line"></span><br><span class="line">        mCallbackQueues = <span class="keyword">new</span> <span class="title class_">CallbackQueue</span>[CALLBACK_LAST + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= CALLBACK_LAST; i++) &#123;</span><br><span class="line">            mCallbackQueues[i] = <span class="keyword">new</span> <span class="title class_">CallbackQueue</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化，创建<code>FrameHandler</code>，创建回调队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCallback</span><span class="params">(<span class="type">int</span> callbackType, Runnable action, Object token)</span> &#123;</span><br><span class="line">        postCallbackDelayed(callbackType, action, token, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postCallbackDelayedInternal</span><span class="params">(<span class="type">int</span> callbackType,</span></span><br><span class="line"><span class="params">        Object action, Object token, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;PostCallback: type=&quot;</span> + callbackType</span><br><span class="line">                + <span class="string">&quot;, action=&quot;</span> + action + <span class="string">&quot;, token=&quot;</span> + token</span><br><span class="line">                + <span class="string">&quot;, delayMillis=&quot;</span> + delayMillis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dueTime</span> <span class="operator">=</span> now + delayMillis;</span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将回调加入回调队列，如果没有延时，锁定当前帧，如果使用<code>VSYNC</code>，诺当前运行在相同的线程，直接通过<code>FrameDisplayEventReceiver</code>要求同步，其他情况发送消息到<code>Handler</code>中执行。<code>Handler</code>处理三种消息,<code>MSG_DO_FRAME</code>,<code>MSG_DO_SCHEDULE_VSYNC</code>, <code>MSG_DO_SCHEDULE_CALLBACK</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doCallbacks</span><span class="params">(<span class="type">int</span> callbackType, <span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">        CallbackRecord callbacks;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// We use &quot;now&quot; to determine when callbacks become due because it&#x27;s possible</span></span><br><span class="line">            <span class="comment">// for earlier processing phases in a frame to post callbacks that should run</span></span><br><span class="line">            <span class="comment">// in a following phase, such as an input event that causes an animation to start.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            callbacks = mCallbackQueues[callbackType].extractDueCallbacksLocked(</span><br><span class="line">                    now / TimeUtils.NANOS_PER_MS);</span><br><span class="line">            <span class="keyword">if</span> (callbacks == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mCallbacksRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update the frame time if necessary when committing the frame.</span></span><br><span class="line">            <span class="comment">// We only update the frame time if we are more than 2 frames late reaching</span></span><br><span class="line">            <span class="comment">// the commit phase.  This ensures that the frame time which is observed by the</span></span><br><span class="line">            <span class="comment">// callbacks will always increase from one frame to the next and never repeat.</span></span><br><span class="line">            <span class="comment">// We never want the next frame&#x27;s starting frame time to end up being less than</span></span><br><span class="line">            <span class="comment">// or equal to the previous frame&#x27;s commit frame time.  Keep in mind that the</span></span><br><span class="line">            <span class="comment">// next frame has most likely already been scheduled by now so we play it</span></span><br><span class="line">            <span class="comment">// safe by ensuring the commit time is always at least one frame behind.</span></span><br><span class="line">            <span class="keyword">if</span> (callbackType == Choreographer.CALLBACK_COMMIT) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">jitterNanos</span> <span class="operator">=</span> now - frameTimeNanos;</span><br><span class="line">                Trace.traceCounter(Trace.TRACE_TAG_VIEW, <span class="string">&quot;jitterNanos&quot;</span>, (<span class="type">int</span>) jitterNanos);</span><br><span class="line">                <span class="keyword">if</span> (jitterNanos &gt;= <span class="number">2</span> * mFrameIntervalNanos) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">lastFrameOffset</span> <span class="operator">=</span> jitterNanos % mFrameIntervalNanos</span><br><span class="line">                            + mFrameIntervalNanos;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_JANK) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;Commit callback delayed by &quot;</span> + (jitterNanos * <span class="number">0.000001f</span>)</span><br><span class="line">                                + <span class="string">&quot; ms which is more than twice the frame interval of &quot;</span></span><br><span class="line">                                + (mFrameIntervalNanos * <span class="number">0.000001f</span>) + <span class="string">&quot; ms!  &quot;</span></span><br><span class="line">                                + <span class="string">&quot;Setting frame time to &quot;</span> + (lastFrameOffset * <span class="number">0.000001f</span>)</span><br><span class="line">                                + <span class="string">&quot; ms in the past.&quot;</span>);</span><br><span class="line">                        mDebugPrintNextFrameTimeDelta = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    frameTimeNanos = now - lastFrameOffset;</span><br><span class="line">                    mLastFrameTimeNanos = frameTimeNanos;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, CALLBACK_TRACE_TITLES[callbackType]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">CallbackRecord</span> <span class="variable">c</span> <span class="operator">=</span> callbacks; c != <span class="literal">null</span>; c = c.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;RunCallback: type=&quot;</span> + callbackType</span><br><span class="line">                            + <span class="string">&quot;, action=&quot;</span> + c.action + <span class="string">&quot;, token=&quot;</span> + c.token</span><br><span class="line">                            + <span class="string">&quot;, latencyMillis=&quot;</span> + (SystemClock.uptimeMillis() - c.dueTime));</span><br><span class="line">                &#125;</span><br><span class="line">                c.run(frameTimeNanos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//执行所有的回调</span></span><br><span class="line">                mCallbacksRunning = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">CallbackRecord</span> <span class="variable">next</span> <span class="operator">=</span> callbacks.next;</span><br><span class="line">                    recycleCallbackLocked(callbacks);</span><br><span class="line">                    callbacks = next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (callbacks != <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>MSG_DO_FRAME</code>:判断当前帧时间，低于上次绘制时间，要求同步。否则调用<code>doCallbacks</code>，执行回调队列中的回调</li>
</ul>
<h5 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h5><h4 id="ObjectAnimator"><a href="#ObjectAnimator" class="headerlink" title="ObjectAnimator"></a>ObjectAnimator</h4><p>支持对目标对象的属性做动画，对<code>ValueAnimator</code>的拓展</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以直接设置target,propertyName</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ObjectAnimator <span class="title function_">ofInt</span><span class="params">(Object target, String propertyName, <span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectAnimator</span>(target, propertyName);</span><br><span class="line">        anim.setIntValues(values);</span><br><span class="line">        <span class="keyword">return</span> anim;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTarget</span><span class="params">(<span class="meta">@Nullable</span> Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">oldTarget</span> <span class="operator">=</span> getTarget();</span><br><span class="line">        <span class="comment">//老的目标与当前目标不同，取消。设置弱引用目标对象</span></span><br><span class="line">        <span class="keyword">if</span> (oldTarget != target) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isStarted()) &#123;</span><br><span class="line">                cancel();</span><br><span class="line">            &#125;</span><br><span class="line">            mTarget = target == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;Object&gt;(target);</span><br><span class="line">            <span class="comment">// New target should cause re-initialization prior to starting</span></span><br><span class="line">            mInitialized = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// See if any of the current active/pending animators need to be canceled</span></span><br><span class="line">        <span class="type">AnimationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> sAnimationHandler.get();</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">numAnims</span> <span class="operator">=</span> handler.mAnimations.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (handler.mAnimations.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> (ObjectAnimator) handler.mAnimations.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</span><br><span class="line">                    <span class="comment">//相同的目标和属性，取消之前的动画</span></span><br><span class="line">                        anim.cancel();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//等待的动画也一样</span></span><br><span class="line">            numAnims = handler.mPendingAnimations.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (handler.mPendingAnimations.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> (ObjectAnimator) handler.mPendingAnimations.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</span><br><span class="line">                        anim.cancel();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//延时的动画也一样</span></span><br><span class="line">            numAnims = handler.mDelayedAnims.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (handler.mDelayedAnims.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> (ObjectAnimator) handler.mDelayedAnims.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</span><br><span class="line">                        anim.cancel();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            Log.d(LOG_TAG, <span class="string">&quot;Anim target, duration: &quot;</span> + getTarget() + <span class="string">&quot;, &quot;</span> + getDuration());</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mValues.length; ++i) &#123;</span><br><span class="line">                <span class="type">PropertyValuesHolder</span> <span class="variable">pvh</span> <span class="operator">=</span> mValues[i];</span><br><span class="line">                Log.d(LOG_TAG, <span class="string">&quot;   Values[&quot;</span> + i + <span class="string">&quot;]: &quot;</span> +</span><br><span class="line">                    pvh.getPropertyName() + <span class="string">&quot;, &quot;</span> + pvh.mKeyframes.getValue(<span class="number">0</span>) + <span class="string">&quot;, &quot;</span> +</span><br><span class="line">                    pvh.mKeyframes.getValue(<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">animateValue</span><span class="params">(<span class="type">float</span> fraction)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getTarget();</span><br><span class="line">        <span class="keyword">if</span> (mTarget != <span class="literal">null</span> &amp;&amp; target == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We lost the target reference, cancel and clean up.</span></span><br><span class="line">            cancel();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.animateValue(fraction);</span><br><span class="line">        <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">            mValues[i].setAnimatedValue(target);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setupStartValues</span><span class="params">()</span> &#123;</span><br><span class="line">		  <span class="comment">//初始化动画</span></span><br><span class="line">        initAnimation();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getTarget();</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">                mValues[i].setupStartValue(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">initAnimation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInitialized) &#123;</span><br><span class="line">            <span class="comment">// mValueType may change due to setter/getter setup; do this before calling super.init(),</span></span><br><span class="line">            <span class="comment">// which uses mValueType to set up the default type evaluator.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getTarget();</span><br><span class="line">            <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">                <span class="comment">//初始化getter setter</span></span><br><span class="line">                   mValues[i].setupSetterAndGetter(target);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">super</span>.initAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;                 </span><br></pre></td></tr></table></figure>

<ul>
<li><code>ObjectAnimator</code>比<code>ValueAnimator</code>多了<code>target</code>和<code>Property</code>，这些信息都在<code>PropertyValuesHolder</code>,必须要要有getter&#x2F;setter才能更新目标对象</li>
</ul>
<h4 id="PropertyValuesHolder-处理setter-getter的寻找"><a href="#PropertyValuesHolder-处理setter-getter的寻找" class="headerlink" title="PropertyValuesHolder 处理setter, getter的寻找"></a>PropertyValuesHolder 处理setter, getter的寻找</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">setupSetterAndGetter</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        mKeyframes.invalidateCache();</span><br><span class="line">        <span class="comment">//属性不为空时,从Propery拿值，并设置到keyFrame</span></span><br><span class="line">        <span class="keyword">if</span> (mProperty != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// check to make sure that mProperty is on the class of target</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">testValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();</span><br><span class="line">                <span class="type">int</span> <span class="variable">keyframeCount</span> <span class="operator">=</span> keyframes == <span class="literal">null</span> ? <span class="number">0</span> : keyframes.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; keyframeCount; i++) &#123;</span><br><span class="line">                    <span class="type">Keyframe</span> <span class="variable">kf</span> <span class="operator">=</span> keyframes.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (testValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                            testValue = convertBack(mProperty.get(target));</span><br><span class="line">                        &#125;</span><br><span class="line">                        kf.setValue(testValue);</span><br><span class="line">                        kf.setValueWasSetOnStart(<span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">                Log.w(<span class="string">&quot;PropertyValuesHolder&quot;</span>,<span class="string">&quot;No such property (&quot;</span> + mProperty.getName() +</span><br><span class="line">                        <span class="string">&quot;) on target object &quot;</span> + target + <span class="string">&quot;. Trying reflection instead&quot;</span>);</span><br><span class="line">                mProperty = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We can&#x27;t just say &#x27;else&#x27; here because the catch statement sets mProperty to null.</span></span><br><span class="line">        <span class="comment">//如果property为空，从目标对象中寻找getter setter</span></span><br><span class="line">        <span class="keyword">if</span> (mProperty == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">targetClass</span> <span class="operator">=</span> target.getClass();</span><br><span class="line">            <span class="keyword">if</span> (mSetter == <span class="literal">null</span>) &#123;</span><br><span class="line">                setupSetter(targetClass);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();</span><br><span class="line">            <span class="type">int</span> <span class="variable">keyframeCount</span> <span class="operator">=</span> keyframes == <span class="literal">null</span> ? <span class="number">0</span> : keyframes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; keyframeCount; i++) &#123;</span><br><span class="line">                <span class="type">Keyframe</span> <span class="variable">kf</span> <span class="operator">=</span> keyframes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mGetter == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//getter没找到，再次寻找</span></span><br><span class="line">                        setupGetter(targetClass);</span><br><span class="line">                        <span class="comment">//依然没找到</span></span><br><span class="line">                        <span class="keyword">if</span> (mGetter == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// Already logged the error - just return to avoid NPE</span></span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> convertBack(mGetter.invoke(target));</span><br><span class="line">                        <span class="comment">//找到getter，将值传给keyFrame</span></span><br><span class="line">                        kf.setValue(value);</span><br><span class="line">                        kf.setValueWasSetOnStart(<span class="literal">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                        Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                        Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setAnimatedValue</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mProperty != <span class="literal">null</span>) &#123;</span><br><span class="line">            mProperty.set(target, getAnimatedValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSetter != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//setter不为空，会调用目标对象的setter</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mTmpValueArray[<span class="number">0</span>] = getAnimatedValue();</span><br><span class="line">                mSetter.invoke(target, mTmpValueArray);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br></pre></td></tr></table></figure>
<ul>
<li><code>PropertyValuesHolder</code>主要持有动画的相关属性信息，包括关键帧集，插值器，估值器等</li>
</ul>
<h4 id="KeyFrame"><a href="#KeyFrame" class="headerlink" title="KeyFrame"></a>KeyFrame</h4><p>动画关键帧，保存动画某一帧的时间&#x2F;值。被<code>ValueAnimator</code>使用来计算两个值之间的动画值。<code>PropertyValuesHolder</code>保存了<code>KeyFrames</code>其保存了多个<code>KeyFrame</code>。简单来说<code>KeyFrame</code>就是我们做动画的起始值，中间值，结束值，这些都是由开发者定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIntValues</span><span class="params">(<span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        mValueType = <span class="type">int</span>.class;</span><br><span class="line">        mKeyframes = KeyframeSet.ofInt(values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">keyFrameSet:</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> KeyframeSet <span class="title function_">ofInt</span><span class="params">(<span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numKeyframes</span> <span class="operator">=</span> values.length;</span><br><span class="line">        IntKeyframe keyframes[] = <span class="keyword">new</span> <span class="title class_">IntKeyframe</span>[Math.max(numKeyframes,<span class="number">2</span>)];</span><br><span class="line">        <span class="keyword">if</span> (numKeyframes == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//当只设置了一个值时，会有两个关键帧，起始关键这和结束关键帧</span></span><br><span class="line">            keyframes[<span class="number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">0f</span>);</span><br><span class="line">            keyframes[<span class="number">1</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">1f</span>, values[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//起始关键帧</span></span><br><span class="line">            keyframes[<span class="number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">0f</span>, values[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; numKeyframes; ++i) &#123;</span><br><span class="line">            <span class="comment">//计算每个阶段的关键帧</span></span><br><span class="line">                keyframes[i] =</span><br><span class="line">                        (IntKeyframe) Keyframe.ofInt((<span class="type">float</span>) i / (numKeyframes - <span class="number">1</span>), values[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IntKeyframeSet</span>(keyframes);</span><br><span class="line">    &#125;    </span><br></pre></td></tr></table></figure>
<ul>
<li>动画至少会包含两个关键帧，一个起始关键帧，一个结束关键帧。中间有多少关键帧由开发者自行定义</li>
</ul>
<h4 id="AnimatorSet"><a href="#AnimatorSet" class="headerlink" title="AnimatorSet"></a>AnimatorSet</h4><p>允许同时播放多个动画或者定义动画的播放顺序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        mTerminated = <span class="literal">false</span>;</span><br><span class="line">        mStarted = <span class="literal">true</span>;</span><br><span class="line">        mPaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">            <span class="comment">//禁止异步运行node.animation.setAllowRunningAsynchronously(false);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置所有动画的长度</span></span><br><span class="line">        <span class="keyword">if</span> (mDuration &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If the duration was set on this AnimatorSet, pass it along to all child animations</span></span><br><span class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> don&#x27;t set the duration of the timing-only nodes created by AnimatorSet to</span></span><br><span class="line">                <span class="comment">// insert &quot;play-after&quot; delays</span></span><br><span class="line">                node.animation.setDuration(mDuration);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置所有动画的插值器</span></span><br><span class="line">        <span class="keyword">if</span> (mInterpolator != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                node.animation.setInterpolator(mInterpolator);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// First, sort the nodes (if necessary). This will ensure that sortedNodes</span></span><br><span class="line">        <span class="comment">// contains the animation nodes in the correct order.</span></span><br><span class="line">        <span class="comment">//对所有的动画节点进行排序</span></span><br><span class="line">        sortNodes();</span><br><span class="line"></span><br><span class="line">		  <span class="comment">//清除老的动画监听	</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">numSortedNodes</span> <span class="operator">=</span> mSortedNodes.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mSortedNodes.get(i);</span><br><span class="line">            <span class="comment">// First, clear out the old listeners</span></span><br><span class="line">            ArrayList&lt;AnimatorListener&gt; oldListeners = node.animation.getListeners();</span><br><span class="line">            <span class="keyword">if</span> (oldListeners != <span class="literal">null</span> &amp;&amp; oldListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ArrayList&lt;AnimatorListener&gt; clonedListeners = <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">ArrayList</span>&lt;AnimatorListener&gt;(oldListeners);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (AnimatorListener listener : clonedListeners) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (listener <span class="keyword">instanceof</span> DependencyListener ||</span><br><span class="line">                            listener <span class="keyword">instanceof</span> AnimatorSetListener) &#123;</span><br><span class="line">                        node.animation.removeListener(listener);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// nodesToStart holds the list of nodes to be started immediately. We don&#x27;t want to</span></span><br><span class="line">        <span class="comment">// start the animations in the loop directly because we first need to set up</span></span><br><span class="line">        <span class="comment">// dependencies on all of the nodes. For example, we don&#x27;t want to start an animation</span></span><br><span class="line">        <span class="comment">// when some other animation also wants to start when the first animation begins.</span></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;Node&gt; nodesToStart = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mSortedNodes.get(i);</span><br><span class="line">            <span class="keyword">if</span> (mSetListener == <span class="literal">null</span>) &#123;</span><br><span class="line">                mSetListener = <span class="keyword">new</span> <span class="title class_">AnimatorSetListener</span>(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//动画节点没有依赖别的节点，添加到即将开始的队列中</span></span><br><span class="line">            <span class="keyword">if</span> (node.dependencies == <span class="literal">null</span> || node.dependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                nodesToStart.add(node);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果有依赖的话，添加依赖监听，并把依赖添加到临时依赖链中</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">numDependencies</span> <span class="operator">=</span> node.dependencies.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; numDependencies; ++j) &#123;</span><br><span class="line">                    <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> node.dependencies.get(j);</span><br><span class="line">                    dependency.node.animation.addListener(</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">DependencyListener</span>(<span class="built_in">this</span>, node, dependency.rule));</span><br><span class="line">                &#125;</span><br><span class="line">                node.tmpDependencies = (ArrayList&lt;Dependency&gt;) node.dependencies.clone();</span><br><span class="line">            &#125;</span><br><span class="line">            node.animation.addListener(mSetListener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Now that all dependencies are set up, start the animations that should be started.</span></span><br><span class="line">        <span class="comment">//开始动画</span></span><br><span class="line">        <span class="keyword">if</span> (mStartDelay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node node : nodesToStart) &#123;</span><br><span class="line">                node.animation.start();</span><br><span class="line">                mPlayingSet.add(node.animation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mDelayAnim = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">            mDelayAnim.setDuration(mStartDelay);</span><br><span class="line">            mDelayAnim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">canceled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationCancel</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">                    canceled = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!canceled) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">numNodes</span> <span class="operator">=</span> nodesToStart.size();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nodesToStart.get(i);</span><br><span class="line">                            node.animation.start();</span><br><span class="line">                            mPlayingSet.add(node.animation);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mDelayAnim = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            mDelayAnim.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//动画开始回调</span></span><br><span class="line">        <span class="keyword">if</span> (mListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                    (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">            <span class="type">int</span> <span class="variable">numListeners</span> <span class="operator">=</span> tmpListeners.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                tmpListeners.get(i).onAnimationStart(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有动画，动画结束回调</span></span><br><span class="line">        <span class="keyword">if</span> (mNodes.size() == <span class="number">0</span> &amp;&amp; mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Handle unusual case where empty AnimatorSet is started - should send out</span></span><br><span class="line">            <span class="comment">// end event immediately since the event will not be sent out at all otherwise</span></span><br><span class="line">            mStarted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">                ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                        (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                <span class="type">int</span> <span class="variable">numListeners</span> <span class="operator">=</span> tmpListeners.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                    tmpListeners.get(i).onAnimationEnd(<span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br></pre></td></tr></table></figure>

<ul>
<li>流程: <ol>
<li>首先禁止异步运行动画，设置所有动画的时间和插值器。</li>
<li>对所有的动画进行排序(根据依赖关系),取消所有老的监听。如果动画没有依赖，加入即将开始的动画队列，否则创建依赖监听，创建临时依赖</li>
<li>没有延时，启动动画。否则创建延时动画，延时动画结束后，后续动画开始</li>
<li>动画开始监听回调，如果没有动画，动画结束监听回调</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">动画排序</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sortNodes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNeedsSort) &#123;</span><br><span class="line">            mSortedNodes.clear();</span><br><span class="line">            ArrayList&lt;Node&gt; roots = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">            <span class="type">int</span> <span class="variable">numNodes</span> <span class="operator">=</span> mNodes.size();</span><br><span class="line">            <span class="comment">//没有依赖的动画变成根节点</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (node.dependencies == <span class="literal">null</span> || node.dependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    roots.add(node);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ArrayList&lt;Node&gt; tmpRoots = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">            <span class="keyword">while</span> (roots.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//遍历每个根节点</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">numRoots</span> <span class="operator">=</span> roots.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numRoots; ++i) &#123;</span><br><span class="line">                    <span class="type">Node</span> <span class="variable">root</span> <span class="operator">=</span> roots.get(i);</span><br><span class="line">                    mSortedNodes.add(root);</span><br><span class="line">                    <span class="keyword">if</span> (root.nodeDependents != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">numDependents</span> <span class="operator">=</span> root.nodeDependents.size();</span><br><span class="line">                        <span class="comment">//根节点有依赖</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; numDependents; ++j) &#123;</span><br><span class="line">                            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> root.nodeDependents.get(j);</span><br><span class="line">                            <span class="comment">//将此根节点从依赖中移除node.nodeDependencies.remove(root);</span></span><br><span class="line">                            <span class="keyword">if</span> (node.nodeDependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                                tmpRoots.add(node);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                roots.clear();</span><br><span class="line">                roots.addAll(tmpRoots);</span><br><span class="line">                tmpRoots.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            mNeedsSort = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mSortedNodes.size() != mNodes.size()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Circular dependencies cannot exist&quot;</span></span><br><span class="line">                        + <span class="string">&quot; in AnimatorSet&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Doesn&#x27;t need sorting, but still need to add in the nodeDependencies list</span></span><br><span class="line">            <span class="comment">// because these get removed as the event listeners fire and the dependencies</span></span><br><span class="line">            <span class="comment">// are satisfied</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">numNodes</span> <span class="operator">=</span> mNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (node.dependencies != <span class="literal">null</span> &amp;&amp; node.dependencies.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">numDependencies</span> <span class="operator">=</span> node.dependencies.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; numDependencies; ++j) &#123;</span><br><span class="line">                        <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> node.dependencies.get(j);</span><br><span class="line">                        <span class="keyword">if</span> (node.nodeDependencies == <span class="literal">null</span>) &#123;</span><br><span class="line">                            node.nodeDependencies = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!node.nodeDependencies.contains(dependency.node)) &#123;</span><br><span class="line">                            node.nodeDependencies.add(dependency.node);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// nodes are &#x27;done&#x27; by default; they become un-done when started, and done</span></span><br><span class="line">                <span class="comment">// again when ended</span></span><br><span class="line">                node.done = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">```  </span><br><span class="line">* 动画排序规则: </span><br><span class="line">  * 如果需要排序</span><br><span class="line">      <span class="number">1.</span> 没有依赖的动画变成根节点.</span><br><span class="line">      <span class="number">2.</span> 循环遍历所有根节点，将根节点从依赖节点中移除</span><br><span class="line">  * 不需要排序</span><br><span class="line">      <span class="number">1.</span> 添加回依赖</span><br><span class="line"></span><br><span class="line">##### Node</span><br><span class="line">代表动画和其依赖。其包含一个动画信息，节点动画依赖集合，独立节点集合</span><br><span class="line"></span><br><span class="line">##### Dependency</span><br><span class="line">动画节点与节点之间的依赖描述</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WITH</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// dependent node must start with this dependency node</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">AFTER</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// dependent node must start when this dependency node finishes</span></span><br></pre></td></tr></table></figure>
<ul>
<li>包含两个规则，一起，后续</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//多个动画一起播放，添加动画``WITH``依赖</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">playTogether</span><span class="params">(Animator... items)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span>) &#123;</span><br><span class="line">            mNeedsSort = <span class="literal">true</span>;</span><br><span class="line">            <span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> play(items[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; items.length; ++i) &#123;</span><br><span class="line">                builder.with(items[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> Builder <span class="title function_">with</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodeMap.get(anim);</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">                node = <span class="keyword">new</span> <span class="title class_">Node</span>(anim);</span><br><span class="line">                mNodeMap.put(anim, node);</span><br><span class="line">                mNodes.add(node);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dependency</span>(mCurrentNode, Dependency.WITH);</span><br><span class="line">            node.addDependency(dependency);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//多个动画串行播放        </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">playSequentially</span><span class="params">(Animator... items)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span>) &#123;</span><br><span class="line">            mNeedsSort = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (items.length == <span class="number">1</span>) &#123;</span><br><span class="line">                play(items[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mReversible = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; items.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">                    play(items[i]).before(items[i+<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//在某个动画之前播放，添加``AFTER``依赖</span></span><br><span class="line"><span class="keyword">public</span> Builder <span class="title function_">before</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">            mReversible = <span class="literal">false</span>;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodeMap.get(anim);</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">                node = <span class="keyword">new</span> <span class="title class_">Node</span>(anim);</span><br><span class="line">                mNodeMap.put(anim, node);</span><br><span class="line">                mNodes.add(node);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dependency</span>(mCurrentNode, Dependency.AFTER);</span><br><span class="line">            node.addDependency(dependency);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;                </span><br></pre></td></tr></table></figure>

<h4 id="LayoutTransition"><a href="#LayoutTransition" class="headerlink" title="LayoutTransition"></a>LayoutTransition</h4><p><code>ViewGroup</code>布局发生改变时播放动画。这个动画的核心概念是两个类型的改变会引起四种不同的动画运行。这两种改变时<code>appearing</code>和<code>disappearing</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ViewGroup</span><br><span class="line"><span class="title function_">setLayoutTransition</span><span class="params">(LayoutTransition transition)</span></span><br></pre></td></tr></table></figure>
<p>动画类型，用一个字节表示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_APPEARING</span>             <span class="operator">=</span> <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_DISAPPEARING</span>          <span class="operator">=</span> <span class="number">0x02</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_CHANGE_APPEARING</span>      <span class="operator">=</span> <span class="number">0x04</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_CHANGE_DISAPPEARING</span>   <span class="operator">=</span> <span class="number">0x08</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_CHANGING</span>              <span class="operator">=</span> <span class="number">0x10</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">mTransitionTypes</span> <span class="operator">=</span> FLAG_CHANGE_APPEARING | FLAG_CHANGE_DISAPPEARING |</span><br><span class="line">            FLAG_APPEARING | FLAG_DISAPPEARING;</span><br><span class="line">            </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupChangeAnimation</span><span class="params">(<span class="keyword">final</span> ViewGroup parent, <span class="keyword">final</span> <span class="type">int</span> changeReason,</span></span><br><span class="line"><span class="params">            Animator baseAnimator, <span class="keyword">final</span> <span class="type">long</span> duration, <span class="keyword">final</span> View child)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we already have a listener for this child, then we&#x27;ve already set up the</span></span><br><span class="line">        <span class="comment">// changing animation we need. Multiple calls for a child may occur when several</span></span><br><span class="line">        <span class="comment">// add/remove operations are run at once on a container; each one will trigger</span></span><br><span class="line">        <span class="comment">// changes for the existing children in the container.</span></span><br><span class="line">        <span class="keyword">if</span> (layoutChangeListenerMap.get(child) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don&#x27;t animate items up from size(0,0); this is likely because the objects</span></span><br><span class="line">        <span class="comment">// were offscreen/invisible or otherwise measured to be infinitely small. We don&#x27;t</span></span><br><span class="line">        <span class="comment">// want to see them animate into their real size; just ignore animation requests</span></span><br><span class="line">        <span class="comment">// on these views</span></span><br><span class="line">        <span class="keyword">if</span> (child.getWidth() == <span class="number">0</span> &amp;&amp; child.getHeight() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make a copy of the appropriate animation</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Animator</span> <span class="variable">anim</span> <span class="operator">=</span> baseAnimator.clone();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the target object for the animation</span></span><br><span class="line">        anim.setTarget(child);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// A ObjectAnimator (or AnimatorSet of them) can extract start values from</span></span><br><span class="line">        <span class="comment">// its target object</span></span><br><span class="line">        anim.setupStartValues();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there&#x27;s an animation running on this view already, cancel it</span></span><br><span class="line">        <span class="type">Animator</span> <span class="variable">currentAnimation</span> <span class="operator">=</span> pendingAnimations.get(child);</span><br><span class="line">        <span class="keyword">if</span> (currentAnimation != <span class="literal">null</span>) &#123;</span><br><span class="line">            currentAnimation.cancel();</span><br><span class="line">            pendingAnimations.remove(child);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Cache the animation in case we need to cancel it later</span></span><br><span class="line">        pendingAnimations.put(child, anim);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For the animations which don&#x27;t get started, we have to have a means of</span></span><br><span class="line">        <span class="comment">// removing them from the cache, lest we leak them and their target objects.</span></span><br><span class="line">        <span class="comment">// We run an animator for the default duration+100 (an arbitrary time, but one</span></span><br><span class="line">        <span class="comment">// which should far surpass the delay between setting them up here and</span></span><br><span class="line">        <span class="comment">// handling layout events which start them.</span></span><br><span class="line">        <span class="type">ValueAnimator</span> <span class="variable">pendingAnimRemover</span> <span class="operator">=</span> ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>).</span><br><span class="line">                setDuration(duration + <span class="number">100</span>);</span><br><span class="line">        pendingAnimRemover.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                pendingAnimations.remove(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        pendingAnimRemover.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add a listener to track layout changes on this view. If we don&#x27;t get a callback,</span></span><br><span class="line">        <span class="comment">// then there&#x27;s nothing to animate.</span></span><br><span class="line">        <span class="keyword">final</span> View.<span class="type">OnLayoutChangeListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">View</span>.OnLayoutChangeListener() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLayoutChange</span><span class="params">(View v, <span class="type">int</span> left, <span class="type">int</span> top, <span class="type">int</span> right, <span class="type">int</span> bottom,</span></span><br><span class="line"><span class="params">                    <span class="type">int</span> oldLeft, <span class="type">int</span> oldTop, <span class="type">int</span> oldRight, <span class="type">int</span> oldBottom)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Tell the animation to extract end values from the changed object</span></span><br><span class="line">                anim.setupEndValues();</span><br><span class="line">                <span class="keyword">if</span> (anim <span class="keyword">instanceof</span> ValueAnimator) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">valuesDiffer</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                    <span class="type">ValueAnimator</span> <span class="variable">valueAnim</span> <span class="operator">=</span> (ValueAnimator)anim;</span><br><span class="line">                    PropertyValuesHolder[] oldValues = valueAnim.getValues();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; oldValues.length; ++i) &#123;</span><br><span class="line">                        <span class="type">PropertyValuesHolder</span> <span class="variable">pvh</span> <span class="operator">=</span> oldValues[i];</span><br><span class="line">                        <span class="keyword">if</span> (pvh.mKeyframes <span class="keyword">instanceof</span> KeyframeSet) &#123;</span><br><span class="line">                            <span class="type">KeyframeSet</span> <span class="variable">keyframeSet</span> <span class="operator">=</span> (KeyframeSet) pvh.mKeyframes;</span><br><span class="line">                            <span class="keyword">if</span> (keyframeSet.mFirstKeyframe == <span class="literal">null</span> ||</span><br><span class="line">                                    keyframeSet.mLastKeyframe == <span class="literal">null</span> ||</span><br><span class="line">                                    !keyframeSet.mFirstKeyframe.getValue().equals(</span><br><span class="line">                                            keyframeSet.mLastKeyframe.getValue())) &#123;</span><br><span class="line">                                valuesDiffer = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pvh.mKeyframes.getValue(<span class="number">0</span>).equals(pvh.mKeyframes.getValue(<span class="number">1</span>))) &#123;</span><br><span class="line">                            valuesDiffer = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!valuesDiffer) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">long</span> <span class="variable">startDelay</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">switch</span> (changeReason) &#123;</span><br><span class="line">                    <span class="keyword">case</span> APPEARING:</span><br><span class="line">                        startDelay = mChangingAppearingDelay + staggerDelay;</span><br><span class="line">                        staggerDelay += mChangingAppearingStagger;</span><br><span class="line">                        <span class="keyword">if</span> (mChangingAppearingInterpolator != sChangingAppearingInterpolator) &#123;</span><br><span class="line">                            anim.setInterpolator(mChangingAppearingInterpolator);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> DISAPPEARING:</span><br><span class="line">                        startDelay = mChangingDisappearingDelay + staggerDelay;</span><br><span class="line">                        staggerDelay += mChangingDisappearingStagger;</span><br><span class="line">                        <span class="keyword">if</span> (mChangingDisappearingInterpolator !=</span><br><span class="line">                                sChangingDisappearingInterpolator) &#123;</span><br><span class="line">                            anim.setInterpolator(mChangingDisappearingInterpolator);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> CHANGING:</span><br><span class="line">                        startDelay = mChangingDelay + staggerDelay;</span><br><span class="line">                        staggerDelay += mChangingStagger;</span><br><span class="line">                        <span class="keyword">if</span> (mChangingInterpolator != sChangingInterpolator) &#123;</span><br><span class="line">                            anim.setInterpolator(mChangingInterpolator);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                anim.setStartDelay(startDelay);</span><br><span class="line">                anim.setDuration(duration);</span><br><span class="line"></span><br><span class="line">                <span class="type">Animator</span> <span class="variable">prevAnimation</span> <span class="operator">=</span> currentChangingAnimations.get(child);</span><br><span class="line">                <span class="keyword">if</span> (prevAnimation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    prevAnimation.cancel();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Animator</span> <span class="variable">pendingAnimation</span> <span class="operator">=</span> pendingAnimations.get(child);</span><br><span class="line">                <span class="keyword">if</span> (pendingAnimation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    pendingAnimations.remove(child);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Cache the animation in case we need to cancel it later</span></span><br><span class="line">                currentChangingAnimations.put(child, anim);</span><br><span class="line"></span><br><span class="line">                parent.requestTransitionStart(LayoutTransition.<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this only removes listeners whose views changed - must clear the</span></span><br><span class="line">                <span class="comment">// other listeners later</span></span><br><span class="line">                child.removeOnLayoutChangeListener(<span class="built_in">this</span>);</span><br><span class="line">                layoutChangeListenerMap.remove(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// Remove the animation from the cache when it ends</span></span><br><span class="line">        anim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationStart</span><span class="params">(Animator animator)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (hasListeners()) &#123;</span><br><span class="line">                    ArrayList&lt;TransitionListener&gt; listeners =</span><br><span class="line">                            (ArrayList&lt;TransitionListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">for</span> (TransitionListener listener : listeners) &#123;</span><br><span class="line">                        listener.startTransition(LayoutTransition.<span class="built_in">this</span>, parent, child,</span><br><span class="line">                                changeReason == APPEARING ?</span><br><span class="line">                                        CHANGE_APPEARING : changeReason == DISAPPEARING ?</span><br><span class="line">                                        CHANGE_DISAPPEARING : CHANGING);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationCancel</span><span class="params">(Animator animator)</span> &#123;</span><br><span class="line">                child.removeOnLayoutChangeListener(listener);</span><br><span class="line">                layoutChangeListenerMap.remove(child);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animator)</span> &#123;</span><br><span class="line">                currentChangingAnimations.remove(child);</span><br><span class="line">                <span class="keyword">if</span> (hasListeners()) &#123;</span><br><span class="line">                    ArrayList&lt;TransitionListener&gt; listeners =</span><br><span class="line">                            (ArrayList&lt;TransitionListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">for</span> (TransitionListener listener : listeners) &#123;</span><br><span class="line">                        listener.endTransition(LayoutTransition.<span class="built_in">this</span>, parent, child,</span><br><span class="line">                                changeReason == APPEARING ?</span><br><span class="line">                                        CHANGE_APPEARING : changeReason == DISAPPEARING ?</span><br><span class="line">                                        CHANGE_DISAPPEARING : CHANGING);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        child.addOnLayoutChangeListener(listener);</span><br><span class="line">        <span class="comment">// cache the listener for later removal</span></span><br><span class="line">        layoutChangeListenerMap.put(child, listener);</span><br><span class="line">    &#125;            </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>主要流程<ol>
<li>启动一个延时动画来移除为执行的动画</li>
<li>监听布局变化,如果是<code>ValueAnimator</code>，判断起始帧和结束帧是否一样，如果一样表示结束.否则根据布局改变的原因设置动画类型，开始动画</li>
<li>移除缓存动画</li>
</ol>
</li>
</ul>
<h4 id="ViewPropertyAnimator"><a href="#ViewPropertyAnimator" class="headerlink" title="ViewPropertyAnimator"></a>ViewPropertyAnimator</h4><p>自动优化<code>View</code>对象的属性动画。如果想做1个或者两个属性动画，使用<code>ObjectAnimator</code>，其也可以设置属性值，合理的刷新视图。但是如果有多个属性要同时动画，或者想要使用更简洁的语法，那么可以使用<code>ViewPropertyAnimator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">animateProperty</span><span class="params">(<span class="type">int</span> constantName, <span class="type">float</span> toValue)</span> &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">fromValue</span> <span class="operator">=</span> getValue(constantName);</span><br><span class="line">        <span class="type">float</span> <span class="variable">deltaValue</span> <span class="operator">=</span> toValue - fromValue;</span><br><span class="line">        animatePropertyBy(constantName, fromValue, deltaValue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">animatePropertyBy</span><span class="params">(<span class="type">int</span> constantName, <span class="type">float</span> startValue, <span class="type">float</span> byValue)</span> &#123;</span><br><span class="line">        <span class="comment">// First, cancel any existing animations on this property</span></span><br><span class="line">        <span class="keyword">if</span> (mAnimatorMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Animator</span> <span class="variable">animatorToCancel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            Set&lt;Animator&gt; animatorSet = mAnimatorMap.keySet();</span><br><span class="line">            <span class="keyword">for</span> (Animator runningAnim : animatorSet) &#123;</span><br><span class="line">                <span class="type">PropertyBundle</span> <span class="variable">bundle</span> <span class="operator">=</span> mAnimatorMap.get(runningAnim);</span><br><span class="line">                <span class="keyword">if</span> (bundle.cancel(constantName)) &#123;</span><br><span class="line">                    <span class="comment">// property was canceled - cancel the animation if it&#x27;s now empty</span></span><br><span class="line">                    <span class="comment">// Note that it&#x27;s safe to break out here because every new animation</span></span><br><span class="line">                    <span class="comment">// on a property will cancel a previous animation on that property, so</span></span><br><span class="line">                    <span class="comment">// there can only ever be one such animation running.</span></span><br><span class="line">                    <span class="keyword">if</span> (bundle.mPropertyMask == NONE) &#123;</span><br><span class="line">                        <span class="comment">// the animation is no longer changing anything - cancel it</span></span><br><span class="line">                        animatorToCancel = runningAnim;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (animatorToCancel != <span class="literal">null</span>) &#123;</span><br><span class="line">                animatorToCancel.cancel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">NameValuesHolder</span> <span class="variable">nameValuePair</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NameValuesHolder</span>(constantName, startValue, byValue);</span><br><span class="line">        mPendingAnimations.add(nameValuePair);</span><br><span class="line">        mView.removeCallbacks(mAnimationStarter);</span><br><span class="line">        mView.postOnAnimation(mAnimationStarter);</span><br><span class="line">    &#125;    </span><br></pre></td></tr></table></figure>

<ul>
<li>上述流程, 做属性动画都会调用<code>animateProperty</code>，其内部会调用<code>animatePropertyBy</code><ol>
<li>首先会取消这个属性上存在的动画</li>
<li>构建<code>NameValuesHolder</code></li>
<li>调用<code>removeCallbacks(runnable)</code>，取消之前动画</li>
<li>调用<code>postOnAnimation(runnable)</code>，开始动画</li>
</ol>
</li>
</ul>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>主要用于做转场动画，其会保存场景转变的信息。任何转变有两个主要工作: 1. 捕获属性值 2. 基于捕获的属性值改变做动画。**无法与<code>TextureView</code>和<code>SurfaceView</code>一起使用。对于<code>SurfaceView</code>，由于其是从非UI线程更新UI，因此会造成不同步。对于<code>TextureView</code>，由于转场动画依赖<code>ViewOverlay</code>，而其又无法与<code>TextureView</code>一起工作。</p>
<h4 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h4><p><img data-src="/./transition.png" alt="transition"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Transition.java</span><br><span class="line"></span><br><span class="line"><span class="comment">//捕获开始场景的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//捕获结束场景的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">captureEndValues</span><span class="params">(TransitionValues transitionValues)</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="开始转场动画"><a href="#开始转场动画" class="headerlink" title="开始转场动画"></a>开始转场动画</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">beginDelayedTransition</span><span class="params">(<span class="keyword">final</span> ViewGroup sceneRoot, Transition transition)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!sPendingTransitions.contains(sceneRoot) &amp;&amp; sceneRoot.isLaidOut()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Transition.DBG) &#123;</span><br><span class="line">                Log.d(LOG_TAG, <span class="string">&quot;beginDelayedTransition: root, transition = &quot;</span> +</span><br><span class="line">                        sceneRoot + <span class="string">&quot;, &quot;</span> + transition);</span><br><span class="line">            &#125;</span><br><span class="line">            sPendingTransitions.add(sceneRoot);</span><br><span class="line">            <span class="keyword">if</span> (transition == <span class="literal">null</span>) &#123;</span><br><span class="line">                transition = sDefaultTransition;<span class="comment">//使用默认转场</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Transition</span> <span class="variable">transitionClone</span> <span class="operator">=</span> transition.clone();</span><br><span class="line">            sceneChangeSetup(sceneRoot, transitionClone);</span><br><span class="line">            Scene.setCurrentScene(sceneRoot, <span class="literal">null</span>);</span><br><span class="line">            sceneChangeRunTransition(sceneRoot, transitionClone);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sceneChangeSetup</span><span class="params">(ViewGroup sceneRoot, Transition transition)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Capture current values</span></span><br><span class="line">        ArrayList&lt;Transition&gt; runningTransitions = getRunningTransitions().get(sceneRoot);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runningTransitions != <span class="literal">null</span> &amp;&amp; runningTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Transition runningTransition : runningTransitions) &#123;</span><br><span class="line">                runningTransition.pause(sceneRoot);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (transition != <span class="literal">null</span>) &#123;</span><br><span class="line">            transition.captureValues(sceneRoot, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Notify previous scene that it is being exited</span></span><br><span class="line">        <span class="type">Scene</span> <span class="variable">previousScene</span> <span class="operator">=</span> Scene.getCurrentScene(sceneRoot);</span><br><span class="line">        <span class="keyword">if</span> (previousScene != <span class="literal">null</span>) &#123;</span><br><span class="line">            previousScene.exit();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sceneChangeRunTransition</span><span class="params">(<span class="keyword">final</span> ViewGroup sceneRoot,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> Transition transition)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (transition != <span class="literal">null</span> &amp;&amp; sceneRoot != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">MultiListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiListener</span>(transition, sceneRoot);</span><br><span class="line">            sceneRoot.addOnAttachStateChangeListener(listener);</span><br><span class="line">            <span class="comment">//设置绘制前监听</span></span><br><span class="line">            sceneRoot.getViewTreeObserver().addOnPreDrawListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<ul>
<li>流程<ol>
<li>未设置<code>Transition</code>，使用默认<code>Transition</code>，也就是<code>AutoTransition</code></li>
<li>暂停当前正在运行的转场动画，捕获当前场景，取消之前的转场动画</li>
<li>设置当前场景</li>
<li>设置绘制(<code>preDraw</code>)监听，在其当中捕获场景和开始转场动画</li>
</ol>
</li>
</ul>
<h5 id="AutoTransition"><a href="#AutoTransition" class="headerlink" title="AutoTransition"></a>AutoTransition</h5><p>组合转场动画，包括渐变和区域改变。<code>Transition</code>由<code>TransitionManger</code>管理。一般可以使用<code>beginDelayedTransition</code>开始一个转场动画，默认的转场动画为<code>AutoTransition</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TransitionManager.beginDelayedTransition(transitionGroup);</span><br><span class="line"></span><br><span class="line">textView.setVisibility(visible ? View.VISIBLE : View.GONE);</span><br></pre></td></tr></table></figure>

<p>效果如下:</p>

<img data-src="./autotransition.gif" alt="autotransition" width="200" />


<h6 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h6><blockquote>
<p>继承自TransitionSet</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        setOrdering(ORDERING_SEQUENTIAL);</span><br><span class="line">        addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.OUT)).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">ChangeBounds</span>()).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.IN));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>顺序播放渐出，区域变化，渐入动画</li>
</ul>
<h5 id="TransitionSet"><a href="#TransitionSet" class="headerlink" title="TransitionSet"></a>TransitionSet</h5><blockquote>
<p>继承自Transition</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Transition childTransition : mTransitions) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childTransition.isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">                    childTransition.captureStartValues(transitionValues);</span><br><span class="line">                    transitionValues.targetedTransitions.add(childTransition);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captureEndValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Transition childTransition : mTransitions) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childTransition.isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">                    childTransition.captureEndValues(transitionValues);</span><br><span class="line">                    transitionValues.targetedTransitions.add(childTransition);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用各个<code>Transition</code>的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">createAnimators</span><span class="params">(ViewGroup sceneRoot, TransitionValuesMaps startValues,</span></span><br><span class="line"><span class="params">            TransitionValuesMaps endValues, ArrayList&lt;TransitionValues&gt; startValuesList,</span></span><br><span class="line"><span class="params">            ArrayList&lt;TransitionValues&gt; endValuesList)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startDelay</span> <span class="operator">=</span> getStartDelay();</span><br><span class="line">        <span class="type">int</span> <span class="variable">numTransitions</span> <span class="operator">=</span> mTransitions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numTransitions; i++) &#123;</span><br><span class="line">            <span class="type">Transition</span> <span class="variable">childTransition</span> <span class="operator">=</span> mTransitions.get(i);</span><br><span class="line">            <span class="comment">// We only set the start delay on the first transition if we are playing</span></span><br><span class="line">            <span class="comment">// the transitions sequentially.</span></span><br><span class="line">            <span class="keyword">if</span> (startDelay &gt; <span class="number">0</span> &amp;&amp; (mPlayTogether || i == <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">childStartDelay</span> <span class="operator">=</span> childTransition.getStartDelay();</span><br><span class="line">                <span class="keyword">if</span> (childStartDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    childTransition.setStartDelay(startDelay + childStartDelay);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    childTransition.setStartDelay(startDelay);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            childTransition.createAnimators(sceneRoot, startValues, endValues, startValuesList,</span><br><span class="line">                    endValuesList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用各自<code>Transition</code>创建动画。为第一个转场动画设置必要的延时</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">runAnimators</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTransitions.isEmpty()) &#123;</span><br><span class="line">            start();</span><br><span class="line">            end();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setupStartEndListeners();</span><br><span class="line">        <span class="type">int</span> <span class="variable">numTransitions</span> <span class="operator">=</span> mTransitions.size();</span><br><span class="line">        <span class="keyword">if</span> (!mPlayTogether) &#123;</span><br><span class="line">        <span class="comment">//串行播放动画</span></span><br><span class="line">            <span class="comment">// Setup sequence with listeners</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Need to add listeners in such a way that we can remove them later if canceled</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; numTransitions; ++i) &#123;</span><br><span class="line">                <span class="type">Transition</span> <span class="variable">previousTransition</span> <span class="operator">=</span> mTransitions.get(i - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Transition</span> <span class="variable">nextTransition</span> <span class="operator">=</span> mTransitions.get(i);</span><br><span class="line">                previousTransition.addListener(<span class="keyword">new</span> <span class="title class_">TransitionListenerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionEnd</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                        nextTransition.runAnimators();</span><br><span class="line">                        transition.removeListener(<span class="built_in">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Transition</span> <span class="variable">firstTransition</span> <span class="operator">=</span> mTransitions.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (firstTransition != <span class="literal">null</span>) &#123;</span><br><span class="line">                firstTransition.runAnimators();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//并行播放动画</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numTransitions; ++i) &#123;</span><br><span class="line">                mTransitions.get(i).runAnimators();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>动画开始，由各个<code>Transition</code>开始动画，在这里会区分动画是串行播放，还是并行播放。</li>
</ul>
<h5 id="ChangeText-自定义transition"><a href="#ChangeText-自定义transition" class="headerlink" title="ChangeText(自定义transition)"></a>ChangeText(自定义transition)</h5>
<img data-src="./changetext.gif" alt="autotransition" width="200" />


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">textView.animate().alpha(<span class="number">0f</span>).setListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                       textView.setText(mSecondText ? TEXT_2 : TEXT_1);</span><br><span class="line">                       textView.animate().setListener(<span class="literal">null</span>);</span><br><span class="line">                       textView.animate().alpha(<span class="number">1f</span>).start();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;).start();</span><br></pre></td></tr></table></figure>
<ul>
<li>上述代码也能实现相同的功能，<code>ChangeText</code>只是对其进行了进一步的封装。这里不分析其源码</li>
</ul>
<h5 id="ChangeBound"><a href="#ChangeBound" class="headerlink" title="ChangeBound"></a>ChangeBound</h5>
<img data-src="./changebound.gif" alt="autotransition" width="200" />


<h6 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h6><blockquote>
<p>继承<code>Transition</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">captureValues</span><span class="params">(TransitionValues values)</span> &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> values.view;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (view.isLaidOut() || view.getWidth() != <span class="number">0</span> || view.getHeight() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//view已经布局完毕，保存当前view边界状态</span></span><br><span class="line">            values.values.put(PROPNAME_BOUNDS, <span class="keyword">new</span> <span class="title class_">Rect</span>(view.getLeft(), view.getTop(),</span><br><span class="line">                    view.getRight(), view.getBottom()));</span><br><span class="line">            values.values.put(PROPNAME_PARENT, values.view.getParent());</span><br><span class="line">            <span class="keyword">if</span> (mReparent) &#123;</span><br><span class="line">            <span class="comment">//如果动画scene的parent一样，记录当前屏幕位置</span></span><br><span class="line">                values.view.getLocationInWindow(tempLocation);</span><br><span class="line">                values.values.put(PROPNAME_WINDOW_X, tempLocation[<span class="number">0</span>]);</span><br><span class="line">                values.values.put(PROPNAME_WINDOW_Y, tempLocation[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mResizeClip) &#123;</span><br><span class="line">                values.values.put(PROPNAME_CLIP, view.getClipBounds());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>保存当前<code>View</code>的边界状态</li>
</ul>
<blockquote>
<p>创建动画，代码很长，核心代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (numChanges &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Animator anim;</span><br><span class="line">                <span class="keyword">if</span> (!mResizeClip) &#123;</span><br><span class="line">                    view.setLeftTopRightBottom(startLeft, startTop, startRight, startBottom);</span><br><span class="line">                    <span class="keyword">if</span> (numChanges == <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (startWidth == endWidth &amp;&amp; startHeight == endHeight) &#123;</span><br><span class="line">                            <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop, endLeft,</span><br><span class="line">                                    endTop);</span><br><span class="line">                            anim = ObjectAnimator.ofObject(view, POSITION_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                    topLeftPath);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">ViewBounds</span> <span class="variable">viewBounds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ViewBounds</span>(view);</span><br><span class="line">                            <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop,</span><br><span class="line">                                    endLeft, endTop);</span><br><span class="line">                            <span class="type">ObjectAnimator</span> <span class="variable">topLeftAnimator</span> <span class="operator">=</span> ObjectAnimator</span><br><span class="line">                                    .ofObject(viewBounds, TOP_LEFT_PROPERTY, <span class="literal">null</span>, topLeftPath);</span><br><span class="line"></span><br><span class="line">                            <span class="type">Path</span> <span class="variable">bottomRightPath</span> <span class="operator">=</span> getPathMotion().getPath(startRight, startBottom,</span><br><span class="line">                                    endRight, endBottom);</span><br><span class="line">                            <span class="type">ObjectAnimator</span> <span class="variable">bottomRightAnimator</span> <span class="operator">=</span> ObjectAnimator.ofObject(viewBounds,</span><br><span class="line">                                    BOTTOM_RIGHT_PROPERTY, <span class="literal">null</span>, bottomRightPath);</span><br><span class="line">                            <span class="type">AnimatorSet</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnimatorSet</span>();</span><br><span class="line">                            set.playTogether(topLeftAnimator, bottomRightAnimator);</span><br><span class="line">                            anim = set;</span><br><span class="line">                            set.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                                <span class="comment">// We need a strong reference to viewBounds until the</span></span><br><span class="line">                                <span class="comment">// animator ends.</span></span><br><span class="line">                                <span class="keyword">private</span> <span class="type">ViewBounds</span> <span class="variable">mViewBounds</span> <span class="operator">=</span> viewBounds;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (startLeft != endLeft || startTop != endTop) &#123;</span><br><span class="line">                        <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop,</span><br><span class="line">                                endLeft, endTop);</span><br><span class="line">                        anim = ObjectAnimator.ofObject(view, TOP_LEFT_ONLY_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                topLeftPath);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">Path</span> <span class="variable">bottomRight</span> <span class="operator">=</span> getPathMotion().getPath(startRight, startBottom,</span><br><span class="line">                                endRight, endBottom);</span><br><span class="line">                        anim = ObjectAnimator.ofObject(view, BOTTOM_RIGHT_ONLY_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                bottomRight);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">maxWidth</span> <span class="operator">=</span> Math.max(startWidth, endWidth);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">maxHeight</span> <span class="operator">=</span> Math.max(startHeight, endHeight);</span><br><span class="line"></span><br><span class="line">                    view.setLeftTopRightBottom(startLeft, startTop, startLeft + maxWidth,</span><br><span class="line">                            startTop + maxHeight);</span><br><span class="line"></span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">positionAnimator</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (startLeft != endLeft || startTop != endTop) &#123;</span><br><span class="line">                        <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop, endLeft,</span><br><span class="line">                                endTop);</span><br><span class="line">                        positionAnimator = ObjectAnimator.ofObject(view, POSITION_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                topLeftPath);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Rect</span> <span class="variable">finalClip</span> <span class="operator">=</span> endClip;</span><br><span class="line">                    <span class="keyword">if</span> (startClip == <span class="literal">null</span>) &#123;</span><br><span class="line">                        startClip = <span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, startWidth, startHeight);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (endClip == <span class="literal">null</span>) &#123;</span><br><span class="line">                        endClip = <span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, endWidth, endHeight);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">clipAnimator</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!startClip.equals(endClip)) &#123;</span><br><span class="line">                        view.setClipBounds(startClip);</span><br><span class="line">                        clipAnimator = ObjectAnimator.ofObject(view, <span class="string">&quot;clipBounds&quot;</span>, sRectEvaluator,</span><br><span class="line">                                startClip, endClip);</span><br><span class="line">                        clipAnimator.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                            <span class="keyword">private</span> <span class="type">boolean</span> mIsCanceled;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationCancel</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                                mIsCanceled = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!mIsCanceled) &#123;</span><br><span class="line">                                    view.setClipBounds(finalClip);</span><br><span class="line">                                    view.setLeftTopRightBottom(endLeft, endTop, endRight,</span><br><span class="line">                                            endBottom);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    anim = TransitionUtils.mergeAnimators(positionAnimator,</span><br><span class="line">                            clipAnimator);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (view.getParent() <span class="keyword">instanceof</span> ViewGroup) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">ViewGroup</span> <span class="variable">parent</span> <span class="operator">=</span> (ViewGroup) view.getParent();</span><br><span class="line">                    parent.suppressLayout(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">TransitionListener</span> <span class="variable">transitionListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransitionListenerAdapter</span>() &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">mCanceled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionCancel</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            parent.suppressLayout(<span class="literal">false</span>);</span><br><span class="line">                            mCanceled = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionEnd</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!mCanceled) &#123;</span><br><span class="line">                                parent.suppressLayout(<span class="literal">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionPause</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            parent.suppressLayout(<span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionResume</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            parent.suppressLayout(<span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    addListener(transitionListener);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> anim;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sceneRoot.getLocationInWindow(tempLocation);</span><br><span class="line">            <span class="type">int</span> <span class="variable">startX</span> <span class="operator">=</span> (Integer) startValues.values.get(PROPNAME_WINDOW_X) - tempLocation[<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">startY</span> <span class="operator">=</span> (Integer) startValues.values.get(PROPNAME_WINDOW_Y) - tempLocation[<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">endX</span> <span class="operator">=</span> (Integer) endValues.values.get(PROPNAME_WINDOW_X) - tempLocation[<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">endY</span> <span class="operator">=</span> (Integer) endValues.values.get(PROPNAME_WINDOW_Y) - tempLocation[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> also handle size changes: check bounds and animate size changes</span></span><br><span class="line">            <span class="keyword">if</span> (startX != endX || startY != endY) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> view.getWidth();</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> view.getHeight();</span><br><span class="line">                <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">                <span class="type">Canvas</span> <span class="variable">canvas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(bitmap);</span><br><span class="line">                view.draw(canvas);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">BitmapDrawable</span> <span class="variable">drawable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BitmapDrawable</span>(bitmap);</span><br><span class="line">                drawable.setBounds(startX, startY, startX + width, startY + height);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">float</span> <span class="variable">transitionAlpha</span> <span class="operator">=</span> view.getTransitionAlpha();</span><br><span class="line">                view.setTransitionAlpha(<span class="number">0</span>);</span><br><span class="line">                sceneRoot.getOverlay().add(drawable);</span><br><span class="line">                <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startX, startY, endX, endY);</span><br><span class="line">                <span class="type">PropertyValuesHolder</span> <span class="variable">origin</span> <span class="operator">=</span> PropertyValuesHolder.ofObject(</span><br><span class="line">                        DRAWABLE_ORIGIN_PROPERTY, <span class="literal">null</span>, topLeftPath);</span><br><span class="line">                <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> ObjectAnimator.ofPropertyValuesHolder(drawable, origin);</span><br><span class="line">                anim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                        sceneRoot.getOverlay().remove(drawable);</span><br><span class="line">                        view.setTransitionAlpha(transitionAlpha);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> anim;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主要功能是判断<code>View</code>的边界有没有发生改变，如果发生改变，使用对应的位置变化动画，主要包括<code>topLeft, bottomRight, position</code>。如果没有发生改变，则在<code>View</code>上绘制<code>Overlay</code>并对其做<code>path</code>动画。</li>
</ul>
<p>设置<code>pathMotion</code></p>
<blockquote>
<p>其是一个抽象类，用于描述<code>Transition</code>的<code>Path</code>信息</p>
</blockquote>

<img data-src="./changebound_pathmotion.gif" alt="autotransition" width="200" />


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">PathMotion</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PathMotion</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PathMotion</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Provide a Path to interpolate between two points &lt;code&gt;(startX, startY)&lt;/code&gt; and</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;(endX, endY)&lt;/code&gt;. This allows controlled curved motion along two dimensions.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startX The x coordinate of the starting point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startY The y coordinate of the starting point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endX   The x coordinate of the ending point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endY   The y coordinate of the ending point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A Path along which the points should be interpolated. The returned Path</span></span><br><span class="line"><span class="comment">     * must start at point &lt;code&gt;(startX, startY)&lt;/code&gt;, typically using</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> android.graphics.Path#moveTo(float, float)&#125; and end at &lt;code&gt;(endX, endY)&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Path <span class="title function_">getPath</span><span class="params">(<span class="type">float</span> startX, <span class="type">float</span> startY, <span class="type">float</span> endX, <span class="type">float</span> endY)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现<code>getPath</code>以便提供两点之间的变化频率</li>
</ul>
<h5 id="Slide"><a href="#Slide" class="headerlink" title="Slide"></a>Slide</h5><blockquote>
<p>继承自<code>Visibility</code></p>
</blockquote>

<img data-src="./slide.gif" alt="autotransition" width="200" />


<h6 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">captureValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> transitionValues.view;</span><br><span class="line">        <span class="type">int</span>[] position = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];</span><br><span class="line">        view.getLocationOnScreen(position);</span><br><span class="line">        transitionValues.values.put(PROPNAME_SCREEN_POSITION, position);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>保存当前<code>View</code>位置</li>
</ul>
<blockquote>
<p>其<code>createAnimator</code>在父类<code>Visibility</code>中被重写，当中调用<code>onAppear</code>和<code>onDisappear</code>，这两个方法分别有各自的重载方法，由子类提供具体的实现，默认无动画</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span><br><span class="line"><span class="params">            TransitionValues startValues, TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (endValues == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span>[] position = (<span class="type">int</span>[]) endValues.values.get(PROPNAME_SCREEN_POSITION);</span><br><span class="line">        <span class="type">float</span> <span class="variable">endX</span> <span class="operator">=</span> view.getTranslationX();</span><br><span class="line">        <span class="type">float</span> <span class="variable">endY</span> <span class="operator">=</span> view.getTranslationY();</span><br><span class="line">        <span class="type">float</span> <span class="variable">startX</span> <span class="operator">=</span> mSlideCalculator.getGoneX(sceneRoot, view);</span><br><span class="line">        <span class="type">float</span> <span class="variable">startY</span> <span class="operator">=</span> mSlideCalculator.getGoneY(sceneRoot, view);</span><br><span class="line">        <span class="keyword">return</span> TranslationAnimationCreator</span><br><span class="line">                .createAnimation(view, endValues, position[<span class="number">0</span>], position[<span class="number">1</span>],</span><br><span class="line">                        startX, startY, endX, endY, sDecelerate, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>CalculateSlide</code>接口的实现计算<code>View</code>离开或者进入场景时的位置，最后由<code>TranslationAnimationCreator</code>创建动画</li>
</ul>
<h5 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h5>
<img data-src="./scale.gif" alt="autotransition" width="200" />


<p>设置<code>alpha</code></p>

<img data-src="./scale_alpha.gif" alt="autotransition" width="200" />


<h6 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h6><p>private Animator createAnimation(final View view, float startScale, float endScale, TransitionValues values) {<br>        final float initialScaleX &#x3D; view.getScaleX();<br>        final float initialScaleY &#x3D; view.getScaleY();<br>        float startScaleX &#x3D; initialScaleX * startScale;<br>        float endScaleX &#x3D; initialScaleX * endScale;<br>        float startScaleY &#x3D; initialScaleY * startScale;<br>        float endScaleY &#x3D; initialScaleY * endScale;</p>
<pre><code>    if (values != null) &#123;
        Float savedScaleX = (Float) values.values.get(PROPNAME_SCALE_X);
        Float savedScaleY = (Float) values.values.get(PROPNAME_SCALE_Y);
        // if saved value is not equal initial value it means that previous
        // transition was interrupted and in the onTransitionEnd
        // we&#39;ve applied endScale. we should apply proper value to
        // continue animation from the interrupted state
        if (savedScaleX != null &amp;&amp; savedScaleX != initialScaleX) &#123;
            startScaleX = savedScaleX;
        &#125;
        if (savedScaleY != null &amp;&amp; savedScaleY != initialScaleY) &#123;
            startScaleY = savedScaleY;
        &#125;
    &#125;

    view.setScaleX(startScaleX);
    view.setScaleY(startScaleY);

    Animator animator = TransitionUtils.mergeAnimators(
            ObjectAnimator.ofFloat(view, View.SCALE_X, startScaleX, endScaleX),
            ObjectAnimator.ofFloat(view, View.SCALE_Y, startScaleY, endScaleY));
    addListener(new TransitionListenerAdapter() &#123;
        @Override
        public void onTransitionEnd(Transition transition) &#123;
            view.setScaleX(initialScaleX);
            view.setScaleY(initialScaleY);
        &#125;
    &#125;);
    return animator;
</code></pre>
<p>}</p>
<ul>
<li>合并<code>x, y</code>缩放的动画，合并是采用<code>TransitionSet</code>，如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Transition <span class="title function_">mergeTransitions</span><span class="params">(Transition... transitions)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nonNullIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; transitions.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (transitions[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">                nonNullIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> transitions[nonNullIndex];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">TransitionSet</span> <span class="variable">transitionSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransitionSet</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; transitions.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (transitions[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                transitionSet.addTransition(transitions[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> transitionSet;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="Explode"><a href="#Explode" class="headerlink" title="Explode"></a>Explode</h5><blockquote>
<p>继承自Visibility</p>
</blockquote>

<img data-src="./explode.gif" alt="autotransition" width="200" />


<h6 id="源码分析-4"><a href="#源码分析-4" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span><br><span class="line"><span class="params">            TransitionValues startValues, TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (endValues == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Rect</span> <span class="variable">bounds</span> <span class="operator">=</span> (Rect) endValues.values.get(PROPNAME_SCREEN_BOUNDS);</span><br><span class="line">        <span class="type">float</span> <span class="variable">endX</span> <span class="operator">=</span> view.getTranslationX();</span><br><span class="line">        <span class="type">float</span> <span class="variable">endY</span> <span class="operator">=</span> view.getTranslationY();</span><br><span class="line">        calculateOut(sceneRoot, bounds, mTempLoc);</span><br><span class="line">        <span class="type">float</span> <span class="variable">startX</span> <span class="operator">=</span> endX + mTempLoc[<span class="number">0</span>];</span><br><span class="line">        <span class="type">float</span> <span class="variable">startY</span> <span class="operator">=</span> endY + mTempLoc[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TranslationAnimationCreator.createAnimation(view, endValues, bounds.left, bounds.top,</span><br><span class="line">                startX, startY, endX, endY, sDecelerate, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>calculateOut</code>计算扩散的距离，使用<code>TranslationAnimationCreator</code>创建动画</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">calculateOut</span><span class="params">(View sceneRoot, Rect bounds, <span class="type">int</span>[] outVector)</span> &#123;</span><br><span class="line">        sceneRoot.getLocationOnScreen(mTempLoc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">sceneRootX</span> <span class="operator">=</span> mTempLoc[<span class="number">0</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">sceneRootY</span> <span class="operator">=</span> mTempLoc[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span> focalX;</span><br><span class="line">        <span class="type">int</span> focalY;</span><br><span class="line"></span><br><span class="line">        <span class="type">Rect</span> <span class="variable">epicenter</span> <span class="operator">=</span> getEpicenter();</span><br><span class="line">        <span class="keyword">if</span> (epicenter == <span class="literal">null</span>) &#123;</span><br><span class="line">            focalX = sceneRootX + (sceneRoot.getWidth() / <span class="number">2</span>)</span><br><span class="line">                    + Math.round(sceneRoot.getTranslationX());</span><br><span class="line">            focalY = sceneRootY + (sceneRoot.getHeight() / <span class="number">2</span>)</span><br><span class="line">                    + Math.round(sceneRoot.getTranslationY());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            focalX = epicenter.centerX();</span><br><span class="line">            focalY = epicenter.centerY();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">centerX</span> <span class="operator">=</span> bounds.centerX();</span><br><span class="line">        <span class="type">int</span> <span class="variable">centerY</span> <span class="operator">=</span> bounds.centerY();</span><br><span class="line">        <span class="type">double</span> <span class="variable">xVector</span> <span class="operator">=</span> centerX - focalX;</span><br><span class="line">        <span class="type">double</span> <span class="variable">yVector</span> <span class="operator">=</span> centerY - focalY;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (xVector == <span class="number">0</span> &amp;&amp; yVector == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Random direction when View is centered on focal View.</span></span><br><span class="line">            xVector = (Math.random() * <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">            yVector = (Math.random() * <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">double</span> <span class="variable">vectorSize</span> <span class="operator">=</span> Math.hypot(xVector, yVector);</span><br><span class="line">        xVector /= vectorSize;</span><br><span class="line">        yVector /= vectorSize;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">maxDistance</span> <span class="operator">=</span></span><br><span class="line">                calculateMaxDistance(sceneRoot, focalX - sceneRootX, focalY - sceneRootY);</span><br><span class="line"></span><br><span class="line">        outVector[<span class="number">0</span>] = (<span class="type">int</span>) Math.round(maxDistance * xVector);</span><br><span class="line">        outVector[<span class="number">1</span>] = (<span class="type">int</span>) Math.round(maxDistance * yVector);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>计算场景动画的偏移量，如果为0，随机算出偏移量，算出x, y偏移量的平方根，求出最大距离<h5 id="TransitionName"><a href="#TransitionName" class="headerlink" title="TransitionName"></a>TransitionName</h5></li>
</ul>
<blockquote>
<p>设置要做动画的标识，在之后的动画中会对这些标识的<code>View</code>做动画</p>
</blockquote>

<img data-src="./transition_name.gif" alt="autotransition" width="200" />


<h5 id="ImageTransform"><a href="#ImageTransform" class="headerlink" title="ImageTransform"></a>ImageTransform</h5>
<img data-src="./ImageTransform.gif" alt="autotransition" width="200" />


<h5 id="ReColor"><a href="#ReColor" class="headerlink" title="ReColor"></a>ReColor</h5>
<img data-src="./recolor.gif" alt="autotransition" width="200" />


<h5 id="Rotate"><a href="#Rotate" class="headerlink" title="Rotate"></a>Rotate</h5><blockquote>
<p>继承自Transition的旋转动画</p>
</blockquote>

<img data-src="./rotate.gif" alt="autotransition" width="200" />


<h6 id="源码分析-5"><a href="#源码分析-5" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Animator <span class="title function_">createAnimator</span><span class="params">(ViewGroup sceneRoot, TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (startValues == <span class="literal">null</span> || endValues == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> endValues.view;</span><br><span class="line">        <span class="type">float</span> <span class="variable">startRotation</span> <span class="operator">=</span> (Float) startValues.values.get(PROPNAME_ROTATION);</span><br><span class="line">        <span class="type">float</span> <span class="variable">endRotation</span> <span class="operator">=</span> (Float) endValues.values.get(PROPNAME_ROTATION);</span><br><span class="line">        <span class="keyword">if</span> (startRotation != endRotation) &#123;</span><br><span class="line">            view.setRotation(startRotation);</span><br><span class="line">            <span class="keyword">return</span> ObjectAnimator.ofFloat(view, View.ROTATION,</span><br><span class="line">                    startRotation, endRotation);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建旋转动画</li>
</ul>
<h5 id="Progress"><a href="#Progress" class="headerlink" title="Progress"></a>Progress</h5>
<img data-src="./progress.gif" alt="autotransition" width="200" />


<h5 id="Change-Scene"><a href="#Change-Scene" class="headerlink" title="Change Scene"></a>Change Scene</h5>
<img data-src="./change_scene.gif" alt="autotransition" width="200" />



<h6 id="源码分析-6"><a href="#源码分析-6" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        setOrdering(ORDERING_SEQUENTIAL);</span><br><span class="line">        addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.OUT)).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">ChangeBounds</span>()).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.IN));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>先淡出效果(<code>Fade</code>)，改变区域(<code>ChangeBound</code>)，淡入效果(<code>Fade</code>)</li>
</ul>
<h5 id="Fade"><a href="#Fade" class="headerlink" title="Fade"></a>Fade</h5><p>渐变转场动画，继承自<code>Visibility</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.captureStartValues(transitionValues);</span><br><span class="line">        transitionValues.values.put(PROPNAME_TRANSITION_ALPHA,</span><br><span class="line">                transitionValues.view.getTransitionAlpha());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>捕获初始场景的<code>alpha</code>值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Animator <span class="title function_">createAnimation</span><span class="params">(<span class="keyword">final</span> View view, <span class="type">float</span> startAlpha, <span class="keyword">final</span> <span class="type">float</span> endAlpha)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (startAlpha == endAlpha) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        view.setTransitionAlpha(startAlpha);</span><br><span class="line">        <span class="comment">//创建渐变属性动画</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> ObjectAnimator.ofFloat(view, <span class="string">&quot;transitionAlpha&quot;</span>, endAlpha);</span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            Log.d(LOG_TAG, <span class="string">&quot;Created animator &quot;</span> + anim);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FadeAnimatorListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FadeAnimatorListener</span>(view);</span><br><span class="line">        anim.addListener(listener);</span><br><span class="line">        anim.addPauseListener(listener);</span><br><span class="line">        addListener(<span class="keyword">new</span> <span class="title class_">TransitionListenerAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionEnd</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                view.setTransitionAlpha(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> anim;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建渐变属性动画，其会由<code>onAppear()</code>和<code>onDisAppear</code>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span><br><span class="line"><span class="params">            TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            <span class="type">View</span> <span class="variable">startView</span> <span class="operator">=</span> (startValues != <span class="literal">null</span>) ? startValues.view : <span class="literal">null</span>;</span><br><span class="line">            Log.d(LOG_TAG, <span class="string">&quot;Fade.onAppear: startView, startVis, endView, endVis = &quot;</span> +</span><br><span class="line">                    startView + <span class="string">&quot;, &quot;</span> + view);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建渐入动画</span></span><br><span class="line">        <span class="keyword">return</span> createAnimation(view, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onDisappear</span><span class="params">(ViewGroup sceneRoot, <span class="keyword">final</span> View view, TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">            <span class="comment">//创建渐出动画</span></span><br><span class="line">        <span class="keyword">return</span> createAnimation(view, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这两个方法由<code>Visibility</code>的<code>createAnimator</code>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">createAnimator</span><span class="params">(ViewGroup sceneRoot, TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="type">VisibilityInfo</span> <span class="variable">visInfo</span> <span class="operator">=</span> getVisibilityChangeInfo(startValues, endValues);</span><br><span class="line">        <span class="keyword">if</span> (visInfo.visibilityChange</span><br><span class="line">                &amp;&amp; (visInfo.startParent != <span class="literal">null</span> || visInfo.endParent != <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (visInfo.fadeIn) &#123;</span><br><span class="line">                <span class="keyword">return</span> onAppear(sceneRoot, startValues, visInfo.startVisibility,</span><br><span class="line">                        endValues, visInfo.endVisibility);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> onDisappear(sceneRoot, startValues, visInfo.startVisibility,</span><br><span class="line">                        endValues, visInfo.endVisibility</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>View</code>显示或隐藏时会创建对应的渐变动画。<code>Transition</code>的<code>playTransition</code>会调用<code>createAnimators</code>，其内部会调用<code>createAnimator</code>。</li>
<li>整体流程是启动<code>Transition</code>-&gt;创建动画(<code>createAnimators</code>)-&gt;创建单个动画(<code>createAnimator</code>由<code>Transition</code>子类实现,默认空)-&gt;<code>Visibility</code>的<code>onAppear()</code>&#x2F;<code>onDisappear</code>-&gt;子类<code>createAnimator</code></li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结:"></a>总结:</h3><blockquote>
<p><code>Transition</code>动画其实是对属性动画的一种高级封装。其主要流程是<code>TransitionManager</code>调用<code>beginDelayedTransition</code>,内部监听了<code>OnPreDrawListener</code>，其在<code>onPreDraw</code>调用<code>captureView</code>用于获取当前<code>View</code>的状态,调用<code>playTransition</code>开始转场动画。之后创建动画<code>createAnimator</code>。这其中<code>captureView</code>都是由子类实现，而<code>createAnimator</code>则可以由子类选择重写。最终动画的开始还有调用<code>animator.start()</code></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/View-Animation/" rel="tag"># View, Animation</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2016/12/03/Picasso%E8%A7%A3%E6%9E%90/" rel="prev" title="Picasso解析">
                  <i class="fa fa-chevron-left"></i> Picasso解析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2016/12/31/2016%E6%80%BB%E7%BB%93/" rel="next" title="2016总结">
                  2016总结 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Binea</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
