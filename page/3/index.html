<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xu6148152.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://xu6148152.github.io/page/3/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale">
<meta property="article:author" content="Binea">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://xu6148152.github.io/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"default","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Binea</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/08/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%B9%B6%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%B9%B6%E5%8F%91/" class="post-title-link" itemprop="url">深入理解Python之并发</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-08-13 00:53:36" itemprop="dateCreated datePublished" datetime="2017-08-13T00:53:36+08:00">2017-08-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>本文主要关注<code>Python</code>中的并发库<code>concurrent.feature</code>，其在<code>Python3.2</code>引入</p>
<h3 id="案例-用三种方式进行Web下载"><a href="#案例-用三种方式进行Web下载" class="headerlink" title="案例:用三种方式进行Web下载"></a>案例:用三种方式进行Web下载</h3><p>为了高效的处理网络<code>I/O</code>，我们需要并发。以下三个例子用于展示三个方式下载图片</p>
<ol>
<li><p>串行下载</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">OP20_CC = (<span class="string">&#x27;CN IN US ID BR PK NG BD RU JP &#x27;</span></span><br><span class="line">            <span class="string">&#x27;MX PH VN ET EG DE IR TR CD FR&#x27;</span>).split()  <span class="comment"># &lt;2&gt;</span></span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&#x27;http://flupy.org/data/flags&#x27;</span>  <span class="comment"># &lt;3&gt;</span></span><br><span class="line"></span><br><span class="line">DEST_DIR = <span class="string">&#x27;downloads/&#x27;</span>  <span class="comment"># &lt;4&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_flag</span>(<span class="params">img, filename</span>):  <span class="comment"># &lt;5&gt;</span></span><br><span class="line">    path = os.path.join(DEST_DIR, filename)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        fp.write(img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">cc</span>):  <span class="comment"># &lt;6&gt;</span></span><br><span class="line">    url = <span class="string">&#x27;&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif&#x27;</span>.<span class="built_in">format</span>(BASE_URL, cc=cc.lower())</span><br><span class="line">    resp = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> resp.content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">text</span>):  <span class="comment"># &lt;7&gt;</span></span><br><span class="line">    <span class="built_in">print</span>(text, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_many</span>(<span class="params">cc_list</span>):  <span class="comment"># &lt;8&gt;</span></span><br><span class="line">    <span class="keyword">for</span> cc <span class="keyword">in</span> <span class="built_in">sorted</span>(cc_list):  <span class="comment"># &lt;9&gt;</span></span><br><span class="line">        image = get_flag(cc)</span><br><span class="line">        show(cc)</span><br><span class="line">        save_flag(image, cc.lower() + <span class="string">&#x27;.gif&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(cc_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">download_many</span>):  <span class="comment"># &lt;10&gt;</span></span><br><span class="line">    t0 = time.time()</span><br><span class="line">    count = download_many(POP20_CC)</span><br><span class="line">    elapsed = time.time() - t0</span><br><span class="line">    msg = <span class="string">&#x27;\n&#123;&#125; flags downloaded in &#123;:.2f&#125;s&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(msg.<span class="built_in">format</span>(count, elapsed))</span><br></pre></td></tr></table></figure>
</li>
<li><p>线程池下载</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MAX_WORKERS = <span class="number">20</span>  <span class="comment"># &lt;2&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_one</span>(<span class="params">cc</span>):  <span class="comment"># &lt;3&gt;</span></span><br><span class="line">    image = get_flag(cc)</span><br><span class="line">    show(cc)</span><br><span class="line">    save_flag(image, cc.lower() + <span class="string">&#x27;.gif&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> cc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_many</span>(<span class="params">cc_list</span>):</span><br><span class="line">    workers = <span class="built_in">min</span>(MAX_WORKERS, <span class="built_in">len</span>(cc_list))  <span class="comment"># &lt;4&gt;</span></span><br><span class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(workers) <span class="keyword">as</span> executor:  <span class="comment"># &lt;5&gt;</span></span><br><span class="line">        res = executor.<span class="built_in">map</span>(download_one, <span class="built_in">sorted</span>(cc_list))  <span class="comment"># &lt;6&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(<span class="built_in">list</span>(res))  <span class="comment"># &lt;7&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Future在哪里？"><a href="#Future在哪里？" class="headerlink" title="Future在哪里？"></a>Future在哪里？</h4><p><code>Future</code>是<code>concurrent.futures</code>和<code>asyncio</code>重要的组件，但作为这些库的使用者，我们通常看不到它</p>
<p><code>Python3.4</code>标准库有两个叫<code>Future</code>的库<code>concurrent.futures.Future</code>和<code>asyncio.Future</code>。他们有相同的目的，表示一个延时的计算，其很像<code>JavaScript</code>中的<code>Promise</code>。</p>
<p><code>Futures</code>封装了等待操作，以便能够放入队列，查询状态，以及能够收到完成的结果。</p>
<p>通常，我们不应该创建<code>Futures</code>，它们由并发框架创建并管理，。这很重要</p>
<p>客户端不应该改变<code>Future</code>的状态，这是由框架完成的。</p>
<p>两种类型的<code>Future</code>都有一个非阻塞<code>done</code>方法，返回<code>Boolean</code>值，告知调用者，回调是否和<code>future</code>连接。客户端通常会使用<code>add_done_callback()</code>要求<code>future</code>通知结果。</p>
<p><code>result()</code>方法，返回回调结果，或者抛出异常。然而如果<code>future</code>没有完成，两种<code>Future</code>的行为有巨大的差异。<code>concurrency.futures.Future</code>实例，当触发<code>result</code>时会阻塞调用线程，直到结果完成，可以设置超时时间。而<code>asyncio.Future</code>不支持超时时间，一般其会使用<code>yield from</code>来获取<code>future</code>的结果</p>
<ol start="3">
<li>异步下载<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@asyncio.coroutine  </span><span class="comment"># &lt;3&gt;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">cc</span>):</span><br><span class="line">    url = <span class="string">&#x27;&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif&#x27;</span>.<span class="built_in">format</span>(BASE_URL, cc=cc.lower())</span><br><span class="line">    resp = <span class="keyword">yield</span> <span class="keyword">from</span> aiohttp.request(<span class="string">&#x27;GET&#x27;</span>, url)  <span class="comment"># &lt;4&gt;</span></span><br><span class="line">    image = <span class="keyword">yield</span> <span class="keyword">from</span> resp.read()  <span class="comment"># &lt;5&gt;</span></span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_one</span>(<span class="params">cc</span>):  <span class="comment"># &lt;6&gt;</span></span><br><span class="line">    image = <span class="keyword">yield</span> <span class="keyword">from</span> get_flag(cc)  <span class="comment"># &lt;7&gt;</span></span><br><span class="line">    show(cc)</span><br><span class="line">    save_flag(image, cc.lower() + <span class="string">&#x27;.gif&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> cc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_many</span>(<span class="params">cc_list</span>):</span><br><span class="line">    loop = asyncio.get_event_loop()  <span class="comment"># &lt;8&gt;</span></span><br><span class="line">    to_do = [download_one(cc) <span class="keyword">for</span> cc <span class="keyword">in</span> <span class="built_in">sorted</span>(cc_list)]  <span class="comment"># &lt;9&gt;</span></span><br><span class="line">    wait_coro = asyncio.wait(to_do)  <span class="comment"># &lt;10&gt;</span></span><br><span class="line">    res, _ = loop.run_until_complete(wait_coro)  <span class="comment"># &lt;11&gt;</span></span><br><span class="line">    loop.close() <span class="comment"># &lt;12&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(res)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>严格上来讲，上述并发程序并不能并行下载，<code>concurrent.futures</code>被<code>GIL</code>(全局解释器锁)限制</p>
<h3 id="阻塞I-x2F-O和GIL-全局解释器锁"><a href="#阻塞I-x2F-O和GIL-全局解释器锁" class="headerlink" title="阻塞I&#x2F;O和GIL(全局解释器锁)"></a>阻塞I&#x2F;O和GIL(全局解释器锁)</h3><p><code>CPython</code>解释器内部不是线程安全的，因此其有个全局解释器锁，同一时刻只允许一个线程运行。</p>
<p>通常，我们写<code>Python</code>时无法越过<code>GIL</code>，但内置方法或者使用<code>C</code>语言能够释放<code>GIL</code>。事实上，<code>C</code>写的<code>Python</code>库能够管理<code>GIL</code>，放出操作系统线程，充分利用<code>CPU</code>的核心，但这让<code>CODE</code>的复杂度大大增加，因此大多数的库都不会这么做</p>
<p>然而，所有的标准库方法，只要执行阻塞<code>I/O</code>操作，就会释放<code>GIL</code>。这意味着，当一个线程正在等待结果，阻塞<code>I/O</code>的函数释放了<code>GIL</code>，另一个线程可以运行</p>
<h3 id="使用concurrent-futures发起进程"><a href="#使用concurrent-futures发起进程" class="headerlink" title="使用concurrent.futures发起进程"></a>使用concurrent.futures发起进程</h3><p>使用<code>ProcessPoolExecutor</code>可以绕过<code>GIL</code>使用所有<code>CPU</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">download_many</span>(<span class="params">cc_list</span>):</span><br><span class="line">    <span class="keyword">with</span> futures.ProcessPoolExecutor() <span class="keyword">as</span> executor:</span><br></pre></td></tr></table></figure>

<p><code>ThreadPoolExecutor</code>和<code>ProcessPoolExecutor</code>的区别在于前者初始化的时候需要指定线程数量，而后者是可选</p>
<h3 id="使用Executor-map"><a href="#使用Executor-map" class="headerlink" title="使用Executor.map"></a>使用Executor.map</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">display</span>(<span class="params">*args</span>):  <span class="comment"># &lt;1&gt;</span></span><br><span class="line">    <span class="built_in">print</span>(strftime(<span class="string">&#x27;[%H:%M:%S]&#x27;</span>), end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(*args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loiter</span>(<span class="params">n</span>):  <span class="comment"># &lt;2&gt;</span></span><br><span class="line">    msg = <span class="string">&#x27;&#123;&#125;loiter(&#123;&#125;): doing nothing for &#123;&#125;s...&#x27;</span></span><br><span class="line">    display(msg.<span class="built_in">format</span>(<span class="string">&#x27;\t&#x27;</span>*n, n, n))</span><br><span class="line">    sleep(n)</span><br><span class="line">    msg = <span class="string">&#x27;&#123;&#125;loiter(&#123;&#125;): done.&#x27;</span></span><br><span class="line">    display(msg.<span class="built_in">format</span>(<span class="string">&#x27;\t&#x27;</span>*n, n))</span><br><span class="line">    <span class="keyword">return</span> n * <span class="number">10</span>  <span class="comment"># &lt;3&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    display(<span class="string">&#x27;Script starting.&#x27;</span>)</span><br><span class="line">    executor = futures.ThreadPoolExecutor(max_workers=<span class="number">3</span>)  <span class="comment"># &lt;4&gt;</span></span><br><span class="line">    results = executor.<span class="built_in">map</span>(loiter, <span class="built_in">range</span>(<span class="number">5</span>))  <span class="comment"># &lt;5&gt;</span></span><br><span class="line">    display(<span class="string">&#x27;results:&#x27;</span>, results)  <span class="comment"># &lt;6&gt;.</span></span><br><span class="line">    display(<span class="string">&#x27;Waiting for individual results:&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, result <span class="keyword">in</span> <span class="built_in">enumerate</span>(results):  <span class="comment"># &lt;7&gt;</span></span><br><span class="line">        display(<span class="string">&#x27;result &#123;&#125;: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i, result))</span><br></pre></td></tr></table></figure>

<p><code>Executor.map</code>用起来很简单，但它有个功能看起来可能不是很有用，它返回结果的顺序和调用的顺序一致，如果不想要这样，可以使用<code>executor.submit()</code>和<code>as_completed()</code>函数</p>
<h3 id="线程和协程"><a href="#线程和协程" class="headerlink" title="线程和协程"></a>线程和协程</h3><p>下面分别有使用线程和协程的例子</p>
<p>线程:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">spin</span>(<span class="params">msg, done</span>):  <span class="comment"># &lt;2&gt;</span></span><br><span class="line">    write, flush = sys.stdout.write, sys.stdout.flush</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">&#x27;|/-\\&#x27;</span>):  <span class="comment"># &lt;3&gt;</span></span><br><span class="line">        status = char + <span class="string">&#x27; &#x27;</span> + msg</span><br><span class="line">        write(status)</span><br><span class="line">        flush()</span><br><span class="line">        write(<span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))  <span class="comment"># &lt;4&gt;</span></span><br><span class="line">        <span class="keyword">if</span> done.wait(<span class="number">.1</span>):  <span class="comment"># &lt;5&gt;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    write(<span class="string">&#x27; &#x27;</span> * <span class="built_in">len</span>(status) + <span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))  <span class="comment"># &lt;6&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">slow_function</span>():  <span class="comment"># &lt;7&gt;</span></span><br><span class="line">    <span class="comment"># pretend waiting a long time for I/O</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)  <span class="comment"># &lt;8&gt;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">supervisor</span>():  <span class="comment"># &lt;9&gt;</span></span><br><span class="line">    done = threading.Event()</span><br><span class="line">    spinner = threading.Thread(target=spin,</span><br><span class="line">                               args=(<span class="string">&#x27;thinking!&#x27;</span>, done))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;spinner object:&#x27;</span>, spinner)  <span class="comment"># &lt;10&gt;</span></span><br><span class="line">    spinner.start()  <span class="comment"># &lt;11&gt;</span></span><br><span class="line">    result = slow_function()  <span class="comment"># &lt;12&gt;</span></span><br><span class="line">    done.<span class="built_in">set</span>()  <span class="comment"># &lt;13&gt;</span></span><br><span class="line">    spinner.join()  <span class="comment"># &lt;14&gt;</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>协程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@asyncio.coroutine  </span><span class="comment"># &lt;1&gt;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spin</span>(<span class="params">msg</span>):  <span class="comment"># &lt;2&gt;</span></span><br><span class="line">    write, flush = sys.stdout.write, sys.stdout.flush</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">&#x27;|/-\\&#x27;</span>):</span><br><span class="line">        status = char + <span class="string">&#x27; &#x27;</span> + msg</span><br><span class="line">        write(status)</span><br><span class="line">        flush()</span><br><span class="line">        write(<span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">.1</span>)  <span class="comment"># &lt;3&gt;</span></span><br><span class="line">        <span class="keyword">except</span> asyncio.CancelledError:  <span class="comment"># &lt;4&gt;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    write(<span class="string">&#x27; &#x27;</span> * <span class="built_in">len</span>(status) + <span class="string">&#x27;\x08&#x27;</span> * <span class="built_in">len</span>(status))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">slow_function</span>():  <span class="comment"># &lt;5&gt;</span></span><br><span class="line">    <span class="comment"># pretend waiting a long time for I/O</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">3</span>)  <span class="comment"># &lt;6&gt;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">supervisor</span>():  <span class="comment"># &lt;7&gt;</span></span><br><span class="line">    spinner = asyncio.<span class="keyword">async</span>(spin(<span class="string">&#x27;thinking!&#x27;</span>))  <span class="comment"># &lt;8&gt;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;spinner object:&#x27;</span>, spinner)  <span class="comment"># &lt;9&gt;</span></span><br><span class="line">    result = <span class="keyword">yield</span> <span class="keyword">from</span> slow_function()  <span class="comment"># &lt;10&gt;</span></span><br><span class="line">    spinner.cancel()  <span class="comment"># &lt;11&gt;</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>两者的主要区别:</p>
<ul>
<li><code>asyncio.Task</code>功能与<code>threading</code>完全相同</li>
<li><code>Task</code>驱动协程，而<code>Thread</code>触发回调</li>
<li>不需要自己初始化<code>Task</code>对象，通过传入一个协程到<code>asyncio.async()</code>或者<code>loop.create_task()</code>中获取</li>
<li>拿到一个<code>Task</code>对象时，其他它已经准备要运行了，而线程必须显式的调用<code>start</code></li>
<li>线程中，目标方法由线程调用，而协程中由<code>yield from</code>驱动的协程调用</li>
<li>没有接口能够从外部中断线程。<code>Task</code>可以调用<code>cancel</code>，其会在协程内抛出<code>CancelledError</code></li>
<li><code>supervisor</code>协程必须在主函数中使用<code>loop.run_until_complete</code>执行</li>
<li><code>Thread</code>可能需要锁来控制状态，而协程状态由内部控制</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/07/22/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%8D%8F%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/22/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%8D%8F%E7%A8%8B/" class="post-title-link" itemprop="url">深入理解Python之协程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-22 16:19:40" itemprop="dateCreated datePublished" datetime="2017-07-22T16:19:40+08:00">2017-07-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><code>Python</code>中在生成器中使用<code>yield</code>，其产生数据，被<code>next()</code>的调用者接收。其也会挂起生成器的执行以便调用者已经准备好接收下一个值，调用者从生成器拉数据</p>
<p>协程<code>coroutine</code>语法就像生成器。但是协程的<code>yield</code>通常会出现在表达式右侧。如果不产生值，那么<code>yield</code>之后跟着<code>None</code>。协程可能会从调用者接收数据，调用者会使用<code>.send(datum)</code>来传数据给协程，通常，调用者会将数据压入协程</p>
<p>有可能没有数据经过<code>yield</code>。除了控制数据流之外，<code>yield</code>能够控制调度器使多任务协作。</p>
<p>本文将讲述</p>
<ul>
<li>生成器作为协程时的表现和状态</li>
<li>使用装饰器自动准备协程</li>
<li>调用者如何通过<code>.close</code>和<code>.throw</code>来控制协程</li>
<li>协程如何根据终端返回值</li>
<li><code>yield</code>的新语法使用</li>
<li>模拟协程管理并发</li>
</ul>
<h3 id="协程如何从生成器进化"><a href="#协程如何从生成器进化" class="headerlink" title="协程如何从生成器进化"></a>协程如何从生成器进化</h3><p>协程的基础框架出现在<code>Python2.5</code>，从那时起，<code>yield</code>能够在表达式中使用。调用者能够使用<code>.send()</code>来发数据，该数据变成<code>yield</code>的值.这样子生成器变成协程了。</p>
<p><code>Python3.3</code>中，协程有两个语法改变</p>
<ul>
<li>生成器能够返回值。在这之前会抛出<code>SyntaxError</code></li>
<li><code>yield from</code></li>
</ul>
<h4 id="协程的基本行为"><a href="#协程的基本行为" class="headerlink" title="协程的基本行为"></a>协程的基本行为</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_coroutine</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&gt; coroutine started&#x27;</span>)</span><br><span class="line">    x = <span class="keyword">yield</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&gt; coroutine received:&#x27;</span>, x)</span><br></pre></td></tr></table></figure>

<p>协程有四个状态。可以使用<code>inspect.getgeneratorstate()</code>来确定当前的状态</p>
<ul>
<li><code>GEN_CREATED</code>:等待开始执行</li>
<li><code>GEN_RUNNING</code>: 当前被解释器执行</li>
<li><code>GEN_SUSPENDED</code>: 当前被<code>yield</code>表达式挂起</li>
<li><code>GEN_CLOSED</code>: 执行已经完成</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">my_coro = simple_coroutine()</span><br><span class="line">my_coro.send(<span class="number">1729</span>)</span><br></pre></td></tr></table></figure>

<p>如果创建一个协程并立即发送一个非<code>None</code>的值，那么会抛出异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_coro2</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&gt; Started: a =&#x27;</span>, a)</span><br><span class="line">    b = <span class="keyword">yield</span> a</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&gt; Received: b =&#x27;</span>, b)</span><br><span class="line">    c = <span class="keyword">yield</span> a + b</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&gt; Received: c =&#x27;</span>, c)</span><br></pre></td></tr></table></figure>

<p>这个方法调用时，分三步，最初初始化方法，创建协程，之后每执行一次<code>next</code>，执行到第一个<code>yield</code>表达式</p>
<h3 id="协程示例"><a href="#协程示例" class="headerlink" title="协程示例"></a>协程示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">averager</span>():</span><br><span class="line">    total = <span class="number">0.0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        term = <span class="keyword">yield</span> average</span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        average = total / count</span><br><span class="line"></span><br><span class="line">coro_avg = averager()</span><br><span class="line"><span class="built_in">next</span>(coro_avg)</span><br><span class="line"><span class="built_in">print</span>(coro_avg.send(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(coro_avg.send(<span class="number">30</span>))</span><br><span class="line"><span class="built_in">print</span>(coro_avg.send(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<p>创建协程，启动<code>next(coro_avg)</code>协程，调用<code>send</code>修改<code>yield</code>右值，每次执行到<code>yield</code>时，会挂起协程，等待下次数据的到来</p>
<h3 id="协程初始化装饰器"><a href="#协程初始化装饰器" class="headerlink" title="协程初始化装饰器"></a>协程初始化装饰器</h3><p>如果没有包装，那么我们每次使用协程都必须调用<code>next(my_coro)</code>。为了使协程用起来更方便.有时会使用装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">coroutine</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Decorator: primes &#x27;func&#x27; by advancing to first &#x27;yield&#x27;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">primer</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        gen = func(*args, **kwargs)</span><br><span class="line">        <span class="built_in">next</span>(gen)</span><br><span class="line">        <span class="keyword">return</span> gen</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> primer</span><br><span class="line"></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">averager</span>():</span><br><span class="line">    total = <span class="number">0.0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        term = <span class="keyword">yield</span> average</span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        average = total / count</span><br></pre></td></tr></table></figure>

<h3 id="中断协程和异常处理"><a href="#中断协程和异常处理" class="headerlink" title="中断协程和异常处理"></a>中断协程和异常处理</h3><p>协程内未处理的异常会传播给引起它的<code>next</code>或者<code>send</code>的调用者</p>
<p>中断协程的方法之一，发送一些标记告知协程退出。从<code>Python2.5</code>开始，生成器对象有两个方法允许客户端显式发送异常给协程–<code>throw</code>和<code>close</code></p>
<p><code>throw</code>: 使<code>yield</code>抛出异常，如果异常被生成器处理了，流程会进入下一个<code>next</code>。如果异常没被处理，传播给调用者</p>
<p><code>close</code>: 抛出<code>Generator Exit exception</code>，如果生成器没有处理异常，不会报告任何错误给调用者.当收到<code>GeneratorExit</code>，生成器不能<code>yield value</code>，否则会抛出<code>timeError</code>异常，如果生成器抛出其他异常，会反馈给调用者</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">demo_exc_handling</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&gt; coroutine started&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                x = <span class="keyword">yield</span></span><br><span class="line">            <span class="keyword">except</span> DemoException:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;*** DemoException handled. Continuing&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;-&gt; coroutine received: &#123;!r&#125;&#x27;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&gt; coroutine ending&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="协程中返回值"><a href="#协程中返回值" class="headerlink" title="协程中返回值"></a>协程中返回值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">averager</span>():</span><br><span class="line">    total = <span class="number">0.0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        term = <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">if</span> term <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        average = total / count</span><br><span class="line">    <span class="keyword">return</span> Result(count, average)</span><br><span class="line"></span><br><span class="line">    coro_avg = averager()</span><br><span class="line">    <span class="built_in">print</span>(coro_avg.send(<span class="number">10</span>))</span><br><span class="line">    <span class="built_in">print</span>(coro_avg.send(<span class="number">30</span>))</span><br><span class="line">    <span class="built_in">print</span>(coro_avg.send(<span class="number">5</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        coro_avg.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">except</span> StopIteration <span class="keyword">as</span> exc:</span><br><span class="line">        result = exc.value</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<h3 id="使用yield-from"><a href="#使用yield-from" class="headerlink" title="使用yield from"></a>使用yield from</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">genYield</span>():</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;AB&#x27;</span>:</span><br><span class="line">        <span class="keyword">yield</span> c</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(genYield()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">genYieldFrom</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="string">&#x27;AB&#x27;</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(genYieldFrom()))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面两个方法的结果一样。<code>yield from</code>类似其他语言的<code>await</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Result = namedtuple(<span class="string">&#x27;Result&#x27;</span>, <span class="string">&#x27;count average&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">averager</span>():</span><br><span class="line">    total = <span class="number">0.0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        term = <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">if</span> term <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        average = total / count</span><br><span class="line">    <span class="keyword">return</span> Result(count, average)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">grouper</span>(<span class="params">results, key</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        results[key] = <span class="keyword">yield</span> <span class="keyword">from</span> averager()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">data</span>):</span><br><span class="line">    results = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key, values <span class="keyword">in</span> data.items():</span><br><span class="line">        group = grouper(results, key)</span><br><span class="line">        <span class="built_in">next</span>(group)</span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> values:</span><br><span class="line">            group.send(value)</span><br><span class="line">        group.send(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    report(results)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report</span>(<span class="params">results</span>):</span><br><span class="line">    <span class="keyword">for</span> key, result <span class="keyword">in</span> <span class="built_in">sorted</span>(results.items()):</span><br><span class="line">        group, unit = key.split(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;:2&#125; &#123;:5&#125; averaging &#123;:.2f&#125;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(result.count, group, result.average, unit))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="案例-协程模拟离散事件"><a href="#案例-协程模拟离散事件" class="headerlink" title="案例:协程模拟离散事件"></a>案例:协程模拟离散事件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT_NUMBER_OF_TAXIS = <span class="number">3</span></span><br><span class="line">DEFAULT_END_TIME = <span class="number">180</span></span><br><span class="line">SEARCH_DURATION = <span class="number">5</span></span><br><span class="line">TRIP_DURATION = <span class="number">20</span></span><br><span class="line">DEPARTURE_INTERVAL = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">Event = collections.namedtuple(<span class="string">&#x27;Event&#x27;</span>, <span class="string">&#x27;time proc action&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># BEGIN TAXI_PROCESS</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">taxi_process</span>(<span class="params">ident, trips, start_time=<span class="number">0</span></span>):  <span class="comment"># &lt;1&gt;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Yield to simulator issuing event at each state change&quot;&quot;&quot;</span></span><br><span class="line">    time = <span class="keyword">yield</span> Event(start_time, ident, <span class="string">&#x27;leave garage&#x27;</span>)  <span class="comment"># &lt;2&gt;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(trips):  <span class="comment"># &lt;3&gt;</span></span><br><span class="line">        time = <span class="keyword">yield</span> Event(time, ident, <span class="string">&#x27;pick up passenger&#x27;</span>)  <span class="comment"># &lt;4&gt;</span></span><br><span class="line">        time = <span class="keyword">yield</span> Event(time, ident, <span class="string">&#x27;drop off passenger&#x27;</span>)  <span class="comment"># &lt;5&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">yield</span> Event(time, ident, <span class="string">&#x27;going home&#x27;</span>)  <span class="comment"># &lt;6&gt;</span></span><br><span class="line">    <span class="comment"># end of taxi process # &lt;7&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># END TAXI_PROCESS</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># BEGIN TAXI_SIMULATOR</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simulator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, procs_map</span>):</span><br><span class="line">        self.events = queue.PriorityQueue()</span><br><span class="line">        self.procs = <span class="built_in">dict</span>(procs_map)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, end_time</span>):  <span class="comment"># &lt;1&gt;</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Schedule and display events until time is up&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># schedule the first event for each cab</span></span><br><span class="line">        <span class="keyword">for</span> _, proc <span class="keyword">in</span> <span class="built_in">sorted</span>(self.procs.items()):  <span class="comment"># &lt;2&gt;</span></span><br><span class="line">            first_event = <span class="built_in">next</span>(proc)  <span class="comment"># &lt;3&gt;</span></span><br><span class="line">            self.events.put(first_event)  <span class="comment"># &lt;4&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># main loop of the simulation</span></span><br><span class="line">        sim_time = <span class="number">0</span>  <span class="comment"># &lt;5&gt;</span></span><br><span class="line">        <span class="keyword">while</span> sim_time &lt; end_time:  <span class="comment"># &lt;6&gt;</span></span><br><span class="line">            <span class="keyword">if</span> self.events.empty():  <span class="comment"># &lt;7&gt;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;*** end of events ***&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            current_event = self.events.get()  <span class="comment"># &lt;8&gt;</span></span><br><span class="line">            sim_time, proc_id, previous_action = current_event  <span class="comment"># &lt;9&gt;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;taxi:&#x27;</span>, proc_id, proc_id * <span class="string">&#x27;   &#x27;</span>, current_event)  <span class="comment"># &lt;10&gt;</span></span><br><span class="line">            active_proc = self.procs[proc_id]  <span class="comment"># &lt;11&gt;</span></span><br><span class="line">            next_time = sim_time + compute_duration(previous_action)  <span class="comment"># &lt;12&gt;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                next_event = active_proc.send(next_time)  <span class="comment"># &lt;13&gt;</span></span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                <span class="keyword">del</span> self.procs[proc_id]  <span class="comment"># &lt;14&gt;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.events.put(next_event)  <span class="comment"># &lt;15&gt;</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># &lt;16&gt;</span></span><br><span class="line">            msg = <span class="string">&#x27;*** end of simulation time: &#123;&#125; events pending ***&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(msg.<span class="built_in">format</span>(self.events.qsize()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># END TAXI_SIMULATOR</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_duration</span>(<span class="params">previous_action</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Compute action duration using exponential distribution&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> previous_action <span class="keyword">in</span> [<span class="string">&#x27;leave garage&#x27;</span>, <span class="string">&#x27;drop off passenger&#x27;</span>]:</span><br><span class="line">        <span class="comment"># new state is prowling</span></span><br><span class="line">        interval = SEARCH_DURATION</span><br><span class="line">    <span class="keyword">elif</span> previous_action == <span class="string">&#x27;pick up passenger&#x27;</span>:</span><br><span class="line">        <span class="comment"># new state is trip</span></span><br><span class="line">        interval = TRIP_DURATION</span><br><span class="line">    <span class="keyword">elif</span> previous_action == <span class="string">&#x27;going home&#x27;</span>:</span><br><span class="line">        interval = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Unknown previous_action: %s&#x27;</span> % previous_action)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(random.expovariate(<span class="number">1</span> / interval)) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">end_time=DEFAULT_END_TIME, num_taxis=DEFAULT_NUMBER_OF_TAXIS,</span></span><br><span class="line"><span class="params">         seed=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Initialize random generator, build procs and run simulation&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> seed <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        random.seed(seed)  <span class="comment"># get reproducible results</span></span><br><span class="line"></span><br><span class="line">    taxis = &#123;i: taxi_process(i, (i + <span class="number">1</span>) * <span class="number">2</span>, i * DEPARTURE_INTERVAL)</span><br><span class="line">             <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_taxis)&#125;</span><br><span class="line">    sim = Simulator(taxis)</span><br><span class="line">    sim.run(end_time)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&#x27;Taxi fleet simulator.&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-e&#x27;</span>, <span class="string">&#x27;--end-time&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                        default=DEFAULT_END_TIME,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;simulation end time; default = %s&#x27;</span></span><br><span class="line">                             % DEFAULT_END_TIME)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--taxis&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                        default=DEFAULT_NUMBER_OF_TAXIS,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;number of taxis running; default = %s&#x27;</span></span><br><span class="line">                             % DEFAULT_NUMBER_OF_TAXIS)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;--seed&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;random generator seed (for testing)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    main(args.end_time, args.taxis, args.seed)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/07/15/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8BContext-Manager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/15/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8BContext-Manager/" class="post-title-link" itemprop="url">深入理解Python之Context Manager</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-15 15:49:07" itemprop="dateCreated datePublished" datetime="2017-07-15T15:49:07+08:00">2017-07-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>### 概述<br>本文主要讨论<code>Python</code>中的控制流特性</p>
<ul>
<li><code>with</code>和<code>context manager</code></li>
<li><code>else</code>在<code>for,while,try</code>中的使用</li>
</ul>
<p><code>with</code>表达式创建临时可靠的上下文。这能防止错误和减少模板代码，使<code>API</code>更便于使用和更安全。经常能够发现使用<code>with</code>表达式能够实现文件的自动关闭。</p>
<h3 id="先做这个，然后做那个-if之后是else块"><a href="#先做这个，然后做那个-if之后是else块" class="headerlink" title="先做这个，然后做那个:if之后是else块"></a>先做这个，然后做那个:if之后是else块</h3><ul>
<li><code>for</code>: 循环执行完并且没有执行<code>if</code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> my_list:</span><br><span class="line">    <span class="keyword">if</span> item.flavor == <span class="string">&#x27;banana&#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> ValueError(‘No banana flavor found!<span class="string">&#x27;)</span></span><br></pre></td></tr></table></figure></li>
<li>while: 当循环条件变成<code>false</code>，循环退出执行</li>
<li>try: 当<code>try</code>块中没有抛出异常执行<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    dagerour_call()</span><br><span class="line">    after_call()</span><br><span class="line"><span class="keyword">except</span> OSError:</span><br><span class="line">    log(<span class="string">&#x27;OSError&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    after_call()</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Context-Manager和with"><a href="#Context-Manager和with" class="headerlink" title="Context Manager和with"></a>Context Manager和with</h3><p>上下文管理器对象用于管理<code>with</code>表达式，就像迭代器用于管理<code>for</code>表达式</p>
<p><code>with</code>表达式被设计用来简化<code>try/finally</code>模式，保证某些操作最后一定能够执行。</p>
<p>上下文管理器协议包含<code>__enter__</code>和<code>__exit__</code>方法.<code>with</code>开始,<code>__enter__</code>触发，而<code>__exit__</code>扮演了<code>finally</code>的角色，离开<code>with</code>块执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;mirror.py&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    src = fp.read(<span class="number">60</span>)</span><br></pre></td></tr></table></figure>

<p>上述代码打开文件，结束之后会自动关闭文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LookingGlass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        self.original_write = sys.stdout.write</span><br><span class="line">        sys.stdout.write = self.reverse_write</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;JABBERWOCKY&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reverse_write</span>(<span class="params">self, text</span>):</span><br><span class="line">        self.original_write(text[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="keyword">import</span> sys</span><br><span class="line">        sys.stdout.write = self.original_write</span><br><span class="line">        <span class="keyword">if</span> exc_type <span class="keyword">is</span> ZeroDivisionError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Please Don\&#x27;t divide by zero!&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h3 id="contextib工具"><a href="#contextib工具" class="headerlink" title="contextib工具"></a>contextib工具</h3><ul>
<li>closing: 创建对象上下文管理器，提供<code>close</code>方法，不需要实现<code>__enter__</code>和<code>__exit__</code></li>
<li>suppress: 上下文管理器临时忽略指定的异常</li>
<li>@contextmanager: 直接生成上下文管理器，而不需要实现<code>__enter__</code>和<code>__exit__</code></li>
<li>ContextDecorator: 上下文管理器装饰器基类</li>
<li>ExitStack: 能够进入几个上下文管理器。当<code>with</code>块结束,其会使用后进先出调用栈中的上下文管理器的<code>__exit__</code></li>
</ul>
<h3 id="contextmanager"><a href="#contextmanager" class="headerlink" title="@contextmanager"></a>@contextmanager</h3><p><code>@contextmanager</code>减少创建上下文管理器的模板代码。使用<code>@contextmanager</code>时,<code>yield</code>会将函数分成两部分，之前的部分会在<code>__enter__</code>中执行，之后的部分会在<code>__exit__</code>中执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">looking_glass</span>():</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    original_write = sys.stdout.write</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reverse_write</span>(<span class="params">text</span>):</span><br><span class="line">        original_write(text[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    sys.stdout.write = reverse_write</span><br><span class="line">    sys.stdout.write = original_write</span><br><span class="line">    msg = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&#x27;JABBERYWOCKY&#x27;</span></span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">        msg = <span class="string">&#x27;Please DO NOT divide by zero&#x27;</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        sys.stdout.write = original_write</span><br><span class="line">        <span class="keyword">if</span> msg:</span><br><span class="line">            <span class="built_in">print</span>(msg)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/07/08/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8BIterable-Iterators-and-Generators/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/08/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8BIterable-Iterators-and-Generators/" class="post-title-link" itemprop="url">深入理解Python之Iterable,Iterators and Generators</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-07-08 17:22:37 / Modified: 17:24:30" itemprop="dateCreated datePublished" datetime="2017-07-08T17:22:37+08:00">2017-07-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><code>Python</code>使用<code>yield</code>关键字来构造生成器，并以迭代器的方式工作。每个生成器都是一个迭代器，生成器实现迭代器接口。</p>
<p>本文主要内容</p>
<ul>
<li>迭代器的内部实现方式</li>
<li><code>Python</code>中实现传统迭代器模式</li>
<li>生成器的实现方式</li>
<li>传统迭代器如何被生成器替代</li>
<li>利用标准库里的通用生成器</li>
<li>使用<code>yield</code>合并生成器</li>
<li>生成器和协程很像，但实际上差距很大</li>
</ul>
<h3 id="单词序列"><a href="#单词序列" class="headerlink" title="单词序列"></a>单词序列</h3><p>通过实现一个<code>Sentence</code>类来解释迭代</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">RE_WORD = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">        self.text = text</span><br><span class="line">        self.words = RE_WORD.findall(text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="keyword">return</span> self.words[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.words)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Sentence(%s)&#x27;</span> % reprlib.<span class="built_in">repr</span>(self.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="为什么Sentence是可迭代的"><a href="#为什么Sentence是可迭代的" class="headerlink" title="为什么Sentence是可迭代的"></a>为什么Sentence是可迭代的</h4><p>当解释器需要迭代一个对象时，其会调用内置方法<code>__iter__</code>,调用顺序</p>
<ol>
<li>检查对象是否实现了<code>__iter__</code>，如果实现了，获取迭代器</li>
<li>如果没有实现<code>__iter__</code>，但是实现了<code>__getitem__</code>,<code>Python</code>会创建一个迭代器，然后会按顺序获取值</li>
<li>如果都没有，那么会抛出异常</li>
</ol>
<p>这就是<code>Sentence</code>能迭代的原因，其实现了<code>__getitem__</code>。事实上，标准库序列都实心了<code>__iter__</code>。对于<code>__getietm__</code>的支持有可能会被去掉。<code>Python3.4</code>检查是否可迭代的最准确的方式是<code>iter(x)</code></p>
<h3 id="可迭代和迭代器"><a href="#可迭代和迭代器" class="headerlink" title="可迭代和迭代器"></a>可迭代和迭代器</h3><ul>
<li>可迭代，对象内置<code>iter</code>能够获取一个迭代器。<code>Python</code>从可迭代对象中获取迭代器。</li>
</ul>
<p>迭代器的标准接口有两个方法</p>
<ol>
<li><code>__next__</code>: 返回下一个值，如果没有更多值了，抛出<code>StopIteration</code>异常</li>
<li><code>__iter__</code>: 返回迭代器自身</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Iterator</span>(<span class="title class_ inherited__">Iterable</span>):</span><br><span class="line">    __slots__ = ()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;Return the next item from the iterator. When exhausted, raise StopIteration&#x27;</span></span><br><span class="line">        <span class="keyword">raise</span> StopIteration</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__subclasshook__</span>(<span class="params">cls, C</span>):</span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">is</span> Iterator:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(<span class="string">&quot;__next__&quot;</span> <span class="keyword">in</span> B.__dict__ <span class="keyword">for</span> B <span class="keyword">in</span> C.__mro__) <span class="keyword">and</span> <span class="built_in">any</span>(<span class="string">&quot;_iter__&quot;</span> <span class="keyword">in</span> B.__dict__ <span class="keyword">for</span> B <span class="keyword">in</span> C.__mro__):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="传统迭代器"><a href="#传统迭代器" class="headerlink" title="传统迭代器"></a>传统迭代器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">RE_WORD = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">        self.text = text</span><br><span class="line">        self.words = RE_WORD.findall(text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Sentence(%s)&#x27;</span> % reprlib.<span class="built_in">repr</span>(self.text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> SentenceIterator(self.words)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SentenceIterator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, words</span>):</span><br><span class="line">        self.words = words</span><br><span class="line">        self.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            word = self.words[self.index]</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration()</span><br><span class="line">        self.index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> word</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="生成器方法"><a href="#生成器方法" class="headerlink" title="生成器方法"></a>生成器方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">RE_WORD = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">        self.text = text</span><br><span class="line">        self.words = RE_WORD.findall(text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Sentence(%s)&#x27;</span> % reprlib.<span class="built_in">repr</span>(self.text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> self.words:</span><br><span class="line">            <span class="keyword">yield</span> word</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="生成器如何工作"><a href="#生成器如何工作" class="headerlink" title="生成器如何工作"></a>生成器如何工作</h3><p>当调用<code>yield</code>时，返回一个生成器对象，换句话说，生成器方法是个生成器工厂</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_123</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="更偷懒的实现方式"><a href="#更偷懒的实现方式" class="headerlink" title="更偷懒的实现方式"></a>更偷懒的实现方式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">RE_WORD = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">        self.text = text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Sentence(%s)&#x27;</span> % reprlib.<span class="built_in">repr</span>(self.text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> match <span class="keyword">in</span> RE_WORD.finditer(self.text):</span><br><span class="line">            <span class="keyword">yield</span> match.group()</span><br></pre></td></tr></table></figure>

<h3 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h3><pre><code class="Python">
RE_WORD = re.compile(&#39;\w+&#39;)


class Sentence:
    def __init__(self, text):
        self.text = text

    def __repr__(self):
        return &#39;Sentence(%s)&#39; % reprlib.repr(self.text)

    def __iter__(self):
        return (match.group() for match in RE_WORD.finditer(self.text))
</code></pre>
<h3 id="迭代器和协程"><a href="#迭代器和协程" class="headerlink" title="迭代器和协程"></a>迭代器和协程</h3><p><code>Python2.5</code>加入了协程</p>
<p>生成器产生数据<br>协程消耗数据</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/06/10/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%93%8D%E4%BD%9C%E7%AC%A6%E9%87%8D%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/06/10/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%93%8D%E4%BD%9C%E7%AC%A6%E9%87%8D%E8%BD%BD/" class="post-title-link" itemprop="url">深入理解Python之正确的操作符重载</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-06-10 16:23:07 / Modified: 16:25:10" itemprop="dateCreated datePublished" datetime="2017-06-10T16:23:07+08:00">2017-06-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>文本将包括以下内容</p>
<ul>
<li><code>Python</code>如何支持不同类型的中缀操作符</li>
<li>使用鸭子类型或者显式类型检查来处理各种类型的操作数</li>
<li>中缀操作符方法如果知道不处理操作数</li>
<li>各种比较操作符的特殊行为</li>
</ul>
<h3 id="操作符101"><a href="#操作符101" class="headerlink" title="操作符101"></a>操作符101</h3><p>操作符重载在某些圈子有不好的名声。它是一种容易被滥用的语言特性，导致别人困惑，<code>bugs</code>和意想不到的性能瓶颈。但是如果用好它，能产生令人愉快的<code>APIs</code>和阅读性很好的代码。<code>Python</code>在灵活，可用，安全之间做了平衡。使用以下的限制:</p>
<ul>
<li>不能重载内置类型操作符</li>
<li>不能创建新的操作符，只能重载原有的</li>
<li>几个操作符不能重载: <code>is, and, or, not</code></li>
</ul>
<p>下面开始讨论最简单的一元操作符</p>
<h3 id="一元操作符"><a href="#一元操作符" class="headerlink" title="一元操作符"></a>一元操作符</h3><ul>
<li><code>-(__neg__)</code></li>
<li><code>+(__pos__)</code></li>
<li><code>~(__invert__)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__abs__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> math.sqrt(<span class="built_in">sum</span>(x * x <span class="keyword">for</span> x <span class="keyword">in</span> self))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__neg__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> Vector(-x <span class="keyword">for</span> x <span class="keyword">in</span> self)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__pos__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> Vector(self)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="什么时候-x-x"><a href="#什么时候-x-x" class="headerlink" title="什么时候 x != +x?"></a>什么时候 <code>x != +x</code>?</h4><p>正常情况下<code>x==+x</code>。以下情况两者不相等</p>
<p>第一种情况, <code>decimal.Decimal</code>中，如果<code>x</code>在数学上下文中创建，而<code>+x</code>在不一样的上下文中创建。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ctx = decimal.getcontext()</span><br><span class="line">ctx.prec = <span class="number">40</span></span><br><span class="line">one_third = decimal.Decimal(<span class="string">&#x27;1&#x27;</span>) / decimal.Decimal(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(one_third)</span><br><span class="line"><span class="built_in">print</span>(one_third == +one_third)</span><br><span class="line">ctx.prec = <span class="number">28</span></span><br><span class="line"><span class="built_in">print</span>(one_third == +one_third)</span><br><span class="line"><span class="built_in">print</span>(one_third)</span><br><span class="line"><span class="built_in">print</span>(+one_third)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line"><span class="number">0.3333333333333333333333333333333333333333</span></span><br><span class="line"><span class="number">0.3333333333333333333333333333</span></span><br></pre></td></tr></table></figure>
<p><code>Decimal</code>的精度被改变。<code>one_third</code>和<code>+one_third</code>值不相等。原因是<code>+one_third</code>用新精度会产生一个新的<code>Decimal</code></p>
<p>第二种情况是<code>collections.Counter</code>，其实现了几个数学操作符。如果使用<code>+</code>操作符，那么会丢弃<code>0</code>及负数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ct = Counter(<span class="string">&#x27;abracadabra&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ct)</span><br><span class="line"></span><br><span class="line">ct[<span class="string">&#x27;r&#x27;</span>] = -<span class="number">3</span></span><br><span class="line">ct[<span class="string">&#x27;d&#x27;</span>] = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(ct)</span><br><span class="line"><span class="built_in">print</span>(+ct)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="为向量相加重载"><a href="#为向量相加重载" class="headerlink" title="为向量相加重载+"></a>为向量相加重载<code>+</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">    pairs = itertools.zip_longest(self, other, fillvalue=<span class="number">0.0</span>)</span><br><span class="line">    <span class="keyword">return</span> Vector(a + b <span class="keyword">for</span> a, b <span class="keyword">in</span> pairs)</span><br><span class="line"></span><br><span class="line">v1 = Vector([<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">v2 = Vector([<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>])</span><br><span class="line"><span class="built_in">print</span>(v1 + v2)</span><br><span class="line"><span class="built_in">print</span>((v1 + v2) == Vector([<span class="number">3</span> + <span class="number">6</span>, <span class="number">4</span> + <span class="number">7</span>, <span class="number">5</span> + <span class="number">8</span>]))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>pairs</code> 是个生成器，能产生<code>tuple(a, b)</code>,<code>a</code>从<code>self</code>,<code>b</code>从<code>other</code>，如果两者的长度不一致，那么会使用<code>fillvalue</code>填充</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>) + v1</span><br></pre></td></tr></table></figure>

<p>然而使用上述表达式会出错。</p>
<p>为了支持不同类型的操作符，<code>Python</code>实现了特殊的下发机制.例如<code>a+b</code>会执行以下步骤</p>
<ol>
<li>如果<code>a</code>有<code>__add__</code>，调用<code>a.__add__(b)</code>，然后返回结果</li>
<li>如果<code>a</code>没有<code>__add__</code>，或者调用它返回<code>NotImplemented</code>，检查<code>b</code>是否有<code>__radd__</code>，然后调用<code>b.__radd__(a)</code>，然后返回结果</li>
<li>如果<code>b</code>也不含有<code>__radd__</code>，或者调用它返回<code>NotImplemented</code>。抛出<code>TypeError</code></li>
</ol>
<p>因此为了使上述的表达式能够正确运行，我们需要实现<code>__radd__</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__radd__</span>(<span class="params">self, other</span>):</span><br><span class="line">    <span class="keyword">return</span> self + other</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="重载"><a href="#重载" class="headerlink" title="重载*"></a>重载<code>*</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__mul__</span>(<span class="params">self, scalar</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(scalar, numbers.Real):</span><br><span class="line">        <span class="keyword">return</span> Vector(n * scalar <span class="keyword">for</span> n <span class="keyword">in</span> self)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__rmul__</span>(<span class="params">self, other</span>):</span><br><span class="line">    <span class="keyword">return</span> self * other</span><br><span class="line"></span><br><span class="line">v1 = Vector([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(v1 * <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>判断被乘数是否是实数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__matmul__</span>(<span class="params">self, other</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(a * b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self, other))</span><br><span class="line">    <span class="keyword">except</span> TypeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__rmatmul__</span>(<span class="params">self, other</span>):</span><br><span class="line">    <span class="keyword">return</span> self @ other</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="丰富的比较操作符"><a href="#丰富的比较操作符" class="headerlink" title="丰富的比较操作符"></a>丰富的比较操作符</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Vector):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self) == <span class="built_in">len</span>(other) <span class="keyword">and</span> <span class="built_in">all</span>(a == b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self, other))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__ne__</span>(<span class="params">self, other</span>):</span><br><span class="line">    eq_result = self == other</span><br><span class="line">    <span class="keyword">if</span> eq_result <span class="keyword">is</span> <span class="literal">NotImplemented</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="增量赋值操作符"><a href="#增量赋值操作符" class="headerlink" title="增量赋值操作符"></a>增量赋值操作符</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddableBingoCage</span>(<span class="title class_ inherited__">BingoCage</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Tombola):</span><br><span class="line">            <span class="keyword">return</span> AddableBingoCage(self.inspect() + other.inspect())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NotImplemented</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iadd__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Tombola):</span><br><span class="line">            other_iterable = other.inspect()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                other_iterable = <span class="built_in">iter</span>(other)</span><br><span class="line">            <span class="keyword">except</span> TypeError:</span><br><span class="line">                self_cls = <span class="built_in">type</span>(self).__name__</span><br><span class="line">                msg = <span class="string">&quot;right operand in += must be &#123;!r&#125; or an iterable&quot;</span></span><br><span class="line">                <span class="keyword">raise</span> TypeError(msg.<span class="built_in">format</span>(self_cls))</span><br><span class="line"></span><br><span class="line">        self.load(other_iterable)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/06/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E4%B9%8BNIO%E6%A6%82%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/06/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E4%B9%8BNIO%E6%A6%82%E8%BF%B0/" class="post-title-link" itemprop="url">深入理解Java之NIO概述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-03 17:16:37" itemprop="dateCreated datePublished" datetime="2017-06-03T17:16:37+08:00">2017-06-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><code>Java</code> NIO是从<code>Java1.4</code>后加入的新型<code>IO API</code>。主要包括了以下的核心组件</p>
<ul>
<li>通道</li>
<li>缓冲</li>
<li>选择器</li>
</ul>
<h4 id="Java-NIO-通道和缓冲"><a href="#Java-NIO-通道和缓冲" class="headerlink" title="Java NIO: 通道和缓冲"></a>Java NIO: 通道和缓冲</h4><p>标准的<code>IO API</code>中，使用字节流和字符流。在<code>NIO</code>中使用通道和缓冲。数据总是从通道读取然后放入缓冲或者从缓冲读取写入通道</p>
<p><img data-src="/./channel.png" alt="channel"></p>
<p>有几种通道和缓冲类型，以下是主要通道类型</p>
<ul>
<li><code>FileChannel</code>(文件通道)</li>
<li><code>DatagramChannel</code>(数据报通道)</li>
<li><code>SocketChannel</code>(套接字通道)</li>
<li><code>ServerSocketChannel</code>(服务器套接字通道)</li>
</ul>
<p>这些通道覆盖了 <code>UDP+TCP</code>的网络<code>IO</code>以及文件<code>IO</code></p>
<p>以下是和兴的缓冲实现</p>
<ul>
<li><code>ByteBuffer</code></li>
<li><code>CharBuffer</code></li>
<li><code>DoubleBuffer</code></li>
<li><code>IntBuffer</code></li>
<li><code>LongBuffer</code></li>
<li><code>LongBuffer</code></li>
<li><code>ShortBuffer</code></li>
</ul>
<p>这些缓冲结构覆盖了基本数据类型</p>
<h4 id="Java-NIO-非阻塞IO"><a href="#Java-NIO-非阻塞IO" class="headerlink" title="Java NIO: 非阻塞IO"></a>Java NIO: 非阻塞<code>IO</code></h4><p><code>Java NIO</code>能够做到非阻塞<code>IO</code>。例如，一个线程能够从通道读取数据到缓冲。当通道读取数据到缓冲时，线程可以做其他事情。一旦数据读取完，线程能够继续执行它</p>
<h4 id="Java-NIO-选择器"><a href="#Java-NIO-选择器" class="headerlink" title="Java NIO: 选择器"></a>Java NIO: 选择器</h4><p><code>Java NIO</code>包含了选择器的概念。选择器是一种对象，其能够监视多个通道的事件，因此单线程能够监控多通道的数据</p>
<p>下图是一个线程使用选择器处理三个通道</p>
<p><img data-src="/./selector.png" alt="selector"></p>
<p>为了使用选择器，首先需要将选择器注册到通道，然后调用<code>select()</code>方法。这个方法会阻塞直到这些通道产生了任意一个准备好的事件。一旦方法返回了，线程可以处理这些事件</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/06/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E7%BB%A7%E6%89%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/06/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E7%BB%A7%E6%89%BF/" class="post-title-link" itemprop="url">深入理解Python之继承</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-06-01 16:56:55" itemprop="dateCreated datePublished" datetime="2017-06-01T16:56:55+08:00">2017-06-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="继承内置类型的技巧"><a href="#继承内置类型的技巧" class="headerlink" title="继承内置类型的技巧"></a>继承内置类型的技巧</h3><p><code>Python2.2</code>之前，不能够继承内置类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoppelDict</span>(<span class="title class_ inherited__">dict</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="built_in">super</span>().__setitem__(key, [value] * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dd = DoppelDict(one=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(dd)</span><br><span class="line"></span><br><span class="line">dd[<span class="string">&#x27;two&#x27;</span>] = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(dd)</span><br><span class="line">dd.update(three=<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(dd)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: [<span class="number">2</span>, <span class="number">2</span>]&#125;</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: [<span class="number">2</span>, <span class="number">2</span>], <span class="string">&#x27;three&#x27;</span>: <span class="number">3</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>DoppelDict</code>当排序时，复制值.<code>__init__</code>忽略<code>__setitem__</code>被重写，因此<code>one</code>没有被复制。<code>[]</code>操作符调用<code>__setitem__</code>，因此<code>two</code>被复制。<code>update</code>方法没有使用重写的<code>__setitem__</code>方法。因此<code>three</code>没有复制</p>
<p>方法的寻找总是从目标对象开始，然后向上寻找</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AnswerDict</span>(<span class="title class_ inherited__">dict</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line">ad = AnswerDict(a=<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ad[<span class="string">&#x27;a&#x27;</span>])</span><br><span class="line"></span><br><span class="line">d = &#123;&#125;</span><br><span class="line">d.update(ad)</span><br><span class="line"><span class="built_in">print</span>(d[<span class="string">&#x27;a&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line"><span class="number">42</span></span><br><span class="line">foo</span><br><span class="line">&#123;<span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;foo&#x27;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>AnswerDict.__getitem__()</code>总是返回42.<code>d</code>是个<code>dict</code>，使用<code>ad</code>更新它，忽略了<code>AnswerDict.__getitem__()</code></p>
<p>直接继承内置类型如<code>dict</code>或者<code>list</code>容易出错，因为内置的方法大多数会忽略用户自定的方法。因此从<code>collections</code>模块中使用<code>UserDict</code>,<code>UserLisat</code>,<code>UserString</code>来派生类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DoppelDict2</span>(collections.UserDict):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="built_in">super</span>().__setitem__(key, [value] * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dd = DoppelDict2(one=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(dd)</span><br><span class="line">dd[<span class="string">&#x27;two&#x27;</span>] = <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(dd)</span><br><span class="line">dd.update(three=<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(dd)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: [<span class="number">1</span>, <span class="number">1</span>]&#125;</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: [<span class="number">1</span>, <span class="number">1</span>], <span class="string">&#x27;two&#x27;</span>: [<span class="number">2</span>, <span class="number">2</span>]&#125;</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: [<span class="number">1</span>, <span class="number">1</span>], <span class="string">&#x27;two&#x27;</span>: [<span class="number">2</span>, <span class="number">2</span>], <span class="string">&#x27;three&#x27;</span>: [<span class="number">3</span>, <span class="number">3</span>]&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多继承"><a href="#多继承" class="headerlink" title="多继承"></a>多继承</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ping</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ping:&#x27;</span>, self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pong</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;pong:&#x27;</span>, self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pong</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;PONG:&#x27;</span>, self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span>(B, C):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ping</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().ping()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;post-ping:&#x27;</span>, self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pingpong</span>(<span class="params">self</span>):</span><br><span class="line">        self.ping()</span><br><span class="line">        <span class="built_in">super</span>().ping()</span><br><span class="line">        self.pong()</span><br><span class="line">        <span class="built_in">super</span>().pong()</span><br><span class="line">        C.pong()</span><br><span class="line"></span><br><span class="line">d = D()</span><br><span class="line"><span class="built_in">print</span>(d.pong())</span><br><span class="line"><span class="built_in">print</span>(C.pong(d))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(D.__mro__)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line">pong: &lt;__main__.D <span class="built_in">object</span> at <span class="number">0x1024a66d8</span>&gt;</span><br><span class="line">PONG: &lt;__main__.D <span class="built_in">object</span> at <span class="number">0x1024a66d8</span>&gt;</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.D&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.B&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.C&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.A&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;)</span><br></pre></td></tr></table></figure>

<p>当在一个类上直接调用方法时，需要显式传入<code>self</code>。调用方法的顺序依据<code>MRO(__mro__)</code>采用<code>C3</code>算法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_mro</span>(<span class="params">cls</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;, &#x27;</span>.join(c.__name__ <span class="keyword">for</span> c <span class="keyword">in</span> cls.__mro__))</span><br><span class="line"></span><br><span class="line">print_mro(tkinter.Text)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line">Text, Widget, BaseWidget, Misc, Pack, Place, Grid, XView, YView, <span class="built_in">object</span></span><br></pre></td></tr></table></figure>

<p>其搜索路径就是按着<code>Text, Widget, BaseWidget, Misc, Pack, Place, Grid, XView, YView, object</code>从左往右搜索</p>
<p>对于多重继承来说，继承顺序决定了搜索顺序</p>
<h3 id="真实的多重继承案例"><a href="#真实的多重继承案例" class="headerlink" title="真实的多重继承案例"></a>真实的多重继承案例</h3><p>适配器模式就使用了多重继承.<code>Python</code>中最常见的多重继承是<code>collection.abc</code>包。标准库<code>Tkinter GUI</code>使用了大量的多重继承</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">print_mro(tkinter.Toplevel)</span><br><span class="line">print_mro(tkinter.Widget)</span><br><span class="line">print_mro(tkinter.Button)</span><br><span class="line">print_mro(tkinter.Entry)</span><br><span class="line">print_mro(tkinter.Text)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line">Toplevel, BaseWidget, Misc, Wm, <span class="built_in">object</span></span><br><span class="line">Widget, BaseWidget, Misc, Pack, Place, Grid, <span class="built_in">object</span></span><br><span class="line">Button, Widget, BaseWidget, Misc, Pack, Place, Grid, <span class="built_in">object</span></span><br><span class="line">Entry, Widget, BaseWidget, Misc, Pack, Place, Grid, XView, <span class="built_in">object</span></span><br><span class="line">Text, Widget, BaseWidget, Misc, Pack, Place, Grid, XView, YView, <span class="built_in">object</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="应对多重继承"><a href="#应对多重继承" class="headerlink" title="应对多重继承"></a>应对多重继承</h3><ol>
<li><p>区分接口继承和实现继承</p>
<ul>
<li>接口继承创建子类型，实现<code>is-a</code>关系</li>
<li>实现继承利于代码复用</li>
</ul>
</li>
<li><p>使用<code>ABCs</code>来创造接口<br></p>
</li>
<li><p>使用<code>Mixin</code>来使代码复用</p>
<p> 如果一个类被设计成为多个不相关的类提供复用，那么请继承<code>Mixin</code>, <code>Mixin</code>不会定义新类型，只是封装方法以便复用.<code>Mixin</code>不该被实例化，任何实体类都不该仅仅只继承<code>Mixin</code>. 每个<code>Mixin</code>应该只提供一种单一特定的行为，实现几个紧密相关的方法</p>
</li>
<li><p>显式命名<code>Mixin</code></p>
<p> 没有标准的方式来说明一个类是<code>Mixin</code>，因此建议使用<code>Mixin</code>作为后缀</p>
</li>
<li><p><code>ABC</code>可能是<code>Mixin</code>，反过来不一定成立</p>
</li>
<li><p>不要继承多个实体类</p>
</li>
<li><p>提供集合类给用户</p>
</li>
<li><p>组合胜过继承</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/05/30/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%8E%A5%E5%8F%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/05/30/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%8E%A5%E5%8F%A3/" class="post-title-link" itemprop="url">深入理解Python之接口</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-05-30 16:38:58 / Modified: 16:42:42" itemprop="dateCreated datePublished" datetime="2017-05-30T16:38:58+08:00">2017-05-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Python文化中的接口和协议"><a href="#Python文化中的接口和协议" class="headerlink" title="Python文化中的接口和协议"></a>Python文化中的接口和协议</h3><p><code>Python</code>在<code>ABCs</code>引入之前已经很成功了.接口在动态语言中是如何工作的。其没有<code>interface</code>关键字。对于<code>ABCs</code>，每个类有个接口。协议是接口。接口的定义是对象公共方法的子集，能够实现特定的功能。<code>Python</code>中最基础的接口之一是序列协议</p>
<h3 id="运行中实现协议"><a href="#运行中实现协议" class="headerlink" title="运行中实现协议"></a>运行中实现协议</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line">shuffle(l)</span><br><span class="line"><span class="built_in">print</span>(l)</span><br></pre></td></tr></table></figure>

<p>对于普通自定义对象，如果想使用<code>shuffle</code>那么需要实现<code>__setitem__</code>,因此可以动态设置<code>xxx.__setitem__ = set_xxx</code>。但这其中暴露了<code>__setitem__</code>给外界，破坏了封装性</p>
<h3 id="ABC子类"><a href="#ABC子类" class="headerlink" title="ABC子类"></a>ABC子类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FrenchDeck2</span>(collections.MutableSequence):</span><br><span class="line">    ranks = [<span class="built_in">str</span>(n) <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">11</span>)] + <span class="built_in">list</span>(<span class="string">&#x27;JQKA&#x27;</span>)</span><br><span class="line">    suits = <span class="string">&#x27;spades diamonds clubs hearts&#x27;</span>.split()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._cards = [Card(rank, suit) <span class="keyword">for</span> suit <span class="keyword">in</span> self.suits <span class="keyword">for</span> rank <span class="keyword">in</span> self.ranks]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self._cards)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, position</span>):</span><br><span class="line">        <span class="keyword">return</span> self._cards[position]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, position, value</span>):</span><br><span class="line">        self._cards[position] = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delitem__</span>(<span class="params">self, position</span>):</span><br><span class="line">        <span class="keyword">del</span> self._cards[position]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert</span>(<span class="params">self, position, value</span>):</span><br><span class="line">        self._cards.insert(position, value)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>继承链是<code>MutableSequence</code>-&gt;<code>Sequence</code></p>
<h3 id="标准库中的ABCs"><a href="#标准库中的ABCs" class="headerlink" title="标准库中的ABCs"></a>标准库中的ABCs</h3><p><code>Python2.6</code>之后引入了<code>ABCs</code></p>
<h4 id="collections-abc"><a href="#collections-abc" class="headerlink" title="collections.abc"></a>collections.abc</h4><ul>
<li><code>Iterable</code>, <code>Container</code>, <code>Sized</code></li>
<li><code>Sequence</code>, <code>Mapping</code>, <code>Set</code></li>
<li><code>MappingView</code></li>
<li><code>Callable</code>, <code>Hashable</code></li>
<li><code>Iterator</code></li>
</ul>
<p>除了<code>collections.abc</code>之外，标准库中最有用的<code>ABCs</code>就是<code>numbers</code></p>
<h4 id="numbers"><a href="#numbers" class="headerlink" title="numbers"></a>numbers</h4><ul>
<li><code>Number</code></li>
<li><code>Complex</code></li>
<li><code>Real</code></li>
<li><code>Rational</code></li>
<li><code>Integral</code></li>
</ul>
<p>因此我们需要使用<code>isinstance(x, numbers.Integral)</code>来检查整形。需要注意的是<code>decimal.Decimal</code>没有成为<code>numbers.Real</code>的子类</p>
<h3 id="定义和使用ABC"><a href="#定义和使用ABC" class="headerlink" title="定义和使用ABC"></a>定义和使用ABC</h3><p>假设我们需要在网页或者<code>APP</code>上随机展示广告。我们将定义名为<code>Tombola</code>的抽象类。</p>
<p><code>Tombola</code>抽象类有四个方法。两个抽象方法是</p>
<ul>
<li><code>load()</code>: 放条目到容器中</li>
<li><code>pick()</code>: 随机移除并返回条目</li>
</ul>
<p>实体方法</p>
<ul>
<li><code>loaded()</code>: 如果容器至少有一个条目，那么返回<code>True</code></li>
<li><code>inspect()</code>: 返回排过序的的元组</li>
</ul>
<p><img data-src="/./tombola.png" alt="tombola"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tombola</span>(abc.ABC):</span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, iterable</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Add items from an iterable.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pick</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Remove item at random, returning it.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        This method should raise &#x27;LookupError&#x27; when the instance is empty</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loaded</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return &#x27;True&#x27; if there&#x27;s at least 1 item, &#x27;Falsle` otherwise.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(self.inspect())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inspect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return a sorted tuple with the items currently inside.&quot;&quot;&quot;</span></span><br><span class="line">        items = []</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                items.append(self.pick())</span><br><span class="line">            <span class="keyword">except</span> LookupError:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        self.load(items)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(<span class="built_in">sorted</span>(items))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用<code>@abc.abstractmethod</code>标识抽象方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Fake</span>(<span class="title class_ inherited__">Tombola</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pick</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">13</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ABC详细语法"><a href="#ABC详细语法" class="headerlink" title="ABC详细语法"></a>ABC详细语法</h4><p>声明抽象类的最好方式是继承<code>abc.ABC</code>或者其他<code>ABC</code>。然而<code>abc.ABC</code>是<code>Python3.4</code>才引入的。在这此前必须使用<code>metaclass=keyword</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Tombola</span>(metaclass=abc.ABCMeta):</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p><code>metaclass=keyword</code>是<code>Python3</code>才引入的，<code>Python2</code>中，必须使用<code>__metaclass__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Tombola</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">__metaclass__ = abc._ABCMeta</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Tombola的子类"><a href="#Tombola的子类" class="headerlink" title="Tombola的子类"></a>Tombola的子类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BingoCage</span>(<span class="title class_ inherited__">Tombola</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, items</span>):</span><br><span class="line">        self._randomizer = random.SystemRandom()</span><br><span class="line">        self._items = []</span><br><span class="line">        self.load(items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, items</span>):</span><br><span class="line">        self._items.extend(items)</span><br><span class="line">        self._randomizer.shuffle(self._items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pick</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._items.pop()</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">raise</span> LookupError(<span class="string">&#x27;pick from empty BingoCage&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self</span>):</span><br><span class="line">        self.pick()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LotteryBlower</span>(<span class="title class_ inherited__">Tombola</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, iterable</span>):</span><br><span class="line">        self._balls = <span class="built_in">list</span>(iterable)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, iterable</span>):</span><br><span class="line">        self._balls.extend(iterable)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pick</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            position = random.randrange(<span class="built_in">len</span>(self._balls))</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">raise</span> LookupError(<span class="string">&#x27;pick from empty BingoCage&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> self._balls.pop(position)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loaded</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(self._balls)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inspect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(<span class="built_in">sorted</span>(self._balls))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Tombola的虚子类"><a href="#Tombola的虚子类" class="headerlink" title="Tombola的虚子类"></a>Tombola的虚子类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Tombola.register</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TomboList</span>(<span class="title class_ inherited__">list</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pick</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self:</span><br><span class="line">            position = randrange(<span class="built_in">len</span>(self))</span><br><span class="line">            <span class="keyword">return</span> self.pop(position)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> LookupError(<span class="string">&#x27;pop from empty TomboList&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    load = <span class="built_in">list</span>.extend</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">loaded</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inspect</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(<span class="built_in">sorted</span>(self))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用<code>@Tombola.register</code>注册作为<code>Tombola</code>的虚子类</p>
<p>注意因为注册了，所以<code>issubclass</code>和<code>isinstance</code>都能表现为<code>TomboList</code>是<code>Tombola</code>的子类。</p>
<p>但是打印继承关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(TomboList.__mro__)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.TomboList&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;list&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;)</span><br></pre></td></tr></table></figure>

<p>可以看出<code>TomboList</code>并没有集成自<code>Tombola</code></p>
<h3 id="Tombola子类测试"><a href="#Tombola子类测试" class="headerlink" title="Tombola子类测试"></a>Tombola子类测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">TEST_FILE = <span class="string">&#x27;tombola_tests.rst&#x27;</span></span><br><span class="line">TEST_MSG = <span class="string">&#x27;&#123;0:16&#125; &#123;1.attempted:2&#125; tests, &#123;1.failed:2&#125; failed - &#123;2&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    verbose = <span class="string">&#x27;-v&#x27;</span> <span class="keyword">in</span> argv</span><br><span class="line">    real_subclasses = Tombola.__subclasses__()</span><br><span class="line">    virtual_subclasses = <span class="built_in">list</span>(Tombola._abc_registry)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> cls <span class="keyword">in</span> real_subclasses + virtual_subclasses:</span><br><span class="line">        test(cls, verbose)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">cls, verbose=<span class="literal">False</span></span>):</span><br><span class="line">    res = doctest.testfile(</span><br><span class="line">        TEST_FILE,</span><br><span class="line">        globs=&#123;<span class="string">&#x27;ConcreteTombola&#x27;</span>: cls&#125;,</span><br><span class="line">        verbose=verbose,</span><br><span class="line">        optionflags=doctest.REPORT_ONLY_FIRST_FAILURE)</span><br><span class="line"></span><br><span class="line">    tag = <span class="string">&#x27;FAIL&#x27;</span> <span class="keyword">if</span> res.failed <span class="keyword">else</span> <span class="string">&#x27;OK&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(TEST_MSG.<span class="built_in">format</span>(cls.__name__, res, tag))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">    main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/05/27/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%BA%8F%E5%88%97%E5%88%87%E7%89%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/05/27/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%BA%8F%E5%88%97%E5%88%87%E7%89%87/" class="post-title-link" itemprop="url">深入理解Python之序列切片</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-05-27 17:14:14" itemprop="dateCreated datePublished" datetime="2017-05-27T17:14:14+08:00">2017-05-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文着重介绍</p>
<ul>
<li>基本序列协议: <code>__len__</code>和<code>__getitem__</code></li>
<li>带有多个条目对象的安全展示</li>
<li>合理的切片支持</li>
<li>哈希处理</li>
<li>自定义格式化语言拓展</li>
</ul>
<h3 id="Vector-自定义序列类型"><a href="#Vector-自定义序列类型" class="headerlink" title="Vector: 自定义序列类型"></a>Vector: 自定义序列类型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vector</span>:</span><br><span class="line">    typecode = <span class="string">&#x27;d&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, components</span>):</span><br><span class="line">        self._components = array(self.typecode, components)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self._components)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        components = reprlib.<span class="built_in">repr</span>(self._components)</span><br><span class="line">        components = components[components.find(<span class="string">&#x27;[&#x27;</span>):-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Vector(&#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(components)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(<span class="built_in">tuple</span>(self))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__bytes__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([<span class="built_in">ord</span>(self.typecode)]) + <span class="built_in">bytes</span>(self._components)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(self) == <span class="built_in">tuple</span>(other)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__abs__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> math.sqrt(<span class="built_in">sum</span>(x * x <span class="keyword">for</span> x <span class="keyword">in</span> self))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__bool__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(<span class="built_in">abs</span>(self))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">frombytes</span>(<span class="params">cls, octets</span>):</span><br><span class="line">        typecode = <span class="built_in">chr</span>(octets[<span class="number">0</span>])</span><br><span class="line">        memv = <span class="built_in">memoryview</span>(octets[<span class="number">1</span>:]).cast(typecode)</span><br><span class="line">        <span class="keyword">return</span> cls(memv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>reprlib</code>来进行安全展示</li>
</ul>
<h3 id="协议和鸭子类型"><a href="#协议和鸭子类型" class="headerlink" title="协议和鸭子类型"></a>协议和鸭子类型</h3><p>为<code>Vector</code>实现<code>__len__</code>和<code>__getitem__</code>协议</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(self._components)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, item</span>):</span><br><span class="line">    <span class="keyword">return</span> self._components[item]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="增强切片功能"><a href="#增强切片功能" class="headerlink" title="增强切片功能"></a>增强切片功能</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, item</span>):</span><br><span class="line">    cls = <span class="built_in">type</span>(self)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">slice</span>):</span><br><span class="line">        <span class="keyword">return</span> cls(self._components[item])</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(item, numbers.Integral):</span><br><span class="line">        <span class="keyword">return</span> self._components[item]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        msg = <span class="string">&#x27;&#123;cls.__name__&#125; indices must be integers&#x27;</span></span><br><span class="line">        <span class="keyword">raise</span> TypeError(msg.<span class="built_in">format</span>(cls=cls))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="动态属性访问"><a href="#动态属性访问" class="headerlink" title="动态属性访问"></a>动态属性访问</h3><p><code>__getattr__</code>当属性查找失败被调用。简单来说就是，给定表达式<code>my_obj.x</code>, <code>Python</code>检查对象是否含有<code>x</code>属性。如果没有，继续寻找类(<code>my_obj.__class__</code>)，然后继承链向上查找。如果依然没有找到<code>x</code>，那么<code>__getattr__</code>就会被调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">    cls = <span class="built_in">type</span>(self)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">1</span>:</span><br><span class="line">        pos = cls.shortcut_names.find(name)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= pos &lt; <span class="built_in">len</span>(self._components):</span><br><span class="line">            <span class="keyword">return</span> self._components[pos]</span><br><span class="line">    msg = <span class="string">&#x27;&#123;.__name__!r&#125; object has no attribute &#123;!r&#125;&#x27;</span></span><br><span class="line">    <span class="keyword">raise</span> AttributeError(msg.<span class="built_in">format</span>(cls, name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">    cls = <span class="built_in">type</span>(self)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> cls.shortcut_names:</span><br><span class="line">            error = <span class="string">&#x27;readonly attribute &#123;attr_name!r&#125;&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> name.islower():</span><br><span class="line">            error = <span class="string">&quot;can&#x27;t set attributes &#x27;a&#x27; to &#x27;z&#x27; in &#123;cls_name!r&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            error = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> error:</span><br><span class="line">            msg = error.<span class="built_in">format</span>(cls_name=cls.__name__, attr_name=name)</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(msg)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>().__setattr__(name, value)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="哈希和更快的-x3D-x3D"><a href="#哈希和更快的-x3D-x3D" class="headerlink" title="哈希和更快的&#x3D;&#x3D;"></a>哈希和更快的&#x3D;&#x3D;</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">    hashes = <span class="built_in">map</span>(<span class="built_in">hash</span>, self._components)</span><br><span class="line">    <span class="keyword">return</span> functools.reduce(operator.xor, hashes, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(self) == <span class="built_in">len</span>(other) <span class="keyword">and</span> <span class="built_in">all</span>(a == b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(self, other))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__format__</span>(<span class="params">self, fmt_spec</span>):</span><br><span class="line">    <span class="keyword">if</span> fmt_spec.endswith(<span class="string">&#x27;h&#x27;</span>):</span><br><span class="line">        fmt_spec = fmt_spec[:-<span class="number">1</span>]</span><br><span class="line">        coords = itertools.chain([<span class="built_in">abs</span>(self), self.angles()])</span><br><span class="line">        outer_fmt = <span class="string">&#x27;&lt;&#123;&#125;&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        coords = self</span><br><span class="line">        outer_fmt = <span class="string">&#x27;(&#123;&#125;)&#x27;</span></span><br><span class="line">    components = (<span class="built_in">format</span>(c, fmt_spec) <span class="keyword">for</span> c <span class="keyword">in</span> coords)</span><br><span class="line">    <span class="keyword">return</span> outer_fmt.<span class="built_in">format</span>(<span class="string">&#x27;, &#x27;</span>.join(components))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/05/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89Python%E5%AF%B9%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/05/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89Python%E5%AF%B9%E8%B1%A1/" class="post-title-link" itemprop="url">深入理解Python之自定义Python对象</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-05-20 16:25:39 / Modified: 16:27:53" itemprop="dateCreated datePublished" datetime="2017-05-20T16:25:39+08:00">2017-05-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="对象展示"><a href="#对象展示" class="headerlink" title="对象展示"></a>对象展示</h3><p><code>Python</code>中有两种方式将对象以字符串的形式表示</p>
<p><code>repr()</code></p>
<blockquote>
<p>返回开发者想要到的字符串形式</p>
</blockquote>
<p><code>str()</code></p>
<blockquote>
<p>返回用户想要的字符串形式</p>
</blockquote>
<p>通过实现特殊的方法<code>__repr__</code>和<code>__str__</code>来支持<code>repr()</code>和<code>str()</code></p>
<p>有两个额外的方法来支持对象的展示形式<code>__bytes__</code>和<code>__format__</code>.<code>__byte__</code>方法和<code>__str__</code>类似，它被<code>bytes()</code>调用来显示对象的字节序列。<code>__format__</code>用于格式化对象显示</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vector2d</span>:</span><br><span class="line">    typecode = <span class="string">&#x27;d&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (i <span class="keyword">for</span> i <span class="keyword">in</span> (self.x, self.y))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        class_name = <span class="built_in">type</span>(self).__name__</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#123;&#125;(&#123;!r&#125;, &#123;!r&#125;)&#x27;</span>.<span class="built_in">format</span>(class_name, *self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(<span class="built_in">tuple</span>(self))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__bytes__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([<span class="built_in">ord</span>(self.typecode)]) + <span class="built_in">bytes</span>(array(self.typecode, self))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(self) == <span class="built_in">tuple</span>(other)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__abs__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> math.hypot(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__bool__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(<span class="built_in">abs</span>(self))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="替代构造函数"><a href="#替代构造函数" class="headerlink" title="替代构造函数"></a>替代构造函数</h3><p>因为能够以字节的形式导出<code>Vector2d</code>，因此需要一个方法能够从二进制序列中导出一个对象。标准库<code>array</code>中有这么一个方法<code>frombytes</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">frombytes</span>(<span class="params">cls, octets</span>):</span><br><span class="line">    typecode = <span class="built_in">chr</span>(octets[<span class="number">0</span>])</span><br><span class="line">    memv = <span class="built_in">memoryview</span>(octets[<span class="number">1</span>:]).cast(typecode)</span><br><span class="line">    <span class="keyword">return</span> cls(*memv)</span><br></pre></td></tr></table></figure>

<h4 id="classmethod-vs-staticmethod"><a href="#classmethod-vs-staticmethod" class="headerlink" title="classmethod vs staticmethod"></a>classmethod vs staticmethod</h4><p><code>classmethod</code>对类而不是实例进行操作，其改变了方法调用的方式，它接受类自身作为第一个参数，最常用于替代构造函数</p>
<p><code>staticmethod</code>改变方法以便它收到的第一个参数不是特殊参数。静态方法就像一个纯净的函数存活在类中，而不是定义在模块层次</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span>:</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">klassmeth</span>(<span class="params">*args</span>):</span><br><span class="line">        <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">statmeth</span>(<span class="params">*args</span>):</span><br><span class="line">        <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Demo.klassmeth())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Demo.klassmeth(<span class="string">&#x27;spam&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Demo.statmeth())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Demo.statmeth(<span class="string">&#x27;spam&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line"></span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.Demo&#x27;</span>&gt;,)</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.Demo&#x27;</span>&gt;, <span class="string">&#x27;spam&#x27;</span>)</span><br><span class="line">()</span><br><span class="line">(<span class="string">&#x27;spam&#x27;</span>,)</span><br></pre></td></tr></table></figure>

<h3 id="格式化显示"><a href="#格式化显示" class="headerlink" title="格式化显示"></a>格式化显示</h3><p>内置方法<code>format()</code>实际上调用<code>__format__(format_spec)</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">brl = <span class="number">1</span>/<span class="number">2.43</span></span><br><span class="line"><span class="built_in">format</span>(brl, <span class="string">&#x27;0.4f&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;1 BRL = &#123;rate:0.2f&#125; USD&#x27;</span>.<span class="built_in">format</span>(rate=brl) =&gt; <span class="string">&#x27;1 BRL = 0.41 USD&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">format</span>(<span class="number">42</span>, <span class="string">&#x27;b&#x27;</span>) =&gt; <span class="string">&#x27;101010&#x27;</span></span><br><span class="line"><span class="built_in">format</span>(<span class="number">2</span>/<span class="number">3</span>, <span class="string">&#x27;.1%&#x27;</span>) =&gt; <span class="string">&#x27;66.7%&#x27;</span></span><br><span class="line"></span><br><span class="line">now = datetime.now()</span><br><span class="line"><span class="built_in">format</span>(now, <span class="string">&#x27;%H:%M:%S&#x27;</span>) =&gt; <span class="string">&#x27;18:49:05&#x27;</span></span><br><span class="line"><span class="string">&quot;It&#x27;s now &#123;:%I:%M %p&#125;&quot;</span>.<span class="built_in">format</span>(now) =&gt; <span class="string">&quot;It&#x27;s now 06:49 PM&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果一个对象没有重写<code>__format__</code>那么将会调用<code>str()</code>，如果传入了格式化规格，那么会报错</li>
</ul>
<p>自定义格式化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__format__</span>(<span class="params">self, format_spec=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> format_spec.endswith(<span class="string">&#x27;p&#x27;</span>):</span><br><span class="line">        format_spec = format_spec[:-<span class="number">1</span>]</span><br><span class="line">        coords = (<span class="built_in">abs</span>(self), self.angle())</span><br><span class="line">        outer_fmt = <span class="string">&#x27;&lt;&#123;&#125;, &#123;&#125;&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        coords = self</span><br><span class="line">        outer_fmt = <span class="string">&#x27;(&#123;&#125;, &#123;&#125;)&#x27;</span></span><br><span class="line">    components = (<span class="built_in">format</span>(c, format_spec) <span class="keyword">for</span> c <span class="keyword">in</span> coords)</span><br><span class="line">    <span class="keyword">return</span> outer_fmt.<span class="built_in">format</span>(*components)</span><br></pre></td></tr></table></figure>

<h3 id="Hashable-Vector2"><a href="#Hashable-Vector2" class="headerlink" title="Hashable Vector2"></a>Hashable Vector2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">x</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.__x</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">y</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.__y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (i <span class="keyword">for</span> i <span class="keyword">in</span> (self.__x, self.__y))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>(self.__x) ^ <span class="built_in">hash</span>(self.__y)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Python中私有和保护的属性"><a href="#Python中私有和保护的属性" class="headerlink" title="Python中私有和保护的属性"></a>Python中私有和保护的属性</h3><p><code>Python</code>无法像<code>Java</code>那样创建<code>private</code>属性。但可以通过<code>__</code>前缀来表示属性是私有的,<code>_</code>用于表示受保护的</p>
<h3 id="使用-slot-节省空间"><a href="#使用-slot-节省空间" class="headerlink" title="使用__slot__节省空间"></a>使用__slot__节省空间</h3><p>默认情况，<code>Python</code>存储对象属性在<code>__dict__</code>。当你处理大数据量的时候，<code>__slots__</code>能够节省很多内存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__slots__ = (<span class="string">&#x27;__x&#x27;</span>, <span class="string">&#x27;__y&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>通过定义<code>__slots__</code>来告诉解释器，这是这个所有的属性，<code>Python</code>会将它们存在每个对象的一个类似<code>tuple</code>的结构中</p>
<h4 id="slots-的弊端"><a href="#slots-的弊端" class="headerlink" title="__slots__的弊端"></a>__slots__的弊端</h4><ul>
<li>必须为每个子类重新定义<code>__slots__</code>，因为继承属性会被忽略</li>
<li>对象只能拥有<code>__slots__</code>中的属性，除非将<code>__dict__</code>包括在<code>__slots__</code>中</li>
<li>对象不能够作为弱引用的目标，除非将<code>__weakref__</code>放到<code>__slots__</code></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Binea</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
