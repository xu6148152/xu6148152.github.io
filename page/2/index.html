<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xu6148152.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://xu6148152.github.io/page/2/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale">
<meta property="article:author" content="Binea">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://xu6148152.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"default","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Binea</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/11/14/SpringCloud%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/11/14/SpringCloud%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">SpringCloud简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-11-14 23:12:39" itemprop="dateCreated datePublished" datetime="2017-11-14T23:12:39+08:00">2017-11-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>Spring Cloud</code>是一个基于<code>Spring Boot</code>实现的云应用开发工具，它为基于JVM的云应用开发中涉及的配置管理、服务发现、断路器、智能路由、微代理、控制总线、全局锁、决策竞选、分布式会话和集群状态管理等操作提供了一种简单的开发方式。</p>
<h3 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h3><p>微服务架构就是将一个完整的应用从数据存储开始垂直拆分成多个不同的服务，每个服务都能独立部署、独立维护、独立扩展，服务与服务间通过诸如RESTful API的方式互相调用。可以参考<code>Martin Fower</code>的<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.html">《MicroServices》</a></p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img data-src="/./springcloud_archtecture.jpg" alt="springcloud_archtecture"></p>
<h4 id="技术组成"><a href="#技术组成" class="headerlink" title="技术组成"></a>技术组成</h4><p><img data-src="/./SpringCloudTechs.png" alt="SpringCloudTechs"></p>
<ul>
<li>服务治理：这是<code>Spring Cloud</code>的核心。目前<code>Spring Cloud</code>主要通过整合<code>Netflix</code>的相关产品来实现这方面的功能（<code>Spring Cloud Netflix</code>），包括用于服务注册和发现的<code>Eureka</code>，调用断路器<code>Hystrix</code>，调用端负载均衡<code>Ribbon</code>，<code>Rest</code>客户端<code>Feign</code>，智能服务路由<code>Zuul</code>，用于监控数据收集和展示的<code>Spectator、Servo、Atlas</code>，用于配置读取的<code>Archaius</code>和提供<code>Controller</code>层<code>Reactive</code>封装的<code>RxJava</code>。</li>
</ul>
<blockquote>
<p>对于服务的注册和发现，除了<code>Eureka，Spring Cloud</code>也整合了<code>Consul</code>和<code>Zookeeper</code>作为备选，但是因为这两个方案在CAP理论上都遵循CP而不是AP，所以官方并没有推荐使用。</p>
</blockquote>
<ul>
<li><p>分布式链路监控：<code>Spring Cloud Sleuth</code>提供了全自动、可配置的数据埋点，以收集微服务调用链路上的性能数据，并发送给<code>Zipkin</code>进行存储、统计和展示。</p>
</li>
<li><p>消息组件：<code>Spring Cloud Stream</code>对于分布式消息的各种需求进行了抽象，包括发布订阅、分组消费、消息分片等功能，实现了微服务之间的异步通信。<code>Spring Cloud Stream</code>也集成了第三方的<code>RabbitMQ</code>和<code>Apache Kafka</code>作为消息队列的实现。而<code>Spring Cloud Bus</code>基于<code>Spring Cloud Stream</code>，主要提供了服务间的事件通信（比如刷新配置）。</p>
</li>
<li><p>配置中心：基于<code>Spring Cloud Netflix</code>和<code>Spring Cloud Bus，Spring</code>又提供了<code>Spring Cloud Config</code>，实现了配置集中管理、动态刷新的配置中心概念。配置通过<code>Git</code>或者简单文件来存储，支持加解密。</p>
</li>
<li><p>安全控制：<code>Spring Cloud Security</code>基于<code>OAUTH2</code>这个开放网络的安全标准，提供了微服务环境下的单点登录、资源授权、令牌管理等功能。</p>
</li>
<li><p>命令行工具：<code>Spring Cloud Cli</code>提供了以命令行和脚本的方式来管理微服务及<code>Spring Cloud</code>组件的方式。</p>
</li>
<li><p>集群工具：<code>Spring Cloud Cluster</code>提供了集群选主、分布式锁、一次性令牌等分布式集群需要的技术组件。</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/10/04/%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90Hook-AMS-PMS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/04/%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90Hook-AMS-PMS/" class="post-title-link" itemprop="url">插件化原理解析Hook AMS&PMS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-04 17:01:47" itemprop="dateCreated datePublished" datetime="2017-10-04T17:01:47+08:00">2017-10-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>ActivityManagerService</code>可以认为是<code>Android</code>系统四大组件的通讯中心。四大组件相关的操作都会跟它打交道。而<code>PackageManagerService</code>则主要负责应用包内容的解析校验。因此在插件化过程中，<code>Hook</code>它们可以带来很多方便</p>
<h3 id="AMS"><a href="#AMS" class="headerlink" title="AMS"></a>AMS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ActivityManager.getService();</span><br></pre></td></tr></table></figure>

<p>通过上述代码，我们能够获得<code>AMS</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title function_">getService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IActivityManagerSingleton.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Singleton</span>&lt;IActivityManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> IActivityManager <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">b</span> <span class="operator">=</span> ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">IActivityManager</span> <span class="variable">am</span> <span class="operator">=</span> IActivityManager.Stub.asInterface(b);</span><br><span class="line">                <span class="keyword">return</span> am;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>

<p>其最终通过<code>ServiceManager</code>获取对应的<code>IBinder</code>对象，然后转成对应的接口，也就是<code>AMS</code></p>
<h4 id="Hook-AMS"><a href="#Hook-AMS" class="headerlink" title="Hook AMS"></a>Hook AMS</h4><p>通过查看源码，我们能够知道在8.0及之后,<code>ActivityManagerNative</code>以及标记过期，即将被去掉。而是直接使用<code>ActivityManager</code>来获取服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AmsPmsHookHelperKt</span> &#123;</span><br><span class="line">    companion object &#123;</span><br><span class="line">        fun <span class="title function_">hookActivityManager</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">val</span> <span class="variable">activityManagerNativeClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.app.ActivityManagerNative&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="type">val</span> <span class="variable">gDefaultField</span> <span class="operator">=</span> activityManagerNativeClass.getDeclaredField(<span class="string">&quot;gDefault&quot;</span>)</span><br><span class="line">                gDefaultField.isAccessible = <span class="literal">true</span></span><br><span class="line">                <span class="type">val</span> <span class="variable">gDefault</span> <span class="operator">=</span> gDefaultField.get(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">                <span class="type">val</span> <span class="variable">singletonClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.util.Singleton&quot;</span>)</span><br><span class="line">                <span class="type">val</span> <span class="variable">instanceField</span> <span class="operator">=</span> singletonClass.getDeclaredField(<span class="string">&quot;mInstance&quot;</span>)</span><br><span class="line">                instanceField.isAccessible = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">                <span class="type">val</span> <span class="variable">rawIActivityManager</span> <span class="operator">=</span> instanceField.get(gDefault)</span><br><span class="line">                <span class="type">val</span> <span class="variable">activityManagerInterface</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.app.IActivityManager&quot;</span>)</span><br><span class="line">                <span class="type">val</span> <span class="variable">proxy</span> <span class="operator">=</span> Proxy.newProxyInstance(Thread.currentThread().contextClassLoader, arrayOf(activityManagerInterface), HookHandler(rawIActivityManager))</span><br><span class="line">                instanceField.set(gDefault, proxy)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取<code>ActivityManagerNative</code>，通过动态代理，重新创建出一个对象，用来替换<code>gDefault</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HookHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;HookHandler&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object mBase;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HookHandler</span><span class="params">(Object base)</span> &#123;</span><br><span class="line">        mBase = base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;hey, baby; you are hooked!!&quot;</span>);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;method:&quot;</span> + method.getName() + <span class="string">&quot; called with args:&quot;</span> + Arrays.toString(args));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> method.invoke(mBase, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当<code>IActivityManager</code>触发调用时，<code>invoke</code>回调，这个时候会打印出添加的内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>-<span class="number">04</span> <span class="number">16</span>:<span class="number">04</span>:<span class="number">13.092</span> <span class="number">17046</span>-<span class="number">17046</span>/cn.binea.pluginframeworkdemo D/HookHandler: hey, baby; you are hooked!!</span><br><span class="line"><span class="number">10</span>-<span class="number">04</span> <span class="number">16</span>:<span class="number">04</span>:<span class="number">13.093</span> <span class="number">17046</span>-<span class="number">17046</span>/cn.binea.pluginframeworkdemo D/HookHandler: method:activityIdle called with args:[android.os.BinderProxy<span class="meta">@e0086ab</span>, &#123;<span class="number">1.0</span> 310mcc260mnc [en_US] ldltr sw360dp w360dp h568dp 480dpi nrml port finger qwerty/v/v -nav/h s<span class="number">.6</span>&#125;, <span class="literal">false</span>]</span><br></pre></td></tr></table></figure>

<h3 id="PMS"><a href="#PMS" class="headerlink" title="PMS"></a>PMS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PackageManager <span class="title function_">getPackageManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPackageManager != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mPackageManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">IPackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> ActivityThread.getPackageManager();</span><br><span class="line">    <span class="keyword">if</span> (pm != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Doesn&#x27;t matter if we make more than one instance.</span></span><br><span class="line">        <span class="keyword">return</span> (mPackageManager = <span class="keyword">new</span> <span class="title class_">ApplicationPackageManager</span>(<span class="built_in">this</span>, pm));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ContextImpl</code>中通过<code>ActivityThread.getPackageManager</code>获取<code>pms</code>，并会通过<code>ApplicationPackageManager</code>增强<code>pms</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IPackageManager <span class="title function_">getPackageManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sPackageManager != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//Slog.v(&quot;PackageManager&quot;, &quot;returning cur default = &quot; + sPackageManager);</span></span><br><span class="line">        <span class="keyword">return</span> sPackageManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">b</span> <span class="operator">=</span> ServiceManager.getService(<span class="string">&quot;package&quot;</span>);</span><br><span class="line">    <span class="comment">//Slog.v(&quot;PackageManager&quot;, &quot;default service binder = &quot; + b);</span></span><br><span class="line">    sPackageManager = IPackageManager.Stub.asInterface(b);</span><br><span class="line">    <span class="comment">//Slog.v(&quot;PackageManager&quot;, &quot;default service = &quot; + sPackageManager);</span></span><br><span class="line">    <span class="keyword">return</span> sPackageManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ThreadActivity</code>中，检查缓存<code>pms</code>是否存在。如果不存在，通过<code>ServiceManager</code>获取特定<code>IBinder</code>对象，并通过<code>asInterface</code>转换成对应的接口<code>IPackageManager</code>.这里可以<code>Hook</code>这个缓存对象。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/10/03/%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90Binder-Hook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/03/%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90Binder-Hook/" class="post-title-link" itemprop="url">插件化原理解析Binder Hook</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-10-03 21:49:13 / Modified: 21:49:14" itemprop="dateCreated datePublished" datetime="2017-10-03T21:49:13+08:00">2017-10-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>Binder</code>是<code>Android</code>系统的通讯桥梁。因此<code>Hook Binder</code>就能够改变通讯行为.分析<code>Hook</code>过程有利于理解<code>Binder</code>机制</p>
<h3 id="系统服务获取"><a href="#系统服务获取" class="headerlink" title="系统服务获取"></a>系统服务获取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ActivityManager</span> <span class="variable">am</span> <span class="operator">=</span> (ActivityManager)context.getSystemService(Context.ACTIVITY_SERVICE)</span><br></pre></td></tr></table></figure>
<p>通过以上代码能够获取系统服务。我们来看看内部是如何获取的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getSystemService</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SystemServiceRegistry.getSystemService(<span class="built_in">this</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getSystemServiceName</span><span class="params">(Class&lt;?&gt; serviceClass)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SystemServiceRegistry.getSystemServiceName(serviceClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ContextImpl</code>中通过<code>SystemServiceRegistry</code>获取服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getSystemService</span><span class="params">(ContextImpl ctx, String name)</span> &#123;</span><br><span class="line">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</span><br><span class="line">    <span class="keyword">return</span> fetcher != <span class="literal">null</span> ? fetcher.getService(ctx) : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSystemServiceName</span><span class="params">(Class&lt;?&gt; serviceClass)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> SYSTEM_SERVICE_NAMES.get(serviceClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>Class</code>或者类限定名都可以获取对应的服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;Class&lt;?&gt;, String&gt; SYSTEM_SERVICE_NAMES =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Class&lt;?&gt;, String&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, ServiceFetcher&lt;?&gt;&gt;();</span><br></pre></td></tr></table></figure>

<p>这里有两个<code>HashMap</code>，一个用于缓存服务名称，一个用于缓存服务获取器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    registerService(Context.ACTIVITY_SERVICE, ActivityManager.class,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CachedServiceFetcher</span>&lt;ActivityManager&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ActivityManager <span class="title function_">createService</span><span class="params">(ContextImpl ctx)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ActivityManager</span>(ctx.getOuterContext(), ctx.mMainThread.getHandler());</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">registerService</span><span class="params">(String serviceName, Class&lt;T&gt; serviceClass,</span></span><br><span class="line"><span class="params">        ServiceFetcher&lt;T&gt; serviceFetcher)</span> &#123;</span><br><span class="line">    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);</span><br><span class="line">    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务在首次使用的时候已经被初始化了。并且初始化时候会被缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CachedServiceFetcher</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">ServiceFetcher</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> mCacheIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CachedServiceFetcher</span><span class="params">()</span> &#123;</span><br><span class="line">        mCacheIndex = sServiceCacheSize++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> T <span class="title function_">getService</span><span class="params">(ContextImpl ctx)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Object[] cache = ctx.mServiceCache;</span><br><span class="line">        <span class="keyword">synchronized</span> (cache) &#123;</span><br><span class="line">            <span class="comment">// Fetch or create the service.</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">service</span> <span class="operator">=</span> cache[mCacheIndex];</span><br><span class="line">            <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    service = createService(ctx);</span><br><span class="line">                    cache[mCacheIndex] = service;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ServiceNotFoundException e) &#123;</span><br><span class="line">                    onServiceNotFound(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (T)service;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title function_">createService</span><span class="params">(ContextImpl ctx)</span> <span class="keyword">throws</span> ServiceNotFoundException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次<code>CacheServiceFetcher</code>创建时，全局的服务缓存空间会增大，并将新的服务放到数组末端。每次需要获取服务的时候，先寻找缓存中的服务，如果不存在创建并缓存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Singleton</span>&lt;IActivityManager&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> IActivityManager <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">IBinder</span> <span class="variable">b</span> <span class="operator">=</span> ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">IActivityManager</span> <span class="variable">am</span> <span class="operator">=</span> IActivityManager.Stub.asInterface(b);</span><br><span class="line">            <span class="keyword">return</span> am;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title function_">getService</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">service</span> <span class="operator">=</span> sCache.get(name);</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> service;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Binder.allowBlocking(getIServiceManager().getService(name));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;error in getService&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ActivityManager</code>中可以看到<code>ActivityManagerService</code>服务的获取方式，从<code>ServiceManager</code>中获取。在<code>ServiceManager</code>中，会先从缓冲中获取。</p>
<h3 id="Hook-IBinder"><a href="#Hook-IBinder" class="headerlink" title="Hook IBinder"></a>Hook IBinder</h3><p>从上述流程中可以了解系统服务的获取过程，那么我们需要怎么去<code>Hook</code>这些服务呢？我们可以将<code>asInterface</code>返回的结果修改成我们<code>Hook</code>过的对象。下面我们以<code>ClipboardService</code>为例来实践<code>Hook</code>过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ClipboardManager</span><span class="params">(Context context, Handler handler)</span> <span class="keyword">throws</span> ServiceNotFoundException &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mService = IClipboard.Stub.asInterface(</span><br><span class="line">            ServiceManager.getServiceOrThrow(Context.CLIPBOARD_SERVICE));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ClipboardManager</code>在初始化的时候，从<code>ServiceManager</code>获取<code>ClipboardService</code>。从这里可以看出<code>asInterface</code>需要一个<code>IBinder</code>参数，这个参数从<code>ServiceManager</code>获取。而在<code>ServiceManager</code>中会首先从缓存中查找。因此我们可以提前往缓存冲插入我们<code>Hook</code>的对象</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(<span class="string">&quot;PrivateApi&quot;</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinderHookHelperKt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Throws(Exception::class)</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">hookClipboardService</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> CLIPBOARD_SERVICE = <span class="string">&quot;clipboard&quot;</span></span><br><span class="line">            <span class="keyword">val</span> serviceManager = Class.forName(<span class="string">&quot;android.os.ServiceManager&quot;</span>)</span><br><span class="line">            <span class="keyword">val</span> getService = serviceManager.getDeclaredMethod(<span class="string">&quot;getService&quot;</span>, String::<span class="keyword">class</span>.java)</span><br><span class="line">            <span class="keyword">val</span> rawBinder = getService.invoke(<span class="literal">null</span>, CLIPBOARD_SERVICE) <span class="keyword">as</span> IBinder</span><br><span class="line">            <span class="keyword">val</span> hookedBinder = Proxy.newProxyInstance(serviceManager.classLoader, arrayOf(IBinder::<span class="keyword">class</span>.java), BinderProxyHookHandlerKt(rawBinder))</span><br><span class="line">            <span class="keyword">val</span> cacheField = serviceManager.getDeclaredField(<span class="string">&quot;sCache&quot;</span>)</span><br><span class="line">            cacheField.isAccessible = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">val</span> cache = cacheField.<span class="keyword">get</span>(<span class="literal">null</span>) <span class="keyword">as</span> HashMap&lt;String, IBinder&gt;</span><br><span class="line">            cache.put(CLIPBOARD_SERVICE, hookedBinder <span class="keyword">as</span> IBinder)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取<code>ServiceManager</code>的<code>getService</code>方法，返回一个<code>IBinder</code>对象。然后通过动态代理，代理此<code>IBinder</code>对象。然后将插入<code>ServiceManager</code>的缓存中。这样下次使用时就能够直接拿到这个代理对象</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinderProxyHookHandlerKt</span></span>(<span class="keyword">val</span> base: IBinder) : InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> TAG = BinderProxyHookHandlerKt::<span class="keyword">class</span>.java.canonicalName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stub = Any()</span><br><span class="line">    <span class="keyword">var</span> iinterface = Any()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stub = Class.forName(<span class="string">&quot;android.content.IClipboard\$Stub&quot;</span>)</span><br><span class="line">            iinterface = Class.forName(<span class="string">&quot;android.content.IClipboard&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(proxy: <span class="type">Any</span>?, method: <span class="type">Method</span>?, args: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">Any</span>&gt;?)</span></span>: Any &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;queryLocalInterface&quot;</span> == method!!.name) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;hook queryLocalInterface&quot;</span>)</span><br><span class="line">            <span class="keyword">val</span> classArray = arrayOf(iinterface <span class="keyword">as</span> Class&lt;Any&gt;)</span><br><span class="line">            <span class="keyword">return</span> Proxy.newProxyInstance((proxy <span class="keyword">as</span> Any).javaClass.classLoader, classArray, BinderHookHandlerKt(base, stub <span class="keyword">as</span> Class&lt;Any&gt;))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;method: &quot;</span> + method.name)</span><br><span class="line">        <span class="keyword">return</span> method.invoke(base, args)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>IBinder</code>的<code>queryLocalInterface</code>触发，那么通过动态代理，代理<code>IClipboard</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinderHookHandlerKt</span></span>(base: IBinder, stubClass: Class&lt;Any&gt;) : InvocationHandler &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> TAG = BinderHookHandlerKt::<span class="keyword">class</span>.java.canonicalName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> obj = Any()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> asInterfaceMethod: Method = stubClass.getDeclaredMethod(<span class="string">&quot;asInterface&quot;</span>, IBinder::<span class="keyword">class</span>.java)</span><br><span class="line">            obj = asInterfaceMethod.invoke(<span class="literal">null</span>, base)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;hooked failed&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(proxy: <span class="type">Any</span>?, method: <span class="type">Method</span>?, args: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">Any</span>&gt;?)</span></span>: Any &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;getPrimaryClip&quot;</span> == method!!.name) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;hook getPrimaryClip&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> ClipData.newPlainText(<span class="literal">null</span>, <span class="string">&quot;you have been hooked&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;hasPrimaryClip&quot;</span> == method.name) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> method.invoke(obj, args)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取<code>IClipboard$Stub</code>的<code>asInterface</code>方法，返回<code>BinderProxy</code>。当<code>getPrimaryClip</code>方法触发时，返回固定值。当<code>hasPrimaryClip</code>触发时，总是返回<code>true</code>表示粘贴板有内容。这样就成功的<code>hook ClipboardService</code></p>
<p>运行程序之后，使用粘贴功能，会发现永远只能粘贴我们自己返回的内容</p>
<p>整个过程的思路是:<br><code>ServiceManager</code>内部一张表管理着很多的<code>Binder</code>对象。我们需要<code>Hook</code>某个<code>Binder</code>对象的<code>queryLocalInterface</code>，并将其缓存。由于<code>ServiceManager</code>的缓存表里的<code>IBinder</code>大部分都是<code>BinderProxy</code>对象。当使用时会调用<code>asInterface</code>转换成需要的接口。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/10/02/%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90Hook%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/02/%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90Hook%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" class="post-title-link" itemprop="url">插件化原理解析Hook动态代理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-10-02 19:24:56 / Modified: 19:28:14" itemprop="dateCreated datePublished" datetime="2017-10-02T19:24:56+08:00">2017-10-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>使用动态代理能够达到AOP编程的效果。现在流行的插件化框架也广泛使用了动态代理。本文主要讲解动态代理的<code>Hook</code>机制</p>
<h3 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h3><p>代理可以实现方法增强，主要分为静态代理和动态代理。</p>
<h4 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h4><p>所有的原始类，代理类都提供好了</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//目标对象接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DoSth</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">doSomething</span><span class="params">(sth: <span class="type">Long</span>)</span></span>: Array&lt;Any&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//目标对象实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoSthImpl</span> : <span class="type">DoSth &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doSomething</span><span class="params">(sth: <span class="type">Long</span>)</span></span>: Array&lt;Any&gt; &#123;</span><br><span class="line">        println(<span class="string">&quot;DoSthImpl &quot;</span> + sth)</span><br><span class="line">        <span class="keyword">return</span> arrayOf(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//代理对象实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyDoSth</span></span>(<span class="keyword">val</span> base: DoSth) : DoSth &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">doSomething</span><span class="params">(sth: <span class="type">Long</span>)</span></span>: Array&lt;Any&gt; &#123;</span><br><span class="line">        println(<span class="string">&quot;ProxyDoSth &quot;</span> + (sth * <span class="number">10</span>))</span><br><span class="line">        <span class="keyword">val</span> sth = base.doSomething(sth)</span><br><span class="line">        sth[<span class="number">0</span>] = <span class="string">&quot;d&quot;</span></span><br><span class="line">        <span class="keyword">return</span> sth</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试程序</span></span><br><span class="line"><span class="keyword">val</span> sthImpl = DoSthImpl()</span><br><span class="line"><span class="keyword">val</span> proxyDoSth = ProxyDoSth(sthImpl)</span><br><span class="line">println(Arrays.toString(proxyDoSth.doSomething(<span class="number">10</span>)))</span><br></pre></td></tr></table></figure>

<p>代理对象实现将目标对象的实现行为改变了，将传入的值扩大10倍，并将返回的数组内容改变。因此代理模式是可以改变目标对象的行为的</p>
<h4 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h4><p>静态代理使用简单，但是比较繁琐。当需要代理的类较多时，会很麻烦。JDK提供了动态代理，运行时生成对应的代理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//代理方法</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InvocationHandlerImpl</span>(val base: Any) : InvocationHandler &#123;</span><br><span class="line">    override fun <span class="title function_">invoke</span><span class="params">(p0: Any?, p1: Method?, p2: Array&lt;out Any&gt;?)</span>: Any &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;doSomething&quot;</span> == (p1!!.name)) &#123;</span><br><span class="line">            val value: Long = p2!![<span class="number">0</span>] as Long</span><br><span class="line">            <span class="type">val</span> <span class="variable">doSthValue</span> <span class="operator">=</span> value * <span class="number">5</span></span><br><span class="line">            println(doSthValue)</span><br><span class="line">            val invoke: Array&lt;Any&gt; = p1.invoke(base, doSthValue) as Array&lt;Any&gt;</span><br><span class="line">            invoke[<span class="number">0</span>] = <span class="string">&quot;d&quot;</span></span><br><span class="line">            <span class="keyword">return</span> invoke</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Unit</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试程序</span></span><br><span class="line"><span class="type">val</span> <span class="variable">sthImpl</span> <span class="operator">=</span> DoSthImpl()</span><br><span class="line"><span class="type">val</span> <span class="variable">result</span> <span class="operator">=</span> Proxy.newProxyInstance(DoSth::class.java.classLoader, sthImpl.javaClass.interfaces, InvocationHandlerImpl(sthImpl))</span><br><span class="line"><span class="type">val</span> <span class="variable">ds</span> <span class="operator">=</span> (result as DoSth).doSomething(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>代理模式，运行时生成对应代理接口的代理实现类，当目标方法调用时，触发<code>Invocation.invoke</code>.</p>
<h3 id="代理Hook"><a href="#代理Hook" class="headerlink" title="代理Hook"></a>代理Hook</h3><p>Hook之前，得先找到<code>Hook</code>点，一般是静态变量或者单例，因为这些对象不会经常变化。下面我们来分析如何<code>Hook Activity</code>。都知道<code>Activity</code>的启动都是通过<code>Instrumentation</code>。而其<code>ActivityThread</code>内部，一个进程只有一个<code>ActivityThread</code>。因此只要<code>Hook</code>住这个对象那么就可以操作<code>Instrumentation</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(<span class="string">&quot;PrivateApi&quot;</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HookHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Throws(Exception::class)</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">attachContext</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> activityThreadClass = Class.forName(<span class="string">&quot;android.app.ActivityThread&quot;</span>)</span><br><span class="line">            <span class="keyword">val</span> currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">&quot;currentActivityThread&quot;</span>)</span><br><span class="line">            currentActivityThreadMethod.isAccessible = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">val</span> currentActivityThread = currentActivityThreadMethod.invoke(<span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">val</span> instrumentationField = activityThreadClass.getDeclaredField(<span class="string">&quot;mInstrumentation&quot;</span>)</span><br><span class="line">            instrumentationField.isAccessible = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">val</span> instrumentation = instrumentationField.<span class="keyword">get</span>(currentActivityThread) <span class="keyword">as</span> Instrumentation</span><br><span class="line"></span><br><span class="line">            <span class="comment">//代理instrumentation</span></span><br><span class="line">            <span class="keyword">val</span> proxyInstrumentation = ProxyInstrumentation(instrumentation)</span><br><span class="line">            instrumentationField.<span class="keyword">set</span>(currentActivityThread, proxyInstrumentation)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HookHelper</code>通过反射获取当前进程的<code>ActivityThread</code>，然后替换内部的<code>Instrumentation</code>字段</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyInstrumentation</span></span>(<span class="keyword">val</span> instrumentation: Instrumentation) : Instrumentation() &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> TAG = ProxyInstrumentation::<span class="keyword">class</span>.java.canonicalName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            who: <span class="type">Context</span>, contextThread: <span class="type">IBinder</span>?, token: <span class="type">IBinder</span>?, target: <span class="type">Activity</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">            intent: <span class="type">Intent</span>, requestCode: <span class="type">Int</span>, options: <span class="type">Bundle</span>?)</span></span>: Instrumentation.ActivityResult? &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;\nstartActivity, who = [&quot;</span> + who + <span class="string">&quot;], &quot;</span> +</span><br><span class="line">                <span class="string">&quot;\ncontextThread = [&quot;</span> + contextThread + <span class="string">&quot;], \ntoken = [&quot;</span> + token + <span class="string">&quot;], &quot;</span> +</span><br><span class="line">                <span class="string">&quot;\ntarget = [&quot;</span> + target + <span class="string">&quot;], \nintent = [&quot;</span> + intent +</span><br><span class="line">                <span class="string">&quot;], \nrequestCode = [&quot;</span> + requestCode + <span class="string">&quot;], \noptions = [&quot;</span> + options + <span class="string">&quot;]&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> execStartActivity = Instrumentation::<span class="keyword">class</span>.java.getDeclaredMethod(<span class="string">&quot;execStartActivity&quot;</span>, Context::<span class="keyword">class</span>.java, IBinder::<span class="keyword">class</span>.java, IBinder::<span class="keyword">class</span>.java, Activity::<span class="keyword">class</span>.java, Intent::<span class="keyword">class</span>.java, <span class="built_in">Int</span>::<span class="keyword">class</span>.javaPrimitiveType, Bundle::<span class="keyword">class</span>.java)</span><br><span class="line">            execStartActivity.isAccessible = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">return</span> execStartActivity.invoke(instrumentation, who, contextThread, token, target, intent, requestCode, options) <span class="keyword">as</span> Instrumentation.ActivityResult?</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;don&#x27;t support hook&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ProxyInstrumentation</code>继承自<code>Instrumentation</code>，用于增强<code>Instrumentation</code>。在每个<code>Activity</code>启动之前打印日志</p>
<p>在<code>App</code>启动的时候修改替换<code>Instrumentation</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> : <span class="type">Application</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">attachBaseContext</span><span class="params">(base: <span class="type">Context</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HookHelper.attachContext()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候启动<code>App</code>，然后重新启动一个<code>Activity</code>,那么会打印日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startActivity, who = [cn.binea.pluginframeworkdemo.MyApp@3cc96c5], contextThread = [android.app.ActivityThread$ApplicationThread@56a681a], token = [null], target = [null], intent = [Intent &#123; act=android.intent.action.VIEW dat=http://www.baidu.com/... flg=0x10000000 &#125;], requestCode = [-1], options = [null]</span><br></pre></td></tr></table></figure>

<p>至此，这个例子简单的<code>Hook</code>了<code>Activity</code>的启动，使其有了别的功能。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/09/26/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90BroadcastReceiver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/26/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90BroadcastReceiver/" class="post-title-link" itemprop="url">源码角度分析BroadcastReceiver</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-09-26 16:26:40 / Modified: 16:28:33" itemprop="dateCreated datePublished" datetime="2017-09-26T16:26:40+08:00">2017-09-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="BroadcastReceiver"><a href="#BroadcastReceiver" class="headerlink" title="BroadcastReceiver"></a>BroadcastReceiver</h3><p>一般广播的使用，都是先注册，后发送。注册可以分为静态注册和动态注册</p>
<h4 id="动态注册"><a href="#动态注册" class="headerlink" title="动态注册"></a>动态注册</h4><h5 id="ContextImpl-registerReceiver"><a href="#ContextImpl-registerReceiver" class="headerlink" title="ContextImpl.registerReceiver"></a>ContextImpl.registerReceiver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Intent <span class="title function_">registerReceiver</span><span class="params">(BroadcastReceiver receiver, IntentFilter filter,</span></span><br><span class="line"><span class="params">            String broadcastPermission, Handler scheduler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> registerReceiverInternal(receiver, getUserId(),</span><br><span class="line">                filter, broadcastPermission, scheduler, getOuterContext(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ContextImpl-registerReceiverInternal"><a href="#ContextImpl-registerReceiverInternal" class="headerlink" title="ContextImpl.registerReceiverInternal"></a>ContextImpl.registerReceiverInternal</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Intent <span class="title function_">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">            IntentFilter filter, String broadcastPermission,</span></span><br><span class="line"><span class="params">            Handler scheduler, Context context, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    <span class="type">IIntentReceiver</span> <span class="variable">rd</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (receiver != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="literal">null</span> &amp;&amp; context != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="literal">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                receiver, context, scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="literal">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            rd = <span class="keyword">new</span> <span class="title class_">LoadedApk</span>.ReceiverDispatcher(</span><br><span class="line">                    receiver, context, scheduler, <span class="literal">null</span>, <span class="literal">true</span>).getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> ActivityManager.getService().registerReceiver(</span><br><span class="line">                mMainThread.getApplicationThread(), mBasePackageName, rd, filter,</span><br><span class="line">                broadcastPermission, userId, flags);</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">            intent.setExtrasClassLoader(getClassLoader());</span><br><span class="line">            intent.prepareToEnterProcess();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intent;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>ContextImpl</code>注册。创建<code>IIntentReceiver</code>，然后通过<code>ActivityManagerService</code>注册广播</p>
<h5 id="AMS-registerReceiver"><a href="#AMS-registerReceiver" class="headerlink" title="AMS.registerReceiver"></a>AMS.registerReceiver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Intent <span class="title function_">registerReceiver</span><span class="params">(IApplicationThread caller, String callerPackage,</span></span><br><span class="line"><span class="params">            IIntentReceiver receiver, IntentFilter filter, String permission, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            <span class="type">ReceiverList</span> <span class="variable">rl</span> <span class="operator">=</span> mRegisteredReceivers.get(receiver.asBinder());</span><br><span class="line">            <span class="keyword">if</span> (rl == <span class="literal">null</span>) &#123;</span><br><span class="line">                rl = <span class="keyword">new</span> <span class="title class_">ReceiverList</span>(<span class="built_in">this</span>, callerApp, callingPid, callingUid,</span><br><span class="line">                        userId, receiver);</span><br><span class="line">                <span class="keyword">if</span> (rl.app != <span class="literal">null</span>) &#123;</span><br><span class="line">                    rl.app.receivers.add(rl);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        receiver.asBinder().linkToDeath(rl, <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="keyword">return</span> sticky;</span><br><span class="line">                    &#125;</span><br><span class="line">                    rl.linkedToDeath = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mRegisteredReceivers.put(receiver.asBinder(), rl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">stickyCount</span> <span class="operator">=</span> allSticky.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; stickyCount; i++) &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> allSticky.get(i);</span><br><span class="line">                <span class="type">BroadcastQueue</span> <span class="variable">queue</span> <span class="operator">=</span> broadcastQueueForIntent(intent);</span><br><span class="line">                <span class="type">BroadcastRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastRecord</span>(queue, intent, <span class="literal">null</span>,</span><br><span class="line">                        <span class="literal">null</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">null</span>, AppOpsManager.OP_NONE, <span class="literal">null</span>, receivers,</span><br><span class="line">                        <span class="literal">null</span>, <span class="number">0</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">true</span>, -<span class="number">1</span>);</span><br><span class="line">                queue.enqueueParallelBroadcastLocked(r);</span><br><span class="line">                queue.scheduleBroadcastsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查是否是<code>sticky broadcast</code>。搜索已注册的广播，如果不存在，创建并缓存。通过每个广播意图，获取对应的前台广播队列或者后台广播队列。然后将新的广播信息入列</p>
<h5 id="BroadcastQueue-scheduleBroadcastsLocked"><a href="#BroadcastQueue-scheduleBroadcastsLocked" class="headerlink" title="BroadcastQueue.scheduleBroadcastsLocked"></a>BroadcastQueue.scheduleBroadcastsLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleBroadcastsLocked</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG_BROADCAST, <span class="string">&quot;Schedule broadcasts [&quot;</span></span><br><span class="line">            + mQueueName + <span class="string">&quot;]: current=&quot;</span></span><br><span class="line">            + mBroadcastsScheduled);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mBroadcastsScheduled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, <span class="built_in">this</span>));</span><br><span class="line">    mBroadcastsScheduled = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>Handler</code>来处理广播消息</p>
<h5 id="BroadcastQueue-processNextBroadcast"><a href="#BroadcastQueue-processNextBroadcast" class="headerlink" title="BroadcastQueue.processNextBroadcast"></a>BroadcastQueue.processNextBroadcast</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">processNextBroadcast</span><span class="params">(<span class="type">boolean</span> fromMsg)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (mParallelBroadcasts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        r = mParallelBroadcasts.remove(<span class="number">0</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> r.receivers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> r.receivers.get(i);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BROADCAST)  Slog.v(TAG_BROADCAST,</span><br><span class="line">                    <span class="string">&quot;Delivering non-ordered on [&quot;</span> + mQueueName + <span class="string">&quot;] to registered &quot;</span></span><br><span class="line">                    + target + <span class="string">&quot;: &quot;</span> + r);</span><br><span class="line">            deliverToRegisteredReceiverLocked(r, (BroadcastFilter)target, <span class="literal">false</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">        addBroadcastToHistoryLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    performReceiveLocked(r.callerApp, r.resultTo,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">Intent</span>(r.intent), r.resultCode,</span><br><span class="line">                                r.resultData, r.resultExtras, <span class="literal">false</span>, <span class="literal">false</span>, r.userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先处理所有无序广播，然后处理有序广播。之后调用<code>performReceiveLocked</code></p>
<h5 id="BroadcastQueue-performReceiveLocked"><a href="#BroadcastQueue-performReceiveLocked" class="headerlink" title="BroadcastQueue.performReceiveLocked"></a>BroadcastQueue.performReceiveLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performReceiveLocked</span><span class="params">(ProcessRecord app, IIntentReceiver receiver,</span></span><br><span class="line"><span class="params">            Intent intent, <span class="type">int</span> resultCode, String data, Bundle extras,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">int</span> sendingUser)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="comment">// Send the intent to the receiver asynchronously using one-way binder calls.</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If we have an app thread, do the call through that so it is</span></span><br><span class="line">            <span class="comment">// correctly ordered with other one-way calls.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                app.thread.scheduleRegisteredReceiver(receiver, intent, resultCode,</span><br><span class="line">                        data, extras, ordered, sticky, sendingUser, app.repProcState);</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Uncomment this when (b/28322359) is fixed and we aren&#x27;t getting</span></span><br><span class="line">            <span class="comment">// DeadObjectException when the process isn&#x27;t actually dead.</span></span><br><span class="line">            <span class="comment">//&#125; catch (DeadObjectException ex) &#123;</span></span><br><span class="line">            <span class="comment">// Failed to call into the process.  It&#x27;s dying so just let it die and move on.</span></span><br><span class="line">            <span class="comment">//    throw ex;</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="comment">// Failed to call into the process. It&#x27;s either dying or wedged. Kill it gently.</span></span><br><span class="line">                <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Can&#x27;t deliver broadcast to &quot;</span> + app.processName</span><br><span class="line">                            + <span class="string">&quot; (pid &quot;</span> + app.pid + <span class="string">&quot;). Crashing it.&quot;</span>);</span><br><span class="line">                    app.scheduleCrash(<span class="string">&quot;can&#x27;t deliver broadcast&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Application has died. Receiver doesn&#x27;t exist.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemoteException</span>(<span class="string">&quot;app.thread must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        receiver.performReceive(intent, resultCode, data, extras, ordered,</span><br><span class="line">                sticky, sendingUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>app</code>进程还存在，那么直接通知<code>ApplicationThread</code>处理消息，以保证广播的顺序。最终都是调用<code>IIntentReceiver</code></p>
<h5 id="LoadApk-ReceiverDispatcher-InnerReceiver"><a href="#LoadApk-ReceiverDispatcher-InnerReceiver" class="headerlink" title="LoadApk.ReceiverDispatcher.InnerReceiver"></a>LoadApk.ReceiverDispatcher.InnerReceiver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performReceive</span><span class="params">(Intent intent, <span class="type">int</span> resultCode, String data,</span></span><br><span class="line"><span class="params">        Bundle extras, <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">int</span> sendingUser)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> LoadedApk.ReceiverDispatcher rd;</span><br><span class="line">    <span class="keyword">if</span> (intent == <span class="literal">null</span>) &#123;</span><br><span class="line">        Log.wtf(TAG, <span class="string">&quot;Null intent received&quot;</span>);</span><br><span class="line">        rd = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rd = mDispatcher.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ActivityThread.DEBUG_BROADCAST) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">seq</span> <span class="operator">=</span> intent.getIntExtra(<span class="string">&quot;seq&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        Slog.i(ActivityThread.TAG, <span class="string">&quot;Receiving broadcast &quot;</span> + intent.getAction()</span><br><span class="line">                + <span class="string">&quot; seq=&quot;</span> + seq + <span class="string">&quot; to &quot;</span> + (rd != <span class="literal">null</span> ? rd.mReceiver : <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rd != <span class="literal">null</span>) &#123;</span><br><span class="line">        rd.performReceive(intent, resultCode, data, extras,</span><br><span class="line">                ordered, sticky, sendingUser);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// The activity manager dispatched a broadcast to a registered</span></span><br><span class="line">        <span class="comment">// receiver in this process, but before it could be delivered the</span></span><br><span class="line">        <span class="comment">// receiver was unregistered.  Acknowledge the broadcast on its</span></span><br><span class="line">        <span class="comment">// behalf so that the system&#x27;s broadcast sequence can continue.</span></span><br><span class="line">        <span class="keyword">if</span> (ActivityThread.DEBUG_BROADCAST) Slog.i(ActivityThread.TAG,</span><br><span class="line">                <span class="string">&quot;Finishing broadcast to unregistered receiver&quot;</span>);</span><br><span class="line">        <span class="type">IActivityManager</span> <span class="variable">mgr</span> <span class="operator">=</span> ActivityManager.getService();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (extras != <span class="literal">null</span>) &#123;</span><br><span class="line">                extras.setAllowFds(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mgr.finishReceiver(<span class="built_in">this</span>, resultCode, data, extras, <span class="literal">false</span>, intent.getFlags());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>IPC</code>从<code>AMS</code>通讯回到<code>LoadedApk</code></p>
<h4 id="静态注册"><a href="#静态注册" class="headerlink" title="静态注册"></a>静态注册</h4><p>在<code>AndroidManifest.xml</code>中注册广播。广播发出后，会经由<code>PackageManagerService</code>获取当前进程的所有配置信息，然后会做比对</p>
<h4 id="广播发送"><a href="#广播发送" class="headerlink" title="广播发送"></a>广播发送</h4><h5 id="AMS-broadcastIntent"><a href="#AMS-broadcastIntent" class="headerlink" title="AMS.broadcastIntent"></a>AMS.broadcastIntent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">broadcastIntent</span><span class="params">(IApplicationThread caller,</span></span><br><span class="line"><span class="params">            Intent intent, String resolvedType, IIntentReceiver resultTo,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> resultCode, String resultData, Bundle resultExtras,</span></span><br><span class="line"><span class="params">            String[] requiredPermissions, <span class="type">int</span> appOp, Bundle bOptions,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> serialized, <span class="type">boolean</span> sticky, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">            intent = verifyBroadcastLocked(intent);</span><br><span class="line">            ...</span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> broadcastIntentLocked(callerApp,</span><br><span class="line">                    callerApp != <span class="literal">null</span> ? callerApp.info.packageName : <span class="literal">null</span>,</span><br><span class="line">                    intent, resolvedType, resultTo, resultCode, resultData, resultExtras,</span><br><span class="line">                    requiredPermissions, appOp, bOptions, serialized, sticky,</span><br><span class="line">                    callingPid, callingUid, userId);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>校验广播意图</p>
<h5 id="AMS-broadcastIntentLocked"><a href="#AMS-broadcastIntentLocked" class="headerlink" title="AMS.broadcastIntentLocked"></a>AMS.broadcastIntentLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">broadcastIntentLocked</span><span class="params">(ProcessRecord callerApp,</span></span><br><span class="line"><span class="params">            String callerPackage, Intent intent, String resolvedType,</span></span><br><span class="line"><span class="params">            IIntentReceiver resultTo, <span class="type">int</span> resultCode, String resultData,</span></span><br><span class="line"><span class="params">            Bundle resultExtras, String[] requiredPermissions, <span class="type">int</span> appOp, Bundle bOptions,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> ordered, <span class="type">boolean</span> sticky, <span class="type">int</span> callingPid, <span class="type">int</span> callingUid, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!ordered &amp;&amp; NR &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If we are not serializing this broadcast, then send the</span></span><br><span class="line">            <span class="comment">// registered receivers separately so they don&#x27;t wait for the</span></span><br><span class="line">            <span class="comment">// components to be launched.</span></span><br><span class="line">            <span class="keyword">if</span> (isCallerSystem) &#123;</span><br><span class="line">                checkBroadcastFromSystem(intent, callerApp, callerPackage, callingUid,</span><br><span class="line">                        isProtectedBroadcast, registeredReceivers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">BroadcastQueue</span> <span class="variable">queue</span> <span class="operator">=</span> broadcastQueueForIntent(intent);</span><br><span class="line">            <span class="type">BroadcastRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastRecord</span>(queue, intent, callerApp,</span><br><span class="line">                    callerPackage, callingPid, callingUid, callerInstantApp, resolvedType,</span><br><span class="line">                    requiredPermissions, appOp, brOptions, registeredReceivers, resultTo,</span><br><span class="line">                    resultCode, resultData, resultExtras, ordered, sticky, <span class="literal">false</span>, userId);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG_BROADCAST, <span class="string">&quot;Enqueueing parallel broadcast &quot;</span> + r);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">replaced</span> <span class="operator">=</span> replacePending</span><br><span class="line">                    &amp;&amp; (queue.replaceParallelBroadcastLocked(r) != <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// Note: We assume resultTo is null for non-ordered broadcasts.</span></span><br><span class="line">            <span class="keyword">if</span> (!replaced) &#123;</span><br><span class="line">                queue.enqueueParallelBroadcastLocked(r);</span><br><span class="line">                queue.scheduleBroadcastsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            registeredReceivers = <span class="literal">null</span>;</span><br><span class="line">            NR = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先处理系统的广播消息。然后将广播消息入队列</p>
<h5 id="BroadCastQueue-processNextBroadcast"><a href="#BroadCastQueue-processNextBroadcast" class="headerlink" title="BroadCastQueue.processNextBroadcast"></a>BroadCastQueue.processNextBroadcast</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">processNextBroadcast</span><span class="params">(<span class="type">boolean</span> fromMsg)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (app != <span class="literal">null</span> &amp;&amp; app.thread != <span class="literal">null</span> &amp;&amp; !app.killed) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            app.addPackage(info.activityInfo.packageName,</span><br><span class="line">                    info.activityInfo.applicationInfo.versionCode, mService.mProcessStats);</span><br><span class="line">            processCurBroadcastLocked(r, app);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果当前进程还在，那么处理当前广播</p>
<h5 id="BroadCastQueue-processCurBroadcastLocked"><a href="#BroadCastQueue-processCurBroadcastLocked" class="headerlink" title="BroadCastQueue.processCurBroadcastLocked"></a>BroadCastQueue.processCurBroadcastLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">processCurBroadcastLocked</span><span class="params">(BroadcastRecord r,</span></span><br><span class="line"><span class="params">            ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                ...</span><br><span class="line">                app.thread.scheduleReceiver(<span class="keyword">new</span> <span class="title class_">Intent</span>(r.intent), r.curReceiver,</span><br><span class="line">                    mService.compatibilityInfoForPackageLocked(r.curReceiver.applicationInfo),</span><br><span class="line">                    r.resultCode, r.resultData, r.resultExtras, r.ordered, r.userId,</span><br><span class="line">                    app.repProcState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果当前进程正在备份，那么忽略广播。更新进程状态，调整优先级。然后通知<code>ApplicationThread</code>处理广播</p>
<h5 id="ActivityThread-handleReceiver"><a href="#ActivityThread-handleReceiver" class="headerlink" title="ActivityThread.handleReceiver"></a>ActivityThread.handleReceiver</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleReceiver</span><span class="params">(ReceiverData data)</span> &#123;</span><br><span class="line">    <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">    <span class="comment">// we are back active so skip it.</span></span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">component</span> <span class="operator">=</span> data.intent.getComponent().getClassName();</span><br><span class="line"></span><br><span class="line">    <span class="type">LoadedApk</span> <span class="variable">packageInfo</span> <span class="operator">=</span> getPackageInfoNoCheck(</span><br><span class="line">            data.info.applicationInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="type">IActivityManager</span> <span class="variable">mgr</span> <span class="operator">=</span> ActivityManager.getService();</span><br><span class="line"></span><br><span class="line">    Application app;</span><br><span class="line">    BroadcastReceiver receiver;</span><br><span class="line">    ContextImpl context;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        app = packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line">        context = (ContextImpl) app.getBaseContext();</span><br><span class="line">        <span class="keyword">if</span> (data.info.splitName != <span class="literal">null</span>) &#123;</span><br><span class="line">            context = (ContextImpl) context.createContextForSplit(data.info.splitName);</span><br><span class="line">        &#125;</span><br><span class="line">        java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">        data.intent.setExtrasClassLoader(cl);</span><br><span class="line">        data.intent.prepareToEnterProcess();</span><br><span class="line">        data.setExtrasClassLoader(cl);</span><br><span class="line">        receiver = (BroadcastReceiver)cl.loadClass(component).newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.i(TAG,</span><br><span class="line">                <span class="string">&quot;Finishing failed broadcast to &quot;</span> + data.intent.getComponent());</span><br><span class="line">        data.sendFinished(mgr);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">            <span class="string">&quot;Unable to instantiate receiver &quot;</span> + component</span><br><span class="line">            + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">            TAG, <span class="string">&quot;Performing receive of &quot;</span> + data.intent</span><br><span class="line">            + <span class="string">&quot;: app=&quot;</span> + app</span><br><span class="line">            + <span class="string">&quot;, appName=&quot;</span> + app.getPackageName()</span><br><span class="line">            + <span class="string">&quot;, pkg=&quot;</span> + packageInfo.getPackageName()</span><br><span class="line">            + <span class="string">&quot;, comp=&quot;</span> + data.intent.getComponent().toShortString()</span><br><span class="line">            + <span class="string">&quot;, dir=&quot;</span> + packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">        sCurrentBroadcastIntent.set(data.intent);</span><br><span class="line">        receiver.setPendingResult(data);</span><br><span class="line">        receiver.onReceive(context.getReceiverRestrictedContext(),</span><br><span class="line">                data.intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.i(TAG,</span><br><span class="line">                <span class="string">&quot;Finishing failed broadcast to &quot;</span> + data.intent.getComponent());</span><br><span class="line">        data.sendFinished(mgr);</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(receiver, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                <span class="string">&quot;Unable to start receiver &quot;</span> + component</span><br><span class="line">                + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        sCurrentBroadcastIntent.set(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (receiver.getPendingResult() != <span class="literal">null</span>) &#123;</span><br><span class="line">        data.finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过反射，创建广播对象，然后调用<code>onReceive</code></p>
<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><h4 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h4><p><img data-src="/./register_receiver.png" alt="register"></p>
<h4 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h4><p><img data-src="/./send_receiver.png" alt="send"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/09/15/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90App%E5%90%AF%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/15/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90App%E5%90%AF%E5%8A%A8/" class="post-title-link" itemprop="url">源码角度分析App启动</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-15 10:27:08" itemprop="dateCreated datePublished" datetime="2017-09-15T10:27:08+08:00">2017-09-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="App启动点"><a href="#App启动点" class="headerlink" title="App启动点"></a>App启动点</h3><h4 id="ActivityThread-performLaunchActivity"><a href="#ActivityThread-performLaunchActivity" class="headerlink" title="ActivityThread.performLaunchActivity"></a>ActivityThread.performLaunchActivity</h4><p>一个<code>APP</code>是从桌面开始启动。其实也是启动一个新的<code>ACTIVITY</code>的过程。因此主要关注<code>ActivityThread.performLaunchActivity</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> r.packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>能够看出这个时候去创建了一个<code>Application</code>。因此<code>LoadApk</code>是<code>apk</code>的启动点</p>
<h4 id="LoadApk-makeApplication"><a href="#LoadApk-makeApplication" class="headerlink" title="LoadApk.makeApplication"></a>LoadApk.makeApplication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mApplication != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mApplication;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="type">ContextImpl</span> <span class="variable">appContext</span> <span class="operator">=</span> ContextImpl.createAppContext(mActivityThread, <span class="built_in">this</span>);</span><br><span class="line">app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">        cl, appClass, appContext);</span><br></pre></td></tr></table></figure>

<ul>
<li>如果<code>application</code>已经存在，那么直接返回</li>
<li>否则会创建<code>ContextImpl</code>，然后通过<code>Instrumentation</code>反射创建出<code>Application</code></li>
</ul>
<h3 id="LoadApk的由来"><a href="#LoadApk的由来" class="headerlink" title="LoadApk的由来"></a>LoadApk的由来</h3><h4 id="ActivityRecordClient-packageInfo"><a href="#ActivityRecordClient-packageInfo" class="headerlink" title="ActivityRecordClient.packageInfo"></a>ActivityRecordClient.packageInfo</h4><p>在源码里可以看出<code>LoadApk</code>是在<code>H Handler</code>中创建的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityStart&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">    r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">    handleLaunchActivity(r, <span class="literal">null</span>, <span class="string">&quot;LAUNCH_ACTIVITY&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取<code>LoadApk</code></li>
</ul>
<h4 id="ActivityThread-getPackageInfo"><a href="#ActivityThread-getPackageInfo" class="headerlink" title="ActivityThread.getPackageInfo"></a>ActivityThread.getPackageInfo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LoadedApk <span class="title function_">getPackageInfo</span><span class="params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span></span><br><span class="line"><span class="params">            ClassLoader baseLoader, <span class="type">boolean</span> securityViolation, <span class="type">boolean</span> includeCode,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> registerPackage)</span> &#123;</span><br><span class="line">                WeakReference&lt;LoadedApk&gt; ref;</span><br><span class="line">            <span class="keyword">if</span> (differentUser) &#123;</span><br><span class="line">                <span class="comment">// Caching not supported across users</span></span><br><span class="line">                ref = <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) &#123;</span><br><span class="line">                ref = mPackages.get(aInfo.packageName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ref = mResourcePackages.get(aInfo.packageName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//创建新的LoadApk</span></span><br><span class="line">    packageInfo =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LoadedApk</span>(<span class="built_in">this</span>, aInfo, compatInfo, baseLoader,</span><br><span class="line">                    securityViolation, includeCode &amp;&amp;</span><br><span class="line">                    (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="number">0</span>, registerPackage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果<code>app</code>已经启动，那么按照包名从缓存中获取。这里的缓存都是弱引用</li>
<li>如果是一个未启动的<code>app</code>，那么会创建新的<code>LoadApk</code>。然后放入缓存</li>
</ul>
<p>在<code>LoadedApk</code>中，能看到其用了系统<code>classLoader</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mClassLoader = ClassLoader.getSystemClassLoader();</span><br></pre></td></tr></table></figure>

<h4 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ClassLoader <span class="title function_">createSystemClassLoader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">classPath</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.class.path&quot;</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">librarySearchPath</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.library.path&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// String[] paths = classPath.split(&quot;:&quot;);</span></span><br><span class="line">    <span class="comment">// URL[] urls = new URL[paths.length];</span></span><br><span class="line">    <span class="comment">// for (int i = 0; i &lt; paths.length; i++) &#123;</span></span><br><span class="line">    <span class="comment">// try &#123;</span></span><br><span class="line">    <span class="comment">// urls[i] = new URL(&quot;file://&quot; + paths[i]);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// catch (Exception ex) &#123;</span></span><br><span class="line">    <span class="comment">// ex.printStackTrace();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// return new java.net.URLClassLoader(urls, null);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO Make this a java.net.URLClassLoader once we have those?</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PathClassLoader</span>(classPath, librarySearchPath, BootClassLoader.getInstance());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>最终会根据<code>classPath</code>,<code>libraryPath</code>以及<code>BootClassLoader</code>来创建<code>PathClassLoader</code>。其首个参数代表的就是<code>apk</code>中的<code>classes.dex</code>的路径</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span><br><span class="line"><span class="params">            String librarySearchPath, ClassLoader parent)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">        <span class="built_in">this</span>.pathList = <span class="keyword">new</span> <span class="title class_">DexPathList</span>(<span class="built_in">this</span>, dexPath, librarySearchPath, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里会创建<code>DexPathList</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,suppressedExceptions, definingContext);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="DexPathList-makeDexElements"><a href="#DexPathList-makeDexElements" class="headerlink" title="DexPathList.makeDexElements"></a>DexPathList.makeDexElements</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions, ClassLoader loader) &#123;</span><br><span class="line">    Element[] elements = <span class="keyword">new</span> <span class="title class_">Element</span>[files.size()];</span><br><span class="line">    <span class="type">int</span> <span class="variable">elementsPos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Open all files and load the (direct or contained) dex files up front.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">            <span class="comment">// We support directories for looking up resources. Looking up resources in</span></span><br><span class="line">            <span class="comment">// directories is useful for running libcore tests.</span></span><br><span class="line">            elements[elementsPos++] = <span class="keyword">new</span> <span class="title class_">Element</span>(file);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> file.getName();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">                <span class="comment">// Raw dex file (not inside a zip/jar).</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">DexFile</span> <span class="variable">dex</span> <span class="operator">=</span> loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                    <span class="keyword">if</span> (dex != <span class="literal">null</span>) &#123;</span><br><span class="line">                        elements[elementsPos++] = <span class="keyword">new</span> <span class="title class_">Element</span>(dex, <span class="literal">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException suppressed) &#123;</span><br><span class="line">                    System.logE(<span class="string">&quot;Unable to load dex file: &quot;</span> + file, suppressed);</span><br><span class="line">                    suppressedExceptions.add(suppressed);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">DexFile</span> <span class="variable">dex</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException suppressed) &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * IOException might get thrown &quot;legitimately&quot; by the DexFile constructor if</span></span><br><span class="line"><span class="comment">                    * the zip file turns out to be resource-only (that is, no classes.dex file</span></span><br><span class="line"><span class="comment">                    * in it).</span></span><br><span class="line"><span class="comment">                    * Let dex == null and hang on to the exception to add to the tea-leaves for</span></span><br><span class="line"><span class="comment">                    * when findClass returns null.</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    suppressedExceptions.add(suppressed);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dex == <span class="literal">null</span>) &#123;</span><br><span class="line">                    elements[elementsPos++] = <span class="keyword">new</span> <span class="title class_">Element</span>(file);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    elements[elementsPos++] = <span class="keyword">new</span> <span class="title class_">Element</span>(dex, file);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.logW(<span class="string">&quot;ClassLoader referenced unknown path: &quot;</span> + file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (elementsPos != elements.length) &#123;</span><br><span class="line">        elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> elements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>遍历所有文件，如果是目录，将目录存到<code>Element</code>数组中<br>8 如果是<code>.dex</code>文件，那么尝试加载，然后存在<code>Element</code>数组中。因此最终<code>.dex</code>的信息都会在<code>Element</code>数组中，那么如果替换<code>dex</code>，那么原理上也是可以的。很多热修复框架就是基于这个原理</li>
<li>上述这个是不分包的情况</li>
</ul>
<h4 id="MultiDexApplication"><a href="#MultiDexApplication" class="headerlink" title="MultiDexApplication"></a>MultiDexApplication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiDexApplication</span> <span class="keyword">extends</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">attachBaseContext</span><span class="params">(Context base)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.attachBaseContext(base);</span><br><span class="line">    MultiDex.install(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">String</span> <span class="variable">apkPath</span> <span class="operator">=</span> applicationInfo.sourceDir;</span><br><span class="line"><span class="keyword">if</span> (installedApk.contains(apkPath)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">installedApk.add(apkPath);</span><br><span class="line">...</span><br><span class="line">clearOldDexDir(context);</span><br><span class="line"></span><br><span class="line"><span class="type">File</span> <span class="variable">dexDir</span> <span class="operator">=</span> getDexDir(context, applicationInfo);</span><br><span class="line">List&lt;? <span class="keyword">extends</span> <span class="title class_">File</span>&gt; files =</span><br><span class="line">    MultiDexExtractor.load(context, applicationInfo, dexDir, <span class="literal">false</span>);</span><br><span class="line">installSecondaryDexes(loader, dexDir, files);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>apk</code>若已经安装过，那么直接返回</li>
<li>清除旧的<code>dex</code>目录</li>
<li>获取<code>Dex</code>目录</li>
<li>加载<code>dex</code>文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">File</span>&gt; load(Context context, ApplicationInfo applicationInfo, File dexDir,</span><br><span class="line">            <span class="type">boolean</span> forceReload) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//如果没有修改过，那么加载之前存在的dex</span></span><br><span class="line">                files = loadExistin</span><br><span class="line">                <span class="title function_">gExtractions</span><span class="params">(context, sourceApk, dexDir)</span>;</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//解压新的dex</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>加载旧的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;ExtractedDex&gt; <span class="title function_">loadExistingExtractions</span><span class="params">(</span></span><br><span class="line"><span class="params">            Context context, File sourceApk, File dexDir)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                ...<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">secondaryNumber</span> <span class="operator">=</span> <span class="number">2</span>; secondaryNumber &lt;= totalDexNumber; secondaryNumber++) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>依次加载从2开始的classes</p>
</li>
<li><p>加载新的</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;ExtractedDex&gt; <span class="title function_">performExtractions</span><span class="params">(File sourceApk, File dexDir)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                ...</span><br><span class="line">                 prepareDexDir(dexDir, extractedFilePrefix);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先移除老的<code>dex</code></li>
<li>依次从<code>classes2.dex</code>加载文件</li>
</ul>
<h4 id="MultiDex-installSecondaryDexes"><a href="#MultiDex-installSecondaryDexes" class="headerlink" title="MultiDex.installSecondaryDexes"></a>MultiDex.installSecondaryDexes</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!files.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</span><br><span class="line">        V19.install(loader, files, dexDir);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">        V14.install(loader, files, dexDir);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        V4.install(loader, files);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按系统版本区分加载</p>
<p>v19以上</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">install</span><span class="params">(ClassLoader loader,</span></span><br><span class="line"><span class="params">                List&lt;? extends File&gt; additionalClassPathEntries,</span></span><br><span class="line"><span class="params">                File optimizedDirectory)</span></span><br><span class="line">                ...</span><br><span class="line">                <span class="type">Field</span> <span class="variable">pathListField</span> <span class="operator">=</span> findField(loader, <span class="string">&quot;pathList&quot;</span>);</span><br><span class="line">                ...</span><br><span class="line">                expandFieldArray(dexPathList, <span class="string">&quot;dexElements&quot;</span>, makeDexElements(dexPathList,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;File&gt;(additionalClassPathEntries), optimizedDirectory,</span><br><span class="line">                    suppressedExceptions));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过反射找到<code>pathList</code></li>
<li>将加载出来的<code>dex</code>数组合并到原有的<code>dexElements</code>后面</li>
</ul>
<p>v14 跟 v19一样，只是少了很多异常处理</p>
<p>v4 合并path, files, zips, dex。之后的版本有<code>Element</code>来存储这些信息</p>
<p>热修复可以基于这种<code>dex</code>的原理，来加载自己的<code>dex</code>文件。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/09/10/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/10/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Service/" class="post-title-link" itemprop="url">源码角度分析Service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-10 22:37:39" itemprop="dateCreated datePublished" datetime="2017-09-10T22:37:39+08:00">2017-09-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2017-09-25 17:39:38" itemprop="dateModified" datetime="2017-09-25T17:39:38+08:00">2017-09-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文基于aosp8.0源码分析</p>
</blockquote>
<h3 id="Service的启动"><a href="#Service的启动" class="headerlink" title="Service的启动"></a>Service的启动</h3><p><code>Service</code>的启动分两种，一种<code>startService</code>，另一种<code>bindService</code></p>
<h4 id="StartService"><a href="#StartService" class="headerlink" title="StartService"></a>StartService</h4><p>一般我们会在<code>Activity</code>中通过<code>startService</code>来启动一个服务</p>
<h5 id="Activity-startService"><a href="#Activity-startService" class="headerlink" title="Activity.startService"></a>Activity.startService</h5><p>其内部实际上是由<code>ContextWrapper</code>的<code>startService</code>来启动，实际启动的地方是在<code>ContextImpl.startService</code></p>
<h5 id="ContextImpl-startService"><a href="#ContextImpl-startService" class="headerlink" title="ContextImpl.startService"></a>ContextImpl.startService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ComponentName <span class="title function_">startService</span><span class="params">(Intent service)</span> &#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line">    <span class="keyword">return</span> startServiceCommon(service, <span class="literal">false</span>, mUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ContextImpl-startServiceCommon"><a href="#ContextImpl-startServiceCommon" class="headerlink" title="ContextImpl.startServiceCommon"></a>ContextImpl.startServiceCommon</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ComponentName <span class="title function_">startServiceCommon</span><span class="params">(Intent service, <span class="type">boolean</span> requireForeground,</span></span><br><span class="line"><span class="params">        UserHandle user)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        validateServiceIntent(service);</span><br><span class="line">        service.prepareToLeaveProcess(<span class="built_in">this</span>);</span><br><span class="line">        <span class="type">ComponentName</span> <span class="variable">cn</span> <span class="operator">=</span> ActivityManager.getService().startService(</span><br><span class="line">            mMainThread.getApplicationThread(), service, service.resolveTypeIfNeeded(</span><br><span class="line">                        getContentResolver()), requireForeground,</span><br><span class="line">                        getOpPackageName(), user.getIdentifier());</span><br><span class="line">        <span class="keyword">if</span> (cn != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">&quot;!&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(</span><br><span class="line">                        <span class="string">&quot;Not allowed to start service &quot;</span> + service</span><br><span class="line">                        + <span class="string">&quot; without permission &quot;</span> + cn.getClassName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">&quot;!!&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(</span><br><span class="line">                        <span class="string">&quot;Unable to start service &quot;</span> + service</span><br><span class="line">                        + <span class="string">&quot;: &quot;</span> + cn.getClassName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cn.getPackageName().equals(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                        <span class="string">&quot;Not allowed to start service &quot;</span> + service + <span class="string">&quot;: &quot;</span> + cn.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cn;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里首选需要验证服务,5.0之后隐世服务就不被允许，何为隐世，未指定包名，未指定类名</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title function_">getService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IActivityManagerSingleton.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从<code>ServiceManager</code>中获取<code>ActivityManager</code>的<code>IBinder</code>对象</li>
<li>通过<code>IPC</code>获取了<code>ActivityManagerService</code>对象</li>
<li>每个系统服务都采用了<code>AIDL</code>的方式进行，不直接对外暴露代理</li>
</ul>
<h5 id="IActivityManager-aidl"><a href="#IActivityManager-aidl" class="headerlink" title="IActivityManager.aidl"></a>IActivityManager.aidl</h5><p>该文件对应的<code>native</code>实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BpActivityManager</span> : <span class="keyword">public</span> BpInterface&lt;IActivityManager&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">BpActivityManager</span><span class="params">(<span class="type">const</span> sp&lt;IBinder&gt;&amp; impl)</span></span></span><br><span class="line"><span class="function">        : BpInterface&lt;IActivityManager&gt;(impl)</span></span><br><span class="line"><span class="function">    &#123;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">openContentUri</span><span class="params">(<span class="type">const</span> String16&amp; stringUri)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Parcel data, reply;</span><br><span class="line">        data.<span class="built_in">writeInterfaceToken</span>(IActivityManager::<span class="built_in">getInterfaceDescriptor</span>());</span><br><span class="line">        data.<span class="built_in">writeString16</span>(stringUri);</span><br><span class="line">        <span class="type">status_t</span> ret = <span class="built_in">remote</span>()-&gt;<span class="built_in">transact</span>(OPEN_CONTENT_URI_TRANSACTION, data, &amp; reply);</span><br><span class="line">        <span class="type">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (ret == NO_ERROR) &#123;</span><br><span class="line">            <span class="type">int32_t</span> exceptionCode = reply.<span class="built_in">readExceptionCode</span>();</span><br><span class="line">            <span class="keyword">if</span> (!exceptionCode) &#123;</span><br><span class="line">                <span class="comment">// Success is indicated here by a nonzero int followed by the fd;</span></span><br><span class="line">                <span class="comment">// failure by a zero int with no data following.</span></span><br><span class="line">                <span class="keyword">if</span> (reply.<span class="built_in">readInt32</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">                    fd = <span class="built_in">fcntl</span>(reply.<span class="built_in">readParcelFileDescriptor</span>(), F_DUPFD_CLOEXEC, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// An exception was thrown back; fall through to return failure</span></span><br><span class="line">                <span class="built_in">ALOGD</span>(<span class="string">&quot;openContentUri(%s) caught exception %d\n&quot;</span>,</span><br><span class="line">                        <span class="built_in">String8</span>(stringUri).<span class="built_in">string</span>(), exceptionCode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="ActivityManagerService-startService"><a href="#ActivityManagerService-startService" class="headerlink" title="ActivityManagerService.startService"></a>ActivityManagerService.startService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title class_">IActivityManager</span>.Stub &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ComponentName <span class="title function_">startService</span><span class="params">(IApplicationThread caller, Intent service,</span></span><br><span class="line"><span class="params">            String resolvedType, <span class="type">boolean</span> requireForeground, String callingPackage, <span class="type">int</span> userId)</span></span><br><span class="line">            <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">                ...</span><br><span class="line">                res = mServices.startServiceLocked(caller, service,</span><br><span class="line">                        resolvedType, callingPid, callingUid,</span><br><span class="line">                        requireForeground, callingPackage, userId);</span><br><span class="line">                ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ActivityManagerService</code>就是<code>ActivityManager</code>定义的<code>AIDL</code>的具体实现</li>
<li>调用<code>ActiveServices.startServiceLocked</code></li>
</ul>
<h5 id="ActiveServices-startServiceLocked"><a href="#ActiveServices-startServiceLocked" class="headerlink" title="ActiveServices.startServiceLocked"></a>ActiveServices.startServiceLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ComponentName <span class="title function_">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> callingPid, <span class="type">int</span> callingUid, <span class="type">boolean</span> fgRequired, String callingPackage, <span class="keyword">final</span> <span class="type">int</span> userId)</span></span><br><span class="line">            <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">//启动服务</span></span><br><span class="line">                <span class="type">ComponentName</span> <span class="variable">cmp</span> <span class="operator">=</span> startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">                ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检查<code>Service</code>调用者合法性。创建并缓存<code>Service</code>信息</p>
<h5 id="ActiveServices-startServiceInnerLocked"><a href="#ActiveServices-startServiceInnerLocked" class="headerlink" title="ActiveServices.startServiceInnerLocked"></a>ActiveServices.startServiceInnerLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ComponentName <span class="title function_">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> callerFg, <span class="type">boolean</span> addToStarting)</span> <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    <span class="type">ServiceState</span> <span class="variable">stracker</span> <span class="operator">=</span> r.getTracker();</span><br><span class="line">    <span class="keyword">if</span> (stracker != <span class="literal">null</span>) &#123;</span><br><span class="line">        stracker.setStarted(<span class="literal">true</span>, mAm.mProcessStats.getMemFactorLocked(), r.lastActivity);</span><br><span class="line">    &#125;</span><br><span class="line">    r.callStart = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">        r.stats.startRunningLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;!!&quot;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">first</span> <span class="operator">=</span> smap.mStartingBackground.size() == <span class="number">0</span>;</span><br><span class="line">        smap.mStartingBackground.add(r);</span><br><span class="line">        r.startingBgTimeout = SystemClock.uptimeMillis() + mAm.mConstants.BG_START_TIMEOUT;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_SERVICE) &#123;</span><br><span class="line">            <span class="type">RuntimeException</span> <span class="variable">here</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;here&quot;</span>);</span><br><span class="line">            here.fillInStackTrace();</span><br><span class="line">            Slog.v(TAG_SERVICE, <span class="string">&quot;Starting background (first=&quot;</span> + first + <span class="string">&quot;): &quot;</span> + r, here);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) &#123;</span><br><span class="line">            Slog.v(TAG_SERVICE, <span class="string">&quot;Starting background (first=&quot;</span> + first + <span class="string">&quot;): &quot;</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (first) &#123;</span><br><span class="line">            smap.rescheduleDelayedStartsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg || r.fgRequired) &#123;</span><br><span class="line">        smap.ensureNotStartingBackgroundLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r.name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用<code>bringUpServiceLocked</code>，处理返回结果</p>
<h5 id="ActiveService-bringUpServiceLocked"><a href="#ActiveService-bringUpServiceLocked" class="headerlink" title="ActiveService.bringUpServiceLocked"></a>ActiveService.bringUpServiceLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="type">int</span> intentFlags, <span class="type">boolean</span> execInFg,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> whileRestarting, <span class="type">boolean</span> permissionsReviewRequired)</span></span><br><span class="line">            <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="literal">null</span> &amp;&amp; r.app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//服务已经启动</span></span><br><span class="line">        sendServiceArgsLocked(r, execInFg, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">&quot;bringUpServiceLocked: appInfo.uid=&quot;</span> + r.appInfo.uid</span><br><span class="line">                + <span class="string">&quot; app=&quot;</span> + app);</span><br><span class="line">    <span class="keyword">if</span> (app != <span class="literal">null</span> &amp;&amp; app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);</span><br><span class="line">            realStartServiceLocked(r, app, execInFg);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Exception when starting service &quot;</span> + r.shortName, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">        <span class="comment">// restart the application.</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果服务已经启动，调用<code>sendserviceArgsLocked</code>。首次创建。获取进程信息。调用<code>realStartServiceLocked</code></p>
<h5 id="ActiveServices-realStartServiceLocked"><a href="#ActiveServices-realStartServiceLocked" class="headerlink" title="ActiveServices.realStartServiceLocked"></a>ActiveServices.realStartServiceLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span><br><span class="line"><span class="params">            ProcessRecord app, <span class="type">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">newService</span> <span class="operator">=</span> app.services.add(r);</span><br><span class="line">                ...</span><br><span class="line">                ...</span><br><span class="line">                app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                    app.repProcState);</span><br><span class="line">                ...</span><br><span class="line"></span><br><span class="line">                sendServiceArgsLocked(r, execInFg, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新服务优先级。通知<code>ApplicationThread</code>创建启动<code>Service</code>。之后调用<code>sendServiceArgsLocked</code>，其作用，处理<code>Service</code>参数，并回调<code>onStartCommand</code></p>
<h5 id="ActivityThread-scheduleCreateService"><a href="#ActivityThread-scheduleCreateService" class="headerlink" title="ActivityThread.scheduleCreateService"></a>ActivityThread.scheduleCreateService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">scheduleCreateService</span><span class="params">(IBinder token,</span></span><br><span class="line"><span class="params">                ServiceInfo info, CompatibilityInfo compatInfo, <span class="type">int</span> processState)</span> &#123;</span><br><span class="line">    updateProcessState(processState, <span class="literal">false</span>);</span><br><span class="line">    <span class="type">CreateServiceData</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateServiceData</span>();</span><br><span class="line">    s.token = token;</span><br><span class="line">    s.info = info;</span><br><span class="line">    s.compatInfo = compatInfo;</span><br><span class="line"></span><br><span class="line">    sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>H Handler</code>发出消息，创建<code>service</code></p>
</li>
<li><p>总结; 在8.0中，一个服务的启动流程是:<br><code>ContextImpl.startService</code> -&gt; <code>startCommonService</code>-&gt;<code>ActivityManager.getService</code>-&gt;<code>ServiceManager.getService</code>-&gt;(IPC) <code>AMS.startService</code>-&gt; <code>ActiveService.startServiceLocked</code>-&gt;<code>startServiceInnerLocked</code>-&gt;<code>bringUpServiceLocked</code>-&gt;<code>realStartServiceLocked</code>-&gt;<code>ApplicationThread.scheduleCreateService</code>-&gt;<code>H.handleCreateService</code></p>
</li>
</ul>
<h4 id="BindService"><a href="#BindService" class="headerlink" title="BindService"></a>BindService</h4><p><code>bindService</code>的流程，跟<code>startService</code>很相似。</p>
<h5 id="ActiveServices-bindServiceLocked"><a href="#ActiveServices-bindServiceLocked" class="headerlink" title="ActiveServices.bindServiceLocked"></a>ActiveServices.bindServiceLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bindServiceLocked</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span><br><span class="line"><span class="params">            String resolvedType, <span class="keyword">final</span> IServiceConnection connection, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">            String callingPackage, <span class="keyword">final</span> <span class="type">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">                ...</span><br><span class="line">                ArrayList&lt;ConnectionRecord&gt; clist = s.connections.get(binder);</span><br><span class="line">            <span class="keyword">if</span> (clist == <span class="literal">null</span>) &#123;</span><br><span class="line">                clist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ConnectionRecord&gt;();</span><br><span class="line">                s.connections.put(binder, clist);</span><br><span class="line">            &#125;</span><br><span class="line">            clist.add(c);</span><br><span class="line">            b.connections.add(c);</span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (activity.connections == <span class="literal">null</span>) &#123;</span><br><span class="line">                    activity.connections = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;ConnectionRecord&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                activity.connections.add(c);</span><br><span class="line">            &#125;</span><br><span class="line">            b.client.connections.add(c);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line">                s.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">                <span class="keyword">if</span> (bringUpServiceLocked(s, service.getFlags(), callerFg, <span class="literal">false</span>,</span><br><span class="line">                        permissionsReviewRequired) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ServiceRecord</code>存储每个<code>Binder</code>，也就是<code>ServiceConnection</code>。内部的数据结构都是<code>Set</code>，确保<code>Binder</code>唯一。调用<code>bringUpServiceLocked</code></p>
<h5 id="ActiveServices-bringUpServiceLocked"><a href="#ActiveServices-bringUpServiceLocked" class="headerlink" title="ActiveServices.bringUpServiceLocked"></a>ActiveServices.bringUpServiceLocked</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="type">int</span> intentFlags, <span class="type">boolean</span> execInFg,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> whileRestarting, <span class="type">boolean</span> permissionsReviewRequired)</span></span><br><span class="line">            <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首次绑定<code>Service</code>的过程和<code>startService</code>一样。也是调用<code>realStartServiceLocked</code>。非首次也是调用<code>sendServiceArgsLocked</code>,这个函数中，如果有<code>startService</code>的话，那么会发出消息通知<code>ApplicationThread</code>需要处理<code>onStartCommand</code>。<code>BindService</code>下，会直接返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span><br><span class="line"><span class="params">            ProcessRecord app, <span class="type">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//创建过程一样</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    requestServiceBindingsLocked(r, execInFg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建过程一样。创建完之后会检查是否有<code>Binder</code>。如果有直接通知<code>ApplicationThread</code>需要绑定服务。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>客户端发起启动服务请求,通过<code>IPC</code>的方式通知<code>SystemServer</code>进程中的<code>ActivityManagerService</code>，然后通知<code>ApplicationThread</code>创建服务  </p>
<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><h4 id="StartService-1"><a href="#StartService-1" class="headerlink" title="StartService"></a>StartService</h4><p><img data-src="/./startService.png" alt="startService"></p>
<h4 id="BindService-1"><a href="#BindService-1" class="headerlink" title="BindService"></a>BindService</h4><p><img data-src="/./bindService.png" alt="bindService"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/09/09/Build-AOSP-in-mac-osx-10-11-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/09/Build-AOSP-in-mac-osx-10-11-3/" class="post-title-link" itemprop="url">Build AOSP(8.0) in mac osx 10.12.6</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-09-09 16:01:03 / Modified: 11:19:21" itemprop="dateCreated datePublished" datetime="2017-09-09T16:01:03+08:00">2017-09-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="更新"><a href="#更新" class="headerlink" title="更新:"></a>更新:</h3><p>2017-09-09更新AOSP8.0的编译<br>2016-05-01更新AOSP6.0编译</p>
<h3 id="配置OSX系统"><a href="#配置OSX系统" class="headerlink" title="配置OSX系统"></a>配置OSX系统</h3><ol>
<li>安装<code>Xcode</code></li>
<li>找到<code>Xcode</code>安装目录，右键打开<code>show package content</code></li>
<li>创建<code>/Developer/SDK</code>目录</li>
<li>将<code>MacOSX10.11.sdk</code>从<code>Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/</code>复制到<code>/Developer/SDK</code></li>
<li>将<code>Xcode.app</code>复制到到&#x2F;Developer目录下</li>
</ol>
<h4 id="完成Xcode的配置"><a href="#完成Xcode的配置" class="headerlink" title="完成Xcode的配置"></a>完成<code>Xcode</code>的配置</h4><ol>
<li>打开<code>Xcode</code></li>
<li>从<code>Xcode</code>的菜单打开<code>Preferences</code></li>
<li>选择<code>Location</code>标签</li>
<li>在<code>Command Line Tools</code>中选择<code>Xcodd 7.2</code>(具体版本依个人电脑上的Xcode版本而定)</li>
</ol>
<h4 id="安装MacPorts"><a href="#安装MacPorts" class="headerlink" title="安装MacPorts"></a>安装<code>MacPorts</code></h4><ol>
<li>获取最新版的<a target="_blank" rel="noopener" href="https://www.macports.org/install.php">MacPorts</a>!</li>
<li>打开控制台，编辑<code>bash</code>配置文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/.bash_profile</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在配置文件中插入</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export PATH=/opt/local/bin:$PATH</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>重新载入配置信息</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ . ~/.bash_profile</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>运行<code>port</code>命令检测是否成功安装</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ port</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>安装需要的依赖包</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ POSIXLY_CORRECT=1 sudo port install gmake libsdl git gnupg</span><br></pre></td></tr></table></figure>

<h4 id="安装java开发包-JDK1-7"><a href="#安装java开发包-JDK1-7" class="headerlink" title="安装java开发包(JDK1.7)"></a>安装<code>java</code>开发包(JDK1.7)</h4><h4 id="安装Repo"><a href="#安装Repo" class="headerlink" title="安装Repo"></a>安装<code>Repo</code></h4><p><code>Repo</code>是基于<code>git</code>的一种工具，能很方便的用来管理<code>Android</code>源码。更多信息请<a target="_blank" rel="noopener" href="http://source.android.com/source/developing.html">查看</a></p>
<ol>
<li>确保根目录下有<code>/bin</code>目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/bin</span><br><span class="line">$ PATH=~/bin:$PATH</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>下载<code>Repo</code>工具，确保它可以运行</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo</span><br><span class="line">$ chmod a+x ~/bin/repo</span><br></pre></td></tr></table></figure>

<h4 id="设置文件描述符"><a href="#设置文件描述符" class="headerlink" title="设置文件描述符"></a>设置文件描述符</h4><p><code>OSX</code>系统的默认文件描述符的数量太小，高并行构建可能会超出这个限制。为了突破这个限制，添加以下命令到<code>.bash_profile</code>中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/.bash_profile</span><br><span class="line">~~~~~</span><br><span class="line"># set the number of open files to be 1024</span><br><span class="line">ulimit -S -n 1024</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="创建字符大小写敏感的虚拟驱动"><a href="#创建字符大小写敏感的虚拟驱动" class="headerlink" title="创建字符大小写敏感的虚拟驱动"></a>创建字符大小写敏感的虚拟驱动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hdiutil create -type SPARSE -fs &#x27;Case-sensitive Journaled HFS+&#x27; -size 100g ~/android.dmg</span><br></pre></td></tr></table></figure>
<p>源码很大，因此建议要创建大一点的虚拟光驱</p>
<p>挂载这个驱动:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdiutil attach ~/android.dmg -mountpoint /Volumes/android</span><br></pre></td></tr></table></figure>

<p>你也可以用另一种方式，在配置文件中加入如下方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function mountAndroid &#123; hdiutil attach ~/android.dmg.sparseimage -mountpoint /Volumes/android; &#125;</span><br></pre></td></tr></table></figure>

<p>然后运行如下命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mountAndroid</span><br></pre></td></tr></table></figure>

<h3 id="下载源文件"><a href="#下载源文件" class="headerlink" title="下载源文件"></a>下载源文件</h3><p>首先我们确定我们要下载的是哪个版本的源码，本文以<code>android-6.0.1_r30</code>为例</p>
<p>首先在<code>/Volumes/android</code>创建一个工作目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /Volumes/android</span><br><span class="line">$ mkdir WORKING_DIRECTORY</span><br><span class="line">$ cd WORKING_DIRECTORY</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ repo init -u https://android.googlesource.com/platform/manifest -b android-5.0.0_r7.0.1</span><br></pre></td></tr></table></figure>

<p>最后运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo sync</span><br></pre></td></tr></table></figure>
<p>来下载源码</p>
<h3 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h3><p>在源码根目录运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ source build/envsetup.sh</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lunch</span><br></pre></td></tr></table></figure>

<p>按回车选择<code>aosp_arm-eng</code>。</p>
<p>安装openssl curl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install curl --with-openssl</span><br><span class="line">export PATH=$(brew --prefix curl)/bin:$PATH</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">caffeinate make -j4</span><br></pre></td></tr></table></figure>
<p><code>caffeinate</code>阻止休眠</p>
<p>开始漫长的编译过程</p>
<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make idegen &amp;&amp; development/tools/idegen/idegen.sh</span><br></pre></td></tr></table></figure>
<p>生成可被<code>IDE</code>识别的工程。</p>
<h3 id="碰到的一些问题"><a href="#碰到的一些问题" class="headerlink" title="碰到的一些问题"></a>碰到的一些问题</h3><ul>
<li>下载源码时，需要比较长的时间，还好支持断点续传。(被盾的地方，必须使用VPN)</li>
<li>源码下载完之后，编译会碰到找不到MacOSsdk。按照文中开头的步骤即可解决</li>
<li>编译过程中会出现<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: linux/netfilter/xt_DSCP.h: No such file or directory</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这是由于我的源码没有直接在<code>/Volumns/android</code>下下载，是从别的地方下载完之后拷贝过来的。而编译源码会严格区分大小写的。相应目录下有小写的头文件。</p>
<p>解决方案是：</p>
<ol>
<li>严格按照官方文档描述，在相应目录下下载源码</li>
<li>在<code>./external/iptables/include/linux/netfilter</code>中创建头文件<code>xt_DSCP.h</code>。在该头文件中加入如下代码:</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* based on ipt_FTOS.c (C) 2000 by Matthew G. Marsh &lt;mgm@paktronix.com&gt;</span><br><span class="line">* This software is distributed under GNU GPL v2, 1991</span><br><span class="line">*</span><br><span class="line">* See RFC2474 for a description of the DSCP field within the IP Header.</span><br><span class="line">*</span><br><span class="line">* xt_DSCP.h,v 1.7 2002/03/14 12:03:13 laforge Exp</span><br><span class="line">*/</span><br><span class="line">#ifndef _XT_DSCP_TARGET_H</span><br><span class="line">#define _XT_DSCP_TARGET_H</span><br><span class="line">#include &lt;linux/netfilter/xt_dscp.h&gt;</span><br><span class="line">#include &lt;linux/types.h&gt;</span><br><span class="line"></span><br><span class="line">/* target info */</span><br><span class="line">struct xt_DSCP_info &#123;</span><br><span class="line">    __u8 dscp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct xt_tos_target_info &#123;</span><br><span class="line">    __u8 tos_value;</span><br><span class="line">    __u8 tos_mask;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif /* _XT_DSCP_TARGET_H */</span><br></pre></td></tr></table></figure>

<ul>
<li>Java文件找不到</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">external/doclava/src/com/google/doclava/ClassInfo.java:20: error: package com.sun.javadoc does not exist import com.sun.javadoc.ClassDoc</span><br></pre></td></tr></table></figure>

<p>解决方案是在配置文件中加入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export PATH=/Library/Java/JavaVirtualMachines/jdk1.7.0_75.jdk/Contents/Home/bin:$PATH</span><br></pre></td></tr></table></figure>

<ul>
<li>编译最新版的aosp可能会遇到<code>Unsupported curl, please use a curl not based on SecureTransport</code>。解决方案是运行一下命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install curl --with-openssl</span><br><span class="line">export PATH=$(brew --prefix curl)/bin:$PATH</span><br><span class="line">caffeinate make -j4</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/09/09/OkHttp%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/09/OkHttp%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">OkHttp3分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-09-09 15:50:11 / Modified: 21:06:01" itemprop="dateCreated datePublished" datetime="2017-09-09T15:50:11+08:00">2017-09-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="更新"><a href="#更新" class="headerlink" title="更新:"></a>更新:</h4><p>2017-09-09<br>2016-10-02</p>
<h4 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h4><p>本文主要分析<code>OkHttp3</code>的原理。。其有很多特点: </p>
<ul>
<li><code>HTTP2/SPDY</code>支持所有面向相同主机的请求共享一个<code>Socket</code></li>
<li>连接池减少请求时间，减少握手次数</li>
<li>基于<code>Headers</code>的缓存策略</li>
<li>响应缓存避免重复的请求</li>
<li>线程队列，支持高效并发</li>
</ul>
<p>本文基于OkHttp3.10.0-SNAPSHOT，需要弄懂一下几个问题</p>
<ul>
<li>连接池如何维护</li>
<li>线程队列如何维护</li>
<li>缓存机制如何实现</li>
<li>重试机制是怎样的</li>
</ul>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><h5 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//get</span></span><br><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">    .url(url)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//post</span></span><br><span class="line"><span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> ReqeustBody.create(JSON, json);</span><br><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">    .url(url)</span><br><span class="line">    .build();</span><br><span class="line">    </span><br><span class="line"><span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute()) &#123;</span><br><span class="line">  <span class="keyword">return</span> response.body().string();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//get</span></span><br><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">    .url(url)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//post</span></span><br><span class="line"><span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> ReqeustBody.create(JSON, json);</span><br><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">    .url(url)</span><br><span class="line">    .build();</span><br><span class="line">    </span><br><span class="line">client.newCall(request).enqueue(Callback)</span><br></pre></td></tr></table></figure>

<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><h5 id="OkHttpClient"><a href="#OkHttpClient" class="headerlink" title="OkHttpClient"></a>OkHttpClient</h5><p><code>OkHttpClient</code>创建的时候，如果没有执行建造器，会使用默认构造器。这里用到了建造者模式，便于参数的配置。默认参数包括</p>
<ul>
<li>支持协议: HTTP&#x2F;2,HTTP1.1，默认没有支持(SPDY)</li>
<li>传输层协议: TLS(传输层安全协议SNI,ALPN)，未加密协议</li>
<li>代理选择器: 使用系统默认的代理选择器</li>
<li>Socket工厂: 默认</li>
<li>主机名验证: 包括验证IP,域名及证书验证X509认证</li>
<li>证书信任验证: 防止证书认证攻击和中间人攻击</li>
<li>连接池</li>
<li>dns</li>
<li>各种超时(连接，读，写: 10s</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Call <span class="title function_">newCall</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RealCall</span>(<span class="built_in">this</span>, request, <span class="literal">false</span> <span class="comment">/* for web socket */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建<code>RealCall</code></li>
</ul>
<h5 id="RealCall"><a href="#RealCall" class="headerlink" title="RealCall"></a>RealCall</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">RealCall</span><span class="params">(OkHttpClient client, Request originalRequest, <span class="type">boolean</span> forWebSocket)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.client = client;</span><br><span class="line">    <span class="built_in">this</span>.originalRequest = originalRequest;</span><br><span class="line">    <span class="built_in">this</span>.forWebSocket = forWebSocket;</span><br><span class="line">    <span class="built_in">this</span>.retryAndFollowUpInterceptor = <span class="keyword">new</span> <span class="title class_">RetryAndFollowUpInterceptor</span>(client, forWebSocket);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建<code>RealCall</code>时会创建<code>RetryAndFollowUpInterceptor</code></li>
</ul>
<p>请求创建完成，接下来开始发起请求</p>
<h5 id="同步请求execute"><a href="#同步请求execute" class="headerlink" title="同步请求execute"></a>同步请求execute</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Already Executed&quot;</span>);</span><br><span class="line">      executed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    captureCallStackTrace();</span><br><span class="line">    eventListener.callStart(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//通过Dispatcher执行请求</span></span><br><span class="line">      client.dispatcher().executed(<span class="built_in">this</span>);</span><br><span class="line">      <span class="type">Response</span> <span class="variable">result</span> <span class="operator">=</span> getResponseWithInterceptorChain();</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Canceled&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      eventListener.callFailed(<span class="built_in">this</span>, e);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      client.dispatcher().finished(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过<code>Dispatcher</code>下发请求。这里是同步的请求。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">executed</span><span class="params">(RealCall call)</span> &#123;</span><br><span class="line">    runningSyncCalls.add(call);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Dispatcher</code>内部有个存储同步运行的<code>Deque</code>双端队列，队列默认大小是16</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>对于<code>ArrayDeque</code>来说,其内部如果容量不够，每次都会翻倍扩容，当大小超过<code>Integer.MAX_VALUE</code>时会抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> n &lt;&lt; <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Sorry, deque too big&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>因此到这里，也仅仅只是将请求放入到双端队列中，还没真正开始执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Response <span class="title function_">getResponseWithInterceptorChain</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">    List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//添加自定义的interceptor</span></span><br><span class="line">    interceptors.addAll(client.interceptors());</span><br><span class="line">    <span class="comment">//添加重试机制</span></span><br><span class="line">    interceptors.add(retryAndFollowUpInterceptor);</span><br><span class="line">    <span class="comment">//桥接用户请求到网络请求</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">BridgeInterceptor</span>(client.cookieJar()));</span><br><span class="line">    <span class="comment">//加入缓存机制</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">CacheInterceptor</span>(client.internalCache()));</span><br><span class="line">    <span class="comment">//加入连接拦截器</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">ConnectInterceptor</span>(client));</span><br><span class="line">    <span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">      <span class="comment">//非websocket,网络拦截器</span></span><br><span class="line">      interceptors.addAll(client.networkInterceptors());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//服务器请求拦截器</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">CallServerInterceptor</span>(forWebSocket));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拦截链开始执行</span></span><br><span class="line">    Interceptor.<span class="type">Chain</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealInterceptorChain</span>(interceptors, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>,</span><br><span class="line">        originalRequest, <span class="built_in">this</span>, eventListener, client.connectTimeoutMillis(),</span><br><span class="line">        client.readTimeoutMillis(), client.writeTimeoutMillis());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>添加拦截器，默认有重试拦截器，桥接拦截器，缓存拦截器，连接拦截器，网络拦截器，调用服务器拦截器。这里可以看得出，将网络请求细化成了很多小部分，便于对每部分的控制。然后开始执行请求。</li>
</ul>
<h5 id="拦截器链-RealInterceptorChain"><a href="#拦截器链-RealInterceptorChain" class="headerlink" title="拦截器链(RealInterceptorChain)"></a>拦截器链(RealInterceptorChain)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Response <span class="title function_">proceed</span><span class="params">(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,</span></span><br><span class="line"><span class="params">      RealConnection connection)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">RealInterceptorChain</span> <span class="variable">next</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealInterceptorChain</span>(interceptors, streamAllocation, httpCodec,</span><br><span class="line">        connection, index + <span class="number">1</span>, request, call, eventListener, connectTimeout, readTimeout,</span><br><span class="line">        writeTimeout);</span><br><span class="line">        <span class="type">Interceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> interceptors.get(index);</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> interceptor.intercept(next);</span><br><span class="line">        ...</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure>

<ul>
<li>检查是否已经编码，如果已经编过码，检查连接的<code>url</code>是否正确</li>
<li>创建新的连接链，并传入下一个拦截器。直到所有的拦截器执行完成，返回结果。</li>
</ul>
<h5 id="Dispatcher异步请求策略"><a href="#Dispatcher异步请求策略" class="headerlink" title="Dispatcher异步请求策略"></a>Dispatcher异步请求策略</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(AsyncCall call)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">      runningAsyncCalls.add(call);</span><br><span class="line">      executorService().execute(call);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      readyAsyncCalls.add(call);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主要由两个双端队列来维护，一个正在运行请求的队列，一个准备好请求的队列</li>
<li>如果队列的大小小于最大请求数并且队列请求中同一个主机的请求数小于最大请求数，添加到队列，否则添加到准备队列。默认最大请求数64，同一主机最大请求数5</li>
<li>使用线程队列执行每个运行中的请求，线程队列采用的<code>SynchronousQueue</code>，控制多线程并发，其内部永远是个空状态，任务插入操作之后，必然等待任务取出操作，内部有个<code>TransferQueue</code>来讲任务插入或取出，确保操作线程安全</li>
</ul>
<h5 id="AsyncCall"><a href="#AsyncCall" class="headerlink" title="AsyncCall"></a>AsyncCall</h5><p>内部的流程跟同步的流程一样</p>
<p>上述不管是同步，或者异步，执行完之后都会调用<code>Dispatcher</code>进行<code>finish</code>操作。来将任务移出队列。如果是异步，还会将准备队列的任务加入到运行队列，并交由线程池运行。至此，一次请求执行完成。这里面拦截器很重要，会在之后详细描述</p>
<h4 id="拦截器-Interceptor"><a href="#拦截器-Interceptor" class="headerlink" title="拦截器(Interceptor)"></a>拦截器(Interceptor)</h4><h5 id="RetryAndFollowUpInterceptor"><a href="#RetryAndFollowUpInterceptor" class="headerlink" title="RetryAndFollowUpInterceptor"></a>RetryAndFollowUpInterceptor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * How many redirects and auth challenges should we attempt? Chrome follows 21 redirects; Firefox,</span></span><br><span class="line"><span class="comment">   * curl, and wget follow 20; Safari follows 16; and HTTP/1.0 recommends 5.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_FOLLOW_UPS</span> <span class="operator">=</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p>关于重试次数，<code>Chrome</code>使用21次，<code>Firefox</code>,<code>curl</code>和<code>wget</code>使用20次,Safari使用16次，HTTP&#x2F;1.0建议5次<br>最大重试20次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ...</span><br><span class="line">  streamAllocation = <span class="keyword">new</span> <span class="title class_">StreamAllocation</span>(client.connectionPool(), createAddress(request.url()),</span><br><span class="line">        call, eventListener, callStackTrace);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (canceled) &#123;</span><br><span class="line">        streamAllocation.release();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Canceled&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        response = realChain.proceed(request, streamAllocation, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        releaseConnection = <span class="literal">false</span>;</span><br><span class="line">      &#125;<span class="keyword">catch</span>(RouteException e) &#123;</span><br><span class="line">        recover()</span><br><span class="line">      &#125;<span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">        recover()</span><br><span class="line">      &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//other exception release</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">Request</span> <span class="variable">followUp</span> <span class="operator">=</span> followUpRequest(response);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>StreamAllocation</code>协调连接池，地址信息以及请求序列</li>
<li>如果请求取消了，那么释放当前<code>Socket</code>资源</li>
<li>尝试发出网络请求，捕获这个过程的异常。<ul>
<li>如果是<code>RouteException</code>，尝试恢复</li>
<li><code>IOException</code>异常</li>
</ul>
</li>
<li>本次请求成功，释放资源</li>
<li>如果之前请求结果存在，获取该响应对应的请求<code>followUpRequest</code></li>
<li>如果请求不存在，直接返回该响应</li>
<li>如果请求次数超过上限，抛出异常</li>
<li>如果请求体已经编过码，抛出异常</li>
<li>响应和请求不是相同的地址，创建新的<code>StreamAllocation</code></li>
<li>保存该请求和该响应</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">recover</span><span class="params">(IOException e, <span class="type">boolean</span> requestSendStarted, Request userRequest)</span> &#123;</span><br><span class="line">    streamAllocation.streamFailed(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The application layer has forbidden retries.</span></span><br><span class="line">    <span class="keyword">if</span> (!client.retryOnConnectionFailure()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We can&#x27;t send the request body again.</span></span><br><span class="line">    <span class="keyword">if</span> (requestSendStarted &amp;&amp; userRequest.body() <span class="keyword">instanceof</span> UnrepeatableRequestBody) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This exception is fatal.</span></span><br><span class="line">    <span class="keyword">if</span> (!isRecoverable(e, requestSendStarted)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No more routes to attempt.</span></span><br><span class="line">    <span class="keyword">if</span> (!streamAllocation.hasMoreRoutes()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For failure recovery, use the same route selector with a new connection.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>尝试重新连接，判断客户端是否允许重试，无法再次发送请求,没有更多的路由可选择，以及各种协议异常。如果以上情况出现则，不会进行重试连接</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Request <span class="title function_">followUpRequest</span><span class="params">(Response userResponse)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">int</span> <span class="variable">responseCode</span> <span class="operator">=</span> userResponse.code();</span><br><span class="line">  <span class="keyword">switch</span>(responseCode) &#123;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取响应码，根据各种响应码，构建出各自的请求，如果响应码是正常的，那么不会返回新的请求体。本次请求成功</li>
</ul>
<p>因此重试的整体流程是</p>
<ul>
<li>尝试连接-&gt;如果出现(Route&#x2F;IOException)，判断能否重试-&gt;如果之前响应体存在，创造空内容的响应体，根据响应体的响应码，构建出请求，如果请求为空，那么本次请求成功，判断是否超过重试次数，请求能否发出，请求和响应地址是否一致</li>
</ul>
<h5 id="BridgeInterceptor"><a href="#BridgeInterceptor" class="headerlink" title="BridgeInterceptor"></a>BridgeInterceptor</h5><p>桥接客户端代码到网络代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">///加入头部压缩</span></span><br><span class="line">  <span class="type">boolean</span> <span class="variable">transparentGzip</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (userRequest.header(<span class="string">&quot;Accept-Encoding&quot;</span>) == <span class="literal">null</span> &amp;&amp; userRequest.header(<span class="string">&quot;Range&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">    transparentGzip = <span class="literal">true</span>;</span><br><span class="line">    requestBuilder.header(<span class="string">&quot;Accept-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//桥接头部</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="type">Response</span> <span class="variable">networkResponse</span> <span class="operator">=</span> chain.proceed(requestBuilder.build());</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (transparentGzip</span><br><span class="line">        &amp;&amp; <span class="string">&quot;gzip&quot;</span>.equalsIgnoreCase(networkResponse.header(<span class="string">&quot;Content-Encoding&quot;</span>))</span><br><span class="line">        &amp;&amp; HttpHeaders.hasBody(networkResponse)) &#123;</span><br><span class="line">      <span class="type">GzipSource</span> <span class="variable">responseBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GzipSource</span>(networkResponse.body().source());</span><br><span class="line">      <span class="type">Headers</span> <span class="variable">strippedHeaders</span> <span class="operator">=</span> networkResponse.headers().newBuilder()</span><br><span class="line">          .removeAll(<span class="string">&quot;Content-Encoding&quot;</span>)</span><br><span class="line">          .removeAll(<span class="string">&quot;Content-Length&quot;</span>)</span><br><span class="line">          .build();</span><br><span class="line">      responseBuilder.headers(strippedHeaders);</span><br><span class="line">      <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> networkResponse.header(<span class="string">&quot;Content-Type&quot;</span>);</span><br><span class="line">      responseBuilder.body(<span class="keyword">new</span> <span class="title class_">RealResponseBody</span>(contentType, -<span class="number">1L</span>, Okio.buffer(responseBody)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先桥接请求头</li>
<li>接下来进入缓存拦截器</li>
<li>处理请求体压缩，使用<code>GzipSource</code></li>
</ul>
<h5 id="CacheInterceptor"><a href="#CacheInterceptor" class="headerlink" title="CacheInterceptor"></a>CacheInterceptor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="type">Response</span> <span class="variable">cacheCandidate</span> <span class="operator">=</span> cache != <span class="literal">null</span></span><br><span class="line">        ? cache.get(chain.request())</span><br><span class="line">        : <span class="literal">null</span>;</span><br><span class="line">  <span class="type">CacheStrategy</span> <span class="variable">strategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CacheStrategy</span>.Factory(now, chain.request(), cacheCandidate).get();</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (networkRequest == <span class="literal">null</span> &amp;&amp; cacheResponse == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>.Builder()</span><br><span class="line">            .request(chain.request())</span><br><span class="line">            .protocol(Protocol.HTTP_1_1)</span><br><span class="line">            .code(<span class="number">504</span>)</span><br><span class="line">            .message(<span class="string">&quot;Unsatisfiable Request (only-if-cached)&quot;</span>)</span><br><span class="line">            .body(Util.EMPTY_RESPONSE)</span><br><span class="line">            .sentRequestAtMillis(-<span class="number">1L</span>)</span><br><span class="line">            .receivedResponseAtMillis(System.currentTimeMillis())</span><br><span class="line">            .build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  networkResponse = chain.proceed(networkRequest);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (cacheResponse != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (networkResponse.code() == HTTP_NOT_MODIFIED) &#123;</span><br><span class="line">        cache.trackConditionalCacheHit();</span><br><span class="line">        cache.update(cacheResponse, response);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (cache != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (HttpHeaders.hasBody(response) &amp;&amp; CacheStrategy.isCacheable(response, networkRequest)) &#123;</span><br><span class="line">        <span class="comment">// Offer this request to the cache.</span></span><br><span class="line">        <span class="type">CacheRequest</span> <span class="variable">cacheRequest</span> <span class="operator">=</span> cache.put(response);</span><br><span class="line">        <span class="keyword">return</span> cacheWritingResponse(cacheRequest, response);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (HttpMethod.invalidatesCache(networkRequest.method())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          cache.remove(networkRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">          <span class="comment">// The cache cannot be written.</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取内部缓存响应，默认使用<code>DiskLruCache</code></li>
<li>根据响应体的头部信息，创建缓存策略(Date, Expires, Last-Modified, ETag, Age)，记录缓存策略</li>
<li>如果禁止网络请求，并且缓存无法满足，则返回失败信息</li>
<li>禁止网络请求，返回缓存</li>
<li>发起网络请求</li>
<li>既有网络响应又有缓存响应，更新缓存</li>
<li>只有网络请求，没有缓存，如果允许缓存，怎缓存网络响应，无法缓存<code>GET</code>以外的响应.</li>
</ul>
<h5 id="ConnectInterceptor"><a href="#ConnectInterceptor" class="headerlink" title="ConnectInterceptor"></a>ConnectInterceptor</h5><p>向目标服务器打开一个连接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">StreamAllocation</span> <span class="variable">streamAllocation</span> <span class="operator">=</span> realChain.streamAllocation();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">doExtensiveHealthChecks</span> <span class="operator">=</span> !request.method().equals(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">    <span class="type">HttpCodec</span> <span class="variable">httpCodec</span> <span class="operator">=</span> streamAllocation.newStream(client, chain, doExtensiveHealthChecks);</span><br><span class="line">    <span class="type">RealConnection</span> <span class="variable">connection</span> <span class="operator">=</span> streamAllocation.connection();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建HttpCodec</li>
<li>连接服务器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> HttpCodec <span class="title function_">newStream</span><span class="params">(</span></span><br><span class="line"><span class="params">      OkHttpClient client, Interceptor.Chain chain, <span class="type">boolean</span> doExtensiveHealthChecks)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="type">RealConnection</span> <span class="variable">resultConnection</span> <span class="operator">=</span> findHealthyConnection(connectTimeout, readTimeout,</span><br><span class="line">          writeTimeout, connectionRetryEnabled, doExtensiveHealthChecks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>找到可用的连接</li>
<li>将请求编码，<code>Http</code>请求如何映射到<code>Socket</code>,使用<code>HttpCodec</code></li>
</ul>
<p>问题,如何找到可用的连连呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RealConnection <span class="title function_">findHealthyConnection</span><span class="params">(<span class="type">int</span> connectTimeout, <span class="type">int</span> readTimeout,</span></span><br><span class="line"><span class="params">      <span class="type">int</span> writeTimeout, <span class="type">boolean</span> connectionRetryEnabled, <span class="type">boolean</span> doExtensiveHealthChecks)</span> &#123;</span><br><span class="line">         <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="type">RealConnection</span> <span class="variable">candidate</span> <span class="operator">=</span> findConnection(connectTimeout, readTimeout, writeTimeout,</span><br><span class="line">          connectionRetryEnabled);</span><br><span class="line">          ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>找出健康连接，何为健康连接,<code>socket</code>没被关闭,<code>socket</code>输入输出关闭,<code>Socket</code>超时,<code>BufferSource</code>耗尽</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RealConnection <span class="title function_">findConnection</span><span class="params">(<span class="type">int</span> connectTimeout, <span class="type">int</span> readTimeout, <span class="type">int</span> writeTimeout,</span></span><br><span class="line"><span class="params">      <span class="type">boolean</span> connectionRetryEnabled)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ...</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.connection != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We had an already-allocated connection and it&#x27;s good.</span></span><br><span class="line">        result = <span class="built_in">this</span>.connection;</span><br><span class="line">        releasedConnection = <span class="literal">null</span>;</span><br><span class="line">      &#125;  </span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Attempt to get a connection from the pool.</span></span><br><span class="line">        Internal.instance.get(connectionPool, address, <span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">          foundPooledConnection = <span class="literal">true</span>;</span><br><span class="line">          result = connection;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          selectedRoute = route;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, size = routes.size(); i &lt; size; i++) &#123;</span><br><span class="line">          <span class="type">Route</span> <span class="variable">route</span> <span class="operator">=</span> routes.get(i);</span><br><span class="line">          Internal.instance.get(connectionPool, address, <span class="built_in">this</span>, route);</span><br><span class="line">          <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">            foundPooledConnection = <span class="literal">true</span>;</span><br><span class="line">            result = connection;</span><br><span class="line">            <span class="built_in">this</span>.route = route;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">  result.connect(</span><br><span class="line">        connectTimeout, readTimeout, writeTimeout, connectionRetryEnabled, call, eventListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果连接已经存在，可以复用</li>
<li>不存在，根据地址从连接池获取一个连接</li>
<li>选择可用路由</li>
<li>如果没有找到可用连接,接着选择可用路由，并创建连接，连接加入新的请求信息</li>
<li>开始<code>TCP/TLS</code>握手，更新路优库</li>
<li>将连接放入连接池</li>
<li>如果有多个相同地址的连接并发创建了，那么释放当前这个，获取别的</li>
</ul>
<p>创建<code>HttpCodec</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> HttpCodec <span class="title function_">newCodec</span><span class="params">(OkHttpClient client, Interceptor.Chain chain,</span></span><br><span class="line"><span class="params">      StreamAllocation streamAllocation)</span> <span class="keyword">throws</span> SocketException &#123;</span><br><span class="line">    <span class="keyword">if</span> (http2Connection != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Http2Codec</span>(client, chain, streamAllocation, http2Connection);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      socket.setSoTimeout(chain.readTimeoutMillis());</span><br><span class="line">      source.timeout().timeout(chain.readTimeoutMillis(), MILLISECONDS);</span><br><span class="line">      sink.timeout().timeout(chain.writeTimeoutMillis(), MILLISECONDS);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Http1Codec</span>(client, streamAllocation, source, sink);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果<code>Http2</code>不为空，直接返回<code>Http2Codec</code></li>
<li><code>Socket</code>设置相应的超时，读写时间</li>
</ul>
<h5 id="CallServerInterceptor"><a href="#CallServerInterceptor" class="headerlink" title="CallServerInterceptor"></a>CallServerInterceptor</h5><p>向服务器发起网络请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;100-continue&quot;</span>.equalsIgnoreCase(request.header(<span class="string">&quot;Expect&quot;</span>))) &#123;</span><br><span class="line">        httpCodec.flushRequest();</span><br><span class="line">        realChain.eventListener().responseHeadersStart(realChain.call());</span><br><span class="line">        responseBuilder = httpCodec.readResponseHeaders(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">CountingSink</span> <span class="variable">requestBodyOut</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CountingSink</span>(httpCodec.createRequestBody(request, contentLength));</span><br><span class="line">  <span class="type">BufferedSink</span> <span class="variable">bufferedRequestBody</span> <span class="operator">=</span> Okio.buffer(requestBodyOut);</span><br><span class="line"></span><br><span class="line">  request.body().writeTo(bufferedRequestBody);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//刷新socket缓冲区</span></span><br><span class="line">  httpCodec.finishRequest();</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//接收响应</span></span><br><span class="line">  response = response.newBuilder()</span><br><span class="line">          .body(httpCodec.openResponseBody(response))</span><br><span class="line">          .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>请求体的内容写到<code>Okio</code>创建<code>BufferedSink</code></li>
<li>将缓冲区的数据放入<code>Socket</code>，发出</li>
<li>接收响应<code>BufferSource</code></li>
<li>更新<code>Socket</code>状态,如果<code>Socket</code>没有新的<code>Stream</code>需要处理，或者没有空连接，关闭当前<code>Socket</code></li>
</ul>
<h4 id="连接池的管理"><a href="#连接池的管理" class="headerlink" title="连接池的管理"></a>连接池的管理</h4><p><code>ConnectionPool</code>内部维护着一个双端队列，用于存储连接。还有一个黑名单路由表。还有一个线程池负责回收失效的连接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealConnection&gt; connections = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">final</span> <span class="type">RouteDatabase</span> <span class="variable">routeDatabase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RouteDatabase</span>();</span><br></pre></td></tr></table></figure>

<p>每当有新的连接要放入连接池的时候，会先触发回收连接操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(RealConnection connection)</span> &#123;</span><br><span class="line">    <span class="keyword">assert</span> (Thread.holdsLock(<span class="built_in">this</span>));</span><br><span class="line">    <span class="keyword">if</span> (!cleanupRunning) &#123;</span><br><span class="line">      cleanupRunning = <span class="literal">true</span>;</span><br><span class="line">      executor.execute(cleanupRunnable);</span><br><span class="line">    &#125;</span><br><span class="line">    connections.add(connection);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>如果清理线程没有再运行，执行清理线程，然后将新的连接添加到连接池中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">cleanupRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">waitNanos</span> <span class="operator">=</span> cleanup(System.nanoTime());</span><br><span class="line">        <span class="keyword">if</span> (waitNanos == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (waitNanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="type">long</span> <span class="variable">waitMillis</span> <span class="operator">=</span> waitNanos / <span class="number">1000000L</span>;</span><br><span class="line">          waitNanos -= (waitMillis * <span class="number">1000000L</span>);</span><br><span class="line">          <span class="keyword">synchronized</span> (ConnectionPool.<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              ConnectionPool.<span class="built_in">this</span>.wait(waitMillis, (<span class="type">int</span>) waitNanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>线程执行一个死循环，只有当无连接可清理时，线程退出,每次清除，线程会等待一段时间</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">cleanup</span><span class="params">(<span class="type">long</span> now)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (pruneAndGetAllocationCount(connection, now) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      inUseConnectionCount++;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (idleDurationNs &gt; longestIdleDurationNs) &#123;</span><br><span class="line">    longestIdleDurationNs = idleDurationNs;</span><br><span class="line">    longestIdleConnection = connection;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (longestIdleDurationNs &gt;= <span class="built_in">this</span>.keepAliveDurationNs</span><br><span class="line">          || idleConnectionCount &gt; <span class="built_in">this</span>.maxIdleConnections) &#123;</span><br><span class="line">    <span class="comment">// We&#x27;ve found a connection to evict. Remove it from the list, then close it below (outside</span></span><br><span class="line">    <span class="comment">// of the synchronized block).</span></span><br><span class="line">    connections.remove(longestIdleConnection);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>寻找有多少连接在使用中，未使用的有多少</li>
<li>找出最长空闲连接，时间必须大于<code>Long.MIN_VALUE</code></li>
<li>如果最长空闲时间大于最长存活时间或者空闲个数大于最大空闲个数，那么移除当前连接</li>
<li>有空闲连接，即将需要清理，返回需要等待的时间，等下一次清理</li>
<li>所有的连接都在用，返回最长的存活时间，让线程等待</li>
<li>最大空闲连接5个，最长存活时间5分钟</li>
</ul>
<p>如何知道连接空闲与否?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">pruneAndGetAllocationCount</span><span class="params">(RealConnection connection, <span class="type">long</span> now)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  Reference&lt;StreamAllocation&gt; reference = references.get(i);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过获取连接流配置信息的弱引用。来统计当前的连接是否再用。</li>
</ul>
<p>流程图</p>
<p><img data-src="/./okhttp3.png" alt="okhttp3"></p>
<h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>采用<code>DiskLruCache</code>来缓存请求和响应</p>
<h5 id="写入缓存put"><a href="#写入缓存put" class="headerlink" title="写入缓存put"></a>写入缓存<code>put</code></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CacheRequest <span class="title function_">put</span><span class="params">(Response response)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestMethod</span> <span class="operator">=</span> response.request().method();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (HttpMethod.invalidatesCache(response.request().method())) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        remove(response.request());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">        <span class="comment">// The cache cannot be written.</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!requestMethod.equals(<span class="string">&quot;GET&quot;</span>)) &#123;</span><br><span class="line">      <span class="comment">// Don&#x27;t cache non-GET responses. We&#x27;re technically allowed to cache</span></span><br><span class="line">      <span class="comment">// HEAD requests and some POST requests, but the complexity of doing</span></span><br><span class="line">      <span class="comment">// so is high and the benefit is low.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (HttpHeaders.hasVaryAll(response)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(response);</span><br><span class="line">    DiskLruCache.<span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      editor = cache.edit(urlToKey(response.request()));</span><br><span class="line">      <span class="keyword">if</span> (editor == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      entry.writeTo(editor);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheRequestImpl</span>(editor);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      abortQuietly(editor);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>主要功能：</p>
<ol>
<li>检查请求类型，如果不是<code>Get</code>，不缓存</li>
<li>使用<code>Request</code>的<code>url</code>作为<code>key</code>来缓存</li>
<li>写入缓存</li>
</ol>
<h4 id="更新缓存update"><a href="#更新缓存update" class="headerlink" title="更新缓存update"></a>更新缓存<code>update</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Response cached, Response network)</span> &#123;</span><br><span class="line">    <span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(network);</span><br><span class="line">    DiskLruCache.<span class="type">Snapshot</span> <span class="variable">snapshot</span> <span class="operator">=</span> ((CacheResponseBody) cached.body()).snapshot;</span><br><span class="line">    DiskLruCache.<span class="type">Editor</span> <span class="variable">editor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      editor = snapshot.edit(); <span class="comment">// Returns null if snapshot is not current.</span></span><br><span class="line">      <span class="keyword">if</span> (editor != <span class="literal">null</span>) &#123;</span><br><span class="line">        entry.writeTo(editor);</span><br><span class="line">        editor.commit();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      abortQuietly(editor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>主要工作：</p>
<ol>
<li>获取缓存快照编辑器</li>
<li>将网络响应写入</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/09/07/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Activity%E5%90%AF%E5%8A%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/07/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90Activity%E5%90%AF%E5%8A%A8/" class="post-title-link" itemprop="url">源码角度分析Activity启动</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-07 00:11:26" itemprop="dateCreated datePublished" datetime="2017-09-07T00:11:26+08:00">2017-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2017-09-23 17:39:09" itemprop="dateModified" datetime="2017-09-23T17:39:09+08:00">2017-09-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>Android</code>开发者都知道启动<code>Activity</code>是使用<code>startActivity()</code>，那么它是怎样一个过程呢？</p>
<h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><h4 id="startActivity"><a href="#startActivity" class="headerlink" title="startActivity"></a>startActivity</h4><p>两种方式，一种<code>Activity</code>自身方法,一种<code>ContextImpl</code>的方法</p>
<h5 id="ContextImpl-startActivity"><a href="#ContextImpl-startActivity" class="headerlink" title="ContextImpl.startActivity"></a>ContextImpl.startActivity</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startActivity</span><span class="params">(Intent intent, Bundle options)</span> &#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calling start activity from outside an activity without FLAG_ACTIVITY_NEW_TASK is</span></span><br><span class="line">    <span class="comment">// generally not allowed, except if the caller specifies the task id the activity should</span></span><br><span class="line">    <span class="comment">// be launched in.</span></span><br><span class="line">    <span class="keyword">if</span> ((intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span></span><br><span class="line">            &amp;&amp; options != <span class="literal">null</span> &amp;&amp; ActivityOptions.fromBundle(options).getLaunchTaskId() == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AndroidRuntimeException</span>(</span><br><span class="line">                <span class="string">&quot;Calling startActivity() from outside of an Activity &quot;</span></span><br><span class="line">                + <span class="string">&quot; context requires the FLAG_ACTIVITY_NEW_TASK flag.&quot;</span></span><br><span class="line">                + <span class="string">&quot; Is this really what you want?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mMainThread.getInstrumentation().execStartActivity(</span><br><span class="line">            getOuterContext(), mMainThread.getApplicationThread(), <span class="literal">null</span>,</span><br><span class="line">            (Activity) <span class="literal">null</span>, intent, -<span class="number">1</span>, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果从<code>Activity</code>外部启动，并且没有设置<code>FLAG_ACTIVITY_NEW_TASK</code>，那么会发生<code>crash</code>。<br>最终调用<code>Instrumentation.execStartActivity</code></p>
<h5 id="Activity-startActivity"><a href="#Activity-startActivity" class="headerlink" title="Activity.startActivity"></a>Activity.startActivity</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startActivity</span><span class="params">(Intent intent, <span class="meta">@Nullable</span> Bundle options)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="literal">null</span>) &#123;</span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">            <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从代码中能看出，最终还是调用的<code>startActivityForResult</code></p>
<h4 id="startActivityForResult"><a href="#startActivityForResult" class="headerlink" title="startActivityForResult"></a>startActivityForResult</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startActivityForResult</span><span class="params">(<span class="meta">@RequiresPermission</span> Intent intent, <span class="type">int</span> requestCode,</span></span><br><span class="line"><span class="params">            <span class="meta">@Nullable</span> Bundle options)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mParent == <span class="literal">null</span>) &#123;</span><br><span class="line">            options = transferSpringboardActivityOptions(options);</span><br><span class="line">            Instrumentation.<span class="type">ActivityResult</span> <span class="variable">ar</span> <span class="operator">=</span></span><br><span class="line">                mInstrumentation.execStartActivity(</span><br><span class="line">                    <span class="built_in">this</span>, mMainThread.getApplicationThread(), mToken, <span class="built_in">this</span>,</span><br><span class="line">                    intent, requestCode, options);</span><br><span class="line">            <span class="keyword">if</span> (ar != <span class="literal">null</span>) &#123;</span><br><span class="line">                mMainThread.sendActivityResult(</span><br><span class="line">                    mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                    ar.getResultData());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// If this start is requesting a result, we can avoid making</span></span><br><span class="line">                <span class="comment">// the activity visible until the result is received.  Setting</span></span><br><span class="line">                <span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></span><br><span class="line">                <span class="comment">// activity hidden during this time, to avoid flickering.</span></span><br><span class="line">                <span class="comment">// This can only be done when a result is requested because</span></span><br><span class="line">                <span class="comment">// that guarantees we will get information back when the</span></span><br><span class="line">                <span class="comment">// activity is finished, no matter what happens to it.</span></span><br><span class="line">                mStartedActivity = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cancelInputsAndStartExitTransition(options);</span><br><span class="line">            <span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (options != <span class="literal">null</span>) &#123;</span><br><span class="line">                mParent.startActivityFromChild(<span class="built_in">this</span>, intent, requestCode, options);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Note we want to go through this method for compatibility with</span></span><br><span class="line">                <span class="comment">// existing applications that may have overridden it.</span></span><br><span class="line">                mParent.startActivityFromChild(<span class="built_in">this</span>, intent, requestCode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先包装<code>options</code>以便支持<code>scene</code>动画</li>
<li><code>Instrumentation</code>执行<code>execStartActiviy</code>，并返回一个结果</li>
<li>将结果传给<code>ActivityThread</code>，最后执行动画</li>
</ul>
<h4 id="Instrumentation-execStartActivity"><a href="#Instrumentation-execStartActivity" class="headerlink" title="Instrumentation.execStartActivity"></a>Instrumentation.execStartActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ActivityResult <span class="title function_">execStartActivity</span><span class="params">(</span></span><br><span class="line"><span class="params">            Context who, IBinder contextThread, IBinder token, Activity target,</span></span><br><span class="line"><span class="params">            Intent intent, <span class="type">int</span> requestCode, Bundle options)</span> &#123;</span><br><span class="line">        <span class="type">IApplicationThread</span> <span class="variable">whoThread</span> <span class="operator">=</span> (IApplicationThread) contextThread;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">referrer</span> <span class="operator">=</span> target != <span class="literal">null</span> ? target.onProvideReferrer() : <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (referrer != <span class="literal">null</span>) &#123;</span><br><span class="line">            intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mActivityMonitors != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> mActivityMonitors.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">ActivityMonitor</span> <span class="variable">am</span> <span class="operator">=</span> mActivityMonitors.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (am.match(who, <span class="literal">null</span>, intent)) &#123;</span><br><span class="line">                        am.mHits++;</span><br><span class="line">                        <span class="keyword">if</span> (am.isBlocking()) &#123;</span><br><span class="line">                            <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            intent.migrateExtraStreamToClipData();</span><br><span class="line">            intent.prepareToLeaveProcess(who);</span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="literal">null</span> ? target.mEmbeddedID : <span class="literal">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="literal">null</span>, options);</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failure from system&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先获取<code>ApplicationThread</code>其继承自<code>Binder</code></li>
<li>如果加入了<code>Activity</code>监控集，会去比对当前的<code>Intent</code>是否已经存在，如果该<code>Activiy</code>正在已经启动，那么本次直接返回</li>
<li>然后交给<code>ActivityManagerNative</code>启动</li>
<li>最后检查返回结果</li>
</ul>
<h4 id="ActivityManagerNative-startActivity"><a href="#ActivityManagerNative-startActivity" class="headerlink" title="ActivityManagerNative.startActivity"></a>ActivityManagerNative.startActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span><br><span class="line"><span class="params">            String resolvedType, IBinder resultTo, String resultWho, <span class="type">int</span> requestCode,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">        data.writeStrongBinder(caller != <span class="literal">null</span> ? caller.asBinder() : <span class="literal">null</span>);</span><br><span class="line">        data.writeString(callingPackage);</span><br><span class="line">        intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        data.writeString(resolvedType);</span><br><span class="line">        data.writeStrongBinder(resultTo);</span><br><span class="line">        data.writeString(resultWho);</span><br><span class="line">        data.writeInt(requestCode);</span><br><span class="line">        data.writeInt(startFlags);</span><br><span class="line">        <span class="keyword">if</span> (profilerInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="literal">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            options.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.readException();</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> reply.readInt();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>获取数据，由<code>ActivityManagerProxy</code>发出<code>START_ACTIVITY_TRANSACTION</code>命令。经过IPC，进入到<code>ActivityManagerNative</code></p>
<h4 id="ActivityManagerNative-onTransact"><a href="#ActivityManagerNative-onTransact" class="headerlink" title="ActivityManagerNative.onTransact"></a>ActivityManagerNative.onTransact</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTransact</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply, <span class="type">int</span> flags)</span></span><br><span class="line">            <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">            <span class="type">IBinder</span> <span class="variable">b</span> <span class="operator">=</span> data.readStrongBinder();</span><br><span class="line">            <span class="type">IApplicationThread</span> <span class="variable">app</span> <span class="operator">=</span> ApplicationThreadNative.asInterface(b);</span><br><span class="line">            <span class="type">String</span> <span class="variable">callingPackage</span> <span class="operator">=</span> data.readString();</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> Intent.CREATOR.createFromParcel(data);</span><br><span class="line">            <span class="type">String</span> <span class="variable">resolvedType</span> <span class="operator">=</span> data.readString();</span><br><span class="line">            <span class="type">IBinder</span> <span class="variable">resultTo</span> <span class="operator">=</span> data.readStrongBinder();</span><br><span class="line">            <span class="type">String</span> <span class="variable">resultWho</span> <span class="operator">=</span> data.readString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">requestCode</span> <span class="operator">=</span> data.readInt();</span><br><span class="line">            <span class="type">int</span> <span class="variable">startFlags</span> <span class="operator">=</span> data.readInt();</span><br><span class="line">            <span class="type">ProfilerInfo</span> <span class="variable">profilerInfo</span> <span class="operator">=</span> data.readInt() != <span class="number">0</span></span><br><span class="line">                    ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Bundle</span> <span class="variable">options</span> <span class="operator">=</span> data.readInt() != <span class="number">0</span></span><br><span class="line">                    ? Bundle.CREATOR.createFromParcel(data) : <span class="literal">null</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> startActivity(app, callingPackage, intent, resolvedType,</span><br><span class="line">                    resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">            reply.writeInt(result);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换数据，调用<code>ActivityManagerService</code>的<code>startActivity</code></p>
<h4 id="ActivityManagerService"><a href="#ActivityManagerService" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span><br><span class="line"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="type">int</span> requestCode,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        enforceNotIsolatedCaller(<span class="string">&quot;startActivity&quot;</span>);</span><br><span class="line">        userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">                userId, <span class="literal">false</span>, ALLOW_FULL_ONLY, <span class="string">&quot;startActivity&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">        <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">                resolvedType, <span class="literal">null</span>, <span class="literal">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">                profilerInfo, <span class="literal">null</span>, <span class="literal">null</span>, bOptions, <span class="literal">false</span>, userId, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>计算用户id，如果是多用户，那么进程id&#x2F;每个用户范围(100000)，否则直接认为系统是用户</li>
</ul>
<h4 id="ActivityStarter-startActivityMayWait"><a href="#ActivityStarter-startActivityMayWait" class="headerlink" title="ActivityStarter.startActivityMayWait"></a>ActivityStarter.startActivityMayWait</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="type">int</span> callingUid,</span></span><br><span class="line"><span class="params">            String callingPackage, Intent intent, String resolvedType,</span></span><br><span class="line"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">            IBinder resultTo, String resultWho, <span class="type">int</span> requestCode, <span class="type">int</span> startFlags,</span></span><br><span class="line"><span class="params">            ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult, Configuration config,</span></span><br><span class="line"><span class="params">            Bundle bOptions, <span class="type">boolean</span> ignoreTargetSecurity, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">            IActivityContainer iContainer, TaskRecord inTask)</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//解析目标Acitvity</span></span><br><span class="line">	<span class="type">ctivityInfo</span> <span class="variable">aInfo</span> <span class="operator">=</span> mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);            </span><br><span class="line">	</span><br><span class="line">	ActivityStackSupervisor.<span class="type">ActivityContainer</span> <span class="variable">container</span> <span class="operator">=</span></span><br><span class="line">                (ActivityStackSupervisor.ActivityContainer)iContainer;</span><br><span class="line">        <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">            <span class="keyword">if</span> (container != <span class="literal">null</span> &amp;&amp; container.mParentActivity != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                    container.mParentActivity.state != RESUMED) &#123;</span><br><span class="line">                <span class="comment">// Cannot start a child activity if the parent is not resumed.</span></span><br><span class="line">                <span class="keyword">return</span> ActivityManager.START_CANCELED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">realCallingPid</span> <span class="operator">=</span> Binder.getCallingPid();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">realCallingUid</span> <span class="operator">=</span> Binder.getCallingUid();</span><br><span class="line">            <span class="type">int</span> callingPid;</span><br><span class="line">            <span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                callingPid = -<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="literal">null</span>) &#123;</span><br><span class="line">                callingPid = realCallingPid;</span><br><span class="line">                callingUid = realCallingUid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                callingPid = callingUid = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack;</span><br><span class="line">            <span class="keyword">if</span> (container == <span class="literal">null</span> || container.mStack.isOnHomeDisplay()) &#123;</span><br><span class="line">                stack = mSupervisor.mFocusedStack;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stack = container.mStack;</span><br><span class="line">            &#125;</span><br><span class="line">            stack.mConfigWillChange = config != <span class="literal">null</span> &amp;&amp; mService.mConfiguration.diff(config) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</span><br><span class="line">                    <span class="string">&quot;Starting activity when config will change = &quot;</span> + stack.mConfigWillChange);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (aInfo != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                    (aInfo.applicationInfo.privateFlags</span><br><span class="line">                            &amp; ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">                            ...</span><br><span class="line">                            <span class="comment">//带隐私分支</span></span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> <span class="title class_">ActivityRecord</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                    aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                    resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                    callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                    options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">                    inTask);</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">if</span> (outResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                outResult.result = res;</span><br><span class="line">                <span class="comment">//开始成功，进行等待，进入下一个状态</span></span><br><span class="line">                <span class="keyword">if</span> (res == ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">                    mSupervisor.mWaitingActivityLaunched.add(outResult);</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mService.wait();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> (outResult.result != START_TASK_TO_FRONT</span><br><span class="line">                            &amp;&amp; !outResult.timeout &amp;&amp; outResult.who == <span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (outResult.result == START_TASK_TO_FRONT) &#123;</span><br><span class="line">                        res = START_TASK_TO_FRONT;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (res == START_TASK_TO_FRONT) &#123;</span><br><span class="line">                    <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> stack.topRunningActivityLocked();</span><br><span class="line">                    <span class="keyword">if</span> (r.nowVisible &amp;&amp; r.state == RESUMED) &#123;</span><br><span class="line">                        outResult.timeout = <span class="literal">false</span>;</span><br><span class="line">                        outResult.who = <span class="keyword">new</span> <span class="title class_">ComponentName</span>(r.info.packageName, r.info.name);</span><br><span class="line">                        outResult.totalTime = <span class="number">0</span>;</span><br><span class="line">                        outResult.thisTime = <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        outResult.thisTime = SystemClock.uptimeMillis();</span><br><span class="line">                        mSupervisor.mWaitingActivityVisible.add(outResult);</span><br><span class="line">                        <span class="keyword">do</span> &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                mService.wait();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">while</span> (!outResult.timeout &amp;&amp; outResult.who == <span class="literal">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>解析目标<code>Actiivty</code></li>
<li>获取<code>ActivityStackSupervisor.ActivityContainer</code>，如果父<code>activity</code>没有处在<code>RESUME</code>，那么不能启动子<code>activity</code></li>
<li>设置进程id和用户id</li>
<li>设置<code>ActivityStack</code>，如果没有父<code>activity</code>，设置<code>ActivityStackSupervisor</code></li>
<li>如果带有隐私标记，那么处理隐私情况</li>
<li>调用<code>startActivityLocked</code>并返回结果,如果启动成功，那么等待。直到满足条件</li>
</ul>
<h4 id="Activity-startActivityLocked"><a href="#Activity-startActivityLocked" class="headerlink" title="Activity.startActivityLocked"></a>Activity.startActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span><br><span class="line"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span><br><span class="line"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">            IBinder resultTo, String resultWho, <span class="type">int</span> requestCode, <span class="type">int</span> callingPid, <span class="type">int</span> callingUid,</span></span><br><span class="line"><span class="params">            String callingPackage, <span class="type">int</span> realCallingPid, <span class="type">int</span> realCallingUid, <span class="type">int</span> startFlags,</span></span><br><span class="line"><span class="params">            ActivityOptions options, <span class="type">boolean</span> ignoreTargetSecurity, <span class="type">boolean</span> componentSpecified,</span></span><br><span class="line"><span class="params">            ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span><br><span class="line"><span class="params">            TaskRecord inTask)</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//检查lanchFlags</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">launchFlags</span> <span class="operator">=</span> intent.getFlags();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Transfer the result target from the source activity to the new</span></span><br><span class="line">            <span class="comment">// one being started, including any failures.</span></span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ActivityOptions.abort(options);</span><br><span class="line">                <span class="keyword">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;</span><br><span class="line">            &#125;</span><br><span class="line">            resultRecord = sourceRecord.resultTo;</span><br><span class="line">            <span class="keyword">if</span> (resultRecord != <span class="literal">null</span> &amp;&amp; !resultRecord.isInStackLocked()) &#123;</span><br><span class="line">                resultRecord = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            resultWho = sourceRecord.resultWho;</span><br><span class="line">            requestCode = sourceRecord.requestCode;</span><br><span class="line">            sourceRecord.resultTo = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (resultRecord != <span class="literal">null</span>) &#123;</span><br><span class="line">                resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sourceRecord.launchedFromUid == callingUid) &#123;</span><br><span class="line">                <span class="comment">// The new activity is being launched from the same uid as the previous</span></span><br><span class="line">                <span class="comment">// activity in the flow, and asking to forward its result back to the</span></span><br><span class="line">                <span class="comment">// previous.  In this case the activity is serving as a trampoline between</span></span><br><span class="line">                <span class="comment">// the two, so we also want to update its launchedFromPackage to be the</span></span><br><span class="line">                <span class="comment">// same as the previous activity.  Note that this is safe, since we know</span></span><br><span class="line">                <span class="comment">// these two packages come from the same uid; the caller could just as</span></span><br><span class="line">                <span class="comment">// well have supplied that same package name itself.  This specifially</span></span><br><span class="line">                <span class="comment">// deals with the case of an intent picker/chooser being launched in the app</span></span><br><span class="line">                <span class="comment">// flow to redirect to an activity picked by the user, where we want the final</span></span><br><span class="line">                <span class="comment">// activity to consider it to have been launched by the previous app activity.</span></span><br><span class="line">                callingPackage = sourceRecord.launchedFromPackage;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We couldn&#x27;t find a class that can handle the given Intent.</span></span><br><span class="line">            <span class="comment">// That&#x27;s the end of that!</span></span><br><span class="line">            err = ActivityManager.START_INTENT_NOT_RESOLVED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We couldn&#x27;t find the specific class specified in the Intent.</span></span><br><span class="line">            <span class="comment">// Also the end of the line.</span></span><br><span class="line">            err = ActivityManager.START_CLASS_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; sourceRecord != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; sourceRecord.task.voiceSession != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If this activity is being launched as part of a voice session, we need</span></span><br><span class="line">            <span class="comment">// to ensure that it is safe to do so.  If the upcoming activity will also</span></span><br><span class="line">            <span class="comment">// be part of the voice session, we can only launch it if it has explicitly</span></span><br><span class="line">            <span class="comment">// said it supports the VOICE category, or it is a part of the calling app.</span></span><br><span class="line">            <span class="keyword">if</span> ((launchFlags &amp; FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; sourceRecord.info.applicationInfo.uid != aInfo.applicationInfo.uid) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    intent.addCategory(Intent.CATEGORY_VOICE);</span><br><span class="line">                    <span class="keyword">if</span> (!AppGlobals.getPackageManager().activitySupportsIntent(</span><br><span class="line">                            intent.getComponent(), intent, resolvedType)) &#123;</span><br><span class="line">                        Slog.w(TAG,</span><br><span class="line">                                <span class="string">&quot;Activity being started in current voice task does not support voice: &quot;</span></span><br><span class="line">                                        + intent);</span><br><span class="line">                        err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Failure checking voice capabilities&quot;</span>, e);</span><br><span class="line">                    err = ActivityManager.START_NOT_VOICE_COMPATIBLE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//创建ActivityRecord</span></span><br><span class="line">        <span class="type">ActivityRecord</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityRecord</span>(mService, callerApp, callingUid, callingPackage,</span><br><span class="line">                intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</span><br><span class="line">                requestCode, componentSpecified, voiceSession != <span class="literal">null</span>, mSupervisor, container,</span><br><span class="line">                options, sourceRecord);</span><br><span class="line">                ...</span><br><span class="line">                err = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                    <span class="literal">true</span>, options, inTask);</span><br><span class="line">                    ...</span><br><span class="line">&#125;</span><br><span class="line">            </span><br></pre></td></tr></table></figure>

<ul>
<li>检查<code>launchFlags</code></li>
<li>创建<code>ActivityRecord</code></li>
</ul>
<h4 id="ActivityStarter-startActivityUnchecked"><a href="#ActivityStarter-startActivityUnchecked" class="headerlink" title="ActivityStarter.startActivityUnchecked"></a>ActivityStarter.startActivityUnchecked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span><br><span class="line"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> startFlags, <span class="type">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> &#123;</span><br><span class="line"></span><br><span class="line">        setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession,</span><br><span class="line">                voiceInteractor);</span><br><span class="line">		 <span class="comment">//计算flags	</span></span><br><span class="line">        computeLaunchingTaskFlags();</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//获取可复用的Intent</span></span><br><span class="line">        mReusedActivity = getReusableIntentActivity();</span><br><span class="line">        <span class="comment">//使activity可见</span></span><br><span class="line">        mTargetStack.ensureActivitiesVisibleLocked(<span class="literal">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>计算<code>launchflags</code></li>
<li>获取可复用的<code>activity</code></li>
<li>做了很多复杂的事情，这里不赘述</li>
</ul>
<h4 id="ActivityStack-ensureActivitiesVisibleLocked"><a href="#ActivityStack-ensureActivitiesVisibleLocked" class="headerlink" title="ActivityStack.ensureActivitiesVisibleLocked"></a>ActivityStack.ensureActivitiesVisibleLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">ensureActivitiesVisibleLocked</span><span class="params">(ActivityRecord starting, <span class="type">int</span> configChanges,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> preserveWindows)</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (r.app == <span class="literal">null</span> || r.app.thread == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (makeVisibleAndRestartIfNeeded(starting, configChanges, isTop,</span><br><span class="line">                                resumeNextActivity, r)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (activityNdx &gt;= activities.size()) &#123;</span><br><span class="line">                                <span class="comment">// Record may be removed if its process needs to restart.</span></span><br><span class="line">                                activityNdx = activities.size() - <span class="number">1</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                resumeNextActivity = <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果<code>ProcessRecord</code>为空，或者<code>ApplicationThread</code>为空，那么尝试重启<code>Acitvity</code></li>
</ul>
<h4 id="ActivityStack-makeVisibleAndRestartIfNeeded"><a href="#ActivityStack-makeVisibleAndRestartIfNeeded" class="headerlink" title="ActivityStack.makeVisibleAndRestartIfNeeded"></a>ActivityStack.makeVisibleAndRestartIfNeeded</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">makeVisibleAndRestartIfNeeded</span><span class="params">(ActivityRecord starting, <span class="type">int</span> configChanges,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isTop, <span class="type">boolean</span> andResume, ActivityRecord r)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (r != starting) &#123;</span><br><span class="line">                mStackSupervisor.startSpecificActivityLocked(r, andResume, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不是正在启动，则启动特定的<code>Activity</code></li>
</ul>
<h4 id="ActivityStackSupervisor-startSpecificActivityLocked"><a href="#ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="ActivityStackSupervisor.startSpecificActivityLocked"></a>ActivityStackSupervisor.startSpecificActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> andResume, <span class="type">boolean</span> checkConfig)</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h4 id="ActivityStackSupervisor-realStartActivityLocked"><a href="#ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="ActivityStackSupervisor.realStartActivityLocked"></a>ActivityStackSupervisor.realStartActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> andResume, <span class="type">boolean</span> checkConfig)</span>&#123;</span><br><span class="line">            ...</span><br><span class="line">            app.thread.scheduleLaunchActivity(<span class="keyword">new</span> <span class="title class_">Intent</span>(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info, <span class="keyword">new</span> <span class="title class_">Configuration</span>(mService.mConfiguration),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Configuration</span>(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>调用<code>ProcessRecord</code>中的<code>ApplicationThread</code>来启动<code>Actiivty</code></li>
</ul>
<h4 id="ApplicationThreadProxy-scheduleLaunchActivity"><a href="#ApplicationThreadProxy-scheduleLaunchActivity" class="headerlink" title="ApplicationThreadProxy.scheduleLaunchActivity"></a>ApplicationThreadProxy.scheduleLaunchActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="type">int</span> ident,</span></span><br><span class="line"><span class="params">            ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span><br><span class="line"><span class="params">            CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span><br><span class="line"><span class="params">            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> notResumed, <span class="type">boolean</span> isForward, ProfilerInfo profilerInfo)</span> &#123;</span><br><span class="line">            </span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过IPC获取调用scheduleLaunchActivity</li>
</ul>
<h4 id="ApplicationThreadNative"><a href="#ApplicationThreadNative" class="headerlink" title="ApplicationThreadNative"></a>ApplicationThreadNative</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="type">int</span> ident,</span></span><br><span class="line"><span class="params">                ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span><br><span class="line"><span class="params">                CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span><br><span class="line"><span class="params">                <span class="type">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span><br><span class="line"><span class="params">                List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span><br><span class="line"><span class="params">                <span class="type">boolean</span> notResumed, <span class="type">boolean</span> isForward, ProfilerInfo profilerInfo)</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">                sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>想H Handler主线程发送启动命令</li>
</ul>
<h4 id="ActivityThread-performLaunchActivity"><a href="#ActivityThread-performLaunchActivity" class="headerlink" title="ActivityThread.performLaunchActivity"></a>ActivityThread.performLaunchActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">	<span class="comment">//通过反射创建activity</span></span><br><span class="line">	...</span><br><span class="line">	<span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> r.packageInfo.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="literal">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Unable to instantiate activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>Activity</code></li>
<li>之后通过<code>Instrumentation</code>开始执行生命周期的方法</li>
<li>至此Acitivity的启动起来了。整个过程相当复杂。为了方便理解，中间省略了很多细节</li>
</ul>
<h3 id="对于onNewIntent的处理"><a href="#对于onNewIntent的处理" class="headerlink" title="对于onNewIntent的处理"></a>对于onNewIntent的处理</h3><p><code>onNewIntent</code>是<code>Activity</code>的一个回调方法，那么在什么情况下会调用呢？在<code>ActivityStack</code>中的<code>navigateUpToLocked</code>中的源码是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (parent != <span class="literal">null</span> &amp;&amp; foundParentInTask) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">parentLaunchMode</span> <span class="operator">=</span> parent.info.launchMode;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">destIntentFlags</span> <span class="operator">=</span> destIntent.getFlags();</span><br><span class="line">            <span class="keyword">if</span> (parentLaunchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE ||</span><br><span class="line">                    parentLaunchMode == ActivityInfo.LAUNCH_SINGLE_TASK ||</span><br><span class="line">                    parentLaunchMode == ActivityInfo.LAUNCH_SINGLE_TOP ||</span><br><span class="line">                    (destIntentFlags &amp; Intent.FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span>) &#123;</span><br><span class="line">                parent.deliverNewIntentLocked(srec.info.applicationInfo.uid, destIntent,</span><br><span class="line">                        srec.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出条件是<ul>
<li>当需要启动的<code>Activity</code>已存在，并且<code>launchMode</code>是 <code>SINGLE_TOP</code>(栈顶是相同的<code>Activity</code>)或者<code>SINGLE_INSTANCE</code>或者<code>SINGLE_TASK</code></li>
</ul>
</li>
</ul>
<h3 id="Activity启动时序图"><a href="#Activity启动时序图" class="headerlink" title="Activity启动时序图"></a>Activity启动时序图</h3><p><img data-src="/./activity_flow.png" alt="activity_flow"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Binea</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
