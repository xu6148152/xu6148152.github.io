<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xu6148152.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://xu6148152.github.io/page/5/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale">
<meta property="article:author" content="Binea">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://xu6148152.github.io/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"default","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Binea</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/12/04/Animator-at-Android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/04/Animator-at-Android/" class="post-title-link" itemprop="url">Animator at Android</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-04 21:17:02" itemprop="dateCreated datePublished" datetime="2016-12-04T21:17:02+08:00">2016-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-08 18:14:04" itemprop="dateModified" datetime="2022-06-08T18:14:04+08:00">2022-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Animator"><a href="#Animator" class="headerlink" title="Animator"></a>Animator</h3><p>其是<code>Android3.0</code>之后加入的作用于对象属性的动画,<code>Animator</code>是所有属性动画的基类，其下有<code>ValueAnimator</code>,<code>AnimatorSet</code>,由<code>ValueAnimator</code>再拓展出<code>ObjectAnimator</code>,<code>TimeAnimator</code></p>
<p>其整体结构图</p>
<img data-src="/2016/12/04/Animator-at-Android/animator.png" class="" title="animator">

<h4 id="ValueAnimator"><a href="#ValueAnimator" class="headerlink" title="ValueAnimator"></a>ValueAnimator</h4><p>为作用对象提供简单的能够计算动画时间和值得时间引擎，它运行在自定义的<code>Handler</code>里面以确保所有的属性改变都会在<code>UI</code>线程。主要<code>API</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ValueAnimator <span class="title function_">ofInt</span><span class="params">(<span class="type">int</span>... values)</span> </span><br><span class="line">ValueAnimator <span class="title function_">ofArgb</span><span class="params">(<span class="type">int</span>... values)</span> <span class="comment">//颜色值变化</span></span><br><span class="line">ValueAnimator <span class="title function_">ofFloat</span><span class="params">(<span class="type">float</span>... values)</span> </span><br><span class="line">ValueAnimator <span class="title function_">ofPropertyValuesHolder</span><span class="params">(PropertyValuesHolder... values)</span></span><br><span class="line">ValueAnimator <span class="title function_">ofObject</span><span class="params">(TypeEvaluator evaluator, Object... values)</span></span><br></pre></td></tr></table></figure>

<p>这些方法里面都是进行值得初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIntValues</span><span class="params">(<span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (values == <span class="literal">null</span> || values.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mValues == <span class="literal">null</span> || mValues.length == <span class="number">0</span>) &#123;</span><br><span class="line">            setValues(PropertyValuesHolder.ofInt(<span class="string">&quot;&quot;</span>, values));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">PropertyValuesHolder</span> <span class="variable">valuesHolder</span> <span class="operator">=</span> mValues[<span class="number">0</span>];</span><br><span class="line">            valuesHolder.setIntValues(values);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// New property/values/target should cause re-initialization prior to starting</span></span><br><span class="line">        mInitialized = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>都是重新封装转化成<code>PropertyValuesHolder</code>，这是封装动画属性和值得对象，之后会详细介绍</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEvaluator</span><span class="params">(TypeEvaluator value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; mValues != <span class="literal">null</span> &amp;&amp; mValues.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mValues[<span class="number">0</span>].setEvaluator(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>设置估值器，最后也是由<code>PropertyValuesHolder</code>保存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数代表是否反转动画</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">boolean</span> playBackwards)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Looper.myLooper() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AndroidRuntimeException</span>(<span class="string">&quot;Animators may only be run on Looper threads&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mReversing = playBackwards;</span><br><span class="line">        mPlayingBackwards = playBackwards;</span><br><span class="line">        <span class="comment">//需要反转动画</span></span><br><span class="line">        <span class="keyword">if</span> (playBackwards &amp;&amp; mSeekFraction != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSeekFraction == <span class="number">0</span> &amp;&amp; mCurrentIteration == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// special case: reversing from seek-to-0 should act as if not seeked at all</span></span><br><span class="line">                mSeekFraction = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mRepeatCount == INFINITE) &#123;</span><br><span class="line">                mSeekFraction = <span class="number">1</span> - (mSeekFraction % <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mSeekFraction = <span class="number">1</span> + mRepeatCount - (mCurrentIteration + mSeekFraction);</span><br><span class="line">            &#125;</span><br><span class="line">            mCurrentIteration = (<span class="type">int</span>) mSeekFraction;</span><br><span class="line">            mSeekFraction = mSeekFraction % <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentIteration &gt; <span class="number">0</span> &amp;&amp; mRepeatMode == REVERSE &amp;&amp;</span><br><span class="line">                (mCurrentIteration &lt; (mRepeatCount + <span class="number">1</span>) || mRepeatCount == INFINITE)) &#123;</span><br><span class="line">            <span class="comment">// if we were seeked to some other iteration in a reversing animator,</span></span><br><span class="line">            <span class="comment">// figure out the correct direction to start playing based on the iteration</span></span><br><span class="line">            <span class="keyword">if</span> (playBackwards) &#123;</span><br><span class="line">                mPlayingBackwards = (mCurrentIteration % <span class="number">2</span>) == <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mPlayingBackwards = (mCurrentIteration % <span class="number">2</span>) != <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">prevPlayingState</span> <span class="operator">=</span> mPlayingState;</span><br><span class="line">        mPlayingState = STOPPED;</span><br><span class="line">        mStarted = <span class="literal">true</span>;</span><br><span class="line">        mStartedDelay = <span class="literal">false</span>;</span><br><span class="line">        mPaused = <span class="literal">false</span>;</span><br><span class="line">        updateScaledDuration(); <span class="comment">// in case the scale factor has changed since creation time</span></span><br><span class="line">        <span class="comment">//创建AnimatorHandler</span></span><br><span class="line">        <span class="type">AnimationHandler</span> <span class="variable">animationHandler</span> <span class="operator">=</span> getOrCreateAnimationHandler();</span><br><span class="line">        animationHandler.mPendingAnimations.add(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// This sets the initial value of the animation, prior to actually starting it running</span></span><br><span class="line">            <span class="keyword">if</span> (prevPlayingState != SEEKED) &#123;</span><br><span class="line">                setCurrentPlayTime(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mPlayingState = STOPPED;</span><br><span class="line">            mRunning = <span class="literal">true</span>;</span><br><span class="line">            notifyStartListeners();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//开始动画</span></span><br><span class="line">        animationHandler.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>开始动画的逻辑其实很简单，主要是判断动画是否需要反转。最终动画的更新交给<code>AnimationHandler</code></p>
<h5 id="AnimationHandler"><a href="#AnimationHandler" class="headerlink" title="AnimationHandler"></a>AnimationHandler</h5><p>处理所有运行中的动画的定时脉冲，这个机制能确保所有的动画都运行在<code>UI</code>线程，其使用<code>Choreograhper(用于调整动画输入和绘制的时机)</code>来执行周期的回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">AnimationHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    mChoreographer = Choreographer.getInstance();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    scheduleAnimation();</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleAnimation</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (!mAnimationScheduled) &#123;</span><br><span class="line">               <span class="comment">//动画未执行过，由Choreographer回调执行</span></span><br><span class="line">               mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, mAnimate, <span class="literal">null</span>);</span><br><span class="line">               mAnimationScheduled = <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">mAnimate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">               mAnimationScheduled = <span class="literal">false</span>;</span><br><span class="line">               doAnimationFrame(mChoreographer.getFrameTime());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">doAnimationFrame</span><span class="params">(<span class="type">long</span> frameTime)</span> &#123;</span><br><span class="line">   <span class="comment">//参数代表执行哪一帧动画</span></span><br><span class="line">           mLastFrameTime = frameTime;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// mPendingAnimations holds any animations that have requested to be started</span></span><br><span class="line">           <span class="comment">// We&#x27;re going to clear mPendingAnimations, but starting animation may</span></span><br><span class="line">           <span class="comment">// cause more to be added to the pending list (for example, if one animation</span></span><br><span class="line">           <span class="comment">// starting triggers another starting). So we loop until mPendingAnimations</span></span><br><span class="line">           <span class="comment">// is empty.</span></span><br><span class="line">           <span class="keyword">while</span> (mPendingAnimations.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">//如果有等待执行的动画，清除并优先执行这些动画</span></span><br><span class="line">               ArrayList&lt;ValueAnimator&gt; pendingCopy =</span><br><span class="line">                       (ArrayList&lt;ValueAnimator&gt;) mPendingAnimations.clone();</span><br><span class="line">               mPendingAnimations.clear();</span><br><span class="line">               <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> pendingCopy.size();</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">                   <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> pendingCopy.get(i);</span><br><span class="line">                   <span class="comment">// If the animation has a startDelay, place it on the delayed list</span></span><br><span class="line">                   <span class="keyword">if</span> (anim.mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">                       anim.startAnimation(<span class="built_in">this</span>);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       mDelayedAnims.add(anim);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Next, process animations currently sitting on the delayed queue, adding</span></span><br><span class="line">           <span class="comment">// them to the active animations if they are ready</span></span><br><span class="line">           <span class="comment">//将延时队列中的动画加入到准备完成队列，开始执行动画，清空队列</span></span><br><span class="line">           <span class="type">int</span> <span class="variable">numDelayedAnims</span> <span class="operator">=</span> mDelayedAnims.size();</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numDelayedAnims; ++i) &#123;</span><br><span class="line">               <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> mDelayedAnims.get(i);</span><br><span class="line">               <span class="keyword">if</span> (anim.delayedAnimationFrame(frameTime)) &#123;</span><br><span class="line">                   mReadyAnims.add(anim);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="type">int</span> <span class="variable">numReadyAnims</span> <span class="operator">=</span> mReadyAnims.size();</span><br><span class="line">           <span class="keyword">if</span> (numReadyAnims &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numReadyAnims; ++i) &#123;</span><br><span class="line">                   <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> mReadyAnims.get(i);</span><br><span class="line">                   anim.startAnimation(<span class="built_in">this</span>);</span><br><span class="line">                   anim.mRunning = <span class="literal">true</span>;</span><br><span class="line">                   mDelayedAnims.remove(anim);</span><br><span class="line">               &#125;</span><br><span class="line">               mReadyAnims.clear();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Now process all active animations. The return value from animationFrame()</span></span><br><span class="line">           <span class="comment">// tells the handler whether it should now be ended</span></span><br><span class="line">           <span class="type">int</span> <span class="variable">numAnims</span> <span class="operator">=</span> mAnimations.size();</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">               mTmpAnimations.add(mAnimations.get(i));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</span><br><span class="line">               <span class="type">ValueAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> mTmpAnimations.get(i);</span><br><span class="line">               <span class="keyword">if</span> (mAnimations.contains(anim) &amp;&amp; anim.doAnimationFrame(frameTime)) &#123;</span><br><span class="line">                   mEndingAnims.add(anim);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           mTmpAnimations.clear();</span><br><span class="line">           <span class="keyword">if</span> (mEndingAnims.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mEndingAnims.size(); ++i) &#123;</span><br><span class="line">                   mEndingAnims.get(i).endAnimation(<span class="built_in">this</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               mEndingAnims.clear();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Schedule final commit for the frame.</span></span><br><span class="line">           mChoreographer.postCallback(Choreographer.CALLBACK_COMMIT, mCommit, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If there are still active or delayed animations, schedule a future call to</span></span><br><span class="line">           <span class="comment">// onAnimate to process the next frame of the animations.</span></span><br><span class="line">           <span class="keyword">if</span> (!mAnimations.isEmpty() || !mDelayedAnims.isEmpty()) &#123;</span><br><span class="line">               scheduleAnimation();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;         </span><br><span class="line">       </span><br></pre></td></tr></table></figure>

<p>流程图</p>
<p><img data-src="/./ValueAnimator.png" alt="ValueAnimator"></p>
<h4 id="插值器"><a href="#插值器" class="headerlink" title="插值器"></a>插值器</h4><p>插值器是描述动画变化的频率。其主要方法是  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入动画基准值，得到计算后的某个时刻的值</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span>;</span><br></pre></td></tr></table></figure>

<p>类关系图:<br><img data-src="/./interpolator.png" alt="interpolator"></p>
<p>系统已经为开发者准备了一些默认的插值器，我们来简单看下这些插值器的算法</p>
<h5 id="LinearInterpolator-线性插值器"><a href="#LinearInterpolator-线性插值器" class="headerlink" title="LinearInterpolator(线性插值器)"></a>LinearInterpolator(线性插值器)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入既是输出</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./LinearInterpolator.png"></p>
<h5 id="AccelerateDecelerateInterpolator-加减速插值器"><a href="#AccelerateDecelerateInterpolator-加减速插值器" class="headerlink" title="AccelerateDecelerateInterpolator(加减速插值器)"></a>AccelerateDecelerateInterpolator(加减速插值器)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">float</span>)(Math.cos((input + <span class="number">1</span>) * Math.PI) / <span class="number">2.0f</span>) + <span class="number">0.5f</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AccelerateDecelerateInterpolator.png">  </p>
<p>其特性是在动画开始和结束阶段变化缓慢，中间阶段变化迅速</p>
<h5 id="AccelerateInterpolator-加速插值器"><a href="#AccelerateInterpolator-加速插值器" class="headerlink" title="AccelerateInterpolator(加速插值器)"></a>AccelerateInterpolator(加速插值器)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFactor == <span class="number">1.0f</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> input * input;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">float</span>)Math.pow(input, mDoubleFactor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AccelerateInterpolator.png"><br>其特点是动画变化速度一直加快，有个加速因子，默认为1。</p>
<h5 id="AnticipateInterpolator"><a href="#AnticipateInterpolator" class="headerlink" title="AnticipateInterpolator"></a>AnticipateInterpolator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> t)</span> &#123;</span><br><span class="line">        <span class="comment">// a(t) = t * t * ((tension + 1) * t - tension)</span></span><br><span class="line">        <span class="keyword">return</span> t * t * ((mTension + <span class="number">1</span>) * t - mTension);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AnticipateInterpolator.png"></p>
<h5 id="AnticipateOvershootInterpolator"><a href="#AnticipateOvershootInterpolator" class="headerlink" title="AnticipateOvershootInterpolator"></a>AnticipateOvershootInterpolator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInterpolation</span><span class="params">(<span class="type">float</span> t)</span> &#123;</span><br><span class="line">        <span class="comment">// a(t, s) = t * t * ((s + 1) * t - s)</span></span><br><span class="line">        <span class="comment">// o(t, s) = t * t * ((s + 1) * t + s)</span></span><br><span class="line">        <span class="comment">// f(t) = 0.5 * a(t * 2, tension * extraTension), when t &lt; 0.5</span></span><br><span class="line">        <span class="comment">// f(t) = 0.5 * (o(t * 2 - 2, tension * extraTension) + 2), when t &lt;= 1.0</span></span><br><span class="line">        <span class="keyword">if</span> (t &lt; <span class="number">0.5f</span>) <span class="keyword">return</span> <span class="number">0.5f</span> * a(t * <span class="number">2.0f</span>, mTension);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0.5f</span> * (o(t * <span class="number">2.0f</span> - <span class="number">2.0f</span>, mTension) + <span class="number">2.0f</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img data-src="/./AnticipateOvershootinterpolator.png"></p>
<p>还有很多别的插值器。这里就不多加赘述了。只要将相应的算法写入<code>getInterpolation</code>中即可</p>
<p>使用的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">animateValue</span><span class="params">(<span class="type">float</span> fraction)</span> &#123;</span><br><span class="line"><span class="comment">//计算动画值</span></span><br><span class="line">        fraction = mInterpolator.getInterpolation(fraction);</span><br><span class="line">        mCurrentFraction = fraction;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">            mValues[i].calculateValue(fraction);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mUpdateListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">numListeners</span> <span class="operator">=</span> mUpdateListeners.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                mUpdateListeners.get(i).onAnimationUpdate(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="TypeEvaluator-估值器"><a href="#TypeEvaluator-估值器" class="headerlink" title="TypeEvaluator(估值器)"></a>TypeEvaluator(估值器)</h4><p>根据当前的动画频率，起始值，结束值计算当前值</p>
<p><img data-src="/./TypeEvaluator.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">evaluate</span><span class="params">(<span class="type">float</span> fraction, T startValue, T endValue)</span>;</span><br></pre></td></tr></table></figure>

<h5 id="ArgbEvaluator"><a href="#ArgbEvaluator" class="headerlink" title="ArgbEvaluator"></a>ArgbEvaluator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">evaluate</span><span class="params">(<span class="type">float</span> fraction, Object startValue, Object endValue)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startInt</span> <span class="operator">=</span> (Integer) startValue;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startA</span> <span class="operator">=</span> (startInt &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startR</span> <span class="operator">=</span> (startInt &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startG</span> <span class="operator">=</span> (startInt &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startB</span> <span class="operator">=</span> startInt &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">endInt</span> <span class="operator">=</span> (Integer) endValue;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endA</span> <span class="operator">=</span> (endInt &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endR</span> <span class="operator">=</span> (endInt &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endG</span> <span class="operator">=</span> (endInt &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">endB</span> <span class="operator">=</span> endInt &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)((startA + (<span class="type">int</span>)(fraction * (endA - startA))) &lt;&lt; <span class="number">24</span>) |</span><br><span class="line">                (<span class="type">int</span>)((startR + (<span class="type">int</span>)(fraction * (endR - startR))) &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                (<span class="type">int</span>)((startG + (<span class="type">int</span>)(fraction * (endG - startG))) &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">                (<span class="type">int</span>)((startB + (<span class="type">int</span>)(fraction * (endB - startB))));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>算法是线性函数，主要因子<code>fraction</code>来自插值器的计算, <code>y= a + kx</code></p>
<h5 id="IntEvaluator"><a href="#IntEvaluator" class="headerlink" title="IntEvaluator"></a>IntEvaluator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Integer <span class="title function_">evaluate</span><span class="params">(<span class="type">float</span> fraction, Integer startValue, Integer endValue)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startInt</span> <span class="operator">=</span> startValue;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>)(startInt + fraction * (endValue - startInt));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>估值器主要实在<code>KeyFrames</code>中使用，而<code>KeyFrames</code>存在<code>PropertyValuesHolder</code>当中，最终<code>Choreographer</code>来更新动画使用</p>
<h4 id="Choreograhper"><a href="#Choreograhper" class="headerlink" title="Choreograhper"></a>Choreograhper</h4><p>协调动画，输入和绘制的时间。其会收到来自显示系统的定时脉冲，然后安排工作作为下一帧渲染的一部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Choreographer</span><span class="params">(Looper looper)</span> &#123;</span><br><span class="line">        mLooper = looper;</span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="title class_">FrameHandler</span>(looper);</span><br><span class="line">        mDisplayEventReceiver = USE_VSYNC ? <span class="keyword">new</span> <span class="title class_">FrameDisplayEventReceiver</span>(looper) : <span class="literal">null</span>;</span><br><span class="line">        mLastFrameTimeNanos = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">        mFrameIntervalNanos = (<span class="type">long</span>)(<span class="number">1000000000</span> / getRefreshRate());</span><br><span class="line"></span><br><span class="line">        mCallbackQueues = <span class="keyword">new</span> <span class="title class_">CallbackQueue</span>[CALLBACK_LAST + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= CALLBACK_LAST; i++) &#123;</span><br><span class="line">            mCallbackQueues[i] = <span class="keyword">new</span> <span class="title class_">CallbackQueue</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化，创建<code>FrameHandler</code>，创建回调队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCallback</span><span class="params">(<span class="type">int</span> callbackType, Runnable action, Object token)</span> &#123;</span><br><span class="line">        postCallbackDelayed(callbackType, action, token, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">postCallbackDelayedInternal</span><span class="params">(<span class="type">int</span> callbackType,</span></span><br><span class="line"><span class="params">        Object action, Object token, <span class="type">long</span> delayMillis)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;PostCallback: type=&quot;</span> + callbackType</span><br><span class="line">                + <span class="string">&quot;, action=&quot;</span> + action + <span class="string">&quot;, token=&quot;</span> + token</span><br><span class="line">                + <span class="string">&quot;, delayMillis=&quot;</span> + delayMillis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">dueTime</span> <span class="operator">=</span> now + delayMillis;</span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="literal">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将回调加入回调队列，如果没有延时，锁定当前帧，如果使用<code>VSYNC</code>，诺当前运行在相同的线程，直接通过<code>FrameDisplayEventReceiver</code>要求同步，其他情况发送消息到<code>Handler</code>中执行。<code>Handler</code>处理三种消息,<code>MSG_DO_FRAME</code>,<code>MSG_DO_SCHEDULE_VSYNC</code>, <code>MSG_DO_SCHEDULE_CALLBACK</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doCallbacks</span><span class="params">(<span class="type">int</span> callbackType, <span class="type">long</span> frameTimeNanos)</span> &#123;</span><br><span class="line">        CallbackRecord callbacks;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// We use &quot;now&quot; to determine when callbacks become due because it&#x27;s possible</span></span><br><span class="line">            <span class="comment">// for earlier processing phases in a frame to post callbacks that should run</span></span><br><span class="line">            <span class="comment">// in a following phase, such as an input event that causes an animation to start.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            callbacks = mCallbackQueues[callbackType].extractDueCallbacksLocked(</span><br><span class="line">                    now / TimeUtils.NANOS_PER_MS);</span><br><span class="line">            <span class="keyword">if</span> (callbacks == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mCallbacksRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update the frame time if necessary when committing the frame.</span></span><br><span class="line">            <span class="comment">// We only update the frame time if we are more than 2 frames late reaching</span></span><br><span class="line">            <span class="comment">// the commit phase.  This ensures that the frame time which is observed by the</span></span><br><span class="line">            <span class="comment">// callbacks will always increase from one frame to the next and never repeat.</span></span><br><span class="line">            <span class="comment">// We never want the next frame&#x27;s starting frame time to end up being less than</span></span><br><span class="line">            <span class="comment">// or equal to the previous frame&#x27;s commit frame time.  Keep in mind that the</span></span><br><span class="line">            <span class="comment">// next frame has most likely already been scheduled by now so we play it</span></span><br><span class="line">            <span class="comment">// safe by ensuring the commit time is always at least one frame behind.</span></span><br><span class="line">            <span class="keyword">if</span> (callbackType == Choreographer.CALLBACK_COMMIT) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">jitterNanos</span> <span class="operator">=</span> now - frameTimeNanos;</span><br><span class="line">                Trace.traceCounter(Trace.TRACE_TAG_VIEW, <span class="string">&quot;jitterNanos&quot;</span>, (<span class="type">int</span>) jitterNanos);</span><br><span class="line">                <span class="keyword">if</span> (jitterNanos &gt;= <span class="number">2</span> * mFrameIntervalNanos) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">lastFrameOffset</span> <span class="operator">=</span> jitterNanos % mFrameIntervalNanos</span><br><span class="line">                            + mFrameIntervalNanos;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_JANK) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;Commit callback delayed by &quot;</span> + (jitterNanos * <span class="number">0.000001f</span>)</span><br><span class="line">                                + <span class="string">&quot; ms which is more than twice the frame interval of &quot;</span></span><br><span class="line">                                + (mFrameIntervalNanos * <span class="number">0.000001f</span>) + <span class="string">&quot; ms!  &quot;</span></span><br><span class="line">                                + <span class="string">&quot;Setting frame time to &quot;</span> + (lastFrameOffset * <span class="number">0.000001f</span>)</span><br><span class="line">                                + <span class="string">&quot; ms in the past.&quot;</span>);</span><br><span class="line">                        mDebugPrintNextFrameTimeDelta = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    frameTimeNanos = now - lastFrameOffset;</span><br><span class="line">                    mLastFrameTimeNanos = frameTimeNanos;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, CALLBACK_TRACE_TITLES[callbackType]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">CallbackRecord</span> <span class="variable">c</span> <span class="operator">=</span> callbacks; c != <span class="literal">null</span>; c = c.next) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;RunCallback: type=&quot;</span> + callbackType</span><br><span class="line">                            + <span class="string">&quot;, action=&quot;</span> + c.action + <span class="string">&quot;, token=&quot;</span> + c.token</span><br><span class="line">                            + <span class="string">&quot;, latencyMillis=&quot;</span> + (SystemClock.uptimeMillis() - c.dueTime));</span><br><span class="line">                &#125;</span><br><span class="line">                c.run(frameTimeNanos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//执行所有的回调</span></span><br><span class="line">                mCallbacksRunning = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">CallbackRecord</span> <span class="variable">next</span> <span class="operator">=</span> callbacks.next;</span><br><span class="line">                    recycleCallbackLocked(callbacks);</span><br><span class="line">                    callbacks = next;</span><br><span class="line">                &#125; <span class="keyword">while</span> (callbacks != <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>MSG_DO_FRAME</code>:判断当前帧时间，低于上次绘制时间，要求同步。否则调用<code>doCallbacks</code>，执行回调队列中的回调</li>
</ul>
<h5 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h5><h4 id="ObjectAnimator"><a href="#ObjectAnimator" class="headerlink" title="ObjectAnimator"></a>ObjectAnimator</h4><p>支持对目标对象的属性做动画，对<code>ValueAnimator</code>的拓展</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以直接设置target,propertyName</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ObjectAnimator <span class="title function_">ofInt</span><span class="params">(Object target, String propertyName, <span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectAnimator</span>(target, propertyName);</span><br><span class="line">        anim.setIntValues(values);</span><br><span class="line">        <span class="keyword">return</span> anim;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTarget</span><span class="params">(<span class="meta">@Nullable</span> Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">oldTarget</span> <span class="operator">=</span> getTarget();</span><br><span class="line">        <span class="comment">//老的目标与当前目标不同，取消。设置弱引用目标对象</span></span><br><span class="line">        <span class="keyword">if</span> (oldTarget != target) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isStarted()) &#123;</span><br><span class="line">                cancel();</span><br><span class="line">            &#125;</span><br><span class="line">            mTarget = target == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;Object&gt;(target);</span><br><span class="line">            <span class="comment">// New target should cause re-initialization prior to starting</span></span><br><span class="line">            mInitialized = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// See if any of the current active/pending animators need to be canceled</span></span><br><span class="line">        <span class="type">AnimationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> sAnimationHandler.get();</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">numAnims</span> <span class="operator">=</span> handler.mAnimations.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (handler.mAnimations.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> (ObjectAnimator) handler.mAnimations.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</span><br><span class="line">                    <span class="comment">//相同的目标和属性，取消之前的动画</span></span><br><span class="line">                        anim.cancel();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//等待的动画也一样</span></span><br><span class="line">            numAnims = handler.mPendingAnimations.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (handler.mPendingAnimations.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> (ObjectAnimator) handler.mPendingAnimations.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</span><br><span class="line">                        anim.cancel();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//延时的动画也一样</span></span><br><span class="line">            numAnims = handler.mDelayedAnims.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> numAnims - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (handler.mDelayedAnims.get(i) <span class="keyword">instanceof</span> ObjectAnimator) &#123;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> (ObjectAnimator) handler.mDelayedAnims.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (anim.mAutoCancel &amp;&amp; hasSameTargetAndProperties(anim)) &#123;</span><br><span class="line">                        anim.cancel();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            Log.d(LOG_TAG, <span class="string">&quot;Anim target, duration: &quot;</span> + getTarget() + <span class="string">&quot;, &quot;</span> + getDuration());</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mValues.length; ++i) &#123;</span><br><span class="line">                <span class="type">PropertyValuesHolder</span> <span class="variable">pvh</span> <span class="operator">=</span> mValues[i];</span><br><span class="line">                Log.d(LOG_TAG, <span class="string">&quot;   Values[&quot;</span> + i + <span class="string">&quot;]: &quot;</span> +</span><br><span class="line">                    pvh.getPropertyName() + <span class="string">&quot;, &quot;</span> + pvh.mKeyframes.getValue(<span class="number">0</span>) + <span class="string">&quot;, &quot;</span> +</span><br><span class="line">                    pvh.mKeyframes.getValue(<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">animateValue</span><span class="params">(<span class="type">float</span> fraction)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getTarget();</span><br><span class="line">        <span class="keyword">if</span> (mTarget != <span class="literal">null</span> &amp;&amp; target == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// We lost the target reference, cancel and clean up.</span></span><br><span class="line">            cancel();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.animateValue(fraction);</span><br><span class="line">        <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">            mValues[i].setAnimatedValue(target);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setupStartValues</span><span class="params">()</span> &#123;</span><br><span class="line">		  <span class="comment">//初始化动画</span></span><br><span class="line">        initAnimation();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getTarget();</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">                mValues[i].setupStartValue(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">initAnimation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInitialized) &#123;</span><br><span class="line">            <span class="comment">// mValueType may change due to setter/getter setup; do this before calling super.init(),</span></span><br><span class="line">            <span class="comment">// which uses mValueType to set up the default type evaluator.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getTarget();</span><br><span class="line">            <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">numValues</span> <span class="operator">=</span> mValues.length;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">                <span class="comment">//初始化getter setter</span></span><br><span class="line">                   mValues[i].setupSetterAndGetter(target);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">super</span>.initAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;                 </span><br></pre></td></tr></table></figure>

<ul>
<li><code>ObjectAnimator</code>比<code>ValueAnimator</code>多了<code>target</code>和<code>Property</code>，这些信息都在<code>PropertyValuesHolder</code>,必须要要有getter&#x2F;setter才能更新目标对象</li>
</ul>
<h4 id="PropertyValuesHolder-处理setter-getter的寻找"><a href="#PropertyValuesHolder-处理setter-getter的寻找" class="headerlink" title="PropertyValuesHolder 处理setter, getter的寻找"></a>PropertyValuesHolder 处理setter, getter的寻找</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">setupSetterAndGetter</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        mKeyframes.invalidateCache();</span><br><span class="line">        <span class="comment">//属性不为空时,从Propery拿值，并设置到keyFrame</span></span><br><span class="line">        <span class="keyword">if</span> (mProperty != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// check to make sure that mProperty is on the class of target</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">testValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();</span><br><span class="line">                <span class="type">int</span> <span class="variable">keyframeCount</span> <span class="operator">=</span> keyframes == <span class="literal">null</span> ? <span class="number">0</span> : keyframes.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; keyframeCount; i++) &#123;</span><br><span class="line">                    <span class="type">Keyframe</span> <span class="variable">kf</span> <span class="operator">=</span> keyframes.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (testValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                            testValue = convertBack(mProperty.get(target));</span><br><span class="line">                        &#125;</span><br><span class="line">                        kf.setValue(testValue);</span><br><span class="line">                        kf.setValueWasSetOnStart(<span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">                Log.w(<span class="string">&quot;PropertyValuesHolder&quot;</span>,<span class="string">&quot;No such property (&quot;</span> + mProperty.getName() +</span><br><span class="line">                        <span class="string">&quot;) on target object &quot;</span> + target + <span class="string">&quot;. Trying reflection instead&quot;</span>);</span><br><span class="line">                mProperty = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We can&#x27;t just say &#x27;else&#x27; here because the catch statement sets mProperty to null.</span></span><br><span class="line">        <span class="comment">//如果property为空，从目标对象中寻找getter setter</span></span><br><span class="line">        <span class="keyword">if</span> (mProperty == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">targetClass</span> <span class="operator">=</span> target.getClass();</span><br><span class="line">            <span class="keyword">if</span> (mSetter == <span class="literal">null</span>) &#123;</span><br><span class="line">                setupSetter(targetClass);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Keyframe&gt; keyframes = mKeyframes.getKeyframes();</span><br><span class="line">            <span class="type">int</span> <span class="variable">keyframeCount</span> <span class="operator">=</span> keyframes == <span class="literal">null</span> ? <span class="number">0</span> : keyframes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; keyframeCount; i++) &#123;</span><br><span class="line">                <span class="type">Keyframe</span> <span class="variable">kf</span> <span class="operator">=</span> keyframes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (!kf.hasValue() || kf.valueWasSetOnStart()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mGetter == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//getter没找到，再次寻找</span></span><br><span class="line">                        setupGetter(targetClass);</span><br><span class="line">                        <span class="comment">//依然没找到</span></span><br><span class="line">                        <span class="keyword">if</span> (mGetter == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// Already logged the error - just return to avoid NPE</span></span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> convertBack(mGetter.invoke(target));</span><br><span class="line">                        <span class="comment">//找到getter，将值传给keyFrame</span></span><br><span class="line">                        kf.setValue(value);</span><br><span class="line">                        kf.setValueWasSetOnStart(<span class="literal">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                        Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                        Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setAnimatedValue</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mProperty != <span class="literal">null</span>) &#123;</span><br><span class="line">            mProperty.set(target, getAnimatedValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSetter != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//setter不为空，会调用目标对象的setter</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mTmpValueArray[<span class="number">0</span>] = getAnimatedValue();</span><br><span class="line">                mSetter.invoke(target, mTmpValueArray);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;PropertyValuesHolder&quot;</span>, e.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br></pre></td></tr></table></figure>
<ul>
<li><code>PropertyValuesHolder</code>主要持有动画的相关属性信息，包括关键帧集，插值器，估值器等</li>
</ul>
<h4 id="KeyFrame"><a href="#KeyFrame" class="headerlink" title="KeyFrame"></a>KeyFrame</h4><p>动画关键帧，保存动画某一帧的时间&#x2F;值。被<code>ValueAnimator</code>使用来计算两个值之间的动画值。<code>PropertyValuesHolder</code>保存了<code>KeyFrames</code>其保存了多个<code>KeyFrame</code>。简单来说<code>KeyFrame</code>就是我们做动画的起始值，中间值，结束值，这些都是由开发者定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIntValues</span><span class="params">(<span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        mValueType = <span class="type">int</span>.class;</span><br><span class="line">        mKeyframes = KeyframeSet.ofInt(values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">keyFrameSet:</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> KeyframeSet <span class="title function_">ofInt</span><span class="params">(<span class="type">int</span>... values)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">numKeyframes</span> <span class="operator">=</span> values.length;</span><br><span class="line">        IntKeyframe keyframes[] = <span class="keyword">new</span> <span class="title class_">IntKeyframe</span>[Math.max(numKeyframes,<span class="number">2</span>)];</span><br><span class="line">        <span class="keyword">if</span> (numKeyframes == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//当只设置了一个值时，会有两个关键帧，起始关键这和结束关键帧</span></span><br><span class="line">            keyframes[<span class="number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">0f</span>);</span><br><span class="line">            keyframes[<span class="number">1</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">1f</span>, values[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//起始关键帧</span></span><br><span class="line">            keyframes[<span class="number">0</span>] = (IntKeyframe) Keyframe.ofInt(<span class="number">0f</span>, values[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; numKeyframes; ++i) &#123;</span><br><span class="line">            <span class="comment">//计算每个阶段的关键帧</span></span><br><span class="line">                keyframes[i] =</span><br><span class="line">                        (IntKeyframe) Keyframe.ofInt((<span class="type">float</span>) i / (numKeyframes - <span class="number">1</span>), values[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IntKeyframeSet</span>(keyframes);</span><br><span class="line">    &#125;    </span><br></pre></td></tr></table></figure>
<ul>
<li>动画至少会包含两个关键帧，一个起始关键帧，一个结束关键帧。中间有多少关键帧由开发者自行定义</li>
</ul>
<h4 id="AnimatorSet"><a href="#AnimatorSet" class="headerlink" title="AnimatorSet"></a>AnimatorSet</h4><p>允许同时播放多个动画或者定义动画的播放顺序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        mTerminated = <span class="literal">false</span>;</span><br><span class="line">        mStarted = <span class="literal">true</span>;</span><br><span class="line">        mPaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">            <span class="comment">//禁止异步运行node.animation.setAllowRunningAsynchronously(false);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置所有动画的长度</span></span><br><span class="line">        <span class="keyword">if</span> (mDuration &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If the duration was set on this AnimatorSet, pass it along to all child animations</span></span><br><span class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> don&#x27;t set the duration of the timing-only nodes created by AnimatorSet to</span></span><br><span class="line">                <span class="comment">// insert &quot;play-after&quot; delays</span></span><br><span class="line">                node.animation.setDuration(mDuration);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置所有动画的插值器</span></span><br><span class="line">        <span class="keyword">if</span> (mInterpolator != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node node : mNodes) &#123;</span><br><span class="line">                node.animation.setInterpolator(mInterpolator);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// First, sort the nodes (if necessary). This will ensure that sortedNodes</span></span><br><span class="line">        <span class="comment">// contains the animation nodes in the correct order.</span></span><br><span class="line">        <span class="comment">//对所有的动画节点进行排序</span></span><br><span class="line">        sortNodes();</span><br><span class="line"></span><br><span class="line">		  <span class="comment">//清除老的动画监听	</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">numSortedNodes</span> <span class="operator">=</span> mSortedNodes.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mSortedNodes.get(i);</span><br><span class="line">            <span class="comment">// First, clear out the old listeners</span></span><br><span class="line">            ArrayList&lt;AnimatorListener&gt; oldListeners = node.animation.getListeners();</span><br><span class="line">            <span class="keyword">if</span> (oldListeners != <span class="literal">null</span> &amp;&amp; oldListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ArrayList&lt;AnimatorListener&gt; clonedListeners = <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">ArrayList</span>&lt;AnimatorListener&gt;(oldListeners);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (AnimatorListener listener : clonedListeners) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (listener <span class="keyword">instanceof</span> DependencyListener ||</span><br><span class="line">                            listener <span class="keyword">instanceof</span> AnimatorSetListener) &#123;</span><br><span class="line">                        node.animation.removeListener(listener);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// nodesToStart holds the list of nodes to be started immediately. We don&#x27;t want to</span></span><br><span class="line">        <span class="comment">// start the animations in the loop directly because we first need to set up</span></span><br><span class="line">        <span class="comment">// dependencies on all of the nodes. For example, we don&#x27;t want to start an animation</span></span><br><span class="line">        <span class="comment">// when some other animation also wants to start when the first animation begins.</span></span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;Node&gt; nodesToStart = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numSortedNodes; ++i) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mSortedNodes.get(i);</span><br><span class="line">            <span class="keyword">if</span> (mSetListener == <span class="literal">null</span>) &#123;</span><br><span class="line">                mSetListener = <span class="keyword">new</span> <span class="title class_">AnimatorSetListener</span>(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//动画节点没有依赖别的节点，添加到即将开始的队列中</span></span><br><span class="line">            <span class="keyword">if</span> (node.dependencies == <span class="literal">null</span> || node.dependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                nodesToStart.add(node);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果有依赖的话，添加依赖监听，并把依赖添加到临时依赖链中</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">numDependencies</span> <span class="operator">=</span> node.dependencies.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; numDependencies; ++j) &#123;</span><br><span class="line">                    <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> node.dependencies.get(j);</span><br><span class="line">                    dependency.node.animation.addListener(</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">DependencyListener</span>(<span class="built_in">this</span>, node, dependency.rule));</span><br><span class="line">                &#125;</span><br><span class="line">                node.tmpDependencies = (ArrayList&lt;Dependency&gt;) node.dependencies.clone();</span><br><span class="line">            &#125;</span><br><span class="line">            node.animation.addListener(mSetListener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Now that all dependencies are set up, start the animations that should be started.</span></span><br><span class="line">        <span class="comment">//开始动画</span></span><br><span class="line">        <span class="keyword">if</span> (mStartDelay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node node : nodesToStart) &#123;</span><br><span class="line">                node.animation.start();</span><br><span class="line">                mPlayingSet.add(node.animation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mDelayAnim = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">            mDelayAnim.setDuration(mStartDelay);</span><br><span class="line">            mDelayAnim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">canceled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationCancel</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">                    canceled = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!canceled) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">numNodes</span> <span class="operator">=</span> nodesToStart.size();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nodesToStart.get(i);</span><br><span class="line">                            node.animation.start();</span><br><span class="line">                            mPlayingSet.add(node.animation);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    mDelayAnim = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            mDelayAnim.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//动画开始回调</span></span><br><span class="line">        <span class="keyword">if</span> (mListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                    (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">            <span class="type">int</span> <span class="variable">numListeners</span> <span class="operator">=</span> tmpListeners.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                tmpListeners.get(i).onAnimationStart(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有动画，动画结束回调</span></span><br><span class="line">        <span class="keyword">if</span> (mNodes.size() == <span class="number">0</span> &amp;&amp; mStartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Handle unusual case where empty AnimatorSet is started - should send out</span></span><br><span class="line">            <span class="comment">// end event immediately since the event will not be sent out at all otherwise</span></span><br><span class="line">            mStarted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mListeners != <span class="literal">null</span>) &#123;</span><br><span class="line">                ArrayList&lt;AnimatorListener&gt; tmpListeners =</span><br><span class="line">                        (ArrayList&lt;AnimatorListener&gt;) mListeners.clone();</span><br><span class="line">                <span class="type">int</span> <span class="variable">numListeners</span> <span class="operator">=</span> tmpListeners.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                    tmpListeners.get(i).onAnimationEnd(<span class="built_in">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br></pre></td></tr></table></figure>

<ul>
<li>流程: <ol>
<li>首先禁止异步运行动画，设置所有动画的时间和插值器。</li>
<li>对所有的动画进行排序(根据依赖关系),取消所有老的监听。如果动画没有依赖，加入即将开始的动画队列，否则创建依赖监听，创建临时依赖</li>
<li>没有延时，启动动画。否则创建延时动画，延时动画结束后，后续动画开始</li>
<li>动画开始监听回调，如果没有动画，动画结束监听回调</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">动画排序</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sortNodes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNeedsSort) &#123;</span><br><span class="line">            mSortedNodes.clear();</span><br><span class="line">            ArrayList&lt;Node&gt; roots = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">            <span class="type">int</span> <span class="variable">numNodes</span> <span class="operator">=</span> mNodes.size();</span><br><span class="line">            <span class="comment">//没有依赖的动画变成根节点</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (node.dependencies == <span class="literal">null</span> || node.dependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    roots.add(node);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ArrayList&lt;Node&gt; tmpRoots = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">            <span class="keyword">while</span> (roots.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//遍历每个根节点</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">numRoots</span> <span class="operator">=</span> roots.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numRoots; ++i) &#123;</span><br><span class="line">                    <span class="type">Node</span> <span class="variable">root</span> <span class="operator">=</span> roots.get(i);</span><br><span class="line">                    mSortedNodes.add(root);</span><br><span class="line">                    <span class="keyword">if</span> (root.nodeDependents != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">numDependents</span> <span class="operator">=</span> root.nodeDependents.size();</span><br><span class="line">                        <span class="comment">//根节点有依赖</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; numDependents; ++j) &#123;</span><br><span class="line">                            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> root.nodeDependents.get(j);</span><br><span class="line">                            <span class="comment">//将此根节点从依赖中移除node.nodeDependencies.remove(root);</span></span><br><span class="line">                            <span class="keyword">if</span> (node.nodeDependencies.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                                tmpRoots.add(node);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                roots.clear();</span><br><span class="line">                roots.addAll(tmpRoots);</span><br><span class="line">                tmpRoots.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            mNeedsSort = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mSortedNodes.size() != mNodes.size()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Circular dependencies cannot exist&quot;</span></span><br><span class="line">                        + <span class="string">&quot; in AnimatorSet&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Doesn&#x27;t need sorting, but still need to add in the nodeDependencies list</span></span><br><span class="line">            <span class="comment">// because these get removed as the event listeners fire and the dependencies</span></span><br><span class="line">            <span class="comment">// are satisfied</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">numNodes</span> <span class="operator">=</span> mNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numNodes; ++i) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodes.get(i);</span><br><span class="line">                <span class="keyword">if</span> (node.dependencies != <span class="literal">null</span> &amp;&amp; node.dependencies.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">numDependencies</span> <span class="operator">=</span> node.dependencies.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; numDependencies; ++j) &#123;</span><br><span class="line">                        <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> node.dependencies.get(j);</span><br><span class="line">                        <span class="keyword">if</span> (node.nodeDependencies == <span class="literal">null</span>) &#123;</span><br><span class="line">                            node.nodeDependencies = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Node&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!node.nodeDependencies.contains(dependency.node)) &#123;</span><br><span class="line">                            node.nodeDependencies.add(dependency.node);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// nodes are &#x27;done&#x27; by default; they become un-done when started, and done</span></span><br><span class="line">                <span class="comment">// again when ended</span></span><br><span class="line">                node.done = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">```  </span><br><span class="line">* 动画排序规则: </span><br><span class="line">  * 如果需要排序</span><br><span class="line">      <span class="number">1.</span> 没有依赖的动画变成根节点.</span><br><span class="line">      <span class="number">2.</span> 循环遍历所有根节点，将根节点从依赖节点中移除</span><br><span class="line">  * 不需要排序</span><br><span class="line">      <span class="number">1.</span> 添加回依赖</span><br><span class="line"></span><br><span class="line">##### Node</span><br><span class="line">代表动画和其依赖。其包含一个动画信息，节点动画依赖集合，独立节点集合</span><br><span class="line"></span><br><span class="line">##### Dependency</span><br><span class="line">动画节点与节点之间的依赖描述</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WITH</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// dependent node must start with this dependency node</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">AFTER</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">// dependent node must start when this dependency node finishes</span></span><br></pre></td></tr></table></figure>
<ul>
<li>包含两个规则，一起，后续</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//多个动画一起播放，添加动画``WITH``依赖</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">playTogether</span><span class="params">(Animator... items)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span>) &#123;</span><br><span class="line">            mNeedsSort = <span class="literal">true</span>;</span><br><span class="line">            <span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> play(items[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; items.length; ++i) &#123;</span><br><span class="line">                builder.with(items[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> Builder <span class="title function_">with</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodeMap.get(anim);</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">                node = <span class="keyword">new</span> <span class="title class_">Node</span>(anim);</span><br><span class="line">                mNodeMap.put(anim, node);</span><br><span class="line">                mNodes.add(node);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dependency</span>(mCurrentNode, Dependency.WITH);</span><br><span class="line">            node.addDependency(dependency);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//多个动画串行播放        </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">playSequentially</span><span class="params">(Animator... items)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span>) &#123;</span><br><span class="line">            mNeedsSort = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (items.length == <span class="number">1</span>) &#123;</span><br><span class="line">                play(items[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mReversible = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; items.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">                    play(items[i]).before(items[i+<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//在某个动画之前播放，添加``AFTER``依赖</span></span><br><span class="line"><span class="keyword">public</span> Builder <span class="title function_">before</span><span class="params">(Animator anim)</span> &#123;</span><br><span class="line">            mReversible = <span class="literal">false</span>;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> mNodeMap.get(anim);</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">                node = <span class="keyword">new</span> <span class="title class_">Node</span>(anim);</span><br><span class="line">                mNodeMap.put(anim, node);</span><br><span class="line">                mNodes.add(node);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Dependency</span> <span class="variable">dependency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dependency</span>(mCurrentNode, Dependency.AFTER);</span><br><span class="line">            node.addDependency(dependency);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;                </span><br></pre></td></tr></table></figure>

<h4 id="LayoutTransition"><a href="#LayoutTransition" class="headerlink" title="LayoutTransition"></a>LayoutTransition</h4><p><code>ViewGroup</code>布局发生改变时播放动画。这个动画的核心概念是两个类型的改变会引起四种不同的动画运行。这两种改变时<code>appearing</code>和<code>disappearing</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ViewGroup</span><br><span class="line"><span class="title function_">setLayoutTransition</span><span class="params">(LayoutTransition transition)</span></span><br></pre></td></tr></table></figure>
<p>动画类型，用一个字节表示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_APPEARING</span>             <span class="operator">=</span> <span class="number">0x01</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_DISAPPEARING</span>          <span class="operator">=</span> <span class="number">0x02</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_CHANGE_APPEARING</span>      <span class="operator">=</span> <span class="number">0x04</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_CHANGE_DISAPPEARING</span>   <span class="operator">=</span> <span class="number">0x08</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLAG_CHANGING</span>              <span class="operator">=</span> <span class="number">0x10</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">mTransitionTypes</span> <span class="operator">=</span> FLAG_CHANGE_APPEARING | FLAG_CHANGE_DISAPPEARING |</span><br><span class="line">            FLAG_APPEARING | FLAG_DISAPPEARING;</span><br><span class="line">            </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupChangeAnimation</span><span class="params">(<span class="keyword">final</span> ViewGroup parent, <span class="keyword">final</span> <span class="type">int</span> changeReason,</span></span><br><span class="line"><span class="params">            Animator baseAnimator, <span class="keyword">final</span> <span class="type">long</span> duration, <span class="keyword">final</span> View child)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we already have a listener for this child, then we&#x27;ve already set up the</span></span><br><span class="line">        <span class="comment">// changing animation we need. Multiple calls for a child may occur when several</span></span><br><span class="line">        <span class="comment">// add/remove operations are run at once on a container; each one will trigger</span></span><br><span class="line">        <span class="comment">// changes for the existing children in the container.</span></span><br><span class="line">        <span class="keyword">if</span> (layoutChangeListenerMap.get(child) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don&#x27;t animate items up from size(0,0); this is likely because the objects</span></span><br><span class="line">        <span class="comment">// were offscreen/invisible or otherwise measured to be infinitely small. We don&#x27;t</span></span><br><span class="line">        <span class="comment">// want to see them animate into their real size; just ignore animation requests</span></span><br><span class="line">        <span class="comment">// on these views</span></span><br><span class="line">        <span class="keyword">if</span> (child.getWidth() == <span class="number">0</span> &amp;&amp; child.getHeight() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make a copy of the appropriate animation</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Animator</span> <span class="variable">anim</span> <span class="operator">=</span> baseAnimator.clone();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the target object for the animation</span></span><br><span class="line">        anim.setTarget(child);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// A ObjectAnimator (or AnimatorSet of them) can extract start values from</span></span><br><span class="line">        <span class="comment">// its target object</span></span><br><span class="line">        anim.setupStartValues();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there&#x27;s an animation running on this view already, cancel it</span></span><br><span class="line">        <span class="type">Animator</span> <span class="variable">currentAnimation</span> <span class="operator">=</span> pendingAnimations.get(child);</span><br><span class="line">        <span class="keyword">if</span> (currentAnimation != <span class="literal">null</span>) &#123;</span><br><span class="line">            currentAnimation.cancel();</span><br><span class="line">            pendingAnimations.remove(child);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Cache the animation in case we need to cancel it later</span></span><br><span class="line">        pendingAnimations.put(child, anim);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For the animations which don&#x27;t get started, we have to have a means of</span></span><br><span class="line">        <span class="comment">// removing them from the cache, lest we leak them and their target objects.</span></span><br><span class="line">        <span class="comment">// We run an animator for the default duration+100 (an arbitrary time, but one</span></span><br><span class="line">        <span class="comment">// which should far surpass the delay between setting them up here and</span></span><br><span class="line">        <span class="comment">// handling layout events which start them.</span></span><br><span class="line">        <span class="type">ValueAnimator</span> <span class="variable">pendingAnimRemover</span> <span class="operator">=</span> ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>).</span><br><span class="line">                setDuration(duration + <span class="number">100</span>);</span><br><span class="line">        pendingAnimRemover.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                pendingAnimations.remove(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        pendingAnimRemover.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add a listener to track layout changes on this view. If we don&#x27;t get a callback,</span></span><br><span class="line">        <span class="comment">// then there&#x27;s nothing to animate.</span></span><br><span class="line">        <span class="keyword">final</span> View.<span class="type">OnLayoutChangeListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">View</span>.OnLayoutChangeListener() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLayoutChange</span><span class="params">(View v, <span class="type">int</span> left, <span class="type">int</span> top, <span class="type">int</span> right, <span class="type">int</span> bottom,</span></span><br><span class="line"><span class="params">                    <span class="type">int</span> oldLeft, <span class="type">int</span> oldTop, <span class="type">int</span> oldRight, <span class="type">int</span> oldBottom)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Tell the animation to extract end values from the changed object</span></span><br><span class="line">                anim.setupEndValues();</span><br><span class="line">                <span class="keyword">if</span> (anim <span class="keyword">instanceof</span> ValueAnimator) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">valuesDiffer</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                    <span class="type">ValueAnimator</span> <span class="variable">valueAnim</span> <span class="operator">=</span> (ValueAnimator)anim;</span><br><span class="line">                    PropertyValuesHolder[] oldValues = valueAnim.getValues();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; oldValues.length; ++i) &#123;</span><br><span class="line">                        <span class="type">PropertyValuesHolder</span> <span class="variable">pvh</span> <span class="operator">=</span> oldValues[i];</span><br><span class="line">                        <span class="keyword">if</span> (pvh.mKeyframes <span class="keyword">instanceof</span> KeyframeSet) &#123;</span><br><span class="line">                            <span class="type">KeyframeSet</span> <span class="variable">keyframeSet</span> <span class="operator">=</span> (KeyframeSet) pvh.mKeyframes;</span><br><span class="line">                            <span class="keyword">if</span> (keyframeSet.mFirstKeyframe == <span class="literal">null</span> ||</span><br><span class="line">                                    keyframeSet.mLastKeyframe == <span class="literal">null</span> ||</span><br><span class="line">                                    !keyframeSet.mFirstKeyframe.getValue().equals(</span><br><span class="line">                                            keyframeSet.mLastKeyframe.getValue())) &#123;</span><br><span class="line">                                valuesDiffer = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pvh.mKeyframes.getValue(<span class="number">0</span>).equals(pvh.mKeyframes.getValue(<span class="number">1</span>))) &#123;</span><br><span class="line">                            valuesDiffer = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!valuesDiffer) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">long</span> <span class="variable">startDelay</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">switch</span> (changeReason) &#123;</span><br><span class="line">                    <span class="keyword">case</span> APPEARING:</span><br><span class="line">                        startDelay = mChangingAppearingDelay + staggerDelay;</span><br><span class="line">                        staggerDelay += mChangingAppearingStagger;</span><br><span class="line">                        <span class="keyword">if</span> (mChangingAppearingInterpolator != sChangingAppearingInterpolator) &#123;</span><br><span class="line">                            anim.setInterpolator(mChangingAppearingInterpolator);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> DISAPPEARING:</span><br><span class="line">                        startDelay = mChangingDisappearingDelay + staggerDelay;</span><br><span class="line">                        staggerDelay += mChangingDisappearingStagger;</span><br><span class="line">                        <span class="keyword">if</span> (mChangingDisappearingInterpolator !=</span><br><span class="line">                                sChangingDisappearingInterpolator) &#123;</span><br><span class="line">                            anim.setInterpolator(mChangingDisappearingInterpolator);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> CHANGING:</span><br><span class="line">                        startDelay = mChangingDelay + staggerDelay;</span><br><span class="line">                        staggerDelay += mChangingStagger;</span><br><span class="line">                        <span class="keyword">if</span> (mChangingInterpolator != sChangingInterpolator) &#123;</span><br><span class="line">                            anim.setInterpolator(mChangingInterpolator);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                anim.setStartDelay(startDelay);</span><br><span class="line">                anim.setDuration(duration);</span><br><span class="line"></span><br><span class="line">                <span class="type">Animator</span> <span class="variable">prevAnimation</span> <span class="operator">=</span> currentChangingAnimations.get(child);</span><br><span class="line">                <span class="keyword">if</span> (prevAnimation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    prevAnimation.cancel();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">Animator</span> <span class="variable">pendingAnimation</span> <span class="operator">=</span> pendingAnimations.get(child);</span><br><span class="line">                <span class="keyword">if</span> (pendingAnimation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    pendingAnimations.remove(child);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Cache the animation in case we need to cancel it later</span></span><br><span class="line">                currentChangingAnimations.put(child, anim);</span><br><span class="line"></span><br><span class="line">                parent.requestTransitionStart(LayoutTransition.<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this only removes listeners whose views changed - must clear the</span></span><br><span class="line">                <span class="comment">// other listeners later</span></span><br><span class="line">                child.removeOnLayoutChangeListener(<span class="built_in">this</span>);</span><br><span class="line">                layoutChangeListenerMap.remove(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// Remove the animation from the cache when it ends</span></span><br><span class="line">        anim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationStart</span><span class="params">(Animator animator)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (hasListeners()) &#123;</span><br><span class="line">                    ArrayList&lt;TransitionListener&gt; listeners =</span><br><span class="line">                            (ArrayList&lt;TransitionListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">for</span> (TransitionListener listener : listeners) &#123;</span><br><span class="line">                        listener.startTransition(LayoutTransition.<span class="built_in">this</span>, parent, child,</span><br><span class="line">                                changeReason == APPEARING ?</span><br><span class="line">                                        CHANGE_APPEARING : changeReason == DISAPPEARING ?</span><br><span class="line">                                        CHANGE_DISAPPEARING : CHANGING);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationCancel</span><span class="params">(Animator animator)</span> &#123;</span><br><span class="line">                child.removeOnLayoutChangeListener(listener);</span><br><span class="line">                layoutChangeListenerMap.remove(child);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animator)</span> &#123;</span><br><span class="line">                currentChangingAnimations.remove(child);</span><br><span class="line">                <span class="keyword">if</span> (hasListeners()) &#123;</span><br><span class="line">                    ArrayList&lt;TransitionListener&gt; listeners =</span><br><span class="line">                            (ArrayList&lt;TransitionListener&gt;) mListeners.clone();</span><br><span class="line">                    <span class="keyword">for</span> (TransitionListener listener : listeners) &#123;</span><br><span class="line">                        listener.endTransition(LayoutTransition.<span class="built_in">this</span>, parent, child,</span><br><span class="line">                                changeReason == APPEARING ?</span><br><span class="line">                                        CHANGE_APPEARING : changeReason == DISAPPEARING ?</span><br><span class="line">                                        CHANGE_DISAPPEARING : CHANGING);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        child.addOnLayoutChangeListener(listener);</span><br><span class="line">        <span class="comment">// cache the listener for later removal</span></span><br><span class="line">        layoutChangeListenerMap.put(child, listener);</span><br><span class="line">    &#125;            </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>主要流程<ol>
<li>启动一个延时动画来移除为执行的动画</li>
<li>监听布局变化,如果是<code>ValueAnimator</code>，判断起始帧和结束帧是否一样，如果一样表示结束.否则根据布局改变的原因设置动画类型，开始动画</li>
<li>移除缓存动画</li>
</ol>
</li>
</ul>
<h4 id="ViewPropertyAnimator"><a href="#ViewPropertyAnimator" class="headerlink" title="ViewPropertyAnimator"></a>ViewPropertyAnimator</h4><p>自动优化<code>View</code>对象的属性动画。如果想做1个或者两个属性动画，使用<code>ObjectAnimator</code>，其也可以设置属性值，合理的刷新视图。但是如果有多个属性要同时动画，或者想要使用更简洁的语法，那么可以使用<code>ViewPropertyAnimator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">animateProperty</span><span class="params">(<span class="type">int</span> constantName, <span class="type">float</span> toValue)</span> &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">fromValue</span> <span class="operator">=</span> getValue(constantName);</span><br><span class="line">        <span class="type">float</span> <span class="variable">deltaValue</span> <span class="operator">=</span> toValue - fromValue;</span><br><span class="line">        animatePropertyBy(constantName, fromValue, deltaValue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">animatePropertyBy</span><span class="params">(<span class="type">int</span> constantName, <span class="type">float</span> startValue, <span class="type">float</span> byValue)</span> &#123;</span><br><span class="line">        <span class="comment">// First, cancel any existing animations on this property</span></span><br><span class="line">        <span class="keyword">if</span> (mAnimatorMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Animator</span> <span class="variable">animatorToCancel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            Set&lt;Animator&gt; animatorSet = mAnimatorMap.keySet();</span><br><span class="line">            <span class="keyword">for</span> (Animator runningAnim : animatorSet) &#123;</span><br><span class="line">                <span class="type">PropertyBundle</span> <span class="variable">bundle</span> <span class="operator">=</span> mAnimatorMap.get(runningAnim);</span><br><span class="line">                <span class="keyword">if</span> (bundle.cancel(constantName)) &#123;</span><br><span class="line">                    <span class="comment">// property was canceled - cancel the animation if it&#x27;s now empty</span></span><br><span class="line">                    <span class="comment">// Note that it&#x27;s safe to break out here because every new animation</span></span><br><span class="line">                    <span class="comment">// on a property will cancel a previous animation on that property, so</span></span><br><span class="line">                    <span class="comment">// there can only ever be one such animation running.</span></span><br><span class="line">                    <span class="keyword">if</span> (bundle.mPropertyMask == NONE) &#123;</span><br><span class="line">                        <span class="comment">// the animation is no longer changing anything - cancel it</span></span><br><span class="line">                        animatorToCancel = runningAnim;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (animatorToCancel != <span class="literal">null</span>) &#123;</span><br><span class="line">                animatorToCancel.cancel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">NameValuesHolder</span> <span class="variable">nameValuePair</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NameValuesHolder</span>(constantName, startValue, byValue);</span><br><span class="line">        mPendingAnimations.add(nameValuePair);</span><br><span class="line">        mView.removeCallbacks(mAnimationStarter);</span><br><span class="line">        mView.postOnAnimation(mAnimationStarter);</span><br><span class="line">    &#125;    </span><br></pre></td></tr></table></figure>

<ul>
<li>上述流程, 做属性动画都会调用<code>animateProperty</code>，其内部会调用<code>animatePropertyBy</code><ol>
<li>首先会取消这个属性上存在的动画</li>
<li>构建<code>NameValuesHolder</code></li>
<li>调用<code>removeCallbacks(runnable)</code>，取消之前动画</li>
<li>调用<code>postOnAnimation(runnable)</code>，开始动画</li>
</ol>
</li>
</ul>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>主要用于做转场动画，其会保存场景转变的信息。任何转变有两个主要工作: 1. 捕获属性值 2. 基于捕获的属性值改变做动画。**无法与<code>TextureView</code>和<code>SurfaceView</code>一起使用。对于<code>SurfaceView</code>，由于其是从非UI线程更新UI，因此会造成不同步。对于<code>TextureView</code>，由于转场动画依赖<code>ViewOverlay</code>，而其又无法与<code>TextureView</code>一起工作。</p>
<h4 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h4><p><img data-src="/./transition.png" alt="transition"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Transition.java</span><br><span class="line"></span><br><span class="line"><span class="comment">//捕获开始场景的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//捕获结束场景的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">captureEndValues</span><span class="params">(TransitionValues transitionValues)</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="开始转场动画"><a href="#开始转场动画" class="headerlink" title="开始转场动画"></a>开始转场动画</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">beginDelayedTransition</span><span class="params">(<span class="keyword">final</span> ViewGroup sceneRoot, Transition transition)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!sPendingTransitions.contains(sceneRoot) &amp;&amp; sceneRoot.isLaidOut()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Transition.DBG) &#123;</span><br><span class="line">                Log.d(LOG_TAG, <span class="string">&quot;beginDelayedTransition: root, transition = &quot;</span> +</span><br><span class="line">                        sceneRoot + <span class="string">&quot;, &quot;</span> + transition);</span><br><span class="line">            &#125;</span><br><span class="line">            sPendingTransitions.add(sceneRoot);</span><br><span class="line">            <span class="keyword">if</span> (transition == <span class="literal">null</span>) &#123;</span><br><span class="line">                transition = sDefaultTransition;<span class="comment">//使用默认转场</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Transition</span> <span class="variable">transitionClone</span> <span class="operator">=</span> transition.clone();</span><br><span class="line">            sceneChangeSetup(sceneRoot, transitionClone);</span><br><span class="line">            Scene.setCurrentScene(sceneRoot, <span class="literal">null</span>);</span><br><span class="line">            sceneChangeRunTransition(sceneRoot, transitionClone);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sceneChangeSetup</span><span class="params">(ViewGroup sceneRoot, Transition transition)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Capture current values</span></span><br><span class="line">        ArrayList&lt;Transition&gt; runningTransitions = getRunningTransitions().get(sceneRoot);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runningTransitions != <span class="literal">null</span> &amp;&amp; runningTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Transition runningTransition : runningTransitions) &#123;</span><br><span class="line">                runningTransition.pause(sceneRoot);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (transition != <span class="literal">null</span>) &#123;</span><br><span class="line">            transition.captureValues(sceneRoot, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Notify previous scene that it is being exited</span></span><br><span class="line">        <span class="type">Scene</span> <span class="variable">previousScene</span> <span class="operator">=</span> Scene.getCurrentScene(sceneRoot);</span><br><span class="line">        <span class="keyword">if</span> (previousScene != <span class="literal">null</span>) &#123;</span><br><span class="line">            previousScene.exit();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sceneChangeRunTransition</span><span class="params">(<span class="keyword">final</span> ViewGroup sceneRoot,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> Transition transition)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (transition != <span class="literal">null</span> &amp;&amp; sceneRoot != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">MultiListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiListener</span>(transition, sceneRoot);</span><br><span class="line">            sceneRoot.addOnAttachStateChangeListener(listener);</span><br><span class="line">            <span class="comment">//设置绘制前监听</span></span><br><span class="line">            sceneRoot.getViewTreeObserver().addOnPreDrawListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<ul>
<li>流程<ol>
<li>未设置<code>Transition</code>，使用默认<code>Transition</code>，也就是<code>AutoTransition</code></li>
<li>暂停当前正在运行的转场动画，捕获当前场景，取消之前的转场动画</li>
<li>设置当前场景</li>
<li>设置绘制(<code>preDraw</code>)监听，在其当中捕获场景和开始转场动画</li>
</ol>
</li>
</ul>
<h5 id="AutoTransition"><a href="#AutoTransition" class="headerlink" title="AutoTransition"></a>AutoTransition</h5><p>组合转场动画，包括渐变和区域改变。<code>Transition</code>由<code>TransitionManger</code>管理。一般可以使用<code>beginDelayedTransition</code>开始一个转场动画，默认的转场动画为<code>AutoTransition</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TransitionManager.beginDelayedTransition(transitionGroup);</span><br><span class="line"></span><br><span class="line">textView.setVisibility(visible ? View.VISIBLE : View.GONE);</span><br></pre></td></tr></table></figure>

<p>效果如下:</p>

<img data-src="./autotransition.gif" alt="autotransition" width="200" />


<h6 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h6><blockquote>
<p>继承自TransitionSet</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        setOrdering(ORDERING_SEQUENTIAL);</span><br><span class="line">        addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.OUT)).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">ChangeBounds</span>()).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.IN));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>顺序播放渐出，区域变化，渐入动画</li>
</ul>
<h5 id="TransitionSet"><a href="#TransitionSet" class="headerlink" title="TransitionSet"></a>TransitionSet</h5><blockquote>
<p>继承自Transition</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Transition childTransition : mTransitions) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childTransition.isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">                    childTransition.captureStartValues(transitionValues);</span><br><span class="line">                    transitionValues.targetedTransitions.add(childTransition);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captureEndValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Transition childTransition : mTransitions) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childTransition.isValidTarget(transitionValues.view)) &#123;</span><br><span class="line">                    childTransition.captureEndValues(transitionValues);</span><br><span class="line">                    transitionValues.targetedTransitions.add(childTransition);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用各个<code>Transition</code>的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">createAnimators</span><span class="params">(ViewGroup sceneRoot, TransitionValuesMaps startValues,</span></span><br><span class="line"><span class="params">            TransitionValuesMaps endValues, ArrayList&lt;TransitionValues&gt; startValuesList,</span></span><br><span class="line"><span class="params">            ArrayList&lt;TransitionValues&gt; endValuesList)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startDelay</span> <span class="operator">=</span> getStartDelay();</span><br><span class="line">        <span class="type">int</span> <span class="variable">numTransitions</span> <span class="operator">=</span> mTransitions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numTransitions; i++) &#123;</span><br><span class="line">            <span class="type">Transition</span> <span class="variable">childTransition</span> <span class="operator">=</span> mTransitions.get(i);</span><br><span class="line">            <span class="comment">// We only set the start delay on the first transition if we are playing</span></span><br><span class="line">            <span class="comment">// the transitions sequentially.</span></span><br><span class="line">            <span class="keyword">if</span> (startDelay &gt; <span class="number">0</span> &amp;&amp; (mPlayTogether || i == <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">childStartDelay</span> <span class="operator">=</span> childTransition.getStartDelay();</span><br><span class="line">                <span class="keyword">if</span> (childStartDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    childTransition.setStartDelay(startDelay + childStartDelay);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    childTransition.setStartDelay(startDelay);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            childTransition.createAnimators(sceneRoot, startValues, endValues, startValuesList,</span><br><span class="line">                    endValuesList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用各自<code>Transition</code>创建动画。为第一个转场动画设置必要的延时</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">runAnimators</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTransitions.isEmpty()) &#123;</span><br><span class="line">            start();</span><br><span class="line">            end();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setupStartEndListeners();</span><br><span class="line">        <span class="type">int</span> <span class="variable">numTransitions</span> <span class="operator">=</span> mTransitions.size();</span><br><span class="line">        <span class="keyword">if</span> (!mPlayTogether) &#123;</span><br><span class="line">        <span class="comment">//串行播放动画</span></span><br><span class="line">            <span class="comment">// Setup sequence with listeners</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Need to add listeners in such a way that we can remove them later if canceled</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; numTransitions; ++i) &#123;</span><br><span class="line">                <span class="type">Transition</span> <span class="variable">previousTransition</span> <span class="operator">=</span> mTransitions.get(i - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Transition</span> <span class="variable">nextTransition</span> <span class="operator">=</span> mTransitions.get(i);</span><br><span class="line">                previousTransition.addListener(<span class="keyword">new</span> <span class="title class_">TransitionListenerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionEnd</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                        nextTransition.runAnimators();</span><br><span class="line">                        transition.removeListener(<span class="built_in">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Transition</span> <span class="variable">firstTransition</span> <span class="operator">=</span> mTransitions.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (firstTransition != <span class="literal">null</span>) &#123;</span><br><span class="line">                firstTransition.runAnimators();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//并行播放动画</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numTransitions; ++i) &#123;</span><br><span class="line">                mTransitions.get(i).runAnimators();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>动画开始，由各个<code>Transition</code>开始动画，在这里会区分动画是串行播放，还是并行播放。</li>
</ul>
<h5 id="ChangeText-自定义transition"><a href="#ChangeText-自定义transition" class="headerlink" title="ChangeText(自定义transition)"></a>ChangeText(自定义transition)</h5>
<img data-src="./changetext.gif" alt="autotransition" width="200" />


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">textView.animate().alpha(<span class="number">0f</span>).setListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                       textView.setText(mSecondText ? TEXT_2 : TEXT_1);</span><br><span class="line">                       textView.animate().setListener(<span class="literal">null</span>);</span><br><span class="line">                       textView.animate().alpha(<span class="number">1f</span>).start();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;).start();</span><br></pre></td></tr></table></figure>
<ul>
<li>上述代码也能实现相同的功能，<code>ChangeText</code>只是对其进行了进一步的封装。这里不分析其源码</li>
</ul>
<h5 id="ChangeBound"><a href="#ChangeBound" class="headerlink" title="ChangeBound"></a>ChangeBound</h5>
<img data-src="./changebound.gif" alt="autotransition" width="200" />


<h6 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h6><blockquote>
<p>继承<code>Transition</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">captureValues</span><span class="params">(TransitionValues values)</span> &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> values.view;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (view.isLaidOut() || view.getWidth() != <span class="number">0</span> || view.getHeight() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//view已经布局完毕，保存当前view边界状态</span></span><br><span class="line">            values.values.put(PROPNAME_BOUNDS, <span class="keyword">new</span> <span class="title class_">Rect</span>(view.getLeft(), view.getTop(),</span><br><span class="line">                    view.getRight(), view.getBottom()));</span><br><span class="line">            values.values.put(PROPNAME_PARENT, values.view.getParent());</span><br><span class="line">            <span class="keyword">if</span> (mReparent) &#123;</span><br><span class="line">            <span class="comment">//如果动画scene的parent一样，记录当前屏幕位置</span></span><br><span class="line">                values.view.getLocationInWindow(tempLocation);</span><br><span class="line">                values.values.put(PROPNAME_WINDOW_X, tempLocation[<span class="number">0</span>]);</span><br><span class="line">                values.values.put(PROPNAME_WINDOW_Y, tempLocation[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mResizeClip) &#123;</span><br><span class="line">                values.values.put(PROPNAME_CLIP, view.getClipBounds());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>保存当前<code>View</code>的边界状态</li>
</ul>
<blockquote>
<p>创建动画，代码很长，核心代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (numChanges &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Animator anim;</span><br><span class="line">                <span class="keyword">if</span> (!mResizeClip) &#123;</span><br><span class="line">                    view.setLeftTopRightBottom(startLeft, startTop, startRight, startBottom);</span><br><span class="line">                    <span class="keyword">if</span> (numChanges == <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (startWidth == endWidth &amp;&amp; startHeight == endHeight) &#123;</span><br><span class="line">                            <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop, endLeft,</span><br><span class="line">                                    endTop);</span><br><span class="line">                            anim = ObjectAnimator.ofObject(view, POSITION_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                    topLeftPath);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">ViewBounds</span> <span class="variable">viewBounds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ViewBounds</span>(view);</span><br><span class="line">                            <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop,</span><br><span class="line">                                    endLeft, endTop);</span><br><span class="line">                            <span class="type">ObjectAnimator</span> <span class="variable">topLeftAnimator</span> <span class="operator">=</span> ObjectAnimator</span><br><span class="line">                                    .ofObject(viewBounds, TOP_LEFT_PROPERTY, <span class="literal">null</span>, topLeftPath);</span><br><span class="line"></span><br><span class="line">                            <span class="type">Path</span> <span class="variable">bottomRightPath</span> <span class="operator">=</span> getPathMotion().getPath(startRight, startBottom,</span><br><span class="line">                                    endRight, endBottom);</span><br><span class="line">                            <span class="type">ObjectAnimator</span> <span class="variable">bottomRightAnimator</span> <span class="operator">=</span> ObjectAnimator.ofObject(viewBounds,</span><br><span class="line">                                    BOTTOM_RIGHT_PROPERTY, <span class="literal">null</span>, bottomRightPath);</span><br><span class="line">                            <span class="type">AnimatorSet</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnimatorSet</span>();</span><br><span class="line">                            set.playTogether(topLeftAnimator, bottomRightAnimator);</span><br><span class="line">                            anim = set;</span><br><span class="line">                            set.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                                <span class="comment">// We need a strong reference to viewBounds until the</span></span><br><span class="line">                                <span class="comment">// animator ends.</span></span><br><span class="line">                                <span class="keyword">private</span> <span class="type">ViewBounds</span> <span class="variable">mViewBounds</span> <span class="operator">=</span> viewBounds;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (startLeft != endLeft || startTop != endTop) &#123;</span><br><span class="line">                        <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop,</span><br><span class="line">                                endLeft, endTop);</span><br><span class="line">                        anim = ObjectAnimator.ofObject(view, TOP_LEFT_ONLY_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                topLeftPath);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">Path</span> <span class="variable">bottomRight</span> <span class="operator">=</span> getPathMotion().getPath(startRight, startBottom,</span><br><span class="line">                                endRight, endBottom);</span><br><span class="line">                        anim = ObjectAnimator.ofObject(view, BOTTOM_RIGHT_ONLY_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                bottomRight);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">maxWidth</span> <span class="operator">=</span> Math.max(startWidth, endWidth);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">maxHeight</span> <span class="operator">=</span> Math.max(startHeight, endHeight);</span><br><span class="line"></span><br><span class="line">                    view.setLeftTopRightBottom(startLeft, startTop, startLeft + maxWidth,</span><br><span class="line">                            startTop + maxHeight);</span><br><span class="line"></span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">positionAnimator</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (startLeft != endLeft || startTop != endTop) &#123;</span><br><span class="line">                        <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startLeft, startTop, endLeft,</span><br><span class="line">                                endTop);</span><br><span class="line">                        positionAnimator = ObjectAnimator.ofObject(view, POSITION_PROPERTY, <span class="literal">null</span>,</span><br><span class="line">                                topLeftPath);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Rect</span> <span class="variable">finalClip</span> <span class="operator">=</span> endClip;</span><br><span class="line">                    <span class="keyword">if</span> (startClip == <span class="literal">null</span>) &#123;</span><br><span class="line">                        startClip = <span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, startWidth, startHeight);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (endClip == <span class="literal">null</span>) &#123;</span><br><span class="line">                        endClip = <span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, endWidth, endHeight);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">ObjectAnimator</span> <span class="variable">clipAnimator</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!startClip.equals(endClip)) &#123;</span><br><span class="line">                        view.setClipBounds(startClip);</span><br><span class="line">                        clipAnimator = ObjectAnimator.ofObject(view, <span class="string">&quot;clipBounds&quot;</span>, sRectEvaluator,</span><br><span class="line">                                startClip, endClip);</span><br><span class="line">                        clipAnimator.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                            <span class="keyword">private</span> <span class="type">boolean</span> mIsCanceled;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationCancel</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                                mIsCanceled = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!mIsCanceled) &#123;</span><br><span class="line">                                    view.setClipBounds(finalClip);</span><br><span class="line">                                    view.setLeftTopRightBottom(endLeft, endTop, endRight,</span><br><span class="line">                                            endBottom);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    anim = TransitionUtils.mergeAnimators(positionAnimator,</span><br><span class="line">                            clipAnimator);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (view.getParent() <span class="keyword">instanceof</span> ViewGroup) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">ViewGroup</span> <span class="variable">parent</span> <span class="operator">=</span> (ViewGroup) view.getParent();</span><br><span class="line">                    parent.suppressLayout(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">TransitionListener</span> <span class="variable">transitionListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransitionListenerAdapter</span>() &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">mCanceled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionCancel</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            parent.suppressLayout(<span class="literal">false</span>);</span><br><span class="line">                            mCanceled = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionEnd</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!mCanceled) &#123;</span><br><span class="line">                                parent.suppressLayout(<span class="literal">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionPause</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            parent.suppressLayout(<span class="literal">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionResume</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                            parent.suppressLayout(<span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    addListener(transitionListener);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> anim;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sceneRoot.getLocationInWindow(tempLocation);</span><br><span class="line">            <span class="type">int</span> <span class="variable">startX</span> <span class="operator">=</span> (Integer) startValues.values.get(PROPNAME_WINDOW_X) - tempLocation[<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">startY</span> <span class="operator">=</span> (Integer) startValues.values.get(PROPNAME_WINDOW_Y) - tempLocation[<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">endX</span> <span class="operator">=</span> (Integer) endValues.values.get(PROPNAME_WINDOW_X) - tempLocation[<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">endY</span> <span class="operator">=</span> (Integer) endValues.values.get(PROPNAME_WINDOW_Y) - tempLocation[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> also handle size changes: check bounds and animate size changes</span></span><br><span class="line">            <span class="keyword">if</span> (startX != endX || startY != endY) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> view.getWidth();</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> view.getHeight();</span><br><span class="line">                <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">                <span class="type">Canvas</span> <span class="variable">canvas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(bitmap);</span><br><span class="line">                view.draw(canvas);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">BitmapDrawable</span> <span class="variable">drawable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BitmapDrawable</span>(bitmap);</span><br><span class="line">                drawable.setBounds(startX, startY, startX + width, startY + height);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">float</span> <span class="variable">transitionAlpha</span> <span class="operator">=</span> view.getTransitionAlpha();</span><br><span class="line">                view.setTransitionAlpha(<span class="number">0</span>);</span><br><span class="line">                sceneRoot.getOverlay().add(drawable);</span><br><span class="line">                <span class="type">Path</span> <span class="variable">topLeftPath</span> <span class="operator">=</span> getPathMotion().getPath(startX, startY, endX, endY);</span><br><span class="line">                <span class="type">PropertyValuesHolder</span> <span class="variable">origin</span> <span class="operator">=</span> PropertyValuesHolder.ofObject(</span><br><span class="line">                        DRAWABLE_ORIGIN_PROPERTY, <span class="literal">null</span>, topLeftPath);</span><br><span class="line">                <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> ObjectAnimator.ofPropertyValuesHolder(drawable, origin);</span><br><span class="line">                anim.addListener(<span class="keyword">new</span> <span class="title class_">AnimatorListenerAdapter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animator animation)</span> &#123;</span><br><span class="line">                        sceneRoot.getOverlay().remove(drawable);</span><br><span class="line">                        view.setTransitionAlpha(transitionAlpha);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> anim;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主要功能是判断<code>View</code>的边界有没有发生改变，如果发生改变，使用对应的位置变化动画，主要包括<code>topLeft, bottomRight, position</code>。如果没有发生改变，则在<code>View</code>上绘制<code>Overlay</code>并对其做<code>path</code>动画。</li>
</ul>
<p>设置<code>pathMotion</code></p>
<blockquote>
<p>其是一个抽象类，用于描述<code>Transition</code>的<code>Path</code>信息</p>
</blockquote>

<img data-src="./changebound_pathmotion.gif" alt="autotransition" width="200" />


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">PathMotion</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PathMotion</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PathMotion</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Provide a Path to interpolate between two points &lt;code&gt;(startX, startY)&lt;/code&gt; and</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;(endX, endY)&lt;/code&gt;. This allows controlled curved motion along two dimensions.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startX The x coordinate of the starting point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startY The y coordinate of the starting point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endX   The x coordinate of the ending point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endY   The y coordinate of the ending point.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A Path along which the points should be interpolated. The returned Path</span></span><br><span class="line"><span class="comment">     * must start at point &lt;code&gt;(startX, startY)&lt;/code&gt;, typically using</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> android.graphics.Path#moveTo(float, float)&#125; and end at &lt;code&gt;(endX, endY)&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Path <span class="title function_">getPath</span><span class="params">(<span class="type">float</span> startX, <span class="type">float</span> startY, <span class="type">float</span> endX, <span class="type">float</span> endY)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现<code>getPath</code>以便提供两点之间的变化频率</li>
</ul>
<h5 id="Slide"><a href="#Slide" class="headerlink" title="Slide"></a>Slide</h5><blockquote>
<p>继承自<code>Visibility</code></p>
</blockquote>

<img data-src="./slide.gif" alt="autotransition" width="200" />


<h6 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">captureValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> transitionValues.view;</span><br><span class="line">        <span class="type">int</span>[] position = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];</span><br><span class="line">        view.getLocationOnScreen(position);</span><br><span class="line">        transitionValues.values.put(PROPNAME_SCREEN_POSITION, position);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>保存当前<code>View</code>位置</li>
</ul>
<blockquote>
<p>其<code>createAnimator</code>在父类<code>Visibility</code>中被重写，当中调用<code>onAppear</code>和<code>onDisappear</code>，这两个方法分别有各自的重载方法，由子类提供具体的实现，默认无动画</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span><br><span class="line"><span class="params">            TransitionValues startValues, TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (endValues == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span>[] position = (<span class="type">int</span>[]) endValues.values.get(PROPNAME_SCREEN_POSITION);</span><br><span class="line">        <span class="type">float</span> <span class="variable">endX</span> <span class="operator">=</span> view.getTranslationX();</span><br><span class="line">        <span class="type">float</span> <span class="variable">endY</span> <span class="operator">=</span> view.getTranslationY();</span><br><span class="line">        <span class="type">float</span> <span class="variable">startX</span> <span class="operator">=</span> mSlideCalculator.getGoneX(sceneRoot, view);</span><br><span class="line">        <span class="type">float</span> <span class="variable">startY</span> <span class="operator">=</span> mSlideCalculator.getGoneY(sceneRoot, view);</span><br><span class="line">        <span class="keyword">return</span> TranslationAnimationCreator</span><br><span class="line">                .createAnimation(view, endValues, position[<span class="number">0</span>], position[<span class="number">1</span>],</span><br><span class="line">                        startX, startY, endX, endY, sDecelerate, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>CalculateSlide</code>接口的实现计算<code>View</code>离开或者进入场景时的位置，最后由<code>TranslationAnimationCreator</code>创建动画</li>
</ul>
<h5 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h5>
<img data-src="./scale.gif" alt="autotransition" width="200" />


<p>设置<code>alpha</code></p>

<img data-src="./scale_alpha.gif" alt="autotransition" width="200" />


<h6 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h6><p>private Animator createAnimation(final View view, float startScale, float endScale, TransitionValues values) {<br>        final float initialScaleX &#x3D; view.getScaleX();<br>        final float initialScaleY &#x3D; view.getScaleY();<br>        float startScaleX &#x3D; initialScaleX * startScale;<br>        float endScaleX &#x3D; initialScaleX * endScale;<br>        float startScaleY &#x3D; initialScaleY * startScale;<br>        float endScaleY &#x3D; initialScaleY * endScale;</p>
<pre><code>    if (values != null) &#123;
        Float savedScaleX = (Float) values.values.get(PROPNAME_SCALE_X);
        Float savedScaleY = (Float) values.values.get(PROPNAME_SCALE_Y);
        // if saved value is not equal initial value it means that previous
        // transition was interrupted and in the onTransitionEnd
        // we&#39;ve applied endScale. we should apply proper value to
        // continue animation from the interrupted state
        if (savedScaleX != null &amp;&amp; savedScaleX != initialScaleX) &#123;
            startScaleX = savedScaleX;
        &#125;
        if (savedScaleY != null &amp;&amp; savedScaleY != initialScaleY) &#123;
            startScaleY = savedScaleY;
        &#125;
    &#125;

    view.setScaleX(startScaleX);
    view.setScaleY(startScaleY);

    Animator animator = TransitionUtils.mergeAnimators(
            ObjectAnimator.ofFloat(view, View.SCALE_X, startScaleX, endScaleX),
            ObjectAnimator.ofFloat(view, View.SCALE_Y, startScaleY, endScaleY));
    addListener(new TransitionListenerAdapter() &#123;
        @Override
        public void onTransitionEnd(Transition transition) &#123;
            view.setScaleX(initialScaleX);
            view.setScaleY(initialScaleY);
        &#125;
    &#125;);
    return animator;
</code></pre>
<p>}</p>
<ul>
<li>合并<code>x, y</code>缩放的动画，合并是采用<code>TransitionSet</code>，如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Transition <span class="title function_">mergeTransitions</span><span class="params">(Transition... transitions)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nonNullIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; transitions.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (transitions[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">                nonNullIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> transitions[nonNullIndex];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">TransitionSet</span> <span class="variable">transitionSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransitionSet</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; transitions.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (transitions[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                transitionSet.addTransition(transitions[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> transitionSet;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="Explode"><a href="#Explode" class="headerlink" title="Explode"></a>Explode</h5><blockquote>
<p>继承自Visibility</p>
</blockquote>

<img data-src="./explode.gif" alt="autotransition" width="200" />


<h6 id="源码分析-4"><a href="#源码分析-4" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span><br><span class="line"><span class="params">            TransitionValues startValues, TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (endValues == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Rect</span> <span class="variable">bounds</span> <span class="operator">=</span> (Rect) endValues.values.get(PROPNAME_SCREEN_BOUNDS);</span><br><span class="line">        <span class="type">float</span> <span class="variable">endX</span> <span class="operator">=</span> view.getTranslationX();</span><br><span class="line">        <span class="type">float</span> <span class="variable">endY</span> <span class="operator">=</span> view.getTranslationY();</span><br><span class="line">        calculateOut(sceneRoot, bounds, mTempLoc);</span><br><span class="line">        <span class="type">float</span> <span class="variable">startX</span> <span class="operator">=</span> endX + mTempLoc[<span class="number">0</span>];</span><br><span class="line">        <span class="type">float</span> <span class="variable">startY</span> <span class="operator">=</span> endY + mTempLoc[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> TranslationAnimationCreator.createAnimation(view, endValues, bounds.left, bounds.top,</span><br><span class="line">                startX, startY, endX, endY, sDecelerate, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>calculateOut</code>计算扩散的距离，使用<code>TranslationAnimationCreator</code>创建动画</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">calculateOut</span><span class="params">(View sceneRoot, Rect bounds, <span class="type">int</span>[] outVector)</span> &#123;</span><br><span class="line">        sceneRoot.getLocationOnScreen(mTempLoc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">sceneRootX</span> <span class="operator">=</span> mTempLoc[<span class="number">0</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">sceneRootY</span> <span class="operator">=</span> mTempLoc[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span> focalX;</span><br><span class="line">        <span class="type">int</span> focalY;</span><br><span class="line"></span><br><span class="line">        <span class="type">Rect</span> <span class="variable">epicenter</span> <span class="operator">=</span> getEpicenter();</span><br><span class="line">        <span class="keyword">if</span> (epicenter == <span class="literal">null</span>) &#123;</span><br><span class="line">            focalX = sceneRootX + (sceneRoot.getWidth() / <span class="number">2</span>)</span><br><span class="line">                    + Math.round(sceneRoot.getTranslationX());</span><br><span class="line">            focalY = sceneRootY + (sceneRoot.getHeight() / <span class="number">2</span>)</span><br><span class="line">                    + Math.round(sceneRoot.getTranslationY());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            focalX = epicenter.centerX();</span><br><span class="line">            focalY = epicenter.centerY();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">centerX</span> <span class="operator">=</span> bounds.centerX();</span><br><span class="line">        <span class="type">int</span> <span class="variable">centerY</span> <span class="operator">=</span> bounds.centerY();</span><br><span class="line">        <span class="type">double</span> <span class="variable">xVector</span> <span class="operator">=</span> centerX - focalX;</span><br><span class="line">        <span class="type">double</span> <span class="variable">yVector</span> <span class="operator">=</span> centerY - focalY;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (xVector == <span class="number">0</span> &amp;&amp; yVector == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Random direction when View is centered on focal View.</span></span><br><span class="line">            xVector = (Math.random() * <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">            yVector = (Math.random() * <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">double</span> <span class="variable">vectorSize</span> <span class="operator">=</span> Math.hypot(xVector, yVector);</span><br><span class="line">        xVector /= vectorSize;</span><br><span class="line">        yVector /= vectorSize;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">maxDistance</span> <span class="operator">=</span></span><br><span class="line">                calculateMaxDistance(sceneRoot, focalX - sceneRootX, focalY - sceneRootY);</span><br><span class="line"></span><br><span class="line">        outVector[<span class="number">0</span>] = (<span class="type">int</span>) Math.round(maxDistance * xVector);</span><br><span class="line">        outVector[<span class="number">1</span>] = (<span class="type">int</span>) Math.round(maxDistance * yVector);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>计算场景动画的偏移量，如果为0，随机算出偏移量，算出x, y偏移量的平方根，求出最大距离<h5 id="TransitionName"><a href="#TransitionName" class="headerlink" title="TransitionName"></a>TransitionName</h5></li>
</ul>
<blockquote>
<p>设置要做动画的标识，在之后的动画中会对这些标识的<code>View</code>做动画</p>
</blockquote>

<img data-src="./transition_name.gif" alt="autotransition" width="200" />


<h5 id="ImageTransform"><a href="#ImageTransform" class="headerlink" title="ImageTransform"></a>ImageTransform</h5>
<img data-src="./ImageTransform.gif" alt="autotransition" width="200" />


<h5 id="ReColor"><a href="#ReColor" class="headerlink" title="ReColor"></a>ReColor</h5>
<img data-src="./recolor.gif" alt="autotransition" width="200" />


<h5 id="Rotate"><a href="#Rotate" class="headerlink" title="Rotate"></a>Rotate</h5><blockquote>
<p>继承自Transition的旋转动画</p>
</blockquote>

<img data-src="./rotate.gif" alt="autotransition" width="200" />


<h6 id="源码分析-5"><a href="#源码分析-5" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Animator <span class="title function_">createAnimator</span><span class="params">(ViewGroup sceneRoot, TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (startValues == <span class="literal">null</span> || endValues == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> endValues.view;</span><br><span class="line">        <span class="type">float</span> <span class="variable">startRotation</span> <span class="operator">=</span> (Float) startValues.values.get(PROPNAME_ROTATION);</span><br><span class="line">        <span class="type">float</span> <span class="variable">endRotation</span> <span class="operator">=</span> (Float) endValues.values.get(PROPNAME_ROTATION);</span><br><span class="line">        <span class="keyword">if</span> (startRotation != endRotation) &#123;</span><br><span class="line">            view.setRotation(startRotation);</span><br><span class="line">            <span class="keyword">return</span> ObjectAnimator.ofFloat(view, View.ROTATION,</span><br><span class="line">                    startRotation, endRotation);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建旋转动画</li>
</ul>
<h5 id="Progress"><a href="#Progress" class="headerlink" title="Progress"></a>Progress</h5>
<img data-src="./progress.gif" alt="autotransition" width="200" />


<h5 id="Change-Scene"><a href="#Change-Scene" class="headerlink" title="Change Scene"></a>Change Scene</h5>
<img data-src="./change_scene.gif" alt="autotransition" width="200" />



<h6 id="源码分析-6"><a href="#源码分析-6" class="headerlink" title="源码分析"></a>源码分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        setOrdering(ORDERING_SEQUENTIAL);</span><br><span class="line">        addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.OUT)).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">ChangeBounds</span>()).</span><br><span class="line">                addTransition(<span class="keyword">new</span> <span class="title class_">Fade</span>(Fade.IN));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>先淡出效果(<code>Fade</code>)，改变区域(<code>ChangeBound</code>)，淡入效果(<code>Fade</code>)</li>
</ul>
<h5 id="Fade"><a href="#Fade" class="headerlink" title="Fade"></a>Fade</h5><p>渐变转场动画，继承自<code>Visibility</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">captureStartValues</span><span class="params">(TransitionValues transitionValues)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.captureStartValues(transitionValues);</span><br><span class="line">        transitionValues.values.put(PROPNAME_TRANSITION_ALPHA,</span><br><span class="line">                transitionValues.view.getTransitionAlpha());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>捕获初始场景的<code>alpha</code>值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Animator <span class="title function_">createAnimation</span><span class="params">(<span class="keyword">final</span> View view, <span class="type">float</span> startAlpha, <span class="keyword">final</span> <span class="type">float</span> endAlpha)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (startAlpha == endAlpha) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        view.setTransitionAlpha(startAlpha);</span><br><span class="line">        <span class="comment">//创建渐变属性动画</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectAnimator</span> <span class="variable">anim</span> <span class="operator">=</span> ObjectAnimator.ofFloat(view, <span class="string">&quot;transitionAlpha&quot;</span>, endAlpha);</span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            Log.d(LOG_TAG, <span class="string">&quot;Created animator &quot;</span> + anim);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FadeAnimatorListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FadeAnimatorListener</span>(view);</span><br><span class="line">        anim.addListener(listener);</span><br><span class="line">        anim.addPauseListener(listener);</span><br><span class="line">        addListener(<span class="keyword">new</span> <span class="title class_">TransitionListenerAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransitionEnd</span><span class="params">(Transition transition)</span> &#123;</span><br><span class="line">                view.setTransitionAlpha(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> anim;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建渐变属性动画，其会由<code>onAppear()</code>和<code>onDisAppear</code>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onAppear</span><span class="params">(ViewGroup sceneRoot, View view,</span></span><br><span class="line"><span class="params">            TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            <span class="type">View</span> <span class="variable">startView</span> <span class="operator">=</span> (startValues != <span class="literal">null</span>) ? startValues.view : <span class="literal">null</span>;</span><br><span class="line">            Log.d(LOG_TAG, <span class="string">&quot;Fade.onAppear: startView, startVis, endView, endVis = &quot;</span> +</span><br><span class="line">                    startView + <span class="string">&quot;, &quot;</span> + view);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建渐入动画</span></span><br><span class="line">        <span class="keyword">return</span> createAnimation(view, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">onDisappear</span><span class="params">(ViewGroup sceneRoot, <span class="keyword">final</span> View view, TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">            <span class="comment">//创建渐出动画</span></span><br><span class="line">        <span class="keyword">return</span> createAnimation(view, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这两个方法由<code>Visibility</code>的<code>createAnimator</code>调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Animator <span class="title function_">createAnimator</span><span class="params">(ViewGroup sceneRoot, TransitionValues startValues,</span></span><br><span class="line"><span class="params">            TransitionValues endValues)</span> &#123;</span><br><span class="line">        <span class="type">VisibilityInfo</span> <span class="variable">visInfo</span> <span class="operator">=</span> getVisibilityChangeInfo(startValues, endValues);</span><br><span class="line">        <span class="keyword">if</span> (visInfo.visibilityChange</span><br><span class="line">                &amp;&amp; (visInfo.startParent != <span class="literal">null</span> || visInfo.endParent != <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (visInfo.fadeIn) &#123;</span><br><span class="line">                <span class="keyword">return</span> onAppear(sceneRoot, startValues, visInfo.startVisibility,</span><br><span class="line">                        endValues, visInfo.endVisibility);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> onDisappear(sceneRoot, startValues, visInfo.startVisibility,</span><br><span class="line">                        endValues, visInfo.endVisibility</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>View</code>显示或隐藏时会创建对应的渐变动画。<code>Transition</code>的<code>playTransition</code>会调用<code>createAnimators</code>，其内部会调用<code>createAnimator</code>。</li>
<li>整体流程是启动<code>Transition</code>-&gt;创建动画(<code>createAnimators</code>)-&gt;创建单个动画(<code>createAnimator</code>由<code>Transition</code>子类实现,默认空)-&gt;<code>Visibility</code>的<code>onAppear()</code>&#x2F;<code>onDisappear</code>-&gt;子类<code>createAnimator</code></li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结:"></a>总结:</h3><blockquote>
<p><code>Transition</code>动画其实是对属性动画的一种高级封装。其主要流程是<code>TransitionManager</code>调用<code>beginDelayedTransition</code>,内部监听了<code>OnPreDrawListener</code>，其在<code>onPreDraw</code>调用<code>captureView</code>用于获取当前<code>View</code>的状态,调用<code>playTransition</code>开始转场动画。之后创建动画<code>createAnimator</code>。这其中<code>captureView</code>都是由子类实现，而<code>createAnimator</code>则可以由子类选择重写。最终动画的开始还有调用<code>animator.start()</code></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/12/03/Picasso%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/03/Picasso%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Picasso解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2016-12-03 17:59:43 / Modified: 18:04:22" itemprop="dateCreated datePublished" datetime="2016-12-03T17:59:43+08:00">2016-12-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>Picasso</code>是常用的图片加载库，其有很多设计上值得学习的地方，比如根据网络调整线程池大小，批量处理图片结果，以及消息分发。文本会对它进行深入分析</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Picasso.with(xxx).load(xxx).into(xxx);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Adapter</code>内下载</li>
<li>图片转换</li>
<li>预置图片</li>
<li>资源加载</li>
</ul>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Picasso <span class="title function_">with</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;context == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (Picasso.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;</span><br><span class="line">          singleton = <span class="keyword">new</span> <span class="title class_">Builder</span>(context).build();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singleton;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建<code>Picasso</code>对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Picasso <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="built_in">this</span>.context;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (downloader == <span class="literal">null</span>) &#123;</span><br><span class="line">        downloader = Utils.createDefaultDownloader(context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (cache == <span class="literal">null</span>) &#123;</span><br><span class="line">        cache = <span class="keyword">new</span> <span class="title class_">LruCache</span>(context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">        service = <span class="keyword">new</span> <span class="title class_">PicassoExecutorService</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (transformer == <span class="literal">null</span>) &#123;</span><br><span class="line">        transformer = RequestTransformer.IDENTITY;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">Stats</span> <span class="variable">stats</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stats</span>(cache);</span><br><span class="line"></span><br><span class="line">      <span class="type">Dispatcher</span> <span class="variable">dispatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dispatcher</span>(context, service, HANDLER, downloader, cache, stats);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Picasso</span>(context, dispatcher, cache, listener, transformer, requestHandlers, stats,</span><br><span class="line">          defaultBitmapConfig, indicatorsEnabled, loggingEnabled);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建默认下载器</li>
<li>创建默认缓存,<code>LRU</code>缓存</li>
<li>自定义线程池</li>
<li>创建默认请求转换器</li>
<li>创建分配器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">RequestCreator</span><br><span class="line"></span><br><span class="line">请求创建者</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">into</span><span class="params">(ImageView target, Callback callback)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">started</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    checkMain();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Target must not be null.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!data.hasImage()) &#123;</span><br><span class="line">    <span class="comment">//没有数据，取消请求</span></span><br><span class="line">      picasso.cancelRequest(target);</span><br><span class="line">      <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">        setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deferred) &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.hasSize()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Fit cannot be used with resize.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> target.getWidth();</span><br><span class="line">      <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> target.getHeight();</span><br><span class="line">      <span class="keyword">if</span> (width == <span class="number">0</span> || height == <span class="number">0</span> || target.isLayoutRequested()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">          setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有指定大小，按View大小</span></span><br><span class="line">        picasso.defer(target, <span class="keyword">new</span> <span class="title class_">DeferredRequestCreator</span>(<span class="built_in">this</span>, target, callback));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      data.resize(width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> createRequest(started);</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestKey</span> <span class="operator">=</span> createKey(request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123;</span><br><span class="line">    <span class="comment">//使用内存缓存</span></span><br><span class="line">      <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> picasso.quickMemoryCacheCheck(requestKey);</span><br><span class="line">      <span class="keyword">if</span> (bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">        picasso.cancelRequest(target);</span><br><span class="line">        setBitmap(target, picasso.context, bitmap, MEMORY, noFade, picasso.indicatorsEnabled);</span><br><span class="line">        <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">          log(OWNER_MAIN, VERB_COMPLETED, request.plainId(), <span class="string">&quot;from &quot;</span> + MEMORY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="literal">null</span>) &#123;</span><br><span class="line">          callback.onSuccess();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">      setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//新的资源，创建Action，进入请求队列</span></span><br><span class="line">    <span class="type">Action</span> <span class="variable">action</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ImageViewAction</span>(picasso, target, request, memoryPolicy, networkPolicy, errorResId,</span><br><span class="line">            errorDrawable, requestKey, tag, callback, noFade);</span><br><span class="line"></span><br><span class="line">    picasso.enqueueAndSubmit(action);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>判断需要的资源是否有缓存，没有，创建请求，进入队列</li>
<li>进入队列后，会由<code>Dispatcher</code>分发请求</li>
<li><code>Dispatcher</code>内有有个<code>Handler</code>用于消息分发，有个主线程<code>Handler</code>用于通知主线程刷新UI</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Dispatcher</span><br><span class="line"></span><br><span class="line">提交请求</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">performSubmit</span><span class="params">(Action action, <span class="type">boolean</span> dismissFailed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123;</span><br><span class="line">      pausedActions.put(action.getTarget(), action);</span><br><span class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</span><br><span class="line">        log(OWNER_DISPATCHER, VERB_PAUSED, action.request.logId(),</span><br><span class="line">            <span class="string">&quot;because tag &#x27;&quot;</span> + action.getTag() + <span class="string">&quot;&#x27; is paused&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">BitmapHunter</span> <span class="variable">hunter</span> <span class="operator">=</span> hunterMap.get(action.getKey());</span><br><span class="line">    <span class="keyword">if</span> (hunter != <span class="literal">null</span>) &#123;</span><br><span class="line">      hunter.attach(action);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service.isShutdown()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</span><br><span class="line">        log(OWNER_DISPATCHER, VERB_IGNORED, action.request.logId(), <span class="string">&quot;because shut down&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hunter = forRequest(action.getPicasso(), <span class="built_in">this</span>, cache, stats, action);</span><br><span class="line">    hunter.future = service.submit(hunter);</span><br><span class="line">    hunterMap.put(action.getKey(), hunter);</span><br><span class="line">    <span class="keyword">if</span> (dismissFailed) &#123;</span><br><span class="line">      failedActions.remove(action.getTarget());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</span><br><span class="line">      log(OWNER_DISPATCHER, VERB_ENQUEUED, action.request.logId());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>判断请求动作是否包含在暂停里面</li>
<li>判断是否已经存在<code>hunterMap</code></li>
<li>加入<code>hunterMap</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">BitmapHunter</span><br><span class="line">解码Bitmap</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      updateThreadName(data);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">        log(OWNER_HUNTER, VERB_EXECUTING, getLogIdsForHunter(<span class="built_in">this</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      result = hunt();<span class="comment">//获取结果</span></span><br><span class="line">		<span class="comment">//分发结果</span></span><br><span class="line">      <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        dispatcher.dispatchFailed(<span class="built_in">this</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatcher.dispatchComplete(<span class="built_in">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Downloader.ResponseException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!e.localCacheOnly || e.responseCode != <span class="number">504</span>) &#123;</span><br><span class="line">        exception = e;</span><br><span class="line">      &#125;</span><br><span class="line">      dispatcher.dispatchFailed(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NetworkRequestHandler.ContentLengthException e) &#123;</span><br><span class="line">      exception = e;</span><br><span class="line">      dispatcher.dispatchRetry(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      exception = e;</span><br><span class="line">      dispatcher.dispatchRetry(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">      <span class="type">StringWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">      stats.createSnapshot().dump(<span class="keyword">new</span> <span class="title class_">PrintWriter</span>(writer));</span><br><span class="line">      exception = <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(writer.toString(), e);</span><br><span class="line">      dispatcher.dispatchFailed(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      exception = e;</span><br><span class="line">      dispatcher.dispatchFailed(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      Thread.currentThread().setName(Utils.THREAD_IDLE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>解码图片，按需求设置转换器，分发结果</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Bitmap <span class="title function_">hunt</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123;</span><br><span class="line">      <span class="comment">//内存缓存获取</span></span><br><span class="line">      bitmap = cache.get(key);</span><br><span class="line">      <span class="keyword">if</span> (bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">        stats.dispatchCacheHit();</span><br><span class="line">        loadedFrom = MEMORY;</span><br><span class="line">        <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">          log(OWNER_HUNTER, VERB_DECODED, data.logId(), <span class="string">&quot;from cache&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//网络策略</span></span><br><span class="line">    data.networkPolicy = retryCount == <span class="number">0</span> ? NetworkPolicy.OFFLINE.index : networkPolicy;</span><br><span class="line">    RequestHandler.<span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> requestHandler.load(data, networkPolicy);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">      loadedFrom = result.getLoadedFrom();</span><br><span class="line">      exifOrientation = result.getExifOrientation();</span><br><span class="line">      bitmap = result.getBitmap();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If there was no Bitmap then we need to decode it from the stream.</span></span><br><span class="line">      <span class="keyword">if</span> (bitmap == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//从流中读取</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> result.getStream();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          bitmap = decodeStream(is, data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          Utils.closeQuietly(is);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">        log(OWNER_HUNTER, VERB_DECODED, data.logId());</span><br><span class="line">      &#125;</span><br><span class="line">      stats.dispatchBitmapDecoded(bitmap);</span><br><span class="line">      <span class="keyword">if</span> (data.needsTransformation() || exifOrientation != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//bitmap 转换</span></span><br><span class="line">        <span class="keyword">synchronized</span> (DECODE_LOCK) &#123;</span><br><span class="line">          <span class="keyword">if</span> (data.needsMatrixTransform() || exifOrientation != <span class="number">0</span>) &#123;</span><br><span class="line">            bitmap = transformResult(data, bitmap, exifOrientation);</span><br><span class="line">            <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">              log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (data.hasCustomTransformations()) &#123;</span><br><span class="line">            bitmap = applyCustomTransformations(data.transformations, bitmap);</span><br><span class="line">            <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">              log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId(), <span class="string">&quot;from custom transformations&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">//更新状态</span></span><br><span class="line">          stats.dispatchBitmapTransformed(bitmap);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bitmap;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整体流程大概是</p>
<ul>
<li><p>创建<code>RequestHandler</code>-&gt;进入队列-&gt;分发请求-&gt;分发结果-&gt;通知主线程</p>
</li>
<li><p>这里面<code>Dispatcher</code>起到请求和结果分发器的作用内部。一个线程池，两个<code>Handler</code>。线程池默认3个线程。会根据网络状况自动调整线程数量</p>
<ul>
<li><code>WIFI</code>，以太网会有四个线程池</li>
<li>移动网络: 4G，三个线程池，3G两个线程池,2G一个线程池</li>
</ul>
</li>
<li><p><code>Dispatcher</code>会批量打包结果一起通知主线程</p>
</li>
</ul>
<h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><img data-src="/./picasso_architecture.png" alt="picasso"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/10/14/How-Does-Instant-Run-Work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/10/14/How-Does-Instant-Run-Work/" class="post-title-link" itemprop="url">How Does Instant Run Work</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-10-14 15:04:05" itemprop="dateCreated datePublished" datetime="2016-10-14T15:04:05+08:00">2016-10-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2016-12-14 15:06:43" itemprop="dateModified" datetime="2016-12-14T15:06:43+08:00">2016-12-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://medium.com/google-developers/instant-run-how-does-it-work-294a1633367f#.89kk542oe">原文</a></p>
<p><code>Instant Run</code>，<code>Android Studio</code>的一项神奇的功能，用于减少增量代码的构建和部署时间。它看起来很神奇。你首次运行或者调试，你就如你预期般的那样工作，之后每次代码的改动，会花很少的时间去构建和部署</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>构建图</p>
<p><img data-src="/./instant_run_build.png" alt="instant build"> </p>
<p><code>Instant Run</code>的目标很简单</p>
<blockquote>
<p><em><strong>移除尽可能多的步骤，使剩下的东西尽可能快</strong></em></p>
</blockquote>
<p>具体是:</p>
<ul>
<li>只构建和部署新增的东西</li>
<li>不重新安装应用</li>
<li>不重新启动应用</li>
<li>不重新启动<code>Activity</code></li>
</ul>
<h4 id="热部署，温部署，冷部署"><a href="#热部署，温部署，冷部署" class="headerlink" title="热部署，温部署，冷部署"></a>热部署，温部署，冷部署</h4><p><img data-src="/./hot_warm_cold.png" alt="hot_warm_cold"></p>
<p><strong>热部署</strong>: 部署新的改变，不需要重新应用，甚至不需要重启当前<code>Activity</code>。能用于方法内简单的改变</p>
<p><strong>温部署</strong>: <code>Activity</code>需要重启后，新的改变才能生效。通常用于资源改变</p>
<p><strong>冷部署</strong>: 应用重启，但不重新安装。任何结构型变化，如继承关系或者方法签名会使用冷部署</p>
<h4 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h4><p><img data-src="/./merged_combined.png" alt="merged_combined"></p>
<p><code>manifest</code>文件被合并，打包。伴随着资源一起打包进<code>APK</code>。<code>java</code>源代码被编译成<code>字节码</code>，转换成<code>.dex</code>文件。它们也会打包进入<code>APK</code></p>
<p><strong>首次点击运行或调试(<code>Instant Run</code>打开), <code>Gradle</code>做的额外操作</strong></p>
<p><img data-src="/./first_run_instant_run.png" alt="first_run_instant_run"> </p>
<p>字节码被添加到<code>.class</code>文件中，一个新的<code>App Server</code>类被注入到<code>app</code>中</p>
<p>一个新的<code>Application</code>类定义也被加入到<code>App</code>，注入自定义类加载器以及将启动<code>App Server</code>。一般来说，<code>manifest</code>会被修改以便<code>app</code>能使用(如果你创建了自己的<code>Application</code>类，<code>Instant Run</code>版本会代理这个<code>Application</code>类)</p>
<p>这时<code>Instant Run</code>运行了。因此如果你改变了代码，<code>Instant Run</code>会尝试避免使用热，温，冷部署来避免全构建</p>
<blockquote>
<p>应用<code>Instant Run</code>改变之前，<code>as</code>会检查<code>Instant Run</code>内是否有一个打开的<code>Socket</code>连接着<code>App Server</code></p>
</blockquote>
<h4 id="热部署"><a href="#热部署" class="headerlink" title="热部署"></a>热部署</h4><p><img data-src="/./hot_swapping.png" alt="hot_swapping"></p>
<p><code>as</code>监控开发过程中哪些字段被修改了。运行自定义<code>Gradle</code>任务来未修改的类生成<code>.dex</code>文件</p>
<p>这些新<code>.dex</code>文件被<code>as</code>挑选，并部署到<code>app</code>中的<code>App Server</code></p>
<p>由于类的原始版本已经存在了，<code>Gradle</code>转换更新版本以便高效覆盖这些之前存在的类。转换结束，更新的类被<code>App Server</code>使用自定义的类加载器加载。</p>
<p>从现在起，每次方法被调用，这个注入到原始类文件中的监控类都会检查是否已经更新。如果更新了，那么后续操作会代理到新的覆盖类中。</p>
<h4 id="温部署"><a href="#温部署" class="headerlink" title="温部署"></a>温部署</h4><p>温部署重启<code>Activity</code>。当<code>Activity</code>启动，资源被加载。因此更新资源需要重启<code>Acitivty</code>以便强制资源重新加载</p>
<p>当前，任何资源的改变会导致，所有的资源被重新打包到<code>app</code>，但使用增量打包器会只打包和部署更改的资源</p>
<blockquote>
<p>注意温部署对于<code>manifest</code>的改变是无效的，因为<code>manifest</code>信息的读取实在<code>apk</code>安装的时候。<code>manifest</code>的改变会触发全量构建和部署</p>
</blockquote>
<h4 id="冷部署"><a href="#冷部署" class="headerlink" title="冷部署"></a>冷部署</h4><p>部署后，<code>app</code>和其子项目被分成10个片段，每个片段有自己的<code>dex</code>文件。类安装它们的包名分割。使用冷部署，修改类会要求所有其他在相同片段中的类重新加载。</p>
<p>这个策略依赖于运行时加载多个<code>dex</code>文件的能力。<code>5.0</code>以上采用<code>ART</code>具备这种能力。之下会采用全量构建部署</p>
<h4 id="Instant-Run技巧和提示"><a href="#Instant-Run技巧和提示" class="headerlink" title="Instant Run技巧和提示"></a><code>Instant Run</code>技巧和提示</h4><ul>
<li><code>manifest</code>的修改会导致全量构建部署</li>
<li><code>Instant Run</code>值监控主进程，如果<code>app</code>使用多进程。热部署和温部署在其他进程中会降到冷部署，如果低于5.0，会采用全量构建部署</li>
<li><code>Windows</code>防火墙可能会导致<code>Instant Run</code>无法启动</li>
<li><code>Instant Run</code>不支持<code>Jack</code>编译器</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/10/03/Retrofit%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/10/03/Retrofit%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Retrofit分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-10-03 16:39:08" itemprop="dateCreated datePublished" datetime="2016-10-03T16:39:08+08:00">2016-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2016-11-11 11:56:01" itemprop="dateModified" datetime="2016-11-11T11:56:01+08:00">2016-11-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Retrofit分析"><a href="#Retrofit分析" class="headerlink" title="Retrofit分析"></a><code>Retrofit</code>分析</h3><p><code>Retrofit</code>可以当做是<code>OkHttp3</code>的应用层。其接收<code>Java</code>注解的请求。</p>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder().baseUrl(url).addConvertFactory(factory).build();</span><br><span class="line">retrofit.create(class);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> &#123;</span><br><span class="line">    Utils.validateServiceInterface(service);</span><br><span class="line">    <span class="keyword">if</span> (validateEagerly) &#123;</span><br><span class="line">      eagerlyValidateMethods(service);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123; service &#125;,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">          <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Platform</span> <span class="variable">platform</span> <span class="operator">=</span> Platform.get();</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object... args)</span></span><br><span class="line">              <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></span><br><span class="line">            <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">              <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</span><br><span class="line">              <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</span><br><span class="line">            &#125;</span><br><span class="line">            ServiceMethod&lt;Object, Object&gt; serviceMethod =</span><br><span class="line">                (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</span><br><span class="line">            OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> <span class="title class_">OkHttpCall</span>&lt;&gt;(serviceMethod, args);</span><br><span class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>create</code>方法接收客户端定义的<code>api</code>接口   </p>
<p>主要工作：  </p>
<ol>
<li>使用代理模式创建出接口对应的类</li>
<li>加载接口里面的方法，并缓存</li>
<li>如果方法不存在，创建<code>ServiceMethod</code>，并缓存</li>
<li>使用<code>API</code>接口的方法创建<code>OkHttpCall</code></li>
<li>将<code>okHttpCall</code>与<code>callAdapter</code>关联</li>
</ol>
<h5 id="ServiceMethod"><a href="#ServiceMethod" class="headerlink" title="ServiceMethod"></a>ServiceMethod</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ServiceMethod <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">      callAdapter = createCallAdapter();</span><br><span class="line">      responseType = callAdapter.responseType();</span><br><span class="line">      <span class="keyword">if</span> (responseType == Response.class || responseType == okhttp3.Response.class) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">            + Utils.getRawType(responseType).getName()</span><br><span class="line">            + <span class="string">&quot;&#x27; is not a valid response body type. Did you mean ResponseBody?&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      responseConverter = createResponseConverter();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</span><br><span class="line">        parseMethodAnnotation(annotation);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (httpMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">&quot;HTTP method annotation is required (e.g., @GET, @POST, etc.).&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!hasBody) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMultipart) &#123;</span><br><span class="line">          <span class="keyword">throw</span> methodError(</span><br><span class="line">              <span class="string">&quot;Multipart can only be specified on HTTP methods with request body (e.g., @POST).&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isFormEncoded) &#123;</span><br><span class="line">          <span class="keyword">throw</span> methodError(<span class="string">&quot;FormUrlEncoded can only be specified on HTTP methods with &quot;</span></span><br><span class="line">              + <span class="string">&quot;request body (e.g., @POST).&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">int</span> <span class="variable">parameterCount</span> <span class="operator">=</span> parameterAnnotationsArray.length;</span><br><span class="line">      parameterHandlers = <span class="keyword">new</span> <span class="title class_">ParameterHandler</span>&lt;?&gt;[parameterCount];</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</span><br><span class="line">        <span class="type">Type</span> <span class="variable">parameterType</span> <span class="operator">=</span> parameterTypes[p];</span><br><span class="line">        <span class="keyword">if</span> (Utils.hasUnresolvableType(parameterType)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">&quot;Parameter type must not include a type variable or wildcard: %s&quot;</span>,</span><br><span class="line">              parameterType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</span><br><span class="line">        <span class="keyword">if</span> (parameterAnnotations == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">&quot;No Retrofit annotation found.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (relativeUrl == <span class="literal">null</span> &amp;&amp; !gotUrl) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">&quot;Missing either @%s URL or @Url parameter.&quot;</span>, httpMethod);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">&quot;Non-body HTTP method cannot contain @Body.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isFormEncoded &amp;&amp; !gotField) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">&quot;Form-encoded method must contain at least one @Field.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isMultipart &amp;&amp; !gotPart) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">&quot;Multipart method must contain at least one @Part.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceMethod</span>&lt;&gt;(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>主要工作:</p>
<ol>
<li>创建请求适配器</li>
<li>创建响应适配器</li>
<li>解析方法注解</li>
<li>解析参数注解</li>
</ol>
<h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img data-src="/./retrofit.png" alt="Retrofit"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/09/25/Load-SO-from-sdcard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/09/25/Load-SO-from-sdcard/" class="post-title-link" itemprop="url">Load .SO from sdcard</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-09-25 14:17:46" itemprop="dateCreated datePublished" datetime="2016-09-25T14:17:46+08:00">2016-09-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Runtime.java</span><br><span class="line"></span><br><span class="line">nativeLoad</span><br></pre></td></tr></table></figure>
<p>C代码:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java_lang_Runtime.cc</span><br><span class="line"></span><br><span class="line">static jstring Runtime_nativeLoad(JNIEnv* env, jclass, jstring javaFilename, jobject javaLoader,</span><br><span class="line">                                  jstring javaLdLibraryPathJstr) &#123;</span><br><span class="line">  ScopedUtfChars filename(env, javaFilename);</span><br><span class="line">  if (filename.c_str() == nullptr) &#123;</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SetLdLibraryPath(env, javaLdLibraryPathJstr);</span><br><span class="line"></span><br><span class="line">  std::string error_msg;</span><br><span class="line">  &#123;</span><br><span class="line">    JavaVMExt* vm = Runtime::Current()-&gt;GetJavaVM();</span><br><span class="line">    bool success = vm-&gt;LoadNativeLibrary(env, filename.c_str(), javaLoader, &amp;error_msg);</span><br><span class="line">    if (success) &#123;</span><br><span class="line">      return nullptr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Don&#x27;t let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.</span><br><span class="line">  env-&gt;ExceptionClear();</span><br><span class="line">  return env-&gt;NewStringUTF(error_msg.c_str());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码可以看出关键代码在于<code>LoadNativeLibrary </code>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">java_vm_ext.cc</span><br><span class="line"></span><br><span class="line">bool JavaVMExt::LoadNativeLibrary(JNIEnv* env, const std::string&amp; path, jobject class_loader,</span><br><span class="line">                                  std::string* error_msg) &#123;</span><br><span class="line">  error_msg-&gt;clear();</span><br><span class="line"></span><br><span class="line">  // See if we&#x27;ve already loaded this library.  If we have, and the class loader</span><br><span class="line">  // matches, return successfully without doing anything.</span><br><span class="line">  // TODO: for better results we should canonicalize the pathname (or even compare</span><br><span class="line">  // inodes). This implementation is fine if everybody is using System.loadLibrary.</span><br><span class="line">  SharedLibrary* library;</span><br><span class="line">  Thread* self = Thread::Current();</span><br><span class="line">  &#123;</span><br><span class="line">    // TODO: move the locking (and more of this logic) into Libraries.</span><br><span class="line">    MutexLock mu(self, *Locks::jni_libraries_lock_);</span><br><span class="line">    library = libraries_-&gt;Get(path);</span><br><span class="line">  &#125;</span><br><span class="line">  if (library != nullptr) &#123;</span><br><span class="line">    if (env-&gt;IsSameObject(library-&gt;GetClassLoader(), class_loader) == JNI_FALSE) &#123;</span><br><span class="line">      // The library will be associated with class_loader. The JNI</span><br><span class="line">      // spec says we can&#x27;t load the same library into more than one</span><br><span class="line">      // class loader.</span><br><span class="line">      StringAppendF(error_msg, &quot;Shared library \&quot;%s\&quot; already opened by &quot;</span><br><span class="line">          &quot;ClassLoader %p; can&#x27;t open in ClassLoader %p&quot;,</span><br><span class="line">          path.c_str(), library-&gt;GetClassLoader(), class_loader);</span><br><span class="line">      LOG(WARNING) &lt;&lt; error_msg;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[Shared library \&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot; already loaded in &quot;</span><br><span class="line">              &lt;&lt; &quot; ClassLoader &quot; &lt;&lt; class_loader &lt;&lt; &quot;]&quot;;</span><br><span class="line">    if (!library-&gt;CheckOnLoadResult()) &#123;</span><br><span class="line">      StringAppendF(error_msg, &quot;JNI_OnLoad failed on a previous attempt &quot;</span><br><span class="line">          &quot;to load \&quot;%s\&quot;&quot;, path.c_str());</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Open the shared library.  Because we&#x27;re using a full path, the system</span><br><span class="line">  // doesn&#x27;t have to search through LD_LIBRARY_PATH.  (It may do so to</span><br><span class="line">  // resolve this library&#x27;s dependencies though.)</span><br><span class="line"></span><br><span class="line">  // Failures here are expected when java.library.path has several entries</span><br><span class="line">  // and we have to hunt for the lib.</span><br><span class="line"></span><br><span class="line">  // Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span><br><span class="line">  // class unloading. Libraries will only be unloaded when the reference count (incremented by</span><br><span class="line">  // dlopen) becomes zero from dlclose.</span><br><span class="line"></span><br><span class="line">  Locks::mutator_lock_-&gt;AssertNotHeld(self);</span><br><span class="line">  const char* path_str = path.empty() ? nullptr : path.c_str();</span><br><span class="line">  void* handle = dlopen(path_str, RTLD_NOW);</span><br><span class="line">  bool needs_native_bridge = false;</span><br><span class="line">  if (handle == nullptr) &#123;</span><br><span class="line">    if (android::NativeBridgeIsSupported(path_str)) &#123;</span><br><span class="line">      handle = android::NativeBridgeLoadLibrary(path_str, RTLD_NOW);</span><br><span class="line">      needs_native_bridge = true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  VLOG(jni) &lt;&lt; &quot;[Call to dlopen(\&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot;, RTLD_NOW) returned &quot; &lt;&lt; handle &lt;&lt; &quot;]&quot;;</span><br><span class="line"></span><br><span class="line">  if (handle == nullptr) &#123;</span><br><span class="line">    *error_msg = dlerror();</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;dlopen(\&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot;, RTLD_NOW) failed: &quot; &lt;&lt; *error_msg;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (env-&gt;ExceptionCheck() == JNI_TRUE) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;Unexpected exception:&quot;;</span><br><span class="line">    env-&gt;ExceptionDescribe();</span><br><span class="line">    env-&gt;ExceptionClear();</span><br><span class="line">  &#125;</span><br><span class="line">  // Create a new entry.</span><br><span class="line">  // TODO: move the locking (and more of this logic) into Libraries.</span><br><span class="line">  bool created_library = false;</span><br><span class="line">  &#123;</span><br><span class="line">    // Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span><br><span class="line">    std::unique_ptr&lt;SharedLibrary&gt; new_library(</span><br><span class="line">        new SharedLibrary(env, self, path, handle, class_loader));</span><br><span class="line">    MutexLock mu(self, *Locks::jni_libraries_lock_);</span><br><span class="line">    library = libraries_-&gt;Get(path);</span><br><span class="line">    if (library == nullptr) &#123;  // We won race to get libraries_lock.</span><br><span class="line">      library = new_library.release();</span><br><span class="line">      libraries_-&gt;Put(path, library);</span><br><span class="line">      created_library = true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if (!created_library) &#123;</span><br><span class="line">    LOG(INFO) &lt;&lt; &quot;WOW: we lost a race to add shared library: &quot;</span><br><span class="line">        &lt;&lt; &quot;\&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot; ClassLoader=&quot; &lt;&lt; class_loader;</span><br><span class="line">    return library-&gt;CheckOnLoadResult();</span><br><span class="line">  &#125;</span><br><span class="line">  VLOG(jni) &lt;&lt; &quot;[Added shared library \&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot; for ClassLoader &quot; &lt;&lt; class_loader &lt;&lt; &quot;]&quot;;</span><br><span class="line"></span><br><span class="line">  bool was_successful = false;</span><br><span class="line">  void* sym;</span><br><span class="line">  if (needs_native_bridge) &#123;</span><br><span class="line">    library-&gt;SetNeedsNativeBridge();</span><br><span class="line">    sym = library-&gt;FindSymbolWithNativeBridge(&quot;JNI_OnLoad&quot;, nullptr);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    sym = dlsym(handle, &quot;JNI_OnLoad&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  if (sym == nullptr) &#123;</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[No JNI_OnLoad found in \&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot;]&quot;;</span><br><span class="line">    was_successful = true;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // Call JNI_OnLoad.  We have to override the current class</span><br><span class="line">    // loader, which will always be &quot;null&quot; since the stuff at the</span><br><span class="line">    // top of the stack is around Runtime.loadLibrary().  (See</span><br><span class="line">    // the comments in the JNI FindClass function.)</span><br><span class="line">    ScopedLocalRef&lt;jobject&gt; old_class_loader(env, env-&gt;NewLocalRef(self-&gt;GetClassLoaderOverride()));</span><br><span class="line">    self-&gt;SetClassLoaderOverride(class_loader);</span><br><span class="line"></span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[Calling JNI_OnLoad in \&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot;]&quot;;</span><br><span class="line">    typedef int (*JNI_OnLoadFn)(JavaVM*, void*);</span><br><span class="line">    JNI_OnLoadFn jni_on_load = reinterpret_cast&lt;JNI_OnLoadFn&gt;(sym);</span><br><span class="line">    int version = (*jni_on_load)(this, nullptr);</span><br><span class="line"></span><br><span class="line">    if (runtime_-&gt;GetTargetSdkVersion() != 0 &amp;&amp; runtime_-&gt;GetTargetSdkVersion() &lt;= 21) &#123;</span><br><span class="line">      fault_manager.EnsureArtActionInFrontOfSignalChain();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self-&gt;SetClassLoaderOverride(old_class_loader.get());</span><br><span class="line"></span><br><span class="line">    if (version == JNI_ERR) &#123;</span><br><span class="line">      StringAppendF(error_msg, &quot;JNI_ERR returned from JNI_OnLoad in \&quot;%s\&quot;&quot;, path.c_str());</span><br><span class="line">    &#125; else if (IsBadJniVersion(version)) &#123;</span><br><span class="line">      StringAppendF(error_msg, &quot;Bad JNI version returned from JNI_OnLoad in \&quot;%s\&quot;: %d&quot;,</span><br><span class="line">                    path.c_str(), version);</span><br><span class="line">      // It&#x27;s unwise to call dlclose() here, but we can mark it</span><br><span class="line">      // as bad and ensure that future load attempts will fail.</span><br><span class="line">      // We don&#x27;t know how far JNI_OnLoad got, so there could</span><br><span class="line">      // be some partially-initialized stuff accessible through</span><br><span class="line">      // newly-registered native method calls.  We could try to</span><br><span class="line">      // unregister them, but that doesn&#x27;t seem worthwhile.</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      was_successful = true;</span><br><span class="line">    &#125;</span><br><span class="line">    VLOG(jni) &lt;&lt; &quot;[Returned &quot; &lt;&lt; (was_successful ? &quot;successfully&quot; : &quot;failure&quot;)</span><br><span class="line">              &lt;&lt; &quot; from JNI_OnLoad in \&quot;&quot; &lt;&lt; path &lt;&lt; &quot;\&quot;]&quot;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  library-&gt;SetResult(was_successful);</span><br><span class="line">  return was_successful;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/09/16/WindowManager%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/09/16/WindowManager%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">WindowManager分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-09-16 16:45:09" itemprop="dateCreated datePublished" datetime="2016-09-16T16:45:09+08:00">2016-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2016-09-17 14:03:38" itemprop="dateModified" datetime="2016-09-17T14:03:38+08:00">2016-09-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="导言"><a href="#导言" class="headerlink" title="导言"></a>导言</h3><p><code>WindowManager</code>是整个绘制系统的核心桥梁。一般通过<code>getSystemService(Context.WindowService)</code>可以获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">registerService(Context.WINDOW_SERVICE, WindowManager.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CachedServiceFetcher</span>&lt;WindowManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> WindowManager <span class="title function_">createService</span><span class="params">(ContextImpl ctx)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WindowManagerImpl</span>(ctx.getDisplay());</span><br><span class="line">            &#125;&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="WindowManagerImpl"><a href="#WindowManagerImpl" class="headerlink" title="WindowManagerImpl"></a>WindowManagerImpl</h4><p>通过代码可以发现<code>WindowManagerImpl</code>的核心实现都在<code>WindowManagerGlobal</code></p>
<h4 id="WindowManagerGlobal"><a href="#WindowManagerGlobal" class="headerlink" title="WindowManagerGlobal"></a>WindowManagerGlobal</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span><br><span class="line"><span class="params">            Display display, Window parentWindow)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (view == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;view must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (display == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;display must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(params <span class="keyword">instanceof</span> WindowManager.LayoutParams)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Params must be WindowManager.LayoutParams&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowManager.<span class="type">LayoutParams</span> <span class="variable">wparams</span> <span class="operator">=</span> (WindowManager.LayoutParams) params;</span><br><span class="line">        <span class="keyword">if</span> (parentWindow != <span class="literal">null</span>) &#123;</span><br><span class="line">            parentWindow.adjustLayoutParamsForSubWindow(wparams);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If there&#x27;s no parent, then hardware acceleration for this view is</span></span><br><span class="line">            <span class="comment">// set from the application&#x27;s hardware acceleration setting.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> view.getContext();</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; (context.getApplicationInfo().flags</span><br><span class="line">                            &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>) &#123;</span><br><span class="line">                wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ViewRootImpl root;</span><br><span class="line">        <span class="type">View</span> <span class="variable">panelParentView</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// Start watching for system property changes.</span></span><br><span class="line">            <span class="keyword">if</span> (mSystemPropertyUpdater == <span class="literal">null</span>) &#123;</span><br><span class="line">                mSystemPropertyUpdater = <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> mRoots.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                                mRoots.get(i).loadSystemProperties();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                SystemProperties.addChangeCallback(mSystemPropertyUpdater);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> findViewLocked(view, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mDyingViews.contains(view)) &#123;</span><br><span class="line">                    <span class="comment">// Don&#x27;t wait for MSG_DIE to make it&#x27;s way through root&#x27;s queue.</span></span><br><span class="line">                    mRoots.get(index).doDie();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;View &quot;</span> + view</span><br><span class="line">                            + <span class="string">&quot; has already been added to the window manager.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// The previous removeView() had not completed executing. Now it has.</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is a panel window, then find the window it is being</span></span><br><span class="line">            <span class="comment">// attached to for future reference.</span></span><br><span class="line">            <span class="keyword">if</span> (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</span><br><span class="line">                    wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> mViews.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</span><br><span class="line">                        panelParentView = mViews.get(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            root = <span class="keyword">new</span> <span class="title class_">ViewRootImpl</span>(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">            view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">            mViews.add(view);</span><br><span class="line">            mRoots.add(root);</span><br><span class="line">            mParams.add(wparams);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do this last because it fires off messages to start doing things</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            root.setView(view, wparams, panelParentView);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            <span class="comment">// BadTokenException or InvalidDisplayException, clean up.</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> findViewLocked(view, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    removeViewLocked(index, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以发现<code>addView</code>里面主要用到<code>ViewRootImpl</code>来添加视图</p>
<h4 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ViewRootImpl</span><span class="params">(Context context, Display display)</span> &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mWindowSession = WindowManagerGlobal.getWindowSession();</span><br><span class="line">        mDisplay = display;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title function_">getWindowSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sWindowSession == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">InputMethodManager</span> <span class="variable">imm</span> <span class="operator">=</span> InputMethodManager.getInstance();</span><br><span class="line">                    <span class="type">IWindowManager</span> <span class="variable">windowManager</span> <span class="operator">=</span> getWindowManagerService();</span><br><span class="line">                    sWindowSession = windowManager.openSession(</span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">IWindowSessionCallback</span>.Stub() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimatorScaleChanged</span><span class="params">(<span class="type">float</span> scale)</span> &#123;</span><br><span class="line">                                    ValueAnimator.setDurationScale(scale);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            imm.getClient(), imm.getInputContext());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;Failed to open window session&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sWindowSession;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IWindowManager <span class="title function_">getWindowManagerService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sWindowManagerService == <span class="literal">null</span>) &#123;</span><br><span class="line">                sWindowManagerService = IWindowManager.Stub.asInterface(</span><br><span class="line">                        ServiceManager.getService(<span class="string">&quot;window&quot;</span>));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sWindowManagerService = getWindowManagerService();</span><br><span class="line">                    ValueAnimator.setDurationScale(sWindowManagerService.getCurrentAnimatorScale());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;Failed to get WindowManagerService, cannot set animator scale&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sWindowManagerService;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>AIDL</code>获取<code>WindowManagerService</code>这时<code>Framework</code>与<code>Native</code>建立起连接了。之后<code>ViewRootImpl</code>会调用<code>setView</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestLayout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">            checkThread();</span><br><span class="line">            mLayoutRequested = <span class="literal">true</span>;</span><br><span class="line">            scheduleTraversals();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>要求系统开始布局</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">scheduleTraversals</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">            mTraversalScheduled = <span class="literal">true</span>;</span><br><span class="line">            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">            mChoreographer.postCallback(</span><br><span class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">                scheduleConsumeBatchedInput();</span><br><span class="line">            &#125;</span><br><span class="line">            notifyRendererOfFramePending();</span><br><span class="line">            pokeDrawLockIfNeeded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>Choreographer</code>发送绘制命令<code>CALLBACK_TRAVERSAL</code>要求系统开始绘制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doTraversal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">            mTraversalScheduled = <span class="literal">false</span>;</span><br><span class="line">            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">                Debug.startMethodTracing(<span class="string">&quot;ViewAncestor&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//绘制所有View节点	</span></span><br><span class="line">            performTraversals();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">                Debug.stopMethodTracing();</span><br><span class="line">                mProfile = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>

<h4 id="performMeasure"><a href="#performMeasure" class="headerlink" title="performMeasure"></a>performMeasure</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mWidth != frame.width() || mHeight != frame.height()) &#123;</span><br><span class="line">    mWidth = frame.width();</span><br><span class="line">    mHeight = frame.height();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">childWidthMeasureSpec</span> <span class="operator">=</span> getRootMeasureSpec(mWidth, lp.width);</span><br><span class="line"><span class="type">int</span> <span class="variable">childHeightMeasureSpec</span> <span class="operator">=</span> getRootMeasureSpec(mHeight, lp.height);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">                    </span><br><span class="line">                    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getRootMeasureSpec</span><span class="params">(<span class="type">int</span> windowSize, <span class="type">int</span> rootDimension)</span> &#123;</span><br><span class="line">        <span class="type">int</span> measureSpec;</span><br><span class="line">        <span class="keyword">switch</span> (rootDimension) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:</span><br><span class="line">            <span class="comment">// Window can&#x27;t resize. Force root view to be windowSize.</span></span><br><span class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ViewGroup.LayoutParams.WRAP_CONTENT:</span><br><span class="line">            <span class="comment">// Window can resize. Set max size for root view.</span></span><br><span class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Window wants to be an exact size. Force root view to be that size.</span></span><br><span class="line">            measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> measureSpec;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>performMeasure</code>会调用<code>view.measure()</code>里面会去调用<code>onMeasure</code>，这里会去真正的做测量操作</p>
<h4 id="performLayout"><a href="#performLayout" class="headerlink" title="performLayout"></a>performLayout</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">            mInLayout = <span class="literal">false</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">numViewsRequestingLayout</span> <span class="operator">=</span> mLayoutRequesters.size();</span><br><span class="line">            <span class="keyword">if</span> (numViewsRequestingLayout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// requestLayout() was called during layout.</span></span><br><span class="line">                <span class="comment">// If no layout-request flags are set on the requesting views, there is no problem.</span></span><br><span class="line">                <span class="comment">// If some requests are still pending, then we need to clear those flags and do</span></span><br><span class="line">                <span class="comment">// a full request/measure/layout pass to handle this situation.</span></span><br><span class="line">                ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</span><br><span class="line">                        <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (validLayoutRequesters != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Set this flag to indicate that any further requests are happening during</span></span><br><span class="line">                    <span class="comment">// the second pass, which may result in posting those requests to the next</span></span><br><span class="line">                    <span class="comment">// frame instead</span></span><br><span class="line">                    mHandlingLayoutInLayoutRequest = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Process fresh layout requests, then measure and layout</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">numValidRequests</span> <span class="operator">=</span> validLayoutRequesters.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> validLayoutRequesters.get(i);</span><br><span class="line">                        Log.w(<span class="string">&quot;View&quot;</span>, <span class="string">&quot;requestLayout() improperly called by &quot;</span> + view +</span><br><span class="line">                                <span class="string">&quot; during layout: running second layout pass&quot;</span>);</span><br><span class="line">                        view.requestLayout();</span><br><span class="line">                    &#125;</span><br><span class="line">                    measureHierarchy(host, lp, mView.getContext().getResources(),</span><br><span class="line">                            desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">                    mInLayout = <span class="literal">true</span>;</span><br><span class="line">                    host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">                    mHandlingLayoutInLayoutRequest = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Check the valid requests again, this time without checking/clearing the</span></span><br><span class="line">                    <span class="comment">// layout flags, since requests happening during the second pass get noop&#x27;d</span></span><br><span class="line">                    validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (validLayoutRequesters != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</span><br><span class="line">                        <span class="comment">// Post second-pass requests to the next frame</span></span><br><span class="line">                        getRunQueue().post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                                <span class="type">int</span> <span class="variable">numValidRequests</span> <span class="operator">=</span> finalRequesters.size();</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numValidRequests; ++i) &#123;</span><br><span class="line">                                    <span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> finalRequesters.get(i);</span><br><span class="line">                                    Log.w(<span class="string">&quot;View&quot;</span>, <span class="string">&quot;requestLayout() improperly called by &quot;</span> + view +</span><br><span class="line">                                            <span class="string">&quot; during second layout pass: posting in next frame&quot;</span>);</span><br><span class="line">                                    view.requestLayout();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">        mInLayout = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>先进行布局，检查需要布局的数目，检查这些布局请求是否合理,不合理重新布局。</p>
<h4 id="performDraw"><a href="#performDraw" class="headerlink" title="performDraw"></a>performDraw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">cancelDraw</span> <span class="operator">=</span> mAttachInfo.mTreeObserver.dispatchOnPreDraw() ||</span><br><span class="line">                viewVisibility != View.VISIBLE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!skipDraw || mReportNextDraw) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mPendingTransitions != <span class="literal">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                        mPendingTransitions.get(i).startChangingAnimations();</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPendingTransitions.clear();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                performDraw();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (viewVisibility == View.VISIBLE) &#123;</span><br><span class="line">                <span class="comment">// Try again</span></span><br><span class="line">                scheduleTraversals();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="literal">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                    mPendingTransitions.get(i).endChangingAnimations();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingTransitions.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>判断此次绘制是否取消或者是新的页面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performDraw</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">fullRedrawNeeded</span> <span class="operator">=</span> mFullRedrawNeeded;</span><br><span class="line">        mFullRedrawNeeded = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        mIsDrawing = <span class="literal">true</span>;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">&quot;draw&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            draw(fullRedrawNeeded);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mIsDrawing = <span class="literal">false</span>;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For whatever reason we didn&#x27;t create a HardwareRenderer, end any</span></span><br><span class="line">        <span class="comment">// hardware animations that are now dangling</span></span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mPendingAnimatingRenderNodes != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> mAttachInfo.mPendingAnimatingRenderNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</span><br><span class="line">            &#125;</span><br><span class="line">            mAttachInfo.mPendingAnimatingRenderNodes.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mReportNextDraw) &#123;</span><br><span class="line">            mReportNextDraw = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mHardwareRenderer != <span class="literal">null</span>) &#123;</span><br><span class="line">                mAttachInfo.mHardwareRenderer.fence();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (LOCAL_LOGV) &#123;</span><br><span class="line">                Log.v(TAG, <span class="string">&quot;FINISHED DRAWING: &quot;</span> + mWindowAttributes.getTitle());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mSurfaceHolder != <span class="literal">null</span> &amp;&amp; mSurface.isValid()) &#123;</span><br><span class="line">                mSurfaceHolderCallback.surfaceRedrawNeeded(mSurfaceHolder);</span><br><span class="line">                SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</span><br><span class="line">                <span class="keyword">if</span> (callbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (SurfaceHolder.Callback c : callbacks) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (c <span class="keyword">instanceof</span> SurfaceHolder.Callback2) &#123;</span><br><span class="line">                            ((SurfaceHolder.Callback2)c).surfaceRedrawNeeded(</span><br><span class="line">                                    mSurfaceHolder);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mWindowSession.finishDrawing(mWindow);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">调用draw()方法</span><br><span class="line">如果开启了硬件加速，使用ThreadedRender.draw绘制，否则采用传统canvas绘制</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>cavas绘制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ANDROID_API</span> <span class="title">Canvas</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">底层采用<span class="title">Skia</span>引擎来绘制</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">DrawFrameTask</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">DrawFrameTask</span>:</span>:run() &#123;</span><br><span class="line">    ATRACE_NAME(<span class="string">&quot;DrawFrame&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> canUnblockUiThread;</span><br><span class="line">    <span class="type">bool</span> canDrawThisFrame;</span><br><span class="line">    &#123;</span><br><span class="line">        TreeInfo <span class="title function_">info</span><span class="params">(TreeInfo::MODE_FULL, mRenderThread-&gt;renderState())</span>;</span><br><span class="line">        canUnblockUiThread = syncFrameState(info);</span><br><span class="line">        canDrawThisFrame = info.out.canDrawThisFrame;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grab a copy of everything we need</span></span><br><span class="line">    CanvasContext* context = mContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// From this point on anything in &quot;this&quot; is *UNSAFE TO ACCESS*</span></span><br><span class="line">    <span class="keyword">if</span> (canUnblockUiThread) &#123;</span><br><span class="line">        unblockUiThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CC_LIKELY(canDrawThisFrame)) &#123;</span><br><span class="line">        context-&gt;draw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!canUnblockUiThread) &#123;</span><br><span class="line">        unblockUiThread();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CanvasContext</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">CanvasContext::draw</span><span class="params">()</span> &#123;</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(!mCanvas || mEglSurface == EGL_NO_SURFACE,</span><br><span class="line">            <span class="string">&quot;drawRenderNode called on a context with no canvas or surface!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    SkRect dirty;</span><br><span class="line">    mDamageAccumulator.finish(&amp;dirty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Re-enable after figuring out cause of b/22592975</span></span><br><span class="line"><span class="comment">//    if (dirty.isEmpty() &amp;&amp; Properties::skipEmptyFrames) &#123;</span></span><br><span class="line"><span class="comment">//        mCurrentFrameInfo-&gt;addFlag(FrameInfoFlags::SkippedFrame);</span></span><br><span class="line"><span class="comment">//        return;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    mCurrentFrameInfo-&gt;markIssueDrawCommandsStart();</span><br><span class="line"></span><br><span class="line">    EGLint width, height;</span><br><span class="line">    mEglManager.beginFrame(mEglSurface, &amp;width, &amp;height);</span><br><span class="line">    <span class="keyword">if</span> (width != mCanvas-&gt;getViewportWidth() || height != mCanvas-&gt;getViewportHeight()) &#123;</span><br><span class="line">        mCanvas-&gt;setViewport(width, height);</span><br><span class="line">        dirty.setEmpty();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mBufferPreserved || mHaveNewSurface) &#123;</span><br><span class="line">        dirty.setEmpty();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!dirty.isEmpty() &amp;&amp; !dirty.intersect(<span class="number">0</span>, <span class="number">0</span>, width, height)) &#123;</span><br><span class="line">            ALOGW(<span class="string">&quot;Dirty &quot;</span> RECT_STRING <span class="string">&quot; doesn&#x27;t intersect with 0 0 %d %d ?&quot;</span>,</span><br><span class="line">                    SK_RECT_ARGS(dirty), width, height);</span><br><span class="line">            dirty.setEmpty();</span><br><span class="line">        &#125;</span><br><span class="line">        profiler().unionDirty(&amp;dirty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dirty.isEmpty()) &#123;</span><br><span class="line">        mCanvas-&gt;prepareDirty(dirty.fLeft, dirty.fTop,</span><br><span class="line">                dirty.fRight, dirty.fBottom, mOpaque);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mCanvas-&gt;prepare(mOpaque);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Rect outBounds;</span><br><span class="line">    mCanvas-&gt;drawRenderNode(mRootRenderNode.get(), outBounds);</span><br><span class="line"></span><br><span class="line">    profiler().draw(mCanvas);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> drew = mCanvas-&gt;finish();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Even if we decided to cancel the frame, from the perspective of jank</span></span><br><span class="line">    <span class="comment">// metrics the frame was swapped at this point</span></span><br><span class="line">    mCurrentFrameInfo-&gt;markSwapBuffers();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (drew) &#123;</span><br><span class="line">        swapBuffers(dirty, width, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Use a fence for real completion?</span></span><br><span class="line">    mCurrentFrameInfo-&gt;markFrameCompleted();</span><br><span class="line">    mJankTracker.addFrame(*mCurrentFrameInfo);</span><br><span class="line">    mRenderThread.jankTracker().addFrame(*mCurrentFrameInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>uml</p>
<p><img data-src="/./WindowManager.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/09/15/LayoutInflater%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/09/15/LayoutInflater%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">LayoutInflater分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2016-09-15 14:58:38 / Modified: 15:10:47" itemprop="dateCreated datePublished" datetime="2016-09-15T14:58:38+08:00">2016-09-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="导言"><a href="#导言" class="headerlink" title="导言"></a>导言</h4><p>加载布局的时候经常会用到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">View.inflate(Context context, @LayoutRes int resource, ViewGroup root) </span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LayoutInflater.from(Context context).inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)</span><br></pre></td></tr></table></figure>

<p>关键就是<code>LayoutInflater</code>，它是通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LayoutInflater LayoutInflater =</span><br><span class="line">                (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE)</span><br></pre></td></tr></table></figure>

<p>因此可以看出它其实属于系统的一种服务。由此我们来分析当使用系统服务时都做了什么？</p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>由源码我能知道获取系统服务总是通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.getSystemService(xxx)</span><br></pre></td></tr></table></figure>

<p>因此在<code>ContextImpl</code>找到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public Object getSystemService(String name) &#123;</span><br><span class="line">        return SystemServiceRegistry.getSystemService(this, name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="SystemServiceRegistry"><a href="#SystemServiceRegistry" class="headerlink" title="SystemServiceRegistry"></a>SystemServiceRegistry</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static Object getSystemService(ContextImpl ctx, String name) &#123;</span><br><span class="line">        ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</span><br><span class="line">        return fetcher != null ? fetcher.getService(ctx) : null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>SYSTEM_SERVICE_FETCHERS</code>是个<code>Map</code>容器，保存着<code>ServiceFetcher</code></p>
<p>从<code>SystemServiceRegistry</code>可以看出，我们平时所需要的系统服务都会在一开始的注册</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static&#123; </span><br><span class="line">	registerService(String serviceName, Class&lt;T&gt; serviceClass,</span><br><span class="line">            ServiceFetcher&lt;T&gt; serviceFetcher)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ServiceFetcher"><a href="#ServiceFetcher" class="headerlink" title="ServiceFetcher"></a>ServiceFetcher</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">static abstract interface ServiceFetcher&lt;T&gt; &#123;</span><br><span class="line">        T getService(ContextImpl ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">static abstract class CachedServiceFetcher&lt;T&gt; implements ServiceFetcher&lt;T&gt; &#123;</span><br><span class="line">        private final int mCacheIndex;</span><br><span class="line"></span><br><span class="line">        public CachedServiceFetcher() &#123;</span><br><span class="line">            mCacheIndex = sServiceCacheSize++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        public final T getService(ContextImpl ctx) &#123;</span><br><span class="line">            final Object[] cache = ctx.mServiceCache;</span><br><span class="line">            synchronized (cache) &#123;</span><br><span class="line">                // Fetch or create the service.</span><br><span class="line">                Object service = cache[mCacheIndex];</span><br><span class="line">                if (service == null) &#123;</span><br><span class="line">                    service = createService(ctx);</span><br><span class="line">                    cache[mCacheIndex] = service;</span><br><span class="line">                &#125;</span><br><span class="line">                return (T)service;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public abstract T createService(ContextImpl ctx);</span><br><span class="line">    &#125;    </span><br></pre></td></tr></table></figure>
<p>这里每次获取服务的时候都会进行缓存检查确保只会存在一个相同的服务</p>
<p>下面是uml图<br><img data-src="/./uml.png" alt="getSystemService"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,</span><br><span class="line">                new CachedServiceFetcher&lt;LayoutInflater&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public LayoutInflater createService(ContextImpl ctx) &#123;</span><br><span class="line">                return new PhoneLayoutInflater(ctx.getOuterContext());</span><br><span class="line">            &#125;&#125;);</span><br></pre></td></tr></table></figure>
<p>上述代码会注册<code>LayoutInflayer</code>服务，可以看出实际的实现在<code>PhoneLayoutInflayer</code>，其继承自<code>LayoutInflayer</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">        final Resources res = getContext().getResources();</span><br><span class="line">        if (DEBUG) &#123;</span><br><span class="line">            Log.d(TAG, &quot;INFLATING from resource: \&quot;&quot; + res.getResourceName(resource) + &quot;\&quot; (&quot;</span><br><span class="line">                    + Integer.toHexString(resource) + &quot;)&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final XmlResourceParser parser = res.getLayout(resource);</span><br><span class="line">        try &#123;</span><br><span class="line">            return inflate(parser, root, attachToRoot);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            parser.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">        synchronized (mConstructorArgs) &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;inflate&quot;);</span><br><span class="line"></span><br><span class="line">            final Context inflaterContext = mContext;</span><br><span class="line">            final AttributeSet attrs = Xml.asAttributeSet(parser);</span><br><span class="line">            Context lastContext = (Context) mConstructorArgs[0];</span><br><span class="line">            mConstructorArgs[0] = inflaterContext;</span><br><span class="line">            View result = root;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                // Look for the root node.</span><br><span class="line">                int type;</span><br><span class="line">                while ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</span><br><span class="line">                        type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                    // Empty</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                    throw new InflateException(parser.getPositionDescription()</span><br><span class="line">                            + &quot;: No start tag found!&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                final String name = parser.getName();</span><br><span class="line">                </span><br><span class="line">                if (DEBUG) &#123;</span><br><span class="line">                    System.out.println(&quot;**************************&quot;);</span><br><span class="line">                    System.out.println(&quot;Creating root view: &quot;</span><br><span class="line">                            + name);</span><br><span class="line">                    System.out.println(&quot;**************************&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">                    if (root == null || !attachToRoot) &#123;</span><br><span class="line">                        throw new InflateException(&quot;&lt;merge /&gt; can be used only with a valid &quot;</span><br><span class="line">                                + &quot;ViewGroup root and attachToRoot=true&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    rInflate(parser, root, inflaterContext, attrs, false);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Temp is the root view that was found in the xml</span><br><span class="line">                    final View temp = createViewFromTag(root, name, inflaterContext, attrs);</span><br><span class="line"></span><br><span class="line">                    ViewGroup.LayoutParams params = null;</span><br><span class="line"></span><br><span class="line">                    if (root != null) &#123;</span><br><span class="line">                        if (DEBUG) &#123;</span><br><span class="line">                            System.out.println(&quot;Creating params from root: &quot; +</span><br><span class="line">                                    root);</span><br><span class="line">                        &#125;</span><br><span class="line">                        // Create layout params that match root, if supplied</span><br><span class="line">                        params = root.generateLayoutParams(attrs);</span><br><span class="line">                        if (!attachToRoot) &#123;</span><br><span class="line">                            // Set the layout params for temp if we are not</span><br><span class="line">                            // attaching. (If we are, we use addView, below)</span><br><span class="line">                            temp.setLayoutParams(params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        System.out.println(&quot;-----&gt; start inflating children&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    // Inflate all children under temp against its context.</span><br><span class="line">                    rInflateChildren(parser, temp, attrs, true);</span><br><span class="line"></span><br><span class="line">                    if (DEBUG) &#123;</span><br><span class="line">                        System.out.println(&quot;-----&gt; done inflating children&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    // We are supposed to attach all the views we found (int temp)</span><br><span class="line">                    // to root. Do that now.</span><br><span class="line">                    if (root != null &amp;&amp; attachToRoot) &#123;</span><br><span class="line">                        root.addView(temp, params);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    // Decide whether to return the root that was passed in or the</span><br><span class="line">                    // top view found in xml.</span><br><span class="line">                    if (root == null || !attachToRoot) &#123;</span><br><span class="line">                        result = temp;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; catch (XmlPullParserException e) &#123;</span><br><span class="line">                InflateException ex = new InflateException(e.getMessage());</span><br><span class="line">                ex.initCause(e);</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                InflateException ex = new InflateException(</span><br><span class="line">                        parser.getPositionDescription()</span><br><span class="line">                                + &quot;: &quot; + e.getMessage());</span><br><span class="line">                ex.initCause(e);</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                // Don&#x27;t retain static reference on context.</span><br><span class="line">                mConstructorArgs[0] = lastContext;</span><br><span class="line">                mConstructorArgs[1] = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line"></span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>主要加载视图的主要步骤:</p>
<p>解析<code>xml</code>根元素，根元素如果是<code>merge</code>直接调用<code>rInflate</code>,<code>root</code>作为根节点。否则调用<code>createViewFromTag</code>加载视图,然后挂到根节点下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">View createViewFromTag(View parent, String name, Context context, AttributeSet attrs,</span><br><span class="line">            boolean ignoreThemeAttr) &#123;</span><br><span class="line">        if (name.equals(&quot;view&quot;)) &#123;</span><br><span class="line">            name = attrs.getAttributeValue(null, &quot;class&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Apply a theme wrapper, if allowed and one is specified.</span><br><span class="line">        if (!ignoreThemeAttr) &#123;</span><br><span class="line">            final TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);</span><br><span class="line">            final int themeResId = ta.getResourceId(0, 0);</span><br><span class="line">            if (themeResId != 0) &#123;</span><br><span class="line">                context = new ContextThemeWrapper(context, themeResId);</span><br><span class="line">            &#125;</span><br><span class="line">            ta.recycle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (name.equals(TAG_1995)) &#123;</span><br><span class="line">            // Let&#x27;s party like it&#x27;s 1995!</span><br><span class="line">            return new BlinkLayout(context, attrs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            View view;</span><br><span class="line">            if (mFactory2 != null) &#123;</span><br><span class="line">                view = mFactory2.onCreateView(parent, name, context, attrs);</span><br><span class="line">            &#125; else if (mFactory != null) &#123;</span><br><span class="line">                view = mFactory.onCreateView(name, context, attrs);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                view = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (view == null &amp;&amp; mPrivateFactory != null) &#123;</span><br><span class="line">                view = mPrivateFactory.onCreateView(parent, name, context, attrs);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (view == null) &#123;</span><br><span class="line">                final Object lastContext = mConstructorArgs[0];</span><br><span class="line">                mConstructorArgs[0] = context;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (-1 == name.indexOf(&#x27;.&#x27;)) &#123;</span><br><span class="line">                        view = onCreateView(parent, name, attrs);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        view = createView(name, null, attrs);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    mConstructorArgs[0] = lastContext;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return view;</span><br><span class="line">        &#125; catch (InflateException e) &#123;</span><br><span class="line">            throw e;</span><br><span class="line"></span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            final InflateException ie = new InflateException(attrs.getPositionDescription()</span><br><span class="line">                    + &quot;: Error inflating class &quot; + name);</span><br><span class="line">            ie.initCause(e);</span><br><span class="line">            throw ie;</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            final InflateException ie = new InflateException(attrs.getPositionDescription()</span><br><span class="line">                    + &quot;: Error inflating class &quot; + name);</span><br><span class="line">            ie.initCause(e);</span><br><span class="line">            throw ie;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过Factory或者Factory2加载视图(主要用于Fragment)，之后如果是内置<code>View</code>调用<code>onCreateView</code>，然后调用<code>createView</code>，自定义<code>View</code>直接调用<code>createView</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">public final View createView(String name, String prefix, AttributeSet attrs)</span><br><span class="line">            throws ClassNotFoundException, InflateException &#123;</span><br><span class="line">        Constructor&lt;? extends View&gt; constructor = sConstructorMap.get(name);</span><br><span class="line">        Class&lt;? extends View&gt; clazz = null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, name);</span><br><span class="line"></span><br><span class="line">            if (constructor == null) &#123;</span><br><span class="line">                // Class not found in the cache, see if it&#x27;s real, and try to add it</span><br><span class="line">                clazz = mContext.getClassLoader().loadClass(</span><br><span class="line">                        prefix != null ? (prefix + name) : name).asSubclass(View.class);</span><br><span class="line">                </span><br><span class="line">                if (mFilter != null &amp;&amp; clazz != null) &#123;</span><br><span class="line">                    boolean allowed = mFilter.onLoadClass(clazz);</span><br><span class="line">                    if (!allowed) &#123;</span><br><span class="line">                        failNotAllowed(name, prefix, attrs);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                constructor = clazz.getConstructor(mConstructorSignature);</span><br><span class="line">                constructor.setAccessible(true);</span><br><span class="line">                sConstructorMap.put(name, constructor);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // If we have a filter, apply it to cached constructor</span><br><span class="line">                if (mFilter != null) &#123;</span><br><span class="line">                    // Have we seen this name before?</span><br><span class="line">                    Boolean allowedState = mFilterMap.get(name);</span><br><span class="line">                    if (allowedState == null) &#123;</span><br><span class="line">                        // New class -- remember whether it is allowed</span><br><span class="line">                        clazz = mContext.getClassLoader().loadClass(</span><br><span class="line">                                prefix != null ? (prefix + name) : name).asSubclass(View.class);</span><br><span class="line">                        </span><br><span class="line">                        boolean allowed = clazz != null &amp;&amp; mFilter.onLoadClass(clazz);</span><br><span class="line">                        mFilterMap.put(name, allowed);</span><br><span class="line">                        if (!allowed) &#123;</span><br><span class="line">                            failNotAllowed(name, prefix, attrs);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (allowedState.equals(Boolean.FALSE)) &#123;</span><br><span class="line">                        failNotAllowed(name, prefix, attrs);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object[] args = mConstructorArgs;</span><br><span class="line">            args[1] = attrs;</span><br><span class="line"></span><br><span class="line">            final View view = constructor.newInstance(args);</span><br><span class="line">            if (view instanceof ViewStub) &#123;</span><br><span class="line">                // Use the same context when inflating ViewStub later.</span><br><span class="line">                final ViewStub viewStub = (ViewStub) view;</span><br><span class="line">                viewStub.setLayoutInflater(cloneInContext((Context) args[0]));</span><br><span class="line">            &#125;</span><br><span class="line">            return view;</span><br><span class="line"></span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            InflateException ie = new InflateException(attrs.getPositionDescription()</span><br><span class="line">                    + &quot;: Error inflating class &quot;</span><br><span class="line">                    + (prefix != null ? (prefix + name) : name));</span><br><span class="line">            ie.initCause(e);</span><br><span class="line">            throw ie;</span><br><span class="line"></span><br><span class="line">        &#125; catch (ClassCastException e) &#123;</span><br><span class="line">            // If loaded class is not a View subclass</span><br><span class="line">            InflateException ie = new InflateException(attrs.getPositionDescription()</span><br><span class="line">                    + &quot;: Class is not a View &quot;</span><br><span class="line">                    + (prefix != null ? (prefix + name) : name));</span><br><span class="line">            ie.initCause(e);</span><br><span class="line">            throw ie;</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            // If loadClass fails, we should propagate the exception.</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            InflateException ie = new InflateException(attrs.getPositionDescription()</span><br><span class="line">                    + &quot;: Error inflating class &quot;</span><br><span class="line">                    + (clazz == null ? &quot;&lt;unknown&gt;&quot; : clazz.getName()));</span><br><span class="line">            ie.initCause(e);</span><br><span class="line">            throw ie;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>createView</code>首先从<code>sConstructorMap</code>中取出缓存的<code>View</code>构造器，如果不存在直接通过反射创建实例，还可以通过<code>Filter</code>来控制加载的<code>View</code>。</p>
<h5 id="rInflate"><a href="#rInflate" class="headerlink" title="rInflate()"></a>rInflate()</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">void rInflate(XmlPullParser parser, View parent, Context context,</span><br><span class="line">            AttributeSet attrs, boolean finishInflate) throws XmlPullParserException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        final int depth = parser.getDepth();</span><br><span class="line">        int type;</span><br><span class="line"></span><br><span class="line">        while (((type = parser.next()) != XmlPullParser.END_TAG ||</span><br><span class="line">                parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line"></span><br><span class="line">            if (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            final String name = parser.getName();</span><br><span class="line">            </span><br><span class="line">            if (TAG_REQUEST_FOCUS.equals(name)) &#123;</span><br><span class="line">                parseRequestFocus(parser, parent);</span><br><span class="line">            &#125; else if (TAG_TAG.equals(name)) &#123;</span><br><span class="line">                parseViewTag(parser, parent, attrs);</span><br><span class="line">            &#125; else if (TAG_INCLUDE.equals(name)) &#123;</span><br><span class="line">                if (parser.getDepth() == 0) &#123;</span><br><span class="line">                    throw new InflateException(&quot;&lt;include /&gt; cannot be the root element&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                parseInclude(parser, context, parent, attrs);</span><br><span class="line">            &#125; else if (TAG_MERGE.equals(name)) &#123;</span><br><span class="line">                throw new InflateException(&quot;&lt;merge /&gt; must be the root element&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                final View view = createViewFromTag(parent, name, context, attrs);</span><br><span class="line">                final ViewGroup viewGroup = (ViewGroup) parent;</span><br><span class="line">                final ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</span><br><span class="line">                rInflateChildren(parser, view, attrs, true);</span><br><span class="line">                viewGroup.addView(view, params);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (finishInflate) &#123;</span><br><span class="line">            parent.onFinishInflate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>解析顺序是<code>&lt;requestFocus/&gt;</code>-&gt;<code>&lt;tag&gt;</code>-&gt;<code>&lt;include&gt;</code>-&gt;<code>&lt;merge&gt;</code>-&gt;<code>&lt;View&gt;</code></p>
</blockquote>
<h4 id="LayoutInflater-uml"><a href="#LayoutInflater-uml" class="headerlink" title="LayoutInflater uml"></a>LayoutInflater uml</h4><p><img data-src="/./LayoutInflater.png" alt="getSystemService"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/07/24/Design_pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/24/Design_pattern/" class="post-title-link" itemprop="url">设计模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-07-24 15:13:45" itemprop="dateCreated datePublished" datetime="2016-07-24T15:13:45+08:00">2016-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2016-11-16 13:43:27" itemprop="dateModified" datetime="2016-11-16T13:43:27+08:00">2016-11-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/xu6148152/Design-Patterns">代码示例</a>   </p>
<blockquote>
<ol>
<li>单一职责原则</li>
<li>接口隔离(多用组合，少用继承)</li>
<li>依赖倒置(高层不依赖低层，都依赖抽象)</li>
<li>里氏替换(子类必须能够替换基类)</li>
<li>迪米特原则(解耦，类之间尽量减少联系)</li>
<li>开闭原则(开放拓展，关闭修改)</li>
</ol>
</blockquote>
<h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><blockquote>
<ol>
<li>封装变化</li>
<li>针对接口编程(针对超类型编程)，而不是针对实现编程</li>
<li>多用组合，少用继承</li>
<li>为了交互对象之间的松耦合设计而努力</li>
<li>对拓展开放，对修改关闭</li>
<li>最少知识(墨忒耳法则(Law of Demeter))</li>
<li>好莱坞原则，别调用我们，我们会调用你</li>
<li>一个类应该只有一个引起变化的原因</li>
<li>依赖倒置原则(不能让高层组件依赖低层组件，两者都应该依赖于抽象)</li>
</ol>
</blockquote>
<ul>
<li>变量不可以持有具体类的引用</li>
<li>不要让类派生自具体类</li>
<li>不要覆盖基类中已实现的方法</li>
</ul>
<h4 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h4><blockquote>
<p>定义了算法族，分别封装起来，让它们之间可以互相替换，让算法的变化独立于使用算法的客户 </p>
</blockquote>
<h4 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h4><blockquote>
<p>定义了对象之间的一对多依赖，这样一来，当一个对象改变状态时，它的所有依赖者都会收到通知并自动更新</p>
</blockquote>
<h4 id="装饰这模式"><a href="#装饰这模式" class="headerlink" title="装饰这模式"></a>装饰这模式</h4><blockquote>
<p>动态地将责任附加到对象上。若要拓展功能，装饰着提供了比继承更有弹性的替代方案</p>
</blockquote>
<h4 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h4><ul>
<li>方法工厂</li>
</ul>
<blockquote>
<p>定义了一个创建对象的接口，但由子类决定要实例化的类是哪一个。工厂方法让类把实例化推迟到子类  </p>
</blockquote>
<ul>
<li>抽象工厂</li>
</ul>
<blockquote>
<p>提供一个接口，用于创建相关或依赖对象的家族，而不需要明确指定具体类  </p>
</blockquote>
<h4 id="单件模式"><a href="#单件模式" class="headerlink" title="单件模式"></a>单件模式</h4><blockquote>
<p>确保一个类只有一个实例，并提供一个全局访问点</p>
</blockquote>
<h4 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h4><blockquote>
<p>“请求”封装成对象，以便使用不同的请求，列队或者日志来参数化其他对象。命令模式也支持可撤销的操作</p>
</blockquote>
<h4 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h4><blockquote>
<p>将一个类的接口，转换成客户期望的另一个接口。适配器让原本接口不兼容的类型可以合作无间。</p>
</blockquote>
<ul>
<li>对象适配器</li>
<li>类适配器(需要多重继承，java不支持)</li>
</ul>
<h4 id="外观模式"><a href="#外观模式" class="headerlink" title="外观模式"></a>外观模式</h4><blockquote>
<p>提供了一个统一的接口，用来访问子系统中的一群接口。外观定义了一个高层接口，让子系统更容易使用。</p>
</blockquote>
<h4 id="模板方法模式"><a href="#模板方法模式" class="headerlink" title="模板方法模式"></a>模板方法模式</h4><blockquote>
<p>在一个方法中定义一个算法的骨架，而将一些步骤延迟到子类中。模板方法使得子类可以在不改变算法结构的情况下，重新定义算法的某些步骤</p>
</blockquote>
<h4 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h4><blockquote>
<p>提供一种方法顺序访问一个聚合对象中的各个元素，而又不暴露其内部的表示</p>
</blockquote>
<h4 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h4><blockquote>
<p>允许你将对象组合成树形结构来表现”整体&#x2F;部分”层次结构。组合能让客户以一致的方式处理对象以及对象组合</p>
</blockquote>
<p>####状态模式</p>
<blockquote>
<p>允许对象在内部状态改变时改变它的行为，对象看起来好像修改了类。策略模式和状态模式是双胞胎，在出生时才分开</p>
</blockquote>
<h4 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h4><blockquote>
<p>为另一个对象提供一个替身或占位符以控制对这个对象的访问，远程代理，虚拟代理,动态代理</p>
</blockquote>
<h4 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h4><blockquote>
<p>把事物抽象和其具体行为、具体特征分离开来，使它们可以各自独立的变化 </p>
</blockquote>
<ul>
<li>使实现解耦，让它和界面之间不再永久绑定</li>
<li>抽象和实现可以独立拓展，不会影响对方</li>
<li>对于“具体的抽象类”所做的改变，不会影响到客户。</li>
<li>增加复杂度</li>
</ul>
<h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><blockquote>
<p>封装一个产品的构造过程，并允许按步骤构造。</p>
</blockquote>
<ul>
<li>将一个复杂对象的创建过程封装起来</li>
<li>允许对象通过多个步骤来创建，并且可以改变过程</li>
<li>向客户隐藏产品内部的表现</li>
<li>产品的实现可以被替换，因为客户只看到一个抽象的接口</li>
</ul>
<h4 id="责任链"><a href="#责任链" class="headerlink" title="责任链"></a>责任链</h4><blockquote>
<p>让一个以上的对象有机会能够处理某个请求的。</p>
</blockquote>
<ul>
<li>将请求的发送者和接受者解耦</li>
<li>可以简化对象，因为它不需要知道链的结构。</li>
<li>通过改变链内的成员或调动它们的次序，允许你动态地新增或者删除责任</li>
</ul>
<h4 id="享元模式-Flyweight"><a href="#享元模式-Flyweight" class="headerlink" title="享元模式(Flyweight)"></a>享元模式(Flyweight)</h4><blockquote>
<p>让某个类的实例能够用来提供许多“虚拟实例”。</p>
</blockquote>
<ul>
<li>减少运行时对象实例的个数，节省内存</li>
<li>将许多“虚拟”对象的状态集中管理</li>
</ul>
<h4 id="解释器-Interpreter"><a href="#解释器-Interpreter" class="headerlink" title="解释器(Interpreter)"></a>解释器(Interpreter)</h4><blockquote>
<p>未语言创建解释器</p>
</blockquote>
<ul>
<li>将每一种语法规则表示成一个类，方便于实现语言</li>
<li>因为语法由许多类组成，所以可以轻易改变或拓展此语言</li>
<li>通过在类结构中加入新的方法，可以在解释的同时增加新的行为</li>
</ul>
<h4 id="中介者-Mediator"><a href="#中介者-Mediator" class="headerlink" title="中介者(Mediator)"></a>中介者(Mediator)</h4><blockquote>
<p>集中相关对象之间复杂的沟通和控制方式</p>
</blockquote>
<ul>
<li>将对象彼此解耦，增加对象的复用性</li>
<li>集中控制逻辑，简化系统维护</li>
<li>让对象之间所传递的信息变得简单而且大幅减少</li>
</ul>
<h4 id="备忘录"><a href="#备忘录" class="headerlink" title="备忘录"></a>备忘录</h4><blockquote>
<p>让对象返回之前的状态</p>
</blockquote>
<ul>
<li>将被存储的状态放在外面，不要和关键对象混在一起，这可以帮助维护内聚</li>
<li>保持关键对象的数据封装</li>
<li>提供了容易实现的恢复能力</li>
</ul>
<h4 id="原型"><a href="#原型" class="headerlink" title="原型"></a>原型</h4><blockquote>
<p>创建对象的种类，并且通过拷贝这些原型创建新的对象</p>
</blockquote>
<ul>
<li>对客户隐藏创建新实例的复杂性</li>
<li>提供让客户能够产生未知类型对象的选项</li>
</ul>
<h4 id="访问者"><a href="#访问者" class="headerlink" title="访问者"></a>访问者</h4><blockquote>
<p>表示一个作用于某对象结构中的各元素的操作。它使你可以在不改变各元素类的前提下定义作用于这些元素的新操作。</p>
</blockquote>
<ul>
<li>允许对组合结构加入新的操作，而无需改变结构本身</li>
<li>想要加入新的操作，相对容易</li>
<li>访问者所进行的操作，其代码是集中在一起的</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://www.amazon.cn/Head-First%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%BC%97%E9%87%8C%E6%9B%BC/dp/B0011FBU34/ref=sr_1_5?ie=UTF8&qid=1478679780&sr=8-5&keywords=%E5%A4%A7%E8%AF%9D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">Head First</a><br><a target="_blank" rel="noopener" href="https://www.amazon.cn/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%9B%E4%B9%A6-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8F%AF%E5%A4%8D%E7%94%A8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BD%AF%E4%BB%B6%E7%9A%84%E5%9F%BA%E7%A1%80-Erich-Gamma/dp/B001130JN8/ref=sr_1_1?ie=UTF8&qid=1478679820&sr=8-1&keywords=%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">设计模式:可复用面向对象软件的基础</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/06/11/Little-stories-about-an-Android-application-architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/11/Little-stories-about-an-Android-application-architecture/" class="post-title-link" itemprop="url">Little stories about an Android application architecture</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-11 15:59:27" itemprop="dateCreated datePublished" datetime="2016-06-11T15:59:27+08:00">2016-06-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="http://roroche.github.io/AndroidStarter/">原文</a></p>
<p>写这篇文章的目的是为了描述我建议的<code>Android app</code>架构。我一步步的通过下面的原因来选择不同的组件。</p>
<p>模板应用的目的很简单：它是<code>master/detail</code>结构，用来展示指定用户的<code>Github</code>仓库。虽然它简单，但它集合了一些通用的东西：</p>
<ul>
<li>使用<code>REST</code>API  </li>
<li>本地数据存储</li>
<li>本地数据加载</li>
<li>架构逻辑层以及页面导航</li>
</ul>
<p>让我们来看看这背后都有什么!</p>
<p>###Consuming REST API</p>
<blockquote>
<p>REST Representational State Transfer表述性状态传递</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://square.github.io/retrofit/">Retrofit</a>是开发者必备的知名网络库<br>我将解释为何我认为它是必备的库：  </p>
<ul>
<li>类型安全</li>
<li>接口可读性好，采用注解<code>API</code>地址</li>
<li>对如何工作采用完全抽象层</li>
<li>支持多部分请求体(上传文件)</li>
<li>使用注解直接管理头部信息</li>
<li>能够使用多种序列化类型(<code>JSON, XML, protobuf, etc</code>)的转换器</li>
<li>能够添加全局的请求拦截器</li>
<li>方便的进行<code>MOCK</code>测试</li>
</ul>
<p>使用时仅需在<code>build.gradle</code>文件中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile &#x27;com.squareup.retrofit:retrofit:&#123;&#123;last_version&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>然后我能够声明<code>GitHubService</code>接口和我们需要使用这个接口的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface GitHubService &#123;</span><br><span class="line">    @GET(&quot;/users/&#123;user&#125;/repos&quot;)</span><br><span class="line">    Call&lt;List&lt;DTORepo&gt;&gt; listRepos(@Path(&quot;user&quot;) final String psUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步通过<code>RestAdapter</code>去实现这个接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final Retrofit loRetrofit = new Retrofit.Builder()</span><br><span class="line">    .baseUrl(&quot;https://api.github.com&quot;)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">final GitHubService loService = loRetrofit.create(GitHubService.class);</span><br><span class="line">return loService;</span><br></pre></td></tr></table></figure>

<p>我使用<a target="_blank" rel="noopener" href="https://github.com/novoda/merlin">Merlin</a>。它能够观察网络的连接状态以及改变。它提供流畅<code>API</code>，设置简单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">final MerlinsBeard merlinsBeard = MerlinsBeard.from(context);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">merlinsBeard.isConnected()</span><br></pre></td></tr></table></figure>
<p>来检查网络是否可用。</p>
<p>###解析数据</p>
<p>现在我们已经能够从服务器拿到数据了，我们需要将这些数据转换成<code>POJO</code>对象。通常的格式是<code>JSON</code>,我们使用<a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson">Jackson</a>来作为转换器。</p>
<p>当然，我将会说明一下为什么我选择<code>Jackson</code>。首先，我很满意它流畅的注解<code>API</code>。能够获取或存储那些没有通过<code>@JsonProperty</code>注解声明的属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@JsonIgnore</span><br><span class="line">    private Map&lt;String, Object&gt; mAdditionalProperties = new HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    @JsonAnyGetter</span><br><span class="line">    public Map&lt;String, Object&gt; getAdditionalProperties() &#123;</span><br><span class="line">        return mAdditionalProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @JsonAnySetter</span><br><span class="line">    public void setAdditionalProperty(final String psName, final Object poValue) &#123;</span><br><span class="line">        mAdditionalProperties.put(psName, value poValue;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>与<code>Retrofit</code>组合</p>
<p><a target="_blank" rel="noopener" href="https://github.com/square/retrofit/tree/master/retrofit-converters/jackson.">https://github.com/square/retrofit/tree/master/retrofit-converters/jackson.</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile &#x27;com.squareup.retrofit2:converter-jackson:&#123;&#123;last_version&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>然后我们将其设置到我们之前的<code>RestAdapter</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">final Retrofit loRetrofit = new Retrofit.Builder()</span><br><span class="line">    .baseUrl(&quot;https://api.github.com&quot;)</span><br><span class="line">    .addConverterFactory(JacksonConverterFactory.create()) // add the Jackson specific converter</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">final GitHubService loService = loRetrofit.create(GitHubService.class);</span><br><span class="line">return loService;</span><br></pre></td></tr></table></figure>

<p>福利<br>我通常使用<a target="_blank" rel="noopener" href="http://www.jsonschema2pojo.org/">jsonchema2pojo</a>  </p>
<blockquote>
<p>Generate Plain Old Java Objects from JSON or JSON-Schema.</p>
</blockquote>
<p>也可以使用<a target="_blank" rel="noopener" href="https://github.com/square/moshi">moshi</a>或者<a target="_blank" rel="noopener" href="https://github.com/bluelinelabs/LoganSquare">LoganSquare</a>  </p>
<p>####组件之间的通讯和数据传递<br>通常的做法是使用事件总线</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://square.github.io/otto/">Otto</a>  </li>
<li><a target="_blank" rel="noopener" href="http://greenrobot.github.io/EventBus/">EventBus</a> </li>
<li><a target="_blank" rel="noopener" href="https://github.com/beworker/tinybus">TinyBus</a></li>
</ul>
<blockquote>
<p>Now can using RxJava to replace above all  </p>
</blockquote>
<p>####线程管理</p>
<blockquote>
<p>RxAndroid thread</p>
</blockquote>
<p>####任务管理<br>多线程和并发是开发者经常要考虑的问题。我罗列出一些不能再主线程操作的任务</p>
<ul>
<li>调用远程API</li>
<li>数据库CURD操作</li>
<li>读取本地文件</li>
</ul>
<p>建议采取:</p>
<ul>
<li>使用<code>Service</code></li>
<li>设置<code>ServiceHelper</code>来进行网络请求</li>
<li>使用专门的类来处理查询操作</li>
</ul>
<p>但需要注意的是<code>Service</code>是运行在主线程中，因此可以使用<code>IntentService</code>或者使用<a target="_blank" rel="noopener" href="https://github.com/yigit/android-priority-jobqueue">Android Priority Job Queue</a>或者是官方的<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/app/job/JobScheduler.html">JobScheduler</a></p>
<p>####Job Manager(android-priority-jobqueue)<br>#####Job Manager Configuration</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">final Configuration loConfiguration = new Configuration.Builder(poContext)</span><br><span class="line">    .minConsumerCount(1) // always keep at least one consumer alive</span><br><span class="line">    .maxConsumerCount(3) // up to 3 consumers at a time</span><br><span class="line">    .loadFactor(3) // 3 jobs per consumer</span><br><span class="line">    .consumerKeepAlive(120) // wait 2 minute</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">final JobManager loJobManager = new JobManager(poContext, loConfiguration);</span><br></pre></td></tr></table></figure>
<p>#####Job Configuration<br>我们可以给一个任务设置一些有用的参数，例如</p>
<ul>
<li>它的优先级</li>
<li>它是否需要网络</li>
<li>如果不执行，是否需要持久化</li>
<li>延时运行</li>
<li>重试机制</li>
</ul>
<p>这个库的持久化引擎非常强大。例如，网络不可用时，任务会被持久化到设备上。一旦网络可用<code>JobManager</code>获取持久化的任务并执行它们</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractQuery extends Job &#123;</span><br><span class="line">    private static final String TAG = AbstractQuery.class.getSimpleName();</span><br><span class="line">    private static final boolean DEBUG = true;</span><br><span class="line"></span><br><span class="line">    protected enum Priority &#123;</span><br><span class="line">        LOW(0),</span><br><span class="line">        MEDIUM(500),</span><br><span class="line">        HIGH(1000);</span><br><span class="line">        private final int value;</span><br><span class="line"></span><br><span class="line">        Priority(final int piValue) &#123;</span><br><span class="line">            value = piValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected boolean mSuccess;</span><br><span class="line">    protected Throwable mThrowable;</span><br><span class="line">    protected AbstractEventQueryDidFinish.ErrorType mErrorType;</span><br><span class="line"></span><br><span class="line">    //region Protected constructor</span><br><span class="line">    protected AbstractQuery(final Priority poPriority) &#123;</span><br><span class="line">        super(new Params(poPriority.value).requireNetwork());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected AbstractQuery(final Priority poPriority, final boolean pbPersistent, final String psGroupId, final long plDelayMs) &#123;</span><br><span class="line">        super(new Params(poPriority.value).requireNetwork().setPersistent(pbPersistent).setGroupId(psGroupId).setDelayMs(plDelayMs));</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Overridden methods</span><br><span class="line">    @Override</span><br><span class="line">    public void onAdded() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onRun() throws Throwable &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            execute();</span><br><span class="line">            mSuccess = true;</span><br><span class="line">        &#125; catch (Throwable loThrowable) &#123;</span><br><span class="line">            if (BuildConfig.DEBUG &amp;&amp; DEBUG) &#123;</span><br><span class="line">                Logger.t(TAG).e(loThrowable, &quot;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            mErrorType = AbstractEventQueryDidFinish.ErrorType.UNKNOWN;</span><br><span class="line">            mThrowable = loThrowable;</span><br><span class="line">            mSuccess = false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        postEventQueryFinished();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCancel() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected int getRetryLimit() &#123;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Protected abstract method for specific job</span><br><span class="line">    protected abstract void execute() throws Exception;</span><br><span class="line"></span><br><span class="line">    protected abstract void postEventQueryFinished();</span><br><span class="line"></span><br><span class="line">    public abstract void postEventQueryFinishedNoNetwork();</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>枚举描述了我需要的优先级</li>
<li>提供两个构造函数</li>
<li>异常处理</li>
<li>默认重试次数</li>
</ul>
<p> 有三个方法被实现</p>
<ul>
<li><code>execute</code>: 执行特定的代码</li>
<li><code>postEventQueryFinished </code>: 通知任务结果</li>
<li><code>postEventQueryFinishedNoNetwork </code>: 通知网络不可用</li>
</ul>
<p> 后两个通常基于总线</p>
<p> 下面是我定义的抽象事件</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> public abstract class AbstractEventQueryDidFinish&lt;QueryType extends AbstractQuery&gt; extends AbstractEvent &#123;</span><br><span class="line">    public enum ErrorType &#123;</span><br><span class="line">        UNKNOWN,</span><br><span class="line">        NETWORK_UNREACHABLE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final QueryType query;</span><br><span class="line"></span><br><span class="line">    public final boolean success;</span><br><span class="line">    public final ErrorType errorType;</span><br><span class="line">    public final Throwable throwable;</span><br><span class="line"></span><br><span class="line">    public AbstractEventQueryDidFinish(final QueryType poQuery, final boolean pbSuccess, final ErrorType poErrorType, final Throwable poThrowable) &#123;</span><br><span class="line">        query = poQuery;</span><br><span class="line">        success = pbSuccess;</span><br><span class="line">        errorType = poErrorType;</span><br><span class="line">        throwable = poThrowable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查询刚完成</li>
<li>终端状态</li>
<li>异常处理</li>
</ul>
<p> 下面是我的查询用户仓库的代码</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> public class QueryGetRepos extends AbstractQuery &#123;</span><br><span class="line">    private static final String TAG = QueryGetRepos.class.getSimpleName();</span><br><span class="line">    private static final boolean DEBUG = true;</span><br><span class="line"></span><br><span class="line">    //region Fields</span><br><span class="line">    public final String user;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Constructor matching super</span><br><span class="line">    protected QueryGetRepos(@NonNull final String psUser) &#123;</span><br><span class="line">        super(Priority.MEDIUM);</span><br><span class="line">        user = psUser;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Overridden method</span><br><span class="line">    @Override</span><br><span class="line">    protected void execute() throws Exception &#123;</span><br><span class="line">        final GitHubService gitHubService = // specific code to get GitHubService instance</span><br><span class="line"></span><br><span class="line">        final Call&lt;List&lt;DTORepo&gt;&gt; loCall = gitHubService.listRepos(user);</span><br><span class="line">        final Response&lt;List&lt;DTORepo&gt;&gt; loExecute = loCall.execute();</span><br><span class="line">        final List&lt;DTORepo&gt; loBody = loExecute.body();</span><br><span class="line"></span><br><span class="line">        // TODO deal with list of DTORepo</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void postEventQueryFinished() &#123;</span><br><span class="line">        final EventQueryGetRepos loEvent = new EventQueryGetRepos(this, mSuccess, mErrorType, mThrowable);</span><br><span class="line">        busManager.postEventOnMainThread(loEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void postEventQueryFinishedNoNetwork() &#123;</span><br><span class="line">        final EventQueryGetRepos loEvent = new EventQueryGetRepos(this, false, AbstractEventQueryDidFinish.ErrorType.NETWORK_UNREACHABLE, null);</span><br><span class="line">        busManager.postEventOnMainThread(loEvent);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Dedicated EventQueryDidFinish</span><br><span class="line">    public static final class EventQueryGetRepos extends AbstractEventQueryDidFinish&lt;QueryGetRepos&gt; &#123;</span><br><span class="line">        public EventQueryGetRepos(final QueryGetRepos poQuery, final boolean pbSuccess, final ErrorType poErrorType, final Throwable poThrowable) &#123;</span><br><span class="line">            super(poQuery, pbSuccess, poErrorType, poThrowable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，通过<code>QueryFactor</code>这个简单的代理类来进行请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class QueryFactory &#123;</span><br><span class="line">    //region Build methods</span><br><span class="line">    public QueryGetRepos buildQueryGetRepos(@NonNull final String psUser) &#123;</span><br><span class="line">        return new QueryGetRepos(psUser);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Start methods</span><br><span class="line">    public void startQuery(@NonNull final Context poContext, @NonNull final AbstractQuery poQuery) &#123;</span><br><span class="line">        final Intent loIntent = new ServiceQueryExecutorIntentBuilder(poQuery).build(poContext);</span><br><span class="line">        poContext.startService(loIntent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void startQueryGetRepos(@NonNull final Context poContext, @NonNull final String psUser) &#123;</span><br><span class="line">        final QueryGetRepos loQuery = buildQueryGetRepos(psUser);</span><br><span class="line">        startQuery(poContext, loQuery);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Service</code>处理如下声明的查询:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class ServiceQueryExecutor extends IntentService &#123;</span><br><span class="line">    private static final String TAG = ServiceQueryExecutor.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    //region Extra fields</span><br><span class="line">    AbstractQuery query;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    MerlinsBeard merlinsBeard;</span><br><span class="line">    JobManager jobManager;</span><br><span class="line"></span><br><span class="line">    //region Constructor matching super</span><br><span class="line">    /**</span><br><span class="line">     * Creates an IntentService.  Invoked by your subclass&#x27;s constructor.</span><br><span class="line">     */</span><br><span class="line">    public ServiceQueryExecutor() &#123;</span><br><span class="line">        super(TAG);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Overridden methods</span><br><span class="line">    @DebugLog</span><br><span class="line">    @Override</span><br><span class="line">    protected void onHandleIntent(final Intent poIntent) &#123;</span><br><span class="line">        // TODO get AbstractQuery from Intent </span><br><span class="line">        // TODO get MerlinsBeard and JobManager instances</span><br><span class="line"></span><br><span class="line">        // If query requires network, and if network is unreachable, and if the query must not persist</span><br><span class="line">        if (query.requiresNetwork() &amp;&amp;</span><br><span class="line">                !merlinsBeard.isConnected() &amp;&amp;</span><br><span class="line">                !query.isPersistent()) &#123;</span><br><span class="line">            // then, we post an event to notify the job could not be done because of network connectivity</span><br><span class="line">            query.postEventQueryFinishedNoNetwork();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // otherwise, we can add the job</span><br><span class="line">            jobManager.addJobInBackground(query);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###数据持久化</p>
<p>####ORM 方式<br>对象关系映射是软件开发中经常使用的技术</p>
<p>####<a target="_blank" rel="noopener" href="http://ormlite.com/sqlite_java_android_orm.shtml">OrmLite</a><br>第一步设置要被映射的<code>POJO</code><br>我创建抽象类来匹配<code>_id</code>列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractOrmLiteEntity &#123;</span><br><span class="line">    @DatabaseField(columnName = BaseColumns._ID, generatedId = true)</span><br><span class="line">    protected long _id;</span><br><span class="line"></span><br><span class="line">    //region Getter</span><br><span class="line">    public long getBaseId() &#123;</span><br><span class="line">        return _id;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在创建一个<code>POJO</code>类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@DatabaseTable(tableName = &quot;REPO&quot;, daoClass = DAORepo.class)</span><br><span class="line">public class RepoEntity extends AbstractOrmLiteEntity &#123;</span><br><span class="line">    @DatabaseField</span><br><span class="line">    public Integer id;</span><br><span class="line"></span><br><span class="line">    @DatabaseField</span><br><span class="line">    public String name;</span><br><span class="line"></span><br><span class="line">    @DatabaseField</span><br><span class="line">    public String location;</span><br><span class="line"></span><br><span class="line">    @DatabaseField</span><br><span class="line">    public String url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看一下DAO。这个设计目的在于通过抽象的接口来访问具体的数据。</p>
<p><code>OrmLite</code>提供了<code>Dao</code>接口以及其实现<code>BaseDaoImpl</code>。CURD所需的操作都具备。</p>
<p>然而，这些都是同步执行的。使用<code>RxJava</code>来异步执行这些操作。</p>
<p>因此我使用<code>RxJava</code>重写了所有的方法<br>我创建了如下接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public interface IRxDao&lt;T, ID&gt; extends Dao&lt;T, ID&gt;</span><br></pre></td></tr></table></figure>

<p>所有的方法名以”rx”为前缀。返回一个特定类型的<code>Observable</code>对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public abstract class RxBaseDaoImpl&lt;DataType extends AbstractOrmLiteEntity, IdType&gt; extends BaseDaoImpl&lt;DataType, IdType&gt; implements IRxDao&lt;DataType, IdType&gt;</span><br></pre></td></tr></table></figure>

<p>使用<code>long</code>作为ID类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public interface IOrmLiteEntityDAO&lt;DataType extends AbstractOrmLiteEntity&gt; extends Dao&lt;DataType, Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抽象类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractBaseDAOImpl&lt;DataType extends AbstractOrmLiteEntity&gt; extends RxBaseDaoImpl&lt;DataType, Long&gt; implements IOrmLiteEntityDAO&lt;DataType&gt; &#123;</span><br><span class="line">    //region Constructors matching super</span><br><span class="line">    protected AbstractBaseDAOImpl(final Class&lt;DataType&gt; poDataClass) throws SQLException &#123;</span><br><span class="line">        super(poDataClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AbstractBaseDAOImpl(final ConnectionSource poConnectionSource, final Class&lt;DataType&gt; poDataClass) throws SQLException &#123;</span><br><span class="line">        super(poConnectionSource, poDataClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AbstractBaseDAOImpl(final ConnectionSource poConnectionSource, final DatabaseTableConfig&lt;DataType&gt; poTableConfig) throws SQLException &#123;</span><br><span class="line">        super(poConnectionSource, poTableConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DAORepo</code>变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class DAORepo extends AbstractBaseDAOImpl&lt;RepoEntity&gt; &#123;</span><br><span class="line">    //region Constructors matching super</span><br><span class="line">    public DAORepo(final ConnectionSource poConnectionSource) throws SQLException &#123;</span><br><span class="line">        this(poConnectionSource, RepoEntity.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public DAORepo(final ConnectionSource poConnectionSource, final Class&lt;RepoEntity&gt; poDataClass) throws SQLException &#123;</span><br><span class="line">        super(poConnectionSource, poDataClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public DAORepo(final ConnectionSource poConnectionSource, final DatabaseTableConfig&lt;RepoEntity&gt; poTableConfig) throws SQLException &#123;</span><br><span class="line">        super(poConnectionSource, poTableConfig);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ORMLite</code>提供<code>SQLiteOpenHelper</code>的抽象子类<code>OrmLiteSQLiteOpenHelper</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class DatabaseHelperAndroidStarter extends OrmLiteSqliteOpenHelper &#123;</span><br><span class="line">    private static final String DATABASE_NAME = &quot;android_starter.db&quot;;</span><br><span class="line">    private static final int DATABASE_VERSION = 1;</span><br><span class="line"></span><br><span class="line">    //region Constructor</span><br><span class="line">    public DatabaseHelperAndroidStarter(@NonNull final Context poContext) &#123;</span><br><span class="line">        super(poContext, DATABASE_NAME, null, DATABASE_VERSION);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Methods to override</span><br><span class="line">    @Override</span><br><span class="line">    @SneakyThrows(SQLException.class)</span><br><span class="line">    public void onCreate(@NonNull final SQLiteDatabase poDatabase, @NonNull final ConnectionSource poConnectionSource) &#123;</span><br><span class="line">        TableUtils.createTable(poConnectionSource, RepoEntity.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    @SneakyThrows(SQLException.class)</span><br><span class="line">    public void onUpgrade(@NonNull final SQLiteDatabase poDatabase, @NonNull final ConnectionSource poConnectionSource, final int piOldVersion, final int piNewVersion) &#123;</span><br><span class="line">        TableUtils.dropTable(poConnectionSource, RepoEntity.class, true);</span><br><span class="line">        onCreate(poDatabase, poConnectionSource);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ORMLite</code>提供<code>TableUtils</code>，其可以根据映射的类文件创建或者删除表</p>
<p>现在，我们需要一个<code>DatabaseHelperAndroidStarter</code>来处理数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public DatabaseHelperAndroidStarter getDatabaseHelperAndroidStarter(@NonNull final Context poContext) &#123;</span><br><span class="line">    return new DatabaseHelperAndroidStarter(poContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们能通过下面的方式获得一个<code>DAORepo</code>实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public DAORepo getDAORepo(@NonNull final DatabaseHelperAndroidStarter poDatabaseHelperAndroidStarter) &#123;</span><br><span class="line">    return new DAORepo(poDatabaseHelperAndroidStarter.getConnectionSource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Fragment</code>中，通过以下方式获取仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private void rxGetRepos() &#123;</span><br><span class="line">    mSubscriptionGetRepos = daoRepo.rxQueryForAll()</span><br><span class="line">            .subscribeOn(Schedulers.newThread())</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .subscribe(</span><br><span class="line">                    (final List&lt;RepoEntity&gt; ploRepos) -&gt; &#123; // onNext</span><br><span class="line">                        // TODO deal with repos</span><br><span class="line">                    &#125;,</span><br><span class="line">                    (final Throwable poException) -&gt; &#123; // onError</span><br><span class="line">                        mSubscriptionGetRepos = null;</span><br><span class="line">                        // TODO deal with error</span><br><span class="line">                    &#125;,</span><br><span class="line">                    () -&gt; &#123; // onCompleted</span><br><span class="line">                       mSubscriptionGetRepos = null;</span><br><span class="line">                    &#125;</span><br><span class="line">            );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但仍然有个问题：如何从网络上获取一个仓库并把它解析然后存储到本地?</p>
<p>我的目标是使用<code>DTORepo</code>来与网络通讯,<code>RepoEntity</code>映射到数据库。它们有相同名字的相同的字段。因此我需要一个工具用来把DTO转换成实体。这时候，我们会用到<a target="_blank" rel="noopener" href="https://github.com/txusballesteros/android-transformer">Android Transformer</a></p>
<p>它提供两个主要的注解</p>
<ul>
<li><code>@Mappable</code>来代表要映射的类</li>
<li><code>@Mapped</code>代表要映射的成员</li>
</ul>
<p>因此，<code>RepoEntity</code>变成:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Mappable(with = DTORepo.class)</span><br><span class="line">@DatabaseTable(tableName = &quot;REPO&quot;, daoClass = DAORepo.class)</span><br><span class="line">public class RepoEntity extends AbstractOrmLiteEntity implements Serializable &#123;</span><br><span class="line">    @Mapped</span><br><span class="line">    @DatabaseField</span><br><span class="line">    public Integer id;</span><br><span class="line"></span><br><span class="line">    @Mapped</span><br><span class="line">    @DatabaseField</span><br><span class="line">    public String name;</span><br><span class="line"></span><br><span class="line">    @Mapped</span><br><span class="line">    @DatabaseField</span><br><span class="line">    public String location;</span><br><span class="line"></span><br><span class="line">    @Mapped</span><br><span class="line">    @DatabaseField</span><br><span class="line">    public String url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们能通过以下方式将DTO转换成实体</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">final Transformer loTransformerRepo = new Transformer.Builder().build(RepoEntity.class);</span><br><span class="line">final RepoEntity loRepo = loTransformerRepo.transform(loDTORepo, RepoEntity.class);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/stephanenicolas/ormlite-android-gradle-plugin">ormgap</a>插件</p>
<h4 id="ContentProvider方式"><a href="#ContentProvider方式" class="headerlink" title="ContentProvider方式"></a>ContentProvider方式</h4><p><code>ContentProvider</code>和<code>Cursor</code>及其派生配合使用异常强大。  </p>
<p>使用<a target="_blank" rel="noopener" href="https://github.com/TimotheeJeannin/ProviGen">ProviGen</a>有以下优势：</p>
<ul>
<li>声明<code>ContentProvider</code>相关类方便</li>
<li>使用<code>ProviGenProvider</code>，其是<code>ContentProvider</code>的一个子类</li>
<li>提供<code>SQLiteOpenHelper</code>默认实现</li>
<li>能够自定义<code>SQLiteOpenHelper</code>的实现</li>
<li><code>TableBuilder</code>能够使用流畅的API创建<code>SQL</code>表</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/chalup/microorm">MicroOrm</a></p>
<p>###依赖注入</p>
<p>依赖注入优点：</p>
<ul>
<li>便于阅读</li>
<li>便于维护</li>
<li>便于测试</li>
</ul>
<p> …</p>
<p>###MVP架构<br><a target="_blank" rel="noopener" href="http://hannesdorfmann.com/mosby/">文章</a><br>你能在这了解到MVP基础，VIEW状态和Loading-Content-Error</p>
<p>另一个有用的工具是<a target="_blank" rel="noopener" href="http://developer.android.com/tools/data-binding/guide.html">DataBinding</a>。它能使<code>View</code>和<code>Model</code>紧密耦合，双向绑定。</p>
<p>使用<code>Mosby</code>来解释MVP</p>
<p>首先设计我们要展示内容的模型类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final class ModelRepoDetail &#123;</span><br><span class="line">    public final RepoEntity repo; // the repo to display</span><br><span class="line"></span><br><span class="line">    public ModelRepoDetail(final RepoEntity poRepo) &#123;</span><br><span class="line">        repo = poRepo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们定义了对应的<code>View</code>接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface ViewRepoDetail extends MvpLceView&lt;ModelRepoDetail&gt; &#123;</span><br><span class="line">    void showEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步是定义<code>Presenter</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">@AutoInjector(ApplicationAndroidStarter.class) // to automatically add inject method in component</span><br><span class="line">public final class PresenterRepoDetail extends MvpBasePresenter&lt;ViewRepoDetail&gt; &#123;</span><br><span class="line"></span><br><span class="line">    //region Injected fields</span><br><span class="line">    @Inject</span><br><span class="line">    DAORepo daoRepo; // we need the DAO to load the repo from its ID</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Fields</span><br><span class="line">    private Subscription mSubscriptionGetRepo; // the RxJava subscription, to destroy it when needed</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Constructor</span><br><span class="line">    public PresenterRepoDetail() &#123;</span><br><span class="line">        // inject necessary fields via the component</span><br><span class="line">        ApplicationAndroidStarter.sharedApplication().componentApplication().inject(this);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Visible API</span><br><span class="line">    public void loadRepo(final long plRepoId, final boolean pbPullToRefresh) &#123;</span><br><span class="line">        if (isViewAttached()) &#123;</span><br><span class="line">            getView().showLoading(pbPullToRefresh);</span><br><span class="line">        &#125;</span><br><span class="line">        // get repo asynchronously via RxJava</span><br><span class="line">        rxGetRepo(plRepoId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onDestroy() &#123;</span><br><span class="line">        // destroy the RxJava subscribtion</span><br><span class="line">        if (mSubscriptionGetRepo != null) &#123;</span><br><span class="line">            mSubscriptionGetRepo.unsubscribe();</span><br><span class="line">            mSubscriptionGetRepo = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Reactive job</span><br><span class="line">    private void rxGetRepo(final long plRepoId) &#123;</span><br><span class="line">        mSubscriptionGetRepo = getDatabaseRepo(plRepoId)</span><br><span class="line">                .subscribeOn(Schedulers.newThread())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(</span><br><span class="line">                        (final RepoEntity poRepo) -&gt; &#123; // onNext</span><br><span class="line">                            if (isViewAttached()) &#123;</span><br><span class="line">                                getView().setData(new ModelRepoDetail(poRepo));</span><br><span class="line">                                if (poRepo == null) &#123;</span><br><span class="line">                                    getView().showEmpty();</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    getView().showContent();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        (final Throwable poException) -&gt; &#123; // onError</span><br><span class="line">                            mSubscriptionGetRepo = null;</span><br><span class="line">                            if (isViewAttached()) &#123;</span><br><span class="line">                                getView().showError(poException, false);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        () -&gt; &#123; // onCompleted</span><br><span class="line">                            mSubscriptionGetRepo = null;</span><br><span class="line">                        &#125;</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Database job</span><br><span class="line">    @RxLogObservable</span><br><span class="line">    private Observable&lt;RepoEntity&gt; getDatabaseRepo(final long plRepoId) &#123;</span><br><span class="line">        return daoRepo.rxQueryForId(plRepoId);</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要代码放在<code>rxGetRepo</code>方法中。它从数据库加载数据,然后刷新UI</p>
<p>我们来看一下<code>FragmentRepoDetail</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">@FragmentWithArgs</span><br><span class="line">public class FragmentRepoDetail</span><br><span class="line">        extends MvpFragment&lt;ViewRepoDetail, PresenterRepoDetail&gt;</span><br><span class="line">        implements ViewRepoDetail &#123;</span><br><span class="line"></span><br><span class="line">    //region FragmentArgs</span><br><span class="line">    @Arg</span><br><span class="line">    Long mItemId;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Fields</span><br><span class="line">    private Switcher mSwitcher;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Injected views</span><br><span class="line">    @Bind(R.id.FragmentRepoDetail_TextView_Empty)</span><br><span class="line">    TextView mTextViewEmpty;</span><br><span class="line">    @Bind(R.id.FragmentRepoDetail_TextView_Error)</span><br><span class="line">    TextView mTextViewError;</span><br><span class="line">    @Bind(R.id.FragmentRepoDetail_ProgressBar_Loading)</span><br><span class="line">    ProgressBar mProgressBarLoading;</span><br><span class="line">    @Bind(R.id.FragmentRepoDetail_ContentView)</span><br><span class="line">    LinearLayout mContentView;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Data-binding</span><br><span class="line">    private FragmentRepoDetailBinding mBinding;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Default constructor</span><br><span class="line">    public FragmentRepoDetail() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region Lifecycle</span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(final Bundle poSavedInstanceState) &#123;</span><br><span class="line">        super.onCreate(poSavedInstanceState);</span><br><span class="line">        FragmentArgs.inject(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(final LayoutInflater poInflater, final ViewGroup poContainer,</span><br><span class="line">                             final Bundle savedInstanceState) &#123;</span><br><span class="line">        mBinding = DataBindingUtil.inflate(poInflater, R.layout.fragment_repo_detail, poContainer, false);</span><br><span class="line">        return mBinding.getRoot();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onViewCreated(final View poView, final Bundle poSavedInstanceState) &#123;</span><br><span class="line">        super.onViewCreated(poView, poSavedInstanceState);</span><br><span class="line"></span><br><span class="line">        ButterKnife.bind(this, poView);</span><br><span class="line"></span><br><span class="line">        mSwitcher = new Switcher.Builder()</span><br><span class="line">                .withEmptyView(mTextViewEmpty)</span><br><span class="line">                .withProgressView(mProgressBarLoading)</span><br><span class="line">                .withErrorView(mTextViewError)</span><br><span class="line">                .withContentView(mContentView)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        loadData(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onDestroyView() &#123;</span><br><span class="line">        super.onDestroyView();</span><br><span class="line"></span><br><span class="line">        ButterKnife.unbind(this);</span><br><span class="line"></span><br><span class="line">        if (mBinding != null) &#123;</span><br><span class="line">            mBinding.unbind();</span><br><span class="line">            mBinding = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region MvpFragment</span><br><span class="line">    @Override</span><br><span class="line">    public PresenterRepoDetail createPresenter() &#123;</span><br><span class="line">        return new PresenterRepoDetail();</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region ViewRepoDetail</span><br><span class="line">    @Override</span><br><span class="line">    public void showEmpty() &#123;</span><br><span class="line">        mSwitcher.showEmptyView();</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line"></span><br><span class="line">    //region MvpLceView</span><br><span class="line">    @Override</span><br><span class="line">    public void showContent() &#123;</span><br><span class="line">        mSwitcher.showContentView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void showLoading(final boolean pbPullToRefresh) &#123;</span><br><span class="line">        mSwitcher.showProgressView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void showError(final Throwable poThrowable, final boolean pbPullToRefresh) &#123;</span><br><span class="line">        mSwitcher.showErrorView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setData(final ModelRepoDetail poData) &#123;</span><br><span class="line">        mBinding.setRepo(poData.repo);</span><br><span class="line"></span><br><span class="line">        final Activity loActivity = this.getActivity();</span><br><span class="line">        final CollapsingToolbarLayout loAppBarLayout = (CollapsingToolbarLayout) loActivity.findViewById(R.id.ActivityRepoDetail_ToolbarLayout);</span><br><span class="line">        if (loAppBarLayout != null) &#123;</span><br><span class="line">            loAppBarLayout.setTitle(poData.repo.url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void loadData(final boolean pbPullToRefresh) &#123;</span><br><span class="line">        if (mItemId == null) &#123;</span><br><span class="line">            mSwitcher.showErrorView();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            getPresenter().loadRepo(mItemId.longValue(), pbPullToRefresh);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当中的一些注解会在下一节中解释</p>
<p>我们来看一下对应的布局</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">        xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;data&gt;</span><br><span class="line">        &lt;variable</span><br><span class="line">            name=&quot;repo&quot;</span><br><span class="line">            type=&quot;fr.guddy.androidstarter.database.entities.RepoEntity&quot;/&gt;</span><br><span class="line">    &lt;/data&gt;</span><br><span class="line"></span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;</span><br><span class="line">        android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/FragmentRepoDetail_TextView_Empty&quot;</span><br><span class="line">            android:layout_width=&quot;match_parent&quot;</span><br><span class="line">            android:layout_height=&quot;match_parent&quot;</span><br><span class="line">            android:gravity=&quot;center&quot;</span><br><span class="line">            android:text=&quot;@string/empty_repo&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/FragmentRepoDetail_TextView_Error&quot;</span><br><span class="line">            android:layout_width=&quot;match_parent&quot;</span><br><span class="line">            android:layout_height=&quot;match_parent&quot;</span><br><span class="line">            android:gravity=&quot;center&quot;</span><br><span class="line">            android:text=&quot;@string/error_repo&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;ProgressBar</span><br><span class="line">            android:id=&quot;@+id/FragmentRepoDetail_ProgressBar_Loading&quot;</span><br><span class="line">            style=&quot;?android:attr/progressBarStyleLarge&quot;</span><br><span class="line">            android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_gravity=&quot;center&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;LinearLayout</span><br><span class="line">            android:id=&quot;@+id/FragmentRepoDetail_ContentView&quot;</span><br><span class="line">            android:layout_width=&quot;match_parent&quot;</span><br><span class="line">            android:layout_height=&quot;match_parent&quot;</span><br><span class="line">            android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line"></span><br><span class="line">            &lt;TextView</span><br><span class="line">                android:id=&quot;@+id/FragmentRepoDetail_TextView_Name&quot;</span><br><span class="line">                style=&quot;?android:attr/textAppearanceLarge&quot;</span><br><span class="line">                android:layout_width=&quot;match_parent&quot;</span><br><span class="line">                android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">                android:padding=&quot;16dp&quot;</span><br><span class="line">                android:text=&quot;@&#123;repo.name&#125;&quot;</span><br><span class="line">                android:textIsSelectable=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;TextView</span><br><span class="line">                android:id=&quot;@+id/FragmentRepoDetail_TextView_Location&quot;</span><br><span class="line">                style=&quot;?android:attr/textAppearanceMedium&quot;</span><br><span class="line">                android:layout_width=&quot;match_parent&quot;</span><br><span class="line">                android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">                android:padding=&quot;16dp&quot;</span><br><span class="line">                android:text=&quot;@&#123;repo.location&#125;&quot;</span><br><span class="line">                android:textIsSelectable=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line">            &lt;TextView</span><br><span class="line">                android:id=&quot;@+id/FragmentRepoDetail_TextView_Url&quot;</span><br><span class="line">                style=&quot;?android:attr/textAppearanceSmall&quot;</span><br><span class="line">                android:layout_width=&quot;match_parent&quot;</span><br><span class="line">                android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">                android:padding=&quot;16dp&quot;</span><br><span class="line">                android:text=&quot;@&#123;repo.url&#125;&quot;</span><br><span class="line">                android:textIsSelectable=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/LinearLayout&gt;</span><br><span class="line">    &lt;/FrameLayout&gt;</span><br><span class="line">&lt;/layout&gt;</span><br></pre></td></tr></table></figure>

<p>多亏了MVP架构，我们收获良多</p>
<ul>
<li>独立的类来加载和展示对应的数据：<code>Presenter</code></li>
<li>要展示的数据: <code>Model</code></li>
<li>展示的方式: <code>View</code></li>
</ul>
<p>###写更轻量的类</p>
<p>####注解和注解处理器的好处<br><code>android-apt</code>是<code>Android</code> 开发的一大进步。</p>
<p>它允许开发者在<code>gradle</code>文件中配置编译时的注解处理。很多库用它来生成模板代码。</p>
<p>####Butter Knife<br>####FragmentArgs<br>####IntentBuilder<br>####Icepick<br>####OnActivityResult<br>####Project Lombok<br>####Switcher</p>
<p>###Testing<br><a target="_blank" rel="noopener" href="https://github.com/ignaciotcrespo/frutilla">frutilla</a><br>####Fluent assertions</p>
<ul>
<li>truth</li>
<li>AssertJ</li>
<li>AssertJ Android</li>
</ul>
<p>####Mocking<br>####UI testing<br>####Code coverage</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">   buildTypes &#123;</span><br><span class="line">      debug &#123;</span><br><span class="line">         testCoverageEnabled = true</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###Code quality</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://checkstyle.sourceforge.net/">CheckStyle</a></li>
<li><a target="_blank" rel="noopener" href="http://findbugs.sourceforge.net/">FindBugs</a></li>
<li><a target="_blank" rel="noopener" href="http://pmd.github.io/">PMD</a></li>
<li><a target="_blank" rel="noopener" href="http://tools.android.com/tips/lint">Android Lint</a></li>
</ul>
<p>###Relevant libraries
 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/06/04/analysis-recyclerview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/04/analysis-recyclerview/" class="post-title-link" itemprop="url">recyclerview-structure</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-04 16:51:53" itemprop="dateCreated datePublished" datetime="2016-06-04T16:51:53+08:00">2016-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-08 18:12:50" itemprop="dateModified" datetime="2022-06-08T18:12:50+08:00">2022-06-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本系列主要分析<code>RecyclerView</code>的源码。本文主要分析<code>RecyclerView</code>的源码结构，以及其各机构的作用。首先来看一下<code>RecyclerView</code>的源码结构:</p>
<img data-src="/2016/06/04/analysis-recyclerview/RecyclerView.jpg" class="">

<p>从图上可以看出<code>RecyclerView</code>依赖了很多别的类。接下来我们首先介绍各个类的作用。</p>
<ul>
<li>RecyclerViewDataObserver 数据观察器</li>
<li>Recycler View循环复用系统，核心部件</li>
<li>SavedState RecyclerView状态</li>
<li>AdapterHelper 适配器更新</li>
<li>ChildHelper 管理子View</li>
<li>ViewInfoStore 存储子VIEW的动画信息</li>
<li>Adapter 数据适配器</li>
<li>LayoutManager 负责子VIEW的布局，核心部件</li>
<li>ItemAnimator Item动画</li>
<li>ViewFlinger 快速滑动管理</li>
<li>NestedScrollingChildHelper 管理子VIEW嵌套滑动</li>
</ul>
<p>###创建布局管理器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">private void createLayoutManager(Context context, String className, AttributeSet attrs,</span><br><span class="line">            int defStyleAttr, int defStyleRes) &#123;</span><br><span class="line">        if (className != null) &#123;</span><br><span class="line">            className = className.trim();</span><br><span class="line">            if (className.length() != 0) &#123;  // Can&#x27;t use isEmpty since it was added in API 9.</span><br><span class="line">                className = getFullClassName(context, className);</span><br><span class="line">                try &#123;</span><br><span class="line">                    ClassLoader classLoader;</span><br><span class="line">                    if (isInEditMode()) &#123;</span><br><span class="line">                        // Stupid layoutlib cannot handle simple class loaders.</span><br><span class="line">                        classLoader = this.getClass().getClassLoader();</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        classLoader = context.getClassLoader();</span><br><span class="line">                    &#125;</span><br><span class="line">                    Class&lt;? extends LayoutManager&gt; layoutManagerClass =</span><br><span class="line">                            classLoader.loadClass(className).asSubclass(LayoutManager.class);</span><br><span class="line">                    Constructor&lt;? extends LayoutManager&gt; constructor;</span><br><span class="line">                    Object[] constructorArgs = null;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        constructor = layoutManagerClass</span><br><span class="line">                                .getConstructor(LAYOUT_MANAGER_CONSTRUCTOR_SIGNATURE);</span><br><span class="line">                        constructorArgs = new Object[]&#123;context, attrs, defStyleAttr, defStyleRes&#125;;</span><br><span class="line">                    &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            constructor = layoutManagerClass.getConstructor();</span><br><span class="line">                        &#125; catch (NoSuchMethodException e1) &#123;</span><br><span class="line">                            e1.initCause(e);</span><br><span class="line">                            throw new IllegalStateException(attrs.getPositionDescription() +</span><br><span class="line">                                    &quot;: Error creating LayoutManager &quot; + className, e1);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    constructor.setAccessible(true);</span><br><span class="line">                    setLayoutManager(constructor.newInstance(constructorArgs));</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    throw new IllegalStateException(attrs.getPositionDescription()</span><br><span class="line">                            + &quot;: Unable to find LayoutManager &quot; + className, e);</span><br><span class="line">                &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">                    throw new IllegalStateException(attrs.getPositionDescription()</span><br><span class="line">                            + &quot;: Could not instantiate the LayoutManager: &quot; + className, e);</span><br><span class="line">                &#125; catch (InstantiationException e) &#123;</span><br><span class="line">                    throw new IllegalStateException(attrs.getPositionDescription()</span><br><span class="line">                            + &quot;: Could not instantiate the LayoutManager: &quot; + className, e);</span><br><span class="line">                &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">                    throw new IllegalStateException(attrs.getPositionDescription()</span><br><span class="line">                            + &quot;: Cannot access non-public constructor &quot; + className, e);</span><br><span class="line">                &#125; catch (ClassCastException e) &#123;</span><br><span class="line">                    throw new IllegalStateException(attrs.getPositionDescription()</span><br><span class="line">                            + &quot;: Class is not a LayoutManager &quot; + className, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果在布局文件里面设置了布局管理器的类型，那么这里会通过反射的方式实例化出对应的布局管理器。最后将实例化出的布局管理器设置到当前的<code>RecyclerView</code></p>
<p>###设置布局管理器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public void setLayoutManager(LayoutManager layout) &#123;</span><br><span class="line">        if (layout == mLayout) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //停止滚动</span><br><span class="line">        stopScroll();</span><br><span class="line">        // TODO We should do this switch a dispachLayout pass and animate children. There is a good</span><br><span class="line">        // chance that LayoutManagers will re-use views.</span><br><span class="line">        if (mLayout != null) &#123;</span><br><span class="line">            if (mIsAttached) &#123;</span><br><span class="line">                mLayout.dispatchDetachedFromWindow(this, mRecycler);</span><br><span class="line">            &#125;</span><br><span class="line">            mLayout.setRecyclerView(null);</span><br><span class="line">        &#125;</span><br><span class="line">        //清空缓存</span><br><span class="line">        mRecycler.clear();</span><br><span class="line">        mChildHelper.removeAllViewsUnfiltered();</span><br><span class="line">        mLayout = layout;</span><br><span class="line">        if (layout != null) &#123;</span><br><span class="line">            if (layout.mRecyclerView != null) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;LayoutManager &quot; + layout +</span><br><span class="line">                        &quot; is already attached to a RecyclerView: &quot; + layout.mRecyclerView);</span><br><span class="line">            &#125;</span><br><span class="line">            mLayout.setRecyclerView(this);</span><br><span class="line">            if (mIsAttached) &#123;</span><br><span class="line">                mLayout.dispatchAttachedToWindow(this);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        requestLayout();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>设置布局管理器之前会先清空所有之前的缓存VIEW。最后通知VIEW刷新</p>
<p>###onMeasure<br>onMeasure这个回调方法用于测量<code>VIEW</code>的大小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">protected void onMeasure(int widthSpec, int heightSpec) &#123;</span><br><span class="line">        if (mLayout == null) &#123;</span><br><span class="line">            defaultOnMeasure(widthSpec, heightSpec);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (mLayout.mAutoMeasure) &#123;</span><br><span class="line">            final int widthMode = MeasureSpec.getMode(widthSpec);</span><br><span class="line">            final int heightMode = MeasureSpec.getMode(heightSpec);</span><br><span class="line">            final boolean skipMeasure = widthMode == MeasureSpec.EXACTLY</span><br><span class="line">                    &amp;&amp; heightMode == MeasureSpec.EXACTLY;</span><br><span class="line">            mLayout.onMeasure(mRecycler, mState, widthSpec, heightSpec);</span><br><span class="line">            if (skipMeasure || mAdapter == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (mState.mLayoutStep == State.STEP_START) &#123;</span><br><span class="line">                dispatchLayoutStep1();</span><br><span class="line">            &#125;</span><br><span class="line">            // set dimensions in 2nd step. Pre-layout should happen with old dimensions for</span><br><span class="line">            // consistency</span><br><span class="line">            mLayout.setMeasureSpecs(widthSpec, heightSpec);</span><br><span class="line">            mState.mIsMeasuring = true;</span><br><span class="line">            dispatchLayoutStep2();</span><br><span class="line"></span><br><span class="line">            // now we can get the width and height from the children.</span><br><span class="line">            mLayout.setMeasuredDimensionFromChildren(widthSpec, heightSpec);</span><br><span class="line"></span><br><span class="line">            // if RecyclerView has non-exact width and height and if there is at least one child</span><br><span class="line">            // which also has non-exact width &amp; height, we have to re-measure.</span><br><span class="line">            if (mLayout.shouldMeasureTwice()) &#123;</span><br><span class="line">                mLayout.setMeasureSpecs(</span><br><span class="line">                        MeasureSpec.makeMeasureSpec(getMeasuredWidth(), MeasureSpec.EXACTLY),</span><br><span class="line">                        MeasureSpec.makeMeasureSpec(getMeasuredHeight(), MeasureSpec.EXACTLY));</span><br><span class="line">                mState.mIsMeasuring = true;</span><br><span class="line">                dispatchLayoutStep2();</span><br><span class="line">                // now we can get the width and height from the children.</span><br><span class="line">                mLayout.setMeasuredDimensionFromChildren(widthSpec, heightSpec);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (mHasFixedSize) &#123;</span><br><span class="line">                mLayout.onMeasure(mRecycler, mState, widthSpec, heightSpec);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            // custom onMeasure</span><br><span class="line">            if (mAdapterUpdateDuringMeasure) &#123;</span><br><span class="line">                eatRequestLayout();</span><br><span class="line">                processAdapterUpdatesAndSetAnimationFlags();</span><br><span class="line"></span><br><span class="line">                if (mState.mRunPredictiveAnimations) &#123;</span><br><span class="line">                    mState.mInPreLayout = true;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // consume remaining updates to provide a consistent state with the layout pass.</span><br><span class="line">                    mAdapterHelper.consumeUpdatesInOnePass();</span><br><span class="line">                    mState.mInPreLayout = false;</span><br><span class="line">                &#125;</span><br><span class="line">                mAdapterUpdateDuringMeasure = false;</span><br><span class="line">                resumeRequestLayout(false);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (mAdapter != null) &#123;</span><br><span class="line">                mState.mItemCount = mAdapter.getItemCount();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mState.mItemCount = 0;</span><br><span class="line">            &#125;</span><br><span class="line">            eatRequestLayout();</span><br><span class="line">            mLayout.onMeasure(mRecycler, mState, widthSpec, heightSpec);</span><br><span class="line">            resumeRequestLayout(false);</span><br><span class="line">            mState.mInPreLayout = false; // clear</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从上述代码可以看出，</p>
<ul>
<li>如果布局是空的，那么<code>RecyclerView</code>会创建调用<code>defaultOnMeasure</code>方法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Used when onMeasure is called before layout manager is set</span><br><span class="line">    */</span><br><span class="line">   void defaultOnMeasure(int widthSpec, int heightSpec) &#123;</span><br><span class="line">       // calling LayoutManager here is not pretty but that API is already public and it is better</span><br><span class="line">       // than creating another method since this is internal.</span><br><span class="line">       final int width = LayoutManager.chooseSize(widthSpec,</span><br><span class="line">               getPaddingLeft() + getPaddingRight(),</span><br><span class="line">               ViewCompat.getMinimumWidth(this));</span><br><span class="line">       final int height = LayoutManager.chooseSize(heightSpec,</span><br><span class="line">               getPaddingTop() + getPaddingBottom(),</span><br><span class="line">               ViewCompat.getMinimumHeight(this));</span><br><span class="line"></span><br><span class="line">       setMeasuredDimension(width, height);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>默认测量是布局管理器根据指定的宽，高规格，算出宽高。</p>
<ul>
<li>如果是自动布局，如果宽高都是明确指定的，那么跳过测量。否则，如果</li>
<li>目前是初始阶段，那么调用<code>dispatchLayoutStep1</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * The first step of a layout where we;</span><br><span class="line">    * - process adapter updates</span><br><span class="line">    * - decide which animation should run</span><br><span class="line">    * - save information about current views</span><br><span class="line">    * - If necessary, run predictive layout and save its information</span><br><span class="line">    */</span><br></pre></td></tr></table></figure>
<ul>
<li>第二步，用老的尺寸规格来预布局，然后调用<code>dispatchLayoutStep2</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void dispatchLayoutStep2() &#123;</span><br><span class="line">        eatRequestLayout();</span><br><span class="line">        onEnterLayoutOrScroll();</span><br><span class="line">        mState.assertLayoutStep(State.STEP_LAYOUT | State.STEP_ANIMATIONS);</span><br><span class="line">        mAdapterHelper.consumeUpdatesInOnePass();</span><br><span class="line">        mState.mItemCount = mAdapter.getItemCount();</span><br><span class="line">        mState.mDeletedInvisibleItemCountSincePreviousLayout = 0;</span><br><span class="line"></span><br><span class="line">        // Step 2: Run layout</span><br><span class="line">        mState.mInPreLayout = false;</span><br><span class="line">        mLayout.onLayoutChildren(mRecycler, mState);</span><br><span class="line"></span><br><span class="line">        mState.mStructureChanged = false;</span><br><span class="line">        mPendingSavedState = null;</span><br><span class="line"></span><br><span class="line">        // onLayoutChildren may have caused client code to disable item animations; re-check</span><br><span class="line">        mState.mRunSimpleAnimations = mState.mRunSimpleAnimations &amp;&amp; mItemAnimator != null;</span><br><span class="line">        mState.mLayoutStep = State.STEP_ANIMATIONS;</span><br><span class="line">        onExitLayoutOrScroll();</span><br><span class="line">        resumeRequestLayout(false);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这之后我们就能够获取子<code>VIEW</code>的宽高了。如果<code>RecyclerView</code>没有明确的宽高，那么我们需要再次测量，然后重复上述步骤。</li>
<li>如果不是自动布局，如果是固定大小，那么直接用现有规格测量。否则首先进行一些动画前置操作，最后依然由布局管理器来测量。</li>
</ul>
<p>###onLayout<br><code>onLayout</code>是确定位置时的回调方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onLayout(boolean changed, int l, int t, int r, int b) &#123;</span><br><span class="line">       TraceCompat.beginSection(TRACE_ON_LAYOUT_TAG);</span><br><span class="line">       dispatchLayout();</span><br><span class="line">       TraceCompat.endSection();</span><br><span class="line">       mFirstLayoutComplete = true;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>dispatchLayout</code>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">void dispatchLayout() &#123;</span><br><span class="line">       if (mAdapter == null) &#123;</span><br><span class="line">           Log.e(TAG, &quot;No adapter attached; skipping layout&quot;);</span><br><span class="line">           // leave the state in START</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       if (mLayout == null) &#123;</span><br><span class="line">           Log.e(TAG, &quot;No layout manager attached; skipping layout&quot;);</span><br><span class="line">           // leave the state in START</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       mState.mIsMeasuring = false;</span><br><span class="line">       if (mState.mLayoutStep == State.STEP_START) &#123;</span><br><span class="line">           dispatchLayoutStep1();</span><br><span class="line">           mLayout.setExactMeasureSpecsFrom(this);</span><br><span class="line">           dispatchLayoutStep2();</span><br><span class="line">       &#125; else if (mAdapterHelper.hasUpdates() || mLayout.getWidth() != getWidth() ||</span><br><span class="line">               mLayout.getHeight() != getHeight()) &#123;</span><br><span class="line">           // First 2 steps are done in onMeasure but looks like we have to run again due to</span><br><span class="line">           // changed size.</span><br><span class="line">           mLayout.setExactMeasureSpecsFrom(this);</span><br><span class="line">           dispatchLayoutStep2();</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           // always make sure we sync them (to ensure mode is exact)</span><br><span class="line">           mLayout.setExactMeasureSpecsFrom(this);</span><br><span class="line">       &#125;</span><br><span class="line">       dispatchLayoutStep3();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果是初始状态，调用<code>dispatchLayoutStep1</code>，测量，调用<code>dispatchLayoutStep2</code>。如果高度或宽度发生变化，测量，调用<code>dispatchLayoutStep2</code>。其他情况制作测量。最后统一调用<code>dispatchLayoutStep3</code>主要处理动画。</li>
</ul>
<p>###onDraw<br><code>onDraw</code>是绘制时的回调  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void onDraw(Canvas c) &#123;</span><br><span class="line">       super.onDraw(c);</span><br><span class="line"></span><br><span class="line">       final int count = mItemDecorations.size();</span><br><span class="line">       for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">           mItemDecorations.get(i).onDraw(c, this, mState);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>主要对<code>ItemDecoration</code>的绘制</p>
<p>至此，<code>RecyclerView</code>的主要回调方法已经简单介绍完毕。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Binea</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
