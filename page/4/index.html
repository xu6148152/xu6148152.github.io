<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xu6148152.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://xu6148152.github.io/page/4/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale">
<meta property="article:author" content="Binea">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://xu6148152.github.io/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"default","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Binea</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/05/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8%EF%BC%8C%E4%BF%AE%E6%94%B9%EF%BC%8C%E5%9B%9E%E6%94%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/05/13/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8%EF%BC%8C%E4%BF%AE%E6%94%B9%EF%BC%8C%E5%9B%9E%E6%94%B6/" class="post-title-link" itemprop="url">深入理解Python之对象引用，修改，回收</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-05-13 16:58:50" itemprop="dateCreated datePublished" datetime="2017-05-13T16:58:50+08:00">2017-05-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="变量不是盒子"><a href="#变量不是盒子" class="headerlink" title="变量不是盒子"></a>变量不是盒子</h2><p><code>Python</code>变量就像<code>Java</code>的引用变量。<code>Python</code>变量应该当成是对象的标签</p>
<h2 id="定义，相等，别名"><a href="#定义，相等，别名" class="headerlink" title="定义，相等，别名"></a>定义，相等，别名</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">charles = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Charles L. Dodgson&#x27;</span>, <span class="string">&#x27;born&#x27;</span>: <span class="number">1832</span>&#125;</span><br><span class="line"></span><br><span class="line">lewis = charles</span><br><span class="line"><span class="built_in">print</span>(lewis <span class="keyword">is</span> charles)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(charles), <span class="built_in">id</span>(lewis))</span><br><span class="line"></span><br><span class="line">lewis[<span class="string">&#x27;balance&#x27;</span>] = <span class="number">950</span></span><br><span class="line"><span class="built_in">print</span>(charles)</span><br><span class="line"></span><br><span class="line">alex = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Charles L. Dodgson&#x27;</span>, <span class="string">&#x27;born&#x27;</span>: <span class="number">1832</span>, <span class="string">&#x27;balance&#x27;</span>: <span class="number">950</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(alex == charles)</span><br><span class="line"><span class="built_in">print</span>(alex <span class="keyword">is</span> charles)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>charles</code>和<code>lewis</code>引用的是相同的对象</li>
<li><code>alex</code>对象的内容与<code>charles</code>相同，但不是引用相同的对象,<code>Python</code>的<code>==</code>，比较的是对象的属相。<code>is</code>操作符比较的是对象的<code>id</code>，对象的<code>id</code>是创建时就确定了，永远不会改变了。</li>
</ul>
<h3 id="x3D-x3D-和is"><a href="#x3D-x3D-和is" class="headerlink" title="&#x3D;&#x3D;和is"></a>&#x3D;&#x3D;和is</h3><p><code>==</code>操作符比较对象的值</p>
<p>判断对象是否为<code>None</code>，更合理的方式是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p><code>is</code>操作符速度比<code>==</code>快，因为它不能被重载，因此<code>Python</code>不用寻找特殊的方法来计算它。只需要简单的比较它们的<code>id</code>就可以了。对于<code>a==b</code>，其实背后使用的是<code>a.__eq__(b)</code>,<code>__eq__</code>是从<code>Object</code>继承用于比较对象的<code>id</code>，因此效果和<code>is</code>一样.但是很多内置的类型重载了<code>__eq__</code>，做了更多的操作比较对象属性的值。因此<code>==</code>可能会产生额外的计算。</p>
<h3 id="Tuple相对不可修改"><a href="#Tuple相对不可修改" class="headerlink" title="Tuple相对不可修改"></a>Tuple相对不可修改</h3><p>元组跟大多数的<code>Python</code>的集合–<code>lists,dicts,sets</code>一样，都是持有对象们的引用。如果引用类型和修改，那么元组自身不可修改，而内部条目可以修改。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t1 = (<span class="number">1</span>, <span class="number">2</span>, [<span class="number">30</span>, <span class="number">40</span>])</span><br><span class="line">t2 = (<span class="number">1</span>, <span class="number">2</span>, [<span class="number">30</span>, <span class="number">40</span>])</span><br><span class="line"><span class="built_in">print</span>(t1 == t2)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(t1[-<span class="number">1</span>]))</span><br><span class="line">t1[-<span class="number">1</span>].append(<span class="number">99</span>)</span><br><span class="line"><span class="built_in">print</span>(t1)</span><br><span class="line"><span class="built_in">print</span>(t1 == t2)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>t1</code>是不可修改的，<code>t[-1]</code>可修改</li>
<li><code>t1</code>和<code>t2</code>的内容一样。修改<code>t2</code>的条目的内容，这个时候<code>t1</code>和<code>t2</code>不相同了</li>
</ul>
<h2 id="默认浅拷贝"><a href="#默认浅拷贝" class="headerlink" title="默认浅拷贝"></a>默认浅拷贝</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">l1 = [<span class="number">3</span>, [<span class="number">55</span>, <span class="number">44</span>], (<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>)]</span><br><span class="line">l2 = <span class="built_in">list</span>(l1)</span><br><span class="line"><span class="built_in">print</span>(l2)</span><br><span class="line"><span class="built_in">print</span>(l1 == l2)</span><br><span class="line"><span class="built_in">print</span>(l1 <span class="keyword">is</span> l2)</span><br><span class="line"></span><br><span class="line">l3 = l1[:]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>l2</code>由<code>l1</code>拷贝，值相等，但对象不相同</li>
<li><code>l3</code>由<code>l1</code>拷贝</li>
<li>两种方式的拷贝都属于浅拷贝。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">l1 = [<span class="number">3</span>, [<span class="number">66</span>, <span class="number">55</span>, <span class="number">44</span>], (<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>)]</span><br><span class="line">l2 = <span class="built_in">list</span>(l1)</span><br><span class="line">l1.append(<span class="number">100</span>)</span><br><span class="line">l1[<span class="number">1</span>].remove(<span class="number">55</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;l1:&#x27;</span>, l1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;l2:&#x27;</span>, l2)</span><br><span class="line">l2[<span class="number">1</span>] += [<span class="number">33</span>, <span class="number">22</span>]</span><br><span class="line">l2[<span class="number">2</span>] += (<span class="number">10</span>, <span class="number">11</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;l1:&#x27;</span>, l1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;l2:&#x27;</span>, l2)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>l2</code>是<code>l1</code>的浅拷贝。<code>l1[1]</code>移除55。这也会影响到<code>l2</code></li>
</ul>
<h3 id="任意对象的深浅拷贝"><a href="#任意对象的深浅拷贝" class="headerlink" title="任意对象的深浅拷贝"></a>任意对象的深浅拷贝</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bus</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, passengers=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> passengers <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.passengers = []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.passengers = <span class="built_in">list</span>(passengers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pick</span>(<span class="params">self, name</span>):</span><br><span class="line">        self.passengers.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">drop</span>(<span class="params">self, name</span>):</span><br><span class="line">        self.passengers.remove(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">bus1 = Bus([<span class="string">&#x27;Alice&#x27;</span>, <span class="string">&#x27;Bill&#x27;</span>, <span class="string">&#x27;Claire&#x27;</span>, <span class="string">&#x27;David&#x27;</span>])</span><br><span class="line">bus2 = copy.copy(bus1)</span><br><span class="line">bus3 = copy.deepcopy(bus1)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(bus1), <span class="built_in">id</span>(bus2), <span class="built_in">id</span>(bus3))</span><br><span class="line"></span><br><span class="line">bus1.drop(<span class="string">&#x27;Bill&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(bus1.passengers)</span><br><span class="line"><span class="built_in">print</span>(bus2.passengers)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">id</span>(bus1.passengers), <span class="built_in">id</span>(bus2.passengers), <span class="built_in">id</span>(bus3.passengers))</span><br><span class="line"><span class="built_in">print</span>(bus3.passengers)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>bus2</code>是<code>bus1</code>的浅拷贝,<code>bus3</code>是<code>bus1</code>的深拷贝</li>
</ul>
<h2 id="删除和垃圾回收"><a href="#删除和垃圾回收" class="headerlink" title="删除和垃圾回收"></a>删除和垃圾回收</h2><p><code>del</code>表达式仅删除名字，不会删除对象。执行<code>del</code>表达式之后，对象可能会被回收。但只有在删除了最后一个引用对象的变量，才会被回收掉。<code>CPython</code>垃圾回收的基本算法是引用计数。<code>CPython2.0</code>，引入了新的垃圾回收算法，可以删除循环引用的对象组</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">s1 = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">s2 = s1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bye</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Gone with the wind&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ender = weakref.finalize(s1, bye)</span><br><span class="line"><span class="built_in">print</span>(ender.alive)</span><br><span class="line"><span class="keyword">del</span> s1</span><br><span class="line"><span class="built_in">print</span>(ender.alive)</span><br><span class="line">s2 = <span class="string">&#x27;spam&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(ender.alive)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>s1</code>,<code>s2</code>指向相同的对象</li>
<li>使用<code>weakref</code>来监控<code>s1</code>的状态</li>
<li>执行<code>del s1</code>,对象还被<code>s2</code>引用没有被回收</li>
<li>改变<code>s2</code>的引用，这个时候对象被回收</li>
</ul>
<h2 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h2><p>弱引用不增加引用计数。弱引用不阻止垃圾回收</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a_set = &#123;<span class="number">0</span>, <span class="number">1</span>&#125;</span><br><span class="line">wref = weakref.ref(a_set)</span><br><span class="line"><span class="built_in">print</span>(wref)</span><br><span class="line"><span class="built_in">print</span>(wref())</span><br><span class="line"></span><br><span class="line">a_set = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(wref())</span><br><span class="line"><span class="built_in">print</span>(wref() <span class="keyword">is</span> <span class="literal">None</span>)</span><br><span class="line"><span class="built_in">print</span>(wref() <span class="keyword">is</span> <span class="literal">None</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="WeakValueDictionary"><a href="#WeakValueDictionary" class="headerlink" title="WeakValueDictionary"></a>WeakValueDictionary</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cheese</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, kind</span>):</span><br><span class="line">        self.kind = kind</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Cheese(%r)&#x27;</span> % self.kind</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> weakref</span><br><span class="line"></span><br><span class="line">stock = weakref.WeakKeyDictionary()</span><br><span class="line">catalog = [Cheese(<span class="string">&#x27;Red Leicester&#x27;</span>), Cheese(<span class="string">&#x27;Tilsit&#x27;</span>), Cheese(<span class="string">&#x27;Brie&#x27;</span>), Cheese(<span class="string">&#x27;Parmesan&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> cheese <span class="keyword">in</span> catalog:</span><br><span class="line">    stock[cheese.kind] = cheese</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(stock.keys()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> catalog</span><br><span class="line"><span class="built_in">print</span>(stock.keys())</span><br><span class="line"><span class="keyword">del</span> cheese</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(stock.keys()))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="弱引用的限制"><a href="#弱引用的限制" class="headerlink" title="弱引用的限制"></a>弱引用的限制</h3><p>不是所有的<code>Python</code>对象都能使用弱引用。基本<code>list</code>和<code>dict</code>都不能被引用。但它们的纯净子类可以。<code>Set</code>也可以</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/05/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8%E5%92%8C%E9%97%AD%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/05/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8%E5%92%8C%E9%97%AD%E5%8C%85/" class="post-title-link" itemprop="url">深入理解Python之函数装饰器和闭包</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-05-06 16:58:34 / Modified: 17:00:17" itemprop="dateCreated datePublished" datetime="2017-05-06T16:58:34+08:00">2017-05-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>函数装饰器用于标识函数来增强功能。它很强大，掌握它需要理解闭包。本文主要讲述函数装饰器如何工作。</p>
<h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><h4 id="装饰器101"><a href="#装饰器101" class="headerlink" title="装饰器101"></a>装饰器101</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@decorate</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">target</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running target()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># the same</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">target</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running target()&#x27;</span>)</span><br><span class="line">target = decorate(target)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>装饰器就是以装饰的函数作为参数的函数调用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deco</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;running inner()&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@deco</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">target</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running target()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># result running innner()</span></span><br></pre></td></tr></table></figure>


<h4 id="Python什么时候执行装饰器"><a href="#Python什么时候执行装饰器" class="headerlink" title="Python什么时候执行装饰器"></a>Python什么时候执行装饰器</h4><p>装饰器的一项关键功能是被装饰的函数定义之后立即被执行，通常在<em>import</em>的时候</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">registry = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running register(%s)&#x27;</span> % func)</span><br><span class="line">    registry.append(func)</span><br><span class="line">    <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@register</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running f1()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@register</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f2</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running f2()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@register</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f3</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running f3()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running main()&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;registry -&gt;&#x27;</span>, registry)</span><br><span class="line">    f1()</span><br><span class="line">    f2()</span><br><span class="line">    f3()</span><br><span class="line"></span><br><span class="line"><span class="comment"># result:</span></span><br><span class="line">running register(&lt;function f1 at <span class="number">0x1022a8268</span>&gt;)</span><br><span class="line">running register(&lt;function f2 at <span class="number">0x1022a82f0</span>&gt;)</span><br><span class="line">running register(&lt;function f3 at <span class="number">0x1022a8378</span>&gt;)</span><br><span class="line">running main()</span><br><span class="line">registry -&gt; [&lt;function f1 at <span class="number">0x1022a8268</span>&gt;, &lt;function f2 at <span class="number">0x1022a82f0</span>&gt;, &lt;function f3 at <span class="number">0x1022a8378</span>&gt;]</span><br><span class="line">running f1()</span><br><span class="line">running f2()</span><br><span class="line">running f3()</span><br></pre></td></tr></table></figure>

<ul>
<li>装饰器在模块载入的时候执行，但被装饰的函数只有在显式触发时才会执行</li>
</ul>
<h3 id="变量作用域"><a href="#变量作用域" class="headerlink" title="变量作用域"></a>变量作用域</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">b = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f1</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="keyword">global</span> b</span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">    <span class="comment"># b is treat as local variable</span></span><br><span class="line">    b = <span class="number">9</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>f1(a)</code>中定于<code>b</code>，其会被当做本地变量，此时未赋值，直接引用会抛出异常</li>
<li>如果在函数体内加上<code>global</code>关键字，那么这个变量就表示引用的是全局变量</li>
</ul>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_averager</span>():</span><br><span class="line">    series = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">averger</span>(<span class="params">new_value</span>):</span><br><span class="line">        series.append(new_value)</span><br><span class="line">        total = <span class="built_in">sum</span>(series)</span><br><span class="line">        <span class="keyword">return</span> total / <span class="built_in">len</span>(series)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> averger</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><em>series</em>是自由变量，能被内部函数使用。闭包就是一种函数，其会保留自由变量的绑定，以便能够之后使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_averager_nonlocal</span>():</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">averager</span>(<span class="params">new_value</span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> count, total</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        total += new_value</span><br><span class="line">        <span class="keyword">return</span> total / count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> averager</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>nonlocal</code>是<code>Python3</code>引入的关键字，用于标识变量作为自由变量，当变量在函数内部需要被重新赋值使用</li>
</ul>
<h3 id="实现装饰器"><a href="#实现装饰器" class="headerlink" title="实现装饰器"></a>实现装饰器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">clock</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clocked</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        t0 = time.perf_counter()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        elapsed = time.perf_counter() - t0</span><br><span class="line">        name = func.__name__</span><br><span class="line">        arg_lst = []</span><br><span class="line">        <span class="keyword">if</span> args:</span><br><span class="line">            arg_lst.append(<span class="string">&#x27;, &#x27;</span>.join(<span class="built_in">repr</span>(arg) <span class="keyword">for</span> arg <span class="keyword">in</span> args))</span><br><span class="line">        <span class="keyword">if</span> kwargs:</span><br><span class="line">            pairs = [<span class="string">&#x27;%s=%r&#x27;</span> % (k, w) <span class="keyword">for</span> k, w <span class="keyword">in</span> <span class="built_in">sorted</span>(kwargs.items())]</span><br><span class="line">            arg_lst.append(<span class="string">&#x27;, &#x27;</span>.join(pairs))</span><br><span class="line">        arg_str = <span class="string">&#x27;, &#x27;</span>.join(arg_lst)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[%0.8fs] %s(%s) -&gt; %r&#x27;</span> % (elapsed, name, arg_str, result))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clocked</span><br><span class="line"></span><br><span class="line"><span class="meta">@clock</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">snooze</span>(<span class="params">seconds</span>):</span><br><span class="line">    time.sleep(seconds)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@clock</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">factorial</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> n &lt; <span class="number">2</span> <span class="keyword">else</span> n * factorial(n - <span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="标准库中的装饰器"><a href="#标准库中的装饰器" class="headerlink" title="标准库中的装饰器"></a>标准库中的装饰器</h3><h4 id="functools-lru-cache"><a href="#functools-lru-cache" class="headerlink" title="functools.lru_cache"></a>functools.lru_cache</h4><p>其实现内存优化，保存之前计算的结果，避免重复计算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@functools.lru_cache()</span></span><br><span class="line"><span class="meta">@clock</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fibonacci</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> n <span class="keyword">if</span> n &lt; <span class="number">2</span> <span class="keyword">else</span> fibonacci(n - <span class="number">2</span>) * fibonacci(n - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># result 未加入lru_cache</span></span><br><span class="line">[<span class="number">0.00000054</span>s] fibonacci(<span class="number">0</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000082</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00008297</span>s] fibonacci(<span class="number">2</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000038</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00000046</span>s] fibonacci(<span class="number">0</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000041</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00001262</span>s] fibonacci(<span class="number">2</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00002402</span>s] fibonacci(<span class="number">3</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00012032</span>s] fibonacci(<span class="number">4</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000041</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00000041</span>s] fibonacci(<span class="number">0</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000044</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00001188</span>s] fibonacci(<span class="number">2</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00002324</span>s] fibonacci(<span class="number">3</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000033</span>s] fibonacci(<span class="number">0</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000041</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00001188</span>s] fibonacci(<span class="number">2</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000039</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00000050</span>s] fibonacci(<span class="number">0</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000038</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00001248</span>s] fibonacci(<span class="number">2</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00002375</span>s] fibonacci(<span class="number">3</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00004736</span>s] fibonacci(<span class="number">4</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00008152</span>s] fibonacci(<span class="number">5</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00021393</span>s] fibonacci(<span class="number">6</span>) -&gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># result 加入lru_cache</span></span><br><span class="line">[<span class="number">0.00000059</span>s] fibonacci(<span class="number">0</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000067</span>s] fibonacci(<span class="number">1</span>) -&gt; <span class="number">1</span></span><br><span class="line">[<span class="number">0.00006346</span>s] fibonacci(<span class="number">2</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000114</span>s] fibonacci(<span class="number">3</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00007960</span>s] fibonacci(<span class="number">4</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00000084</span>s] fibonacci(<span class="number">5</span>) -&gt; <span class="number">0</span></span><br><span class="line">[<span class="number">0.00009436</span>s] fibonacci(<span class="number">6</span>) -&gt; <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><em>lru_cache</em>的加入，减少了一些重复的计算</li>
</ul>
<h3 id="带着SingleDispatch的通用函数"><a href="#带着SingleDispatch的通用函数" class="headerlink" title="带着SingleDispatch的通用函数"></a>带着<em>SingleDispatch</em>的通用函数</h3><p><code>Python3.4</code>中引入的<code>singledispatch</code>。其允许每个模块定制总体方案，为类提供特定的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@singledispatch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">htmlize</span>(<span class="params">obj</span>):</span><br><span class="line">    content = html.escape(<span class="built_in">repr</span>(obj))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;pre&gt;&#123;&#125;&lt;/pre&gt;&#x27;</span>.<span class="built_in">format</span>(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@htmlize.register(<span class="params"><span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_</span>(<span class="params">text</span>):</span><br><span class="line">    content = html.escape(text).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&lt;br&gt;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;p&gt;&#123;0&#125;&lt;/p&gt;&#x27;</span>.<span class="built_in">format</span>(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@htmlize.register(<span class="params">numbers.Integral</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;pre&gt;&#123;0&#125; (0x&#123;0:x&#125;)&lt;/pre&gt;&#x27;</span>.<span class="built_in">format</span>(n)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@htmlize.register(<span class="params"><span class="built_in">tuple</span></span>)</span></span><br><span class="line"><span class="meta">@htmlize.register(<span class="params">abc.MutableSequence</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_</span>(<span class="params">seq</span>):</span><br><span class="line">    inner = <span class="string">&#x27;&lt;/li&gt;\n&lt;li&gt;&#x27;</span>.join(htmlize(item) <span class="keyword">for</span> item <span class="keyword">in</span> seq)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;ul&gt;\n&lt;li&gt;&#x27;</span> + inner + <span class="string">&#x27;&lt;/li&gt;\n&lt;/ul&gt;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><em>singledispatch</em> 定义了通用模板，然后可以使用特定的方法定制化</li>
</ul>
<h3 id="堆放装饰器"><a href="#堆放装饰器" class="headerlink" title="堆放装饰器"></a>堆放装饰器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@d1</span></span><br><span class="line"><span class="meta">@d2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># same to </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">f = d1(d2(f))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="接收多个参数的装饰器"><a href="#接收多个参数的装饰器" class="headerlink" title="接收多个参数的装饰器"></a>接收多个参数的装饰器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">active=<span class="literal">True</span></span>):</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line"><span class="meta">@register(<span class="params">active=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">f1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;running f1()&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/04/29/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pyhton%E4%B9%8B%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/29/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pyhton%E4%B9%8B%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">深入理解Pyhton之函数设计模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-04-29 18:50:28 / Modified: 18:54:55" itemprop="dateCreated datePublished" datetime="2017-04-29T18:50:28+08:00">2017-04-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>虽然设计模式是语言无关。但并不意味着每种设计模式都适用于任何语言。<code>Python</code>中可以多用一些设计模式如: 策略,命令,模板方法和访问者模式。</p>
<h3 id="案例学习-Pyhton中的策略模式"><a href="#案例学习-Pyhton中的策略模式" class="headerlink" title="案例学习: Pyhton中的策略模式"></a>案例学习: Pyhton中的策略模式</h3><p><code>Python</code>使用策略模式能让你的代码更简单。</p>
<h4 id="传统策略模式"><a href="#传统策略模式" class="headerlink" title="传统策略模式"></a>传统策略模式</h4><p><img data-src="/./straetgy_uml.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Customer = namedtuple(<span class="string">&quot;Customer&quot;</span>, <span class="string">&#x27;name fidelity&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LineItem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, product, quantity, price</span>):</span><br><span class="line">        self.product = product</span><br><span class="line">        self.quantity = quantity</span><br><span class="line">        self.price = price</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">total</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.price * self.quantity</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>:  <span class="comment"># the context</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, customer, cart, promotion=<span class="literal">None</span></span>):</span><br><span class="line">        self.customer = customer</span><br><span class="line">        self.cart = <span class="built_in">list</span>(cart)</span><br><span class="line">        self.promotion = promotion</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">total</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;__total&#x27;</span>):</span><br><span class="line">            self.__total = <span class="built_in">sum</span>(item.total() <span class="keyword">for</span> item <span class="keyword">in</span> self.cart)</span><br><span class="line">        <span class="keyword">return</span> self.__total</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">due</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.promotion <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            discount = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            discount = self.promotion.discount(self)</span><br><span class="line">        <span class="keyword">return</span> self.total() - discount</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        fmt = <span class="string">&#x27;&lt;Order total: &#123;:.2f&#125; due: &#123;:.2f&#125;&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> fmt.<span class="built_in">format</span>(self.total(), self.due())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Promotion</span>(<span class="title class_ inherited__">ABC</span>):  <span class="comment"># the Strategy: an abstract base class</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractclassmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">discount</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return discount as a positive dollar amount&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FidelityPromo</span>(<span class="title class_ inherited__">Promotion</span>):  <span class="comment"># first Concrete strategy</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;%5 discount for customers with 1000 or more fidelity points&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">discount</span>(<span class="params">self, order</span>):</span><br><span class="line">        <span class="keyword">return</span> order.total() * <span class="number">.05</span> <span class="keyword">if</span> order.customer.fidelity &gt;= <span class="number">1000</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BulkItemPromo</span>(<span class="title class_ inherited__">Promotion</span>):  <span class="comment"># second Concrete strategy</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;10% discount for each LineItem wit 20 or more units&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">discount</span>(<span class="params">self, order</span>):</span><br><span class="line">        discount = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> order.cart:</span><br><span class="line">            <span class="keyword">if</span> item.quantity &gt;= <span class="number">20</span>:</span><br><span class="line">                discount += item.total * <span class="number">.1</span></span><br><span class="line">        <span class="keyword">return</span> discount</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LaregOrderPromo</span>(<span class="title class_ inherited__">Promotion</span>):  <span class="comment"># third concrete startegy</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;%7 discount for orders with 10 or more distinct items&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">discount</span>(<span class="params">self, order</span>):</span><br><span class="line">        distinct_items = &#123;item.product <span class="keyword">for</span> item <span class="keyword">in</span> order.cart&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(distinct_items) &gt;= <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">return</span> order.total() * <span class="number">.07</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    joe = Customer(<span class="string">&#x27;John Doe&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    ann = Customer(<span class="string">&#x27;Ann Smith&#x27;</span>, <span class="number">1100</span>)</span><br><span class="line">    cart = [LineItem(<span class="string">&#x27;banana&#x27;</span>, <span class="number">4</span>, <span class="number">.5</span>),</span><br><span class="line">            LineItem(<span class="string">&#x27;apple&#x27;</span>, <span class="number">10</span>, <span class="number">1.5</span>),</span><br><span class="line">            LineItem(<span class="string">&#x27;watermellon&#x27;</span>, <span class="number">5</span>, <span class="number">5.0</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(Order(joe, cart, FidelityPromo()))</span><br></pre></td></tr></table></figure>

<ul>
<li>令<code>Promotion</code>继承<code>ABC</code>作为抽象基类，以便使用<code>@abstractclassmethod</code>装饰器</li>
</ul>
<h4 id="面向函数的策略模式"><a href="#面向函数的策略模式" class="headerlink" title="面向函数的策略模式"></a>面向函数的策略模式</h4><p>对于上述的例子，每个实体策略有一个单独的方法<code>discount</code>。进一步讲，策略对象没有状态。它们看起来就像纯净的函数。因此我们重构上述代码</p>
<p>对于<code>Order</code>类进行如下改造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">due</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> self.promotion <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        discount = <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># discount = self.promotion.discount(self)</span></span><br><span class="line">        <span class="comment">#2</span></span><br><span class="line">        discount = self.promotion(self)</span><br><span class="line">    <span class="keyword">return</span> self.total() - discount</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加如下方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fideilty_promo</span>(<span class="params">order</span>):</span><br><span class="line">    <span class="keyword">return</span> order.total() * <span class="number">.05</span> <span class="keyword">if</span> order.customer.fidelity &gt;= <span class="number">1000</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bulk_item_promo</span>(<span class="params">order</span>):</span><br><span class="line">    discount = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order.cart:</span><br><span class="line">        <span class="keyword">if</span> item.quantity &gt;= <span class="number">20</span>:</span><br><span class="line">            discount += item.total * <span class="number">.1</span></span><br><span class="line">    <span class="keyword">return</span> discount</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">large_order_promo</span>(<span class="params">order</span>):</span><br><span class="line">    distinct_items = &#123;item.product <span class="keyword">for</span> item <span class="keyword">in</span> order.cart&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(distinct_items) &gt;= <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> order.total() * <span class="number">.07</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>将原来的<code>Promotion</code>以及其子类由上述方法替代，不需要使用抽象函数</li>
</ul>
<h4 id="选择最佳策略-简单方案"><a href="#选择最佳策略-简单方案" class="headerlink" title="选择最佳策略: 简单方案"></a>选择最佳策略: 简单方案</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">promos = [fideilty_promo, bulk_item_promo, large_order_promo]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">best_promo</span>(<span class="params">order</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">max</span>(promo(order) <span class="keyword">for</span> promo <span class="keyword">in</span> promos)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>best_promo</code>方法来查询最佳方案</li>
</ul>
<h4 id="系统模块中寻找策略"><a href="#系统模块中寻找策略" class="headerlink" title="系统模块中寻找策略"></a>系统模块中寻找策略</h4><p>内置<code>globals</code></p>
<blockquote>
<p>返回表示当前全局符号表的字典</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">promos = [<span class="built_in">globals</span>()[name] <span class="keyword">for</span> name <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">if</span> name.endswith(<span class="string">&#x27;_promo&#x27;</span>) <span class="keyword">and</span> name != <span class="string">&#x27;best_promo&#x27;</span>]</span><br><span class="line"></span><br><span class="line">promos = [func <span class="keyword">for</span> name, func <span class="keyword">in</span> inspect.getmembers(promos, inspect.isfunction)]</span><br></pre></td></tr></table></figure>

<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><pre><code class="python">class MacroCommand:
    def __init__(self, commands):
        self.commands = list(commands)

    def __call__(self):
        for command in self.commands:
            command()
``
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/04/22/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/22/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">深入理解Python之函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-04-22 17:28:44" itemprop="dateCreated datePublished" datetime="2017-04-22T17:28:44+08:00">2017-04-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>函数在<code>Python</code>是首要类对象。<br>首要对象： </p>
<ul>
<li>运行时创建 </li>
<li>能赋值给变量或者数据结构中的元素</li>
<li>接收参数</li>
<li>返回结果</li>
</ul>
<h3 id="把函数当做对象"><a href="#把函数当做对象" class="headerlink" title="把函数当做对象"></a>把函数当做对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">factorial</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;returns n!&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> n &lt; <span class="number">2</span> <span class="keyword">else</span> n * factorial(n - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_factorial</span>():</span><br><span class="line">    <span class="built_in">print</span>(factorial(<span class="number">42</span>))</span><br><span class="line">    <span class="built_in">print</span>(factorial.__doc__)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(factorial))</span><br><span class="line"></span><br><span class="line">    fact = factorial</span><br><span class="line">    <span class="built_in">print</span>(fact)</span><br><span class="line">    <span class="built_in">print</span>(fact(<span class="number">5</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">map</span>(factorial, <span class="built_in">range</span>(<span class="number">11</span>)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(fact, <span class="built_in">range</span>(<span class="number">11</span>))))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建函数，读取<code>__doc__</code>属性显示函数注释，使用<code>type</code>显示函数类型，其是个<code>function</code>类</p>
</li>
<li><p>能够将函数赋值给变量</p>
</li>
</ul>
<h3 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h3><p>函数接收一个函数作为参数，并返回一个函数作为结果，称为<em>高阶函数</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">fruits = [<span class="string">&#x27;strawberry&#x27;</span>, <span class="string">&#x27;fig&#x27;</span>, <span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;cherry&#x27;</span>, <span class="string">&#x27;raspberry&#x27;</span>, <span class="string">&#x27;banana&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(fruits, key=<span class="built_in">len</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(fruits, key=reverse))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse</span>(<span class="params">word</span>):</span><br><span class="line">    <span class="keyword">return</span> word[::-<span class="number">1</span>]    </span><br></pre></td></tr></table></figure>

<h4 id="map-filter-reduce的现代替代品"><a href="#map-filter-reduce的现代替代品" class="headerlink" title="map, filter, reduce的现代替代品"></a>map, filter, reduce的现代替代品</h4><h5 id="map-filter"><a href="#map-filter" class="headerlink" title="map, filter"></a>map, filter</h5><p><code>Python3</code>中<code>map</code>,<code>filter</code>返回生成器，在<code>pythn2</code>中返回序列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(factorial, <span class="built_in">range</span>(<span class="number">6</span>))))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(factorial, <span class="built_in">filter</span>(<span class="keyword">lambda</span> n: n % <span class="number">2</span>, <span class="built_in">range</span>(<span class="number">6</span>)))))</span><br><span class="line"><span class="built_in">print</span>([factorial(n) <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>) <span class="keyword">if</span> n % <span class="number">2</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h5><p><code>python3</code>中，<code>reduce</code>被移到<code>functools</code>中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> add</span><br><span class="line"><span class="built_in">print</span>(reduce(add, <span class="built_in">range</span>(<span class="number">100</span>)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这里<code>reduce</code>的作用相当于<code>sum</code>做累加</li>
</ul>
<h3 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h3><p><code>lambda</code>关键字创建一个匿名函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(fruits, key=<span class="keyword">lambda</span> word: word[::-<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<h3 id="可调用对象的七种风格"><a href="#可调用对象的七种风格" class="headerlink" title="可调用对象的七种风格"></a>可调用对象的七种风格</h3><h4 id="用户定义函数"><a href="#用户定义函数" class="headerlink" title="用户定义函数"></a><em>用户定义函数</em></h4><p>使用<code>def</code>或者<code>lambda</code>创建的表达式</p>
<h4 id="内建的函数"><a href="#内建的函数" class="headerlink" title="内建的函数"></a><em>内建的函数</em></h4><p><code>C</code>语言实现的函数</p>
<h4 id="内建方法"><a href="#内建方法" class="headerlink" title="内建方法"></a><em>内建方法</em></h4><p><code>C</code>语言实现的方法</p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a><em>方法</em></h4><p>在类体中定义的函数</p>
<h4 id="类"><a href="#类" class="headerlink" title="类"></a><em>类</em></h4><p>当触发时，类运行<code>__new__</code>方法创建对象，然后在<code>__init__</code>中初始化。最后返回对象给调用者。因为<code>Python</code>中没有<code>new</code>操作符，因此调用类就像调用函数</p>
<h4 id="类实例"><a href="#类实例" class="headerlink" title="类实例"></a><em>类实例</em></h4><p>if类定义了<code>__call__</code>方法，它的对象可能像函数一样触发</p>
<h4 id="生成器函数"><a href="#生成器函数" class="headerlink" title="生成器函数"></a><em>生成器函数</em></h4><p>函数或者方法使用<code>yield</code>关键字。当调用时，返回生成器对象</p>
<ul>
<li>可以使用<code>callable</code>来检查对象是否可以调用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">callable</span>(obj) <span class="keyword">for</span> obj <span class="keyword">in</span> (<span class="built_in">abs</span>, <span class="built_in">str</span>, <span class="number">13</span>)]</span><br></pre></td></tr></table></figure>

<h3 id="用户定义的可调用类型"><a href="#用户定义的可调用类型" class="headerlink" title="用户定义的可调用类型"></a>用户定义的可调用类型</h3><p>只要实现<code>__call__</code>就能让对象表现得像函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BingoCage</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, items</span>):</span><br><span class="line">        self._items = <span class="built_in">list</span>(items)</span><br><span class="line">        random.shuffle(self._items)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pick</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self._items.pop()</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">raise</span> LookupError(<span class="string">&#x27;pick from empty BingoCage&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.pick()</span><br><span class="line"></span><br><span class="line">bingo = BingoCage(<span class="built_in">range</span>(<span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>(bingo.pick())</span><br><span class="line"><span class="built_in">print</span>(bingo())</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(bingo))</span><br></pre></td></tr></table></figure>

<h3 id="函数自省"><a href="#函数自省" class="headerlink" title="函数自省"></a>函数自省</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>: <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">obj = C()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(): <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">sorted</span>(<span class="built_in">set</span>(<span class="built_in">dir</span>(func)) - <span class="built_in">set</span>(<span class="built_in">dir</span>(obj))))</span><br><span class="line"></span><br><span class="line">result: [<span class="string">&#x27;__annotations__&#x27;</span>, <span class="string">&#x27;__call__&#x27;</span>, <span class="string">&#x27;__closure__&#x27;</span>, <span class="string">&#x27;__code__&#x27;</span>, <span class="string">&#x27;__defaults__&#x27;</span>, <span class="string">&#x27;__get__&#x27;</span>, <span class="string">&#x27;__globals__&#x27;</span>, <span class="string">&#x27;__kwdefaults__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__qualname__&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="函数关键字参数"><a href="#函数关键字参数" class="headerlink" title="函数关键字参数"></a>函数关键字参数</h3><p>这是<code>Python3</code>的新特性， <code>*</code>表示序列， <code>**</code>表示字典，关键字参数是可选参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tag</span>(<span class="params">name, *content, cls=<span class="literal">None</span>, **attrs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate one or more HTML tag&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> cls <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        attrs[<span class="string">&#x27;class&#x27;</span>] = cls</span><br><span class="line">    <span class="keyword">if</span> attrs:</span><br><span class="line">        attr_str = <span class="string">&#x27;&#x27;</span>.join(<span class="string">&#x27; %s=&quot;%s&quot;&#x27;</span> % (attr, value) <span class="keyword">for</span> attr, value <span class="keyword">in</span> <span class="built_in">sorted</span>(attrs.items()))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        attr_str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> content:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;\n&#x27;</span>.join(<span class="string">&#x27;&lt;%s%s&gt;%s&lt;/%s&gt;&#x27;</span> % (name, attr_str, c, name) <span class="keyword">for</span> c <span class="keyword">in</span> content)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;%s%s /&gt;&#x27;</span> % (name, attr_str)</span><br></pre></td></tr></table></figure>

<h3 id="函数参数信息"><a href="#函数参数信息" class="headerlink" title="函数参数信息"></a>函数参数信息</h3><p>函数对象中，<code>__defaults__</code>持有位置和关键字参数的默认值，是<code>tuple</code>类型。关键字参数的默认值在<code>__kwdefaults__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">clip</span>(<span class="params">text, max_len=<span class="number">80</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return text clipped at the last space before or after max_len&quot;&quot;&quot;</span></span><br><span class="line">    end = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(text) &gt; max_len:</span><br><span class="line">        space_before = text.rfind(<span class="string">&#x27; &#x27;</span>, <span class="number">0</span>, max_len)</span><br><span class="line">        <span class="keyword">if</span> space_before &gt;= <span class="number">0</span>:</span><br><span class="line">            end = space_before</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            space_after = text.rfind(<span class="string">&#x27; &#x27;</span>, max_len)</span><br><span class="line">            <span class="keyword">if</span> space_after &gt;= <span class="number">0</span>:</span><br><span class="line">                end = space_after</span><br><span class="line">    <span class="keyword">if</span> end <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        end = <span class="built_in">len</span>(text)</span><br><span class="line">    <span class="keyword">return</span> text[:end].rstrip()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(clip.__defaults__)</span><br><span class="line"><span class="built_in">print</span>(clip.__code__)</span><br><span class="line"><span class="built_in">print</span>(clip.__code__.co_argcount)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> signature</span><br><span class="line">sig = signature(clip)</span><br><span class="line"><span class="built_in">print</span>(sig)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(sig))</span><br><span class="line"><span class="keyword">for</span> name, param <span class="keyword">in</span> sig.parameters.items():</span><br><span class="line">    <span class="built_in">print</span>(param.kind, <span class="string">&#x27;:&#x27;</span>, name, <span class="string">&#x27;=&#x27;</span>, param.default)</span><br></pre></td></tr></table></figure>

<p>使用<code>inspect/Signature</code>可以实现类似查看函数元数据的功能</p>
<h3 id="函数注解"><a href="#函数注解" class="headerlink" title="函数注解"></a>函数注解</h3><p><code>Python3</code>能够添加元数据到函数声明的参数和返回值上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">clip</span>(<span class="params">text: <span class="built_in">str</span>, max_len: <span class="string">&#x27;int &gt; 0&#x27;</span>=<span class="number">80</span></span>) -&gt; <span class="built_in">str</span>:</span><br></pre></td></tr></table></figure>

<h3 id="函数编程的包"><a href="#函数编程的包" class="headerlink" title="函数编程的包"></a>函数编程的包</h3><h4 id="operator模块"><a href="#operator模块" class="headerlink" title="operator模块"></a>operator模块</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> mul</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fact</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> a, b: a * b, <span class="built_in">range</span>(<span class="number">1</span>, n + <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fact_op</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> reduce(mul, <span class="built_in">range</span>(<span class="number">1</span>, n + <span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> methodcaller</span><br><span class="line">s = <span class="string">&#x27;The time has come&#x27;</span></span><br><span class="line">upcase = methodcaller(<span class="string">&#x27;upper&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(upcase(s))</span><br><span class="line">hiphenate = methodcaller(<span class="string">&#x27;replace&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(hiphenate(s))</span><br></pre></td></tr></table></figure>
<h3 id="使用functools-partial冻结参数"><a href="#使用functools-partial冻结参数" class="headerlink" title="使用functools.partial冻结参数"></a>使用functools.partial冻结参数</h3><p><code>functools.partial</code>是一种高阶函数，允许应用函数功能的一部分。给定一个函数，部分功能会产生一个新的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> mul</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line">triple = partial(mul, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(triple(<span class="number">7</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(triple, <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>))))</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文主要描述了<code>Python</code>中的函数。主要思想是函数能够赋值给变量，传给其他函数，将他们存在数据结构中，访问函数属性，允许框架和工具操作相关信息。高阶函数的使用。调用的七种形式</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/04/15/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8BDictionaries%E5%92%8CSets/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/15/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8BDictionaries%E5%92%8CSets/" class="post-title-link" itemprop="url">深入理解Python之Dictionaries和Sets</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-04-15 16:57:42 / Modified: 17:01:45" itemprop="dateCreated datePublished" datetime="2017-04-15T16:57:42+08:00">2017-04-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Dictionaries"><a href="#Dictionaries" class="headerlink" title="Dictionaries"></a>Dictionaries</h3><p><code>Dictionary</code>是<code>Python</code>中最常用的数据结构之一</p>
<h4 id="推导式"><a href="#推导式" class="headerlink" title="推导式"></a>推导式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DIAL_CODES = [</span><br><span class="line">    (<span class="number">86</span>, <span class="string">&#x27;China&#x27;</span>),</span><br><span class="line">    (<span class="number">91</span>, <span class="string">&#x27;India&#x27;</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="string">&#x27;United States&#x27;</span>),</span><br><span class="line">    (<span class="number">62</span>, <span class="string">&#x27;Indonesia&#x27;</span>),</span><br><span class="line">    (<span class="number">55</span>, <span class="string">&#x27;Brazil&#x27;</span>),</span><br><span class="line">    (<span class="number">92</span>, <span class="string">&#x27;Pakistan&#x27;</span>),</span><br><span class="line">    (<span class="number">880</span>, <span class="string">&#x27;Bangladesh&#x27;</span>),</span><br><span class="line">    (<span class="number">234</span>, <span class="string">&#x27;Nigeria&#x27;</span>),</span><br><span class="line">    (<span class="number">7</span>, <span class="string">&#x27;Russia&#x27;</span>),</span><br><span class="line">    (<span class="number">81</span>, <span class="string">&#x27;Japan&#x27;</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">country_code = &#123;country: code <span class="keyword">for</span> code, country <span class="keyword">in</span> DIAL_CODES&#125;</span><br><span class="line"><span class="comment"># print(country_code)</span></span><br><span class="line"><span class="built_in">print</span>(&#123;code: country.upper() <span class="keyword">for</span> country, code <span class="keyword">in</span> country_code.items() <span class="keyword">if</span> code &lt; <span class="number">66</span>&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="使用setdefault处理无key"><a href="#使用setdefault处理无key" class="headerlink" title="使用setdefault处理无key"></a>使用<code>setdefault</code>处理无<code>key</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">WORD_RE = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line">index = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(sys.argv[<span class="number">1</span>], encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    <span class="keyword">for</span> line_no, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(fp, <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> match <span class="keyword">in</span> WORD_RE.finditer(line):</span><br><span class="line">            word = match.group()</span><br><span class="line">            column_no = match.start() + <span class="number">1</span></span><br><span class="line">            location = (line_no, column_no)</span><br><span class="line">            occurrences = index.get(word, [])</span><br><span class="line">            occurrences.append(location)</span><br><span class="line">            index[word] = occurrences</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> <span class="built_in">sorted</span>(index, key=<span class="built_in">str</span>.upper):</span><br><span class="line">    <span class="built_in">print</span>(word, index[word])</span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用<code>get(key, defaultValue)</code>和<code>setdefault(key, defaultValue)</code>来处理<code>key</code>不存在的情况,也可以使用<code>collections.defaultdict(value)</code>来设置创建默认<code>new-key</code>的字典。采用这方式，如果<code>dd</code>是一个<code>defaultdict</code>,那么当<code>dd[k]</code>不存在时，会调用<code>default_factory</code>来创建一个默认值，但返回结果依然是<code>None</code></li>
</ul>
<h4 id="missing"><a href="#missing" class="headerlink" title="__missing__"></a><code>__missing__</code></h4><p>这个方法默认是没有定义的，当<code>dict</code>的子类提供了这个方法的实现，那么当<code>key</code>不存在时，不会抛出异常<code>KeyError</code>，<code>__getitem__</code>会调用<code>__missing__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StrKeyDict0</span>(<span class="title class_ inherited__">dict</span>):</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__missing__</span>(<span class="params">self, key</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">raise</span> KeyError(key)</span><br><span class="line">    <span class="keyword">return</span> self[<span class="built_in">str</span>(key)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, k, d=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> self[k]</span><br><span class="line">    <span class="keyword">except</span> KeyError:</span><br><span class="line">        <span class="keyword">return</span> default</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__contains__</span>(<span class="params">self, item</span>):</span><br><span class="line">    <span class="keyword">return</span> key <span class="keyword">in</span> self.keys() <span class="keyword">or</span> <span class="built_in">str</span>(key) <span class="keyword">in</span> self.keys()</span><br></pre></td></tr></table></figure>

<ul>
<li>这里需要注意<code>isintance</code>检查<code>key</code>是否为<code>str</code>,否则会陷入死循环。使用<code>k in dict.keys()</code>效率很高</li>
</ul>
<h4 id="各种各样的dict"><a href="#各种各样的dict" class="headerlink" title="各种各样的dict"></a>各种各样的<code>dict</code></h4><p>除了<code>defaultdict</code>之外，还会有很多别的<code>dict</code></p>
<h5 id="collections-OrderedDict"><a href="#collections-OrderedDict" class="headerlink" title="collections.OrderedDict"></a>collections.OrderedDict</h5><p><code>key</code>有顺序的<code>dict</code>，类似<code>Java</code>中的<code>TreeMap</code></p>
<h5 id="collections-ChainMap"><a href="#collections-ChainMap" class="headerlink" title="collections.ChainMap"></a>collections.ChainMap</h5><p>将多个<code>dict</code>当成一个<code>dict</code>，按顺序搜索<code>key</code>，只要搜索到<code>key</code>，结果返回成功</p>
<h5 id="collections-Counter"><a href="#collections-Counter" class="headerlink" title="collections.Counter"></a>collections.Counter</h5><p>持有<code>key</code>的计数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ct = collections.Counter(<span class="string">&#x27;dsakfjdjsfakdjfs&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ct)</span><br><span class="line"></span><br><span class="line">result: Counter(&#123;<span class="string">&#x27;d&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;s&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;f&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;j&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;a&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;k&#x27;</span>: <span class="number">2</span>&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="userDict"><a href="#userDict" class="headerlink" title="userDict"></a>userDict</h5><p>纯<code>Python</code>实现的标准<code>dict</code></p>
<ul>
<li>一般来说<code>userDict</code>被用来集成，其他几个直接使用</li>
</ul>
<h4 id="UserDict派生"><a href="#UserDict派生" class="headerlink" title="UserDict派生"></a>UserDict派生</h4><p><code>UserDict</code>内部提供了很多默认的实现方法，因此直接从<code>UserDict</code>继承会很方便。<code>UserDict</code>不是继承<code>dict</code>，但其内部有个<code>dict</code>实例。这是真正数据存储的地方</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StrKeyDict0</span>(collections.UserDict):</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__missing__</span>(<span class="params">self, key</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(key, <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">raise</span> KeyError(key)</span><br><span class="line">    <span class="keyword">return</span> self[<span class="built_in">str</span>(key)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__contains__</span>(<span class="params">self, item</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(item) <span class="keyword">in</span> self.data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">    self.data[<span class="built_in">str</span>(key)] = value</span><br></pre></td></tr></table></figure>

<h4 id="不可改Mapping"><a href="#不可改Mapping" class="headerlink" title="不可改Mapping"></a>不可改Mapping</h4><p>标准库提供的映射类型都是可以修改的。你可能想让你的映射不能够被修改。<code>Python3.3</code>之后，标准库提供了只读的<code>MappingProxy</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> MappingProxyType</span><br><span class="line">d = &#123;<span class="number">1</span>: <span class="string">&#x27;A&#x27;</span>&#125;</span><br><span class="line">d_proxy = MappingProxyType(d)</span><br><span class="line"><span class="built_in">print</span>(d_proxy)</span><br><span class="line">d_proxy[<span class="number">2</span>] = <span class="string">&#x27;x&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码会抛出异常，因为<code>d_proxy</code>是不允许被修改的</li>
</ul>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="string">&#x27;spam&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>, <span class="string">&#x27;eggs&#x27;</span>, <span class="string">&#x27;spam&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">set</span>(l))</span><br><span class="line"></span><br><span class="line">result: &#123;<span class="string">&#x27;spam&#x27;</span>, <span class="string">&#x27;eggs&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>需要注意<code>Set</code>的元素必须是能哈希的</li>
<li>支持<code>&amp;(intersetion)</code></li>
</ul>
<h4 id="Set语法"><a href="#Set语法" class="headerlink" title="Set语法"></a>Set语法</h4><p><code>Python3</code>中，<code>set</code>标准表示方法<code>s = &#123;1&#125;</code>。使用这个方式会比使用<code>set([1])</code>效率高</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dis <span class="keyword">import</span> dis</span><br><span class="line"><span class="built_in">print</span>(dis(<span class="string">&#x27;&#123;1&#125;&#x27;</span>))</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>           <span class="number">0</span> LOAD_CONST               <span class="number">0</span> (<span class="number">1</span>)</span><br><span class="line">            <span class="number">2</span> BUILD_SET                <span class="number">1</span></span><br><span class="line">            <span class="number">4</span> RETURN_VALUE</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dis(<span class="string">&#x27;set([1])&#x27;</span>)</span><br><span class="line"></span><br><span class="line">result:</span><br><span class="line"><span class="number">1</span>           <span class="number">0</span> LOAD_NAME                <span class="number">0</span> (<span class="built_in">set</span>)</span><br><span class="line">            <span class="number">2</span> LOAD_CONST               <span class="number">0</span> (<span class="number">1</span>)</span><br><span class="line">            <span class="number">4</span> BUILD_LIST               <span class="number">1</span></span><br><span class="line">            <span class="number">6</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">            <span class="number">8</span> RETURN_VALUE</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>dis</code>来查看两种方式的字节码操作。第一种方式效率明显高于第二种</li>
</ul>
<h4 id="Set推导式"><a href="#Set推导式" class="headerlink" title="Set推导式"></a>Set推导式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicodedata <span class="keyword">import</span> name</span><br><span class="line"><span class="built_in">print</span>(&#123;<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">256</span>) <span class="keyword">if</span> <span class="string">&#x27;SIGN&#x27;</span> <span class="keyword">in</span> name(<span class="built_in">chr</span>(i), <span class="string">&#x27;&#x27;</span>)&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h4><table>
<thead>
<tr>
<th>数据量</th>
<th>因子</th>
<th>dict时间</th>
<th>因子</th>
</tr>
</thead>
<tbody><tr>
<td>1000</td>
<td>1x</td>
<td>0.000202s</td>
<td>1.00x</td>
</tr>
<tr>
<td>10000</td>
<td>10x</td>
<td>0.000140s</td>
<td>0.69x</td>
</tr>
<tr>
<td>100000</td>
<td>100x</td>
<td>0.000228s</td>
<td>1.13x</td>
</tr>
<tr>
<td>1000000</td>
<td>1000x</td>
<td>0.000290s</td>
<td>1.44x</td>
</tr>
<tr>
<td>10000000</td>
<td>10000x</td>
<td>0.000337s</td>
<td>1.67x</td>
</tr>
</tbody></table>
<p><code>dict</code>的高性能多亏了<code>hashtable</code></p>
<p><img data-src="/./dict_hash_algorithm.png" alt="dict_hash_algorithm"></p>
<h4 id="好处和坏处"><a href="#好处和坏处" class="headerlink" title="好处和坏处"></a>好处和坏处</h4><ul>
<li><p><code>key</code>必须要能<code>hash</code>,需要满足</p>
<ul>
<li>支持<code>hash()</code>，同一个对象返回的值总是相同</li>
<li>支持<code>eq()</code></li>
<li>如果<code>a==b</code>，那么<code>hash(a)==hash(b)</code></li>
<li>用户定义的类型的<code>hash</code>值是<code>id()</code></li>
</ul>
</li>
<li><p>内存开销大</p>
</li>
<li><p>key搜索非常快</p>
<ul>
<li><code>dict</code>是典型的以空间换取时间</li>
</ul>
</li>
<li><p>key的顺序依赖插入顺序</p>
</li>
<li><p>添加数据会影响已存在<code>key</code>的顺序</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/04/04/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%95%B0%E7%BB%84%E5%BA%8F%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/04/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%95%B0%E7%BB%84%E5%BA%8F%E5%88%97/" class="post-title-link" itemprop="url">深入理解Python之数组序列</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-04-04 17:26:00" itemprop="dateCreated datePublished" datetime="2017-04-04T17:26:00+08:00">2017-04-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2017-04-08 14:47:59" itemprop="dateModified" datetime="2017-04-08T14:47:59+08:00">2017-04-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="列表推导式和生成器表达式"><a href="#列表推导式和生成器表达式" class="headerlink" title="列表推导式和生成器表达式"></a>列表推导式和生成器表达式</h3><h4 id="列表推导式可读性"><a href="#列表推导式可读性" class="headerlink" title="列表推导式可读性"></a>列表推导式可读性</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test1</span>():</span><br><span class="line">    codes = []</span><br><span class="line">    <span class="keyword">for</span> symbol <span class="keyword">in</span> symbols:</span><br><span class="line">        codes.append(<span class="built_in">ord</span>(symbol))</span><br><span class="line">    <span class="built_in">print</span>(codes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test2</span>():</span><br><span class="line">    codes = [<span class="built_in">ord</span>(symbol) <span class="keyword">for</span> symbol <span class="keyword">in</span> symbols]</span><br><span class="line">    <span class="built_in">print</span>(codes)</span><br></pre></td></tr></table></figure>

<ul>
<li>上面两个代码的效果是一样的，<code>test2</code>使用列表推导式的可读性会更好</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="string">&#x27;my precious&#x27;</span></span><br><span class="line">dummy = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;ABC&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure>

<ul>
<li>对于上述代码，在<code>python2.x</code>中，<code>x</code>的值是<code>C</code>。而在<code>python3.x</code>中，<code>x</code>的值依然是<code>my precious</code>。在<code>python3.x</code>中，列表推导式的变量不再泄露，其有自己的内部作用域</li>
</ul>
<h4 id="列表推导式和map-filter"><a href="#列表推导式和map-filter" class="headerlink" title="列表推导式和map,filter"></a>列表推导式和<code>map</code>,<code>filter</code></h4><p>列表推导式也能做到<code>map</code>和<code>filter</code>能做到的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">beyond_ascii = [<span class="built_in">ord</span>(s) <span class="keyword">for</span> s <span class="keyword">in</span> symbols <span class="keyword">if</span> <span class="built_in">ord</span>(s) &gt; <span class="number">127</span>]</span><br><span class="line"><span class="built_in">print</span>(beyond_ascii)</span><br><span class="line"></span><br><span class="line">beyond_ascii = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> c: c &gt; <span class="number">127</span>, <span class="built_in">map</span>(<span class="built_in">ord</span>, symbols)))</span><br><span class="line"><span class="built_in">print</span>(beyond_ascii)</span><br></pre></td></tr></table></figure>

<ul>
<li>上述两个表达式的结果一样，但使用列表推导式会更简洁。而且它们的效率也差不多。我们来测试一下它们的效率</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TIMES = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">SETUP = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">symbols = &#x27;$¢£¥€¤&#x27;</span></span><br><span class="line"><span class="string">def non_ascii(c):</span></span><br><span class="line"><span class="string">    return c &gt; 127</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clock</span>(<span class="params">label, cmd</span>):</span><br><span class="line">    res = timeit.repeat(cmd, setup=SETUP, number=TIMES)</span><br><span class="line">    <span class="built_in">print</span>(label, *(<span class="string">&#x27;&#123;:.3f&#125;&#x27;</span>.<span class="built_in">format</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> res))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_speed</span>():</span><br><span class="line">    clock(<span class="string">&#x27;listcomp        :&#x27;</span>, <span class="string">&#x27;[ord(s) for s in symbols if ord(s) &gt; 127]&#x27;</span>)</span><br><span class="line">    clock(<span class="string">&#x27;listcomp + func :&#x27;</span>, <span class="string">&#x27;[ord(s) for s in symbols if non_ascii(ord(s))]&#x27;</span>)</span><br><span class="line">    clock(<span class="string">&#x27;filter + lambda :&#x27;</span>, <span class="string">&#x27;list(filter(lambda c: c &gt; 127, map(ord, symbols)))&#x27;</span>)</span><br><span class="line">    clock(<span class="string">&#x27;filter + func   :&#x27;</span>, <span class="string">&#x27;list(filter(non_ascii, map(ord, symbols)))&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>运行结果:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listcomp        : <span class="number">0.015</span> <span class="number">0.015</span> <span class="number">0.015</span></span><br><span class="line">listcomp + func : <span class="number">0.019</span> <span class="number">0.019</span> <span class="number">0.021</span></span><br><span class="line"><span class="built_in">filter</span> + <span class="keyword">lambda</span> : <span class="number">0.017</span> <span class="number">0.017</span> <span class="number">0.017</span></span><br><span class="line"><span class="built_in">filter</span> + func   : <span class="number">0.016</span> <span class="number">0.019</span> <span class="number">0.016</span></span><br></pre></td></tr></table></figure>

<h4 id="笛卡尔积"><a href="#笛卡尔积" class="headerlink" title="笛卡尔积"></a>笛卡尔积</h4><p>列表推导式能从两个或多个迭代对象中生成笛卡尔积</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">colors = [<span class="string">&#x27;black&#x27;</span>, <span class="string">&#x27;white&#x27;</span>]</span><br><span class="line">sizes = [<span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;L&#x27;</span>]</span><br><span class="line">tshirts = [(color, size) <span class="keyword">for</span> color <span class="keyword">in</span> colors <span class="keyword">for</span> size <span class="keyword">in</span> sizes]</span><br><span class="line"><span class="built_in">print</span>(tshirts)</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">&#x27;black&#x27;</span>, <span class="string">&#x27;S&#x27;</span>), (<span class="string">&#x27;black&#x27;</span>, <span class="string">&#x27;M&#x27;</span>), (<span class="string">&#x27;black&#x27;</span>, <span class="string">&#x27;L&#x27;</span>), (<span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;S&#x27;</span>), (<span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;M&#x27;</span>), (<span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;L&#x27;</span>)]</span><br></pre></td></tr></table></figure>

<h4 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">colors = [<span class="string">&#x27;black&#x27;</span>, <span class="string">&#x27;white&#x27;</span>]</span><br><span class="line">sizes = [<span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;L&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> tshirt <span class="keyword">in</span> (<span class="string">&#x27;%s %s&#x27;</span> % (c, s) <span class="keyword">for</span> c <span class="keyword">in</span> colors <span class="keyword">for</span> s <span class="keyword">in</span> sizes):</span><br><span class="line">    <span class="built_in">print</span>(tshirt)</span><br></pre></td></tr></table></figure>

<ul>
<li>通过使用生成器表达式可以省去构建数组的成本</li>
</ul>
<h3 id="Tuples不仅是不可变的序列"><a href="#Tuples不仅是不可变的序列" class="headerlink" title="Tuples不仅是不可变的序列"></a><code>Tuples</code>不仅是不可变的序列</h3><h4 id="Tuple作为Records"><a href="#Tuple作为Records" class="headerlink" title="Tuple作为Records"></a><code>Tuple</code>作为<code>Records</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">traveler_ids = [(<span class="string">&#x27;USA&#x27;</span>, <span class="string">&#x27;31195855&#x27;</span>), (<span class="string">&#x27;BRA&#x27;</span>, <span class="string">&#x27;CE342567&#x27;</span>), (<span class="string">&#x27;ESP&#x27;</span>, <span class="string">&#x27;XDA205856&#x27;</span>)]</span><br><span class="line"><span class="keyword">for</span> passport <span class="keyword">in</span> <span class="built_in">sorted</span>(traveler_ids):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%s/%s&#x27;</span> % passport)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> country, _ <span class="keyword">in</span> traveler_ids:</span><br><span class="line">    <span class="built_in">print</span>(country)</span><br></pre></td></tr></table></figure>

<h5 id="Tuple解包"><a href="#Tuple解包" class="headerlink" title="Tuple解包"></a><code>Tuple</code>解包</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lax_coordinates = (<span class="number">33.9425</span>, -<span class="number">118.408056</span>)</span><br><span class="line">latitude, longitude = lax_coordinates</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#123;0&#125;, &#123;1&#125;&#x27;</span>.<span class="built_in">format</span>(latitude, longitude))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;%s, %s&#x27;</span> % (latitude, longitude))</span><br><span class="line"></span><br><span class="line">a, b, *rest = <span class="built_in">range</span>(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(a, b, rest)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>python3.x</code>之前还支持函数参数解包。</li>
</ul>
<h5 id="命名Tuple"><a href="#命名Tuple" class="headerlink" title="命名Tuple"></a>命名<code>Tuple</code></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line">City = namedtuple(<span class="string">&#x27;City&#x27;</span>, <span class="string">&#x27;name country population coordinates&#x27;</span>)</span><br><span class="line">tokyo = City(<span class="string">&#x27;Tokyo&#x27;</span>, <span class="string">&#x27;JP&#x27;</span>, <span class="number">36.933</span>, (<span class="number">35.689722</span>, <span class="number">139.691667</span>))</span><br><span class="line"><span class="built_in">print</span>(tokyo)</span><br><span class="line"></span><br><span class="line">LatLong = namedtuple(<span class="string">&#x27;LatLong&#x27;</span>, <span class="string">&#x27;lat long&#x27;</span>)</span><br><span class="line">delhi_data = (<span class="string">&#x27;Delhi NCR&#x27;</span>, <span class="string">&#x27;IN&#x27;</span>, <span class="number">21.935</span>, LatLong(<span class="number">28.613889</span>, <span class="number">77.208889</span>))</span><br><span class="line">delhi = City._make(delhi_data)</span><br><span class="line"><span class="built_in">print</span>(delhi._asdict())</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_field</code>是<code>tuple</code>类的属性名</li>
<li><code>_make</code>允许使用迭代器初始化<code>named tuple</code></li>
<li><code>_asdict</code>返回一个用<code>name tuple</code>构建的排过序的字典</li>
</ul>
<h3 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h3><p><code>python</code>中所有的序列类型都支持切片操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t = (<span class="number">1</span>, <span class="number">2</span>, [<span class="number">30</span>, <span class="number">40</span>])</span><br><span class="line">t[<span class="number">2</span>] += [<span class="number">50</span>, <span class="number">60</span>]</span><br><span class="line"><span class="built_in">print</span>(t)</span><br></pre></td></tr></table></figure>

<ul>
<li>执行上述代码会报错，但事实上<code>t</code>已经变成了<code>[30, 40, 50, 60]</code></li>
<li>不要将可变对象放到<code>tuple</code>中</li>
<li><code>+=</code>不是一个原子操作。从上面我们看到，其实异常时在它执行完之后抛出的</li>
<li>使用<code>dis</code>能够很方便的查看<code>python</code>字节码</li>
</ul>
<h3 id="使用二分法管理序列"><a href="#使用二分法管理序列" class="headerlink" title="使用二分法管理序列"></a>使用二分法管理序列</h3><h4 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">grade</span>(<span class="params">score, breakpoints=[<span class="number">60</span>, <span class="number">70</span>, <span class="number">80</span>, <span class="number">90</span>], grades=<span class="string">&#x27;FDCBA&#x27;</span></span>):</span><br><span class="line">    i = bisect.bisect(breakpoints, score)</span><br><span class="line">    <span class="keyword">return</span> grades[i]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>([grade(score) <span class="keyword">for</span> score <span class="keyword">in</span> [<span class="number">33</span>, <span class="number">99</span>, <span class="number">77</span>, <span class="number">70</span>, <span class="number">89</span>, <span class="number">90</span>, <span class="number">100</span>]])</span><br></pre></td></tr></table></figure>

<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SIZE = <span class="number">7</span></span><br><span class="line">random.seed(<span class="number">1729</span>)</span><br><span class="line"></span><br><span class="line">my_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(SIZE):</span><br><span class="line">    new_item = random.randrange(SIZE * <span class="number">2</span>)</span><br><span class="line">    bisect.insort(my_list, new_item)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%sd -&gt;&#x27;</span> % new_item, my_list)</span><br></pre></td></tr></table></figure>

<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>使用<code>array.tofile和array.fromfile</code>，效率很高。读取使用<br><code>array.tofile</code>创建的二进制文件中的1千万个双精度浮点数仅需0.1s。这速度是从文件读取数字的60倍。写操作是7倍。并且最后生成的文件小</p>
<blockquote>
<p>注意，<code>Python3.4</code>之后<code>array</code>已经没有内置的排序方法</p>
</blockquote>
<h3 id="MemoryView"><a href="#MemoryView" class="headerlink" title="MemoryView"></a>MemoryView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">numbers = array(<span class="string">&#x27;h&#x27;</span>, [-<span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line">memv = <span class="built_in">memoryview</span>(numbers)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(memv))</span><br><span class="line"><span class="built_in">print</span>(memv[<span class="number">0</span>])</span><br><span class="line">memv_oct = memv.cast(<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(memv_oct.tolist())</span><br><span class="line">memv_oct[<span class="number">5</span>] = <span class="number">4</span></span><br><span class="line"><span class="built_in">print</span>(numbers)</span><br></pre></td></tr></table></figure>

<h3 id="双端队列和其他队列"><a href="#双端队列和其他队列" class="headerlink" title="双端队列和其他队列"></a>双端队列和其他队列</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dq = deque(<span class="built_in">range</span>(<span class="number">10</span>), maxlen=<span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(dq)</span><br><span class="line">dq.rotate(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(dq)</span><br><span class="line">dq.rotate(-<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(dq)</span><br><span class="line">dq.appendleft(-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(dq)</span><br></pre></td></tr></table></figure>

<ul>
<li>除了<code>deque</code>之外，其他一些标准库也实现了<code>queues</code>: <ul>
<li><code>queue</code>: <code>Queue</code>, <code>LifoQueue</code>, <code>PriorityQueue</code></li>
<li><code>multiprocessing</code>: <code>JoinableQueue</code></li>
<li><code>asyncio</code></li>
<li><code>heapq</code></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/04/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Python%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">深入理解Python之数据模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-04-03 17:23:12 / Modified: 17:31:35" itemprop="dateCreated datePublished" datetime="2017-04-03T17:23:12+08:00">2017-04-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="数据模型-Data-Model"><a href="#数据模型-Data-Model" class="headerlink" title="数据模型(Data Model)"></a>数据模型(Data Model)</h3><p><code>python</code>提供了很多特殊的方法</p>
<h4 id="不含操作符"><a href="#不含操作符" class="headerlink" title="不含操作符"></a>不含操作符</h4><table>
<thead>
<tr>
<th>种类</th>
<th>方法名称</th>
</tr>
</thead>
<tbody><tr>
<td>字符串&#x2F;字节表示</td>
<td><code>__repr__</code>, <code>__str__</code>, <code>__format__</code>, <code>__bytes</code></td>
</tr>
<tr>
<td>数值转换</td>
<td><code>__abs__</code>, <code>__bool__</code>, <code>__complex</code>, <code>__int__</code>, <code>__float__</code>, <code>__hash__</code>, <code>__index__</code></td>
</tr>
<tr>
<td>模拟集合</td>
<td><code>__len__</code>, <code>__getitem__</code>, <code>__setitem__</code>, <code>__delitem</code>, <code>__contains__</code></td>
</tr>
<tr>
<td>迭代器</td>
<td><code>__iter__</code>, <code>__reversed__</code>, <code>__next__</code></td>
</tr>
<tr>
<td>模拟调用</td>
<td><code>__call__</code></td>
</tr>
<tr>
<td>上下文管理</td>
<td><code>__enter__</code>, <code>__exit__</code></td>
</tr>
<tr>
<td>实例创建和销毁</td>
<td><code>__new__</code>, <code>__init__</code>, <code>__del__</code></td>
</tr>
<tr>
<td>属性管理</td>
<td><code>__getattr__</code>, <code>__getattribute__</code>, <code>__setattr__</code>, <code>__delattr__</code>, <code>__dir__</code></td>
</tr>
<tr>
<td>属性描述器</td>
<td><code>__get__</code>, <code>__set__</code>, <code>__delete__</code></td>
</tr>
<tr>
<td>类服务</td>
<td><code>__prepare__</code>, <code>__instancecheck__</code>, <code>__subclasscheck__</code></td>
</tr>
</tbody></table>
<h4 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h4><table>
<thead>
<tr>
<th>种类</th>
<th>方法名和相关操作符</th>
</tr>
</thead>
<tbody><tr>
<td>一元数值操作符</td>
<td><code>__neg__</code>-, <code>__pos__</code>+, <code>__abs__</code>()</td>
</tr>
<tr>
<td>比较操作符</td>
<td><code>__lt__</code>&lt;, <code>__le__</code>&lt;&#x3D;, <code>__eq__</code>&#x3D;, <code>__ne__</code>!&#x3D;, <code>__gt__</code>&gt;, <code>__ge__</code>&gt;&#x3D;</td>
</tr>
<tr>
<td>算术操作符</td>
<td><code>__add__</code>+, <code>__sub__</code>-, <code>__mul__</code>*, <code>__truediv__</code>&#x2F;, <code>__floordiv__</code>&#x2F;&#x2F;, <code>__mod__</code>%, <code>__divmod__ divmod()</code>, <code>__pow__ **或者(pow())</code>, <code>__round__ round()</code></td>
</tr>
<tr>
<td>反向算术操作符</td>
<td><code>__radd__</code>, <code>__rsub__</code>, <code>__rmul__</code>, <code>__rtruediv__</code>, <code>__rfloordiv__</code>, <code>__rmod__</code>, <code>__rdivmod__</code>, <code>__rpow__</code></td>
</tr>
<tr>
<td>自操作符</td>
<td><code>_iadd__</code>, <code>__isub__</code>, <code>__imul__</code>, <code>__itruediv__</code>, <code>__ifloordiv__</code>, <code>__imod__</code>, <code>__ipow__</code></td>
</tr>
<tr>
<td>位操作符</td>
<td><code>__invert__</code>~, <code>__lshift__</code>&lt;&lt;, <code>__rshift__</code>&gt;&gt;, <code>__and__</code>&amp;, <code>__or__</code></td>
</tr>
<tr>
<td>反向位操作符</td>
<td><code>__rlshift__</code>, <code>__rrshift__</code>, <code>__rand__</code>, <code>__rxor__</code>, <code>__ror__</code></td>
</tr>
<tr>
<td>自增位操作符</td>
<td><code>__ilshift__</code>, <code>__irshift__</code>, <code>__iand__</code>, <code>__ixor__</code>, <code>__ior__</code></td>
</tr>
</tbody></table>
<ul>
<li>通过实现上述特殊的方法，你自己的对象能表现得像内置类型。例如为了让对象打印出来可读性更好，这个时候需要实现<code>__repr__</code>和<code>__str__</code> <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/1436703/difference-between-str-and-repr-in-python">区别</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/03/04/Ionic%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/04/Ionic%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E4%B9%8B%E8%B7%AF/" class="post-title-link" itemprop="url">Ionic自动化构建之路</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2017-03-04 15:51:33 / Modified: 15:52:28" itemprop="dateCreated datePublished" datetime="2017-03-04T15:51:33+08:00">2017-03-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文主要讲述<code>Ionic</code>在公司最新产品中的应用</p>
<h3 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h3><p>公司计划发布新的产品。为了利用现有的资源，快速构建产品，采用<code>ionic</code>作为基础框架。<code>ionic</code>是一款H5移动开发框架，打包插件基于<code>apache cordova</code>。</p>
<h3 id="实践之路"><a href="#实践之路" class="headerlink" title="实践之路"></a>实践之路</h3><p>实践过程:</p>
<ul>
<li>安装<code>ionic</code>, <code>cordova</code>框架。运行如下命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -y .</span><br><span class="line">npm install -y ionic cordova</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>ionic</code>项目。使用如下命令，可以指定包名</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ionic start xxx(项目名称) --<span class="built_in">id</span> xxx(包名)</span><br></pre></td></tr></table></figure>

<ul>
<li>下载需要的<code>cordova</code>插件</li>
<li>获取资源文件</li>
<li>更新配置文件</li>
<li>添加支持平台</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ionic platform add android</span><br></pre></td></tr></table></figure>
<ul>
<li>构建项目</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ionic build xxx(平台)</span><br></pre></td></tr></table></figure>

<h3 id="可持续集成"><a href="#可持续集成" class="headerlink" title="可持续集成"></a>可持续集成</h3><p>为了可持续集成，那么我这里将整个项目分为两部分，一部分固定不变的，即每次框架自动生成的文件。另一部分为我们一直需要修改的。因此这里的想法是，将改变的部分分离出去。每次运行脚本，自动生成文件。然后使用改变的部分覆盖自动生成的部分。这里改变的部分，主要包括配置文件，<code>Native</code>代码以及资源文件。替换完毕，打包签名出<code>apk</code>文件，并上传云服务。根据此思路，编写<code>python</code>脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 覆盖配置文件</span></span><br><span class="line">copy_file(<span class="string">&#x27;config.xml&#x27;</span>, subfix)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖build.gradle文件</span></span><br><span class="line">copy_file(<span class="string">&#x27;build.gradle&#x27;</span>, androidPath)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖 AndroidManifest</span></span><br><span class="line">copy_file(<span class="string">&#x27;AndroidManifest.xml&#x27;</span>, androidPath)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖资源文件</span></span><br><span class="line"><span class="comment"># 先删除资源文件</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    remove_tree(toDirectory + <span class="string">&#x27;/resources&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> OSError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖资源文件</span></span><br><span class="line">copy_tree(fromDirectory, toDirectory + <span class="string">&#x27;/resources&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖native代码</span></span><br><span class="line">copy_tree(fromDirectory, toDirectory)</span><br></pre></td></tr></table></figure>

<p>之后签名打包，上传云服务</p>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><ol>
<li>由于默认初始化项目，会自动生成一个包名。为了指定包名，因此需要使用<code>--id</code>来指定包名</li>
<li>自动生成的<code>config.xml</code>文件中包含了自动生成的包名，一旦打包签名时，会根据这个包名自动生成代码，因此需要将此自动包名，修改为需要的包名</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>此项目目前能实现从项目初始化，构建到最后打包上传完全自动化。大大减少工作量。对于我个人也是一次从新框架，新CI(bitrise)到最终的自动化构建的一次完整系统的学习。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2017/01/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3RxJava/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3RxJava/" class="post-title-link" itemprop="url">深入理解RxJava</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-01-01 23:27:27" itemprop="dateCreated datePublished" datetime="2017-01-01T23:27:27+08:00">2017-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2017-01-02 18:24:22" itemprop="dateModified" datetime="2017-01-02T18:24:22+08:00">2017-01-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>RxJava</code>使用观察者模式，基于事件驱动。主要包含两部分<code>Observable</code>和<code>Observaber</code>。而<code>Rxjava</code>最大的特色在于其灵活强大的操作符(<code>Operators</code>)和调度器(<code>Scheduler</code>)</p>
<h3 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h3><h4 id="Creating-Observables"><a href="#Creating-Observables" class="headerlink" title="Creating Observables"></a>Creating Observables</h4><h5 id="create-OnSubscribe"><a href="#create-OnSubscribe" class="headerlink" title="create(OnSubscribe)"></a>create(OnSubscribe)</h5><blockquote>
<p>示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(subscriber -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;subscriber&quot;</span>);</span><br><span class="line">        &#125;).subscribe(<span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;onCompleted&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;onError&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;onNext&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>这种情况下会打印<code>subscriber</code>。</li>
<li>这个时候加上</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">                subscriber.onNext(subscriber);</span><br><span class="line">                subscriber.onCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>那么会打印</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onNext</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable&lt;T&gt; <span class="title function_">create</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observable</span>&lt;T&gt;(RxJavaHooks.onCreate(f));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>RxJavaHooks</code>创建<code>OnSubscribe</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable.OnSubscribe&lt;T&gt; <span class="title function_">onCreate</span><span class="params">(Observable.OnSubscribe&lt;T&gt; onSubscribe)</span> &#123;</span><br><span class="line">        Func1&lt;Observable.OnSubscribe, Observable.OnSubscribe&gt; f = onObservableCreate;</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> f.call(onSubscribe);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> onSubscribe;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>RxJavaHooks</code>会在首次使用的时候初始化。</li>
</ul>
<p>之后还需要订阅</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &lt;T&gt; Subscription <span class="title function_">subscribe</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; subscriber, Observable&lt;T&gt; observable)</span> &#123;</span><br><span class="line">	<span class="comment">//省略若干代码</span></span><br><span class="line">	RxJavaHooks.onObservableStart(observable, observable.onSubscribe).call(subscriber);     </span><br><span class="line">	<span class="comment">//省略异常处理代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RxJavaHooks.<span class="type">java</span></span><br><span class="line"></span><br><span class="line"><span class="variable">onObservableStart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Func2</span>&lt;Observable, Observable.OnSubscribe, Observable.OnSubscribe&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Observable.OnSubscribe <span class="title function_">call</span><span class="params">(Observable t1, Observable.OnSubscribe t2)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> RxJavaPlugins.getInstance().getObservableExecutionHook().onSubscribeStart(t1, t2);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">RxJavaPlugins.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; OnSubscribe&lt;T&gt; <span class="title function_">onSubscribeStart</span><span class="params">(Observable&lt;? extends T&gt; observableInstance, <span class="keyword">final</span> OnSubscribe&lt;T&gt; onSubscribe)</span> &#123;</span><br><span class="line">        <span class="comment">// pass through by default</span></span><br><span class="line">        <span class="keyword">return</span> onSubscribe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>判断订阅者是否为空,之后直接交给<code>RxJavaHooks</code>执行<code>onObservableStart</code>，这里的参数<code>observable.onSubscribe</code>正是<code>Create</code>传入的，而在<code>RxJavaHooks</code>中<code>onObservableStart</code>调用了<code>RxJavaPlugin</code>中的<code>onSubscribeStart</code>。这个方法直接返回原来的<code>OnSubscribe</code>也就是<code>Create</code>传入的。这个时候会回调<code>call</code>。</p>
</li>
<li><p><code>create()</code>有另外两种参数专门用于处理<code>backPressure(反向压力，生产者生产速度远大于消费者消费速度)</code>。</p>
</li>
</ul>
<p><code>SyncOnSubscribe</code>里面需要关注的是<code>SubscriptionProducer</code>，而<code>AsyncOnSubscribe</code>需要关注<code>AsyncOuterManager</code>。这两个东西之后再讨论(TODO)</p>
<h5 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h5><blockquote>
<p>直到观察者订阅之后才创建可观察对象，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.defer(Observable::empty).subscribe(<span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;onCompleted&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;onError&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;onNext&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="number">2.0</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable&lt;T&gt; <span class="title function_">defer</span><span class="params">(Callable&lt;? extends ObservableSource&lt;? extends T&gt;&gt; supplier)</span> &#123;</span><br><span class="line">        ObjectHelper.requireNonNull(supplier, <span class="string">&quot;supplier is null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> <span class="title class_">ObservableDefer</span>&lt;T&gt;(supplier));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="number">1.2</span><span class="number">.4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable&lt;T&gt; <span class="title function_">defer</span><span class="params">(Func0&lt;Observable&lt;T&gt;&gt; observableFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> create(<span class="keyword">new</span> <span class="title class_">OnSubscribeDefer</span>&lt;T&gt;(observableFactory));</span><br><span class="line">    &#125;    </span><br></pre></td></tr></table></figure>

<ul>
<li>1.2.4采用<code>OnSubscribeDefer</code>,2.0.3采用<code>ObservableDefer</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeDefer.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; s)</span> &#123;</span><br><span class="line">        Observable&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; o;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            o = observableFactory.call();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwOrReport(t, s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        o.unsafeSubscribe(Subscribers.wrap(s));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ObservableDefer.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribeActual</span><span class="params">(Observer&lt;? <span class="built_in">super</span> T&gt; s)</span> &#123;</span><br><span class="line">        ObservableSource&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; pub;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pub = ObjectHelper.requireNonNull(supplier.call(), <span class="string">&quot;null publisher supplied&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(t);</span><br><span class="line">            EmptyDisposable.error(t, s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pub.subscribe(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Empty-Never-Throw"><a href="#Empty-Never-Throw" class="headerlink" title="Empty Never Throw"></a>Empty Never Throw</h5><blockquote>
<p>Empty</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EmptyObservableHolder.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> Object&gt; child)</span> &#123;</span><br><span class="line">        child.onCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>直接调用<code>onCompleted</code>，这是一个枚举单例</li>
</ul>
<blockquote>
<p>Never</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NeverObservableHolder.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> Object&gt; child)</span> &#123;</span><br><span class="line">        <span class="comment">// deliberately no op</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>什么都不做，主要用于做测试,这是一个枚举单例</li>
</ul>
<blockquote>
<p>Throw</p>
</blockquote>
<ul>
<li>源码分析:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; observer)</span> &#123;</span><br><span class="line">        observer.onError(exception);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="From"><a href="#From" class="headerlink" title="From"></a>From</h5><blockquote>
<p>将<code>Future</code>转化成<code>Observable</code>，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(Executors.newSingleThreadExecutor().submit(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;before sleep&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;)).subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>

<ul>
<li>打印结果</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">before sleep</span><br><span class="line">onNext</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable&lt;T&gt; <span class="title function_">from</span><span class="params">(Future&lt;? extends T&gt; future)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (Observable&lt;T&gt;)create(OnSubscribeToObservableFuture.toObservableFuture(future));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeToObservableFuture.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; OnSubscribe&lt;T&gt; <span class="title function_">toObservableFuture</span><span class="params">(<span class="keyword">final</span> Future&lt;? extends T&gt; that)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ToObservableFuture</span>&lt;T&gt;(that);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; subscriber)</span> &#123;</span><br><span class="line">        <span class="comment">//核心代码</span></span><br><span class="line">        <span class="keyword">if</span> (subscriber.isUnsubscribed()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> (unit == <span class="literal">null</span>) ? (T) that.get() : (T) that.get(time, unit);</span><br><span class="line">                subscriber.setProducer(<span class="keyword">new</span> <span class="title class_">SingleProducer</span>&lt;T&gt;(subscriber, value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>等待<code>future</code>结果。将结果作为生产者发出消息.<code>push data</code></li>
</ul>
<blockquote>
<p>将数组转换成Observable</p>
</blockquote>
<ul>
<li>源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeFromArray.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; child)</span> &#123;</span><br><span class="line">        child.setProducer(<span class="keyword">new</span> <span class="title class_">FromArrayProducer</span>&lt;T&gt;(child, array));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里面依然涉及到反向压力的处理，当请求id等于阈值时采用<code>fastPath</code>处理。反之采用<code>slowPath</code>。正常情况下请求id都是<code>Long.MaxValue</code>，当<code>producer</code>为空时，id会发生改变</li>
</ul>
<h5 id="Interval"><a href="#Interval" class="headerlink" title="Interval"></a>Interval</h5><blockquote>
<p>定时发出事件,示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS).subscribe(counter -&gt; &#123;</span><br><span class="line">            latch.countDown();</span><br><span class="line">            System.out.println(<span class="string">&quot;Got: &quot;</span> + counter + <span class="string">&quot; time: &quot;</span> + (System.currentTimeMillis() - startTime));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">结果</span><br><span class="line">Got: <span class="number">0</span> time: <span class="number">1252</span></span><br><span class="line">Got: <span class="number">1</span> time: <span class="number">2245</span></span><br><span class="line">Got: <span class="number">2</span> time: <span class="number">3249</span></span><br><span class="line">Got: <span class="number">3</span> time: <span class="number">4247</span></span><br><span class="line">Got: <span class="number">4</span> time: <span class="number">5244</span></span><br><span class="line">       </span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeTimerPeriodically.java</span><br><span class="line"></span><br><span class="line">默认使用computation调度器</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> Long&gt; child)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> scheduler.createWorker();</span><br><span class="line">        child.add(worker);</span><br><span class="line">        worker.schedulePeriodically(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">            <span class="type">long</span> counter;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    child.onNext(counter++);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        worker.unsubscribe();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        Exceptions.throwOrReport(e, child);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, initialDelay, period, unit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建工作器。工作器串行执行。</li>
</ul>
<h5 id="Just"><a href="#Just" class="headerlink" title="Just"></a>Just</h5><blockquote>
<p>发送特定的消息，有多个重载方法，区分在于单个参数和多个参数，单个参数使用ScalarSynchronousObservable,而多个参数使用from</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ScalarSynchronousObservable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">ScalarSynchronousObservable</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(RxJavaHooks.onCreate(<span class="keyword">new</span> <span class="title class_">JustOnSubscribe</span>&lt;T&gt;(t)));</span><br><span class="line">        <span class="built_in">this</span>.t = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; s)</span> &#123;</span><br><span class="line">            s.setProducer(createProducer(s, value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><ul>
<li>创建生产者时区分单生产者和弱单生产者</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">WeakSingleProducer.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> n)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (once) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (n &lt; <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;n &gt;= required but it was &quot;</span> + n);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            once = <span class="literal">true</span>;</span><br><span class="line">            Subscriber&lt;? <span class="built_in">super</span> T&gt; a = actual;</span><br><span class="line">            <span class="keyword">if</span> (a.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">v</span> <span class="operator">=</span> value;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                a.onNext(v);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwOrReport(e, a, v);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (a.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            a.onCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>弱单生产者不考虑并发问题，仅仅只使用<code>once</code>来记录此次请求已经发出</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> n)</span> &#123;</span><br><span class="line">        <span class="comment">// negative requests are bugs</span></span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;n &gt;= 0 required&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// we ignore zero requests</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// atomically change the state into emitting mode</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="comment">// avoid re-reading the instance fields</span></span><br><span class="line">            <span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; c = child;</span><br><span class="line">            <span class="comment">// eagerly check for unsubscription</span></span><br><span class="line">            <span class="keyword">if</span> (c.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">v</span> <span class="operator">=</span> value;</span><br><span class="line">            <span class="comment">// emit the value</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c.onNext(v);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwOrReport(e, c, v);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// eagerly check for unsubscription</span></span><br><span class="line">            <span class="keyword">if</span> (c.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// complete the child</span></span><br><span class="line">            c.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>单生产者考虑并发问题，继承<code>AtomicBoolean</code>，通过<code>compareAndSet</code>来确保线程安全</li>
</ul>
<h5 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h5><blockquote>
<p>串行发出某一范围的消息</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> requestedAmount)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (get() == Long.MAX_VALUE) &#123;</span><br><span class="line">                <span class="comment">// already started with fast-path</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requestedAmount == Long.MAX_VALUE &amp;&amp; compareAndSet(<span class="number">0L</span>, Long.MAX_VALUE)) &#123;</span><br><span class="line">                <span class="comment">// fast-path without backpressure</span></span><br><span class="line">                fastPath();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestedAmount &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">c</span> <span class="operator">=</span> BackpressureUtils.getAndAddRequest(<span class="built_in">this</span>, requestedAmount);</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="number">0L</span>) &#123;</span><br><span class="line">                    <span class="comment">// backpressure is requested</span></span><br><span class="line">                    slowPath(requestedAmount);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>策略依然跟大部分<code>producer</code>一样,正常情况下使用<code>fastPath</code>，<code>slowPath</code>则会考虑线程安全</li>
</ul>
<h5 id="Repeat"><a href="#Repeat" class="headerlink" title="Repeat"></a>Repeat</h5><blockquote>
<p>重复发出消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Observable.range(<span class="number">0</span>, <span class="number">3</span>).repeat(<span class="number">3</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">打印结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onCompleted</span><br><span class="line"></span><br><span class="line">打印三组range</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">repeat默认使用trampoline作为线程调度器，在当前线程串行执行</span><br><span class="line"></span><br><span class="line">OnSubscribeRedo.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; child)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//订阅源消息</span></span><br><span class="line">	<span class="keyword">final</span> <span class="type">Action0</span> <span class="variable">subscribeToSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (child.isUnsubscribed()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Subscriber&lt;T&gt; terminalDelegatingSubscriber = <span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;T&gt;() &#123;</span><br><span class="line">                    <span class="type">boolean</span> done;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                            done = <span class="literal">true</span>;</span><br><span class="line">                            unsubscribe();</span><br><span class="line">                            terminals.onNext(Notification.createOnCompleted());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                            done = <span class="literal">true</span>;</span><br><span class="line">                            unsubscribe();</span><br><span class="line">                            terminals.onNext(Notification.createOnError(e));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T v)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                            child.onNext(v);</span><br><span class="line">                            decrementConsumerCapacity();</span><br><span class="line">                            arbiter.produced(<span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">decrementConsumerCapacity</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="comment">// use a CAS loop because we don&#x27;t want to decrement the</span></span><br><span class="line">                        <span class="comment">// value if it is Long.MAX_VALUE</span></span><br><span class="line">                        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                            <span class="type">long</span> <span class="variable">cc</span> <span class="operator">=</span> consumerCapacity.get();</span><br><span class="line">                            <span class="keyword">if</span> (cc != Long.MAX_VALUE) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (consumerCapacity.compareAndSet(cc, cc - <span class="number">1</span>)) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProducer</span><span class="params">(Producer producer)</span> &#123;</span><br><span class="line">                        arbiter.setProducer(producer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="comment">// new subscription each time so if it unsubscribes itself it does not prevent retries</span></span><br><span class="line">                <span class="comment">// by unsubscribing the child subscription</span></span><br><span class="line">                sourceSubscriptions.set(terminalDelegatingSubscriber);</span><br><span class="line">                source.unsafeSubscribe(terminalDelegatingSubscriber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//重复发送源消息</span></span><br><span class="line">        <span class="keyword">final</span> Observable&lt;?&gt; restarts = controlHandlerFunction.call(</span><br><span class="line">                terminals.lift(<span class="keyword">new</span> <span class="title class_">Operator</span>&lt;Notification&lt;?&gt;, Notification&lt;?&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Subscriber&lt;? <span class="built_in">super</span> Notification&lt;?&gt;&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> Notification&lt;?&gt;&gt; filteredTerminals) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;Notification&lt;?&gt;&gt;(filteredTerminals) &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                                filteredTerminals.onCompleted();</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                                filteredTerminals.onError(e);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Notification&lt;?&gt; t)</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (t.isOnCompleted() &amp;&amp; stopOnComplete) &#123;</span><br><span class="line">                                    filteredTerminals.onCompleted();</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.isOnError() &amp;&amp; stopOnError) &#123;</span><br><span class="line">                                    filteredTerminals.onError(t.getThrowable());</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    filteredTerminals.onNext(t);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProducer</span><span class="params">(Producer producer)</span> &#123;</span><br><span class="line">                                producer.request(Long.MAX_VALUE);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;));</span><br><span class="line">     <span class="comment">//订阅重复发送的源消息           </span></span><br><span class="line">     worker.schedule(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                restarts.unsafeSubscribe(<span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;Object&gt;(child) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                        child.onCompleted();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                        child.onError(e);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Object t)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!child.isUnsubscribed()) &#123;</span><br><span class="line">                            <span class="comment">// perform a best endeavours check on consumerCapacity</span></span><br><span class="line">                            <span class="comment">// with the intent of only resubscribing immediately</span></span><br><span class="line">                            <span class="comment">// if there is outstanding capacity</span></span><br><span class="line">                            <span class="keyword">if</span> (consumerCapacity.get() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                worker.schedule(subscribeToSource);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// set this to true so that on next request</span></span><br><span class="line">                                <span class="comment">// subscribeToSource will be scheduled</span></span><br><span class="line">                                resumeBoundary.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProducer</span><span class="params">(Producer producer)</span> &#123;</span><br><span class="line">                        producer.request(Long.MAX_VALUE);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);                </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>流程<ol>
<li>订阅源消息</li>
<li>重复发送源消息</li>
<li>订阅重复发送的源消息</li>
</ol>
</li>
</ul>
<h5 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h5><blockquote>
<p>延时特定时间后发出一个消息，默认使用computation作为线程调度器</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> Long&gt; child)</span> &#123;</span><br><span class="line">        <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> scheduler.createWorker();</span><br><span class="line">        child.add(worker);</span><br><span class="line">        worker.schedule(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    child.onNext(<span class="number">0L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    Exceptions.throwOrReport(t, child);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                child.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, time, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Transforming-Observables"><a href="#Transforming-Observables" class="headerlink" title="Transforming Observables"></a>Transforming Observables</h4><h5 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h5><blockquote>
<p>缓存源数据发出的消息，再一起发出。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Integer[] integers = <span class="keyword">new</span> <span class="title class_">Integer</span>[<span class="number">9</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; integers.length; i++) &#123;</span><br><span class="line">    integers[i] = i;</span><br><span class="line">&#125;</span><br><span class="line">Observable.from(integers).buffer(<span class="number">2</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:<span class="number">2</span>个值一组</span><br><span class="line"></span><br><span class="line">onNext value: [<span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">onNext value: [<span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">onNext value: [<span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">onNext value: [<span class="number">6</span>, <span class="number">7</span>]</span><br><span class="line">onNext value: [<span class="number">8</span>]</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<h6 id="buffer-int-count-int-skip"><a href="#buffer-int-count-int-skip" class="headerlink" title="buffer(int count, int skip)"></a><code>buffer(int count, int skip)</code></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">OperatorBufferWithSize.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> List&lt;T&gt;&gt; child) &#123;</span><br><span class="line">        <span class="keyword">if</span> (skip == count) &#123;</span><br><span class="line">            BufferExact&lt;T&gt; parent = <span class="keyword">new</span> <span class="title class_">BufferExact</span>&lt;T&gt;(child, count);</span><br><span class="line"></span><br><span class="line">            child.add(parent);</span><br><span class="line">            child.setProducer(parent.createProducer());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (skip &gt; count) &#123;</span><br><span class="line">            BufferSkip&lt;T&gt; parent = <span class="keyword">new</span> <span class="title class_">BufferSkip</span>&lt;T&gt;(child, count, skip);</span><br><span class="line"></span><br><span class="line">            child.add(parent);</span><br><span class="line">            child.setProducer(parent.createProducer());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line">        BufferOverlap&lt;T&gt; parent = <span class="keyword">new</span> <span class="title class_">BufferOverlap</span>&lt;T&gt;(child, count, skip);</span><br><span class="line"></span><br><span class="line">        child.add(parent);</span><br><span class="line">        child.setProducer(parent.createProducer());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当<code>skip</code>等于<code>count</code>(默认情况)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">BufferExact</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">            List&lt;T&gt; b = buffer;</span><br><span class="line">            <span class="keyword">if</span> (b == <span class="literal">null</span>) &#123;</span><br><span class="line">                b = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;(count);</span><br><span class="line">                buffer = b;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            b.add(t);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (b.size() == count) &#123;</span><br><span class="line">                buffer = <span class="literal">null</span>;</span><br><span class="line">                actual.onNext(b);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建大小为<code>count</code>的数组，将接收到的数组添加到数组中，数组满，将数组作为数据发出</p>
</li>
<li><p><code>skip</code>大于<code>count</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">BufferSkip.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> index;</span><br><span class="line">            List&lt;T&gt; b = buffer;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                b = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;(count);</span><br><span class="line">                buffer = b;</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">if</span> (i == skip) &#123;</span><br><span class="line">                index = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                index = i;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (b != <span class="literal">null</span>) &#123;</span><br><span class="line">                b.add(t);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (b.size() == count) &#123;</span><br><span class="line">                    buffer = <span class="literal">null</span>;</span><br><span class="line">                    actual.onNext(b);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>每组<code>count</code>个，接收<code>skip</code>个数据，填满<code>count</code>个，剩余丢弃</p>
</li>
<li><p><code>count</code>大于<code>skip</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BufferOverlap.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> index;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                List&lt;T&gt; b = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;(count);</span><br><span class="line">                queue.offer(b);</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">if</span> (i == skip) &#123;</span><br><span class="line">                index = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                index = i;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (List&lt;T&gt; list : queue) &#123;</span><br><span class="line">                list.add(t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;T&gt; b = queue.peek();</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="literal">null</span> &amp;&amp; b.size() == count) &#123;</span><br><span class="line">                queue.poll();</span><br><span class="line">                produced++;</span><br><span class="line">                actual.onNext(b);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>ArrayDeque</code>存储每组数据。<code>ArrayDeque</code>会储存之前的数据。</li>
</ul>
<h6 id="buffer-Func0"><a href="#buffer-Func0" class="headerlink" title="buffer(Func0)"></a>buffer(Func0)</h6><ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">OperatorBufferWithSingleObservable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> List&lt;T&gt;&gt; child) &#123;</span><br><span class="line">        Observable&lt;? <span class="keyword">extends</span> <span class="title class_">TClosing</span>&gt; closing;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            closing = bufferClosingSelector.call();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwOrReport(t, child);</span><br><span class="line">            <span class="keyword">return</span> Subscribers.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BufferingSubscriber</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferingSubscriber</span>(<span class="keyword">new</span> <span class="title class_">SerializedSubscriber</span>&lt;List&lt;T&gt;&gt;(child));</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;TClosing&gt; closingSubscriber = <span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;TClosing&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(TClosing t)</span> &#123;</span><br><span class="line">                s.emit();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                s.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                s.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        child.add(closingSubscriber);</span><br><span class="line">        child.add(s);</span><br><span class="line"></span><br><span class="line">        closing.unsafeSubscribe(closingSubscriber);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>bufferClosingSelector</code>产生的<code>Observable</code>订阅<code>BufferingSubscriber</code>其内部使用<code>chunk</code>收集数据，当<code>closingSubscriber</code>被订阅，将<code>chunk</code>数据发出</li>
</ul>
<h6 id="buffer-long-timespan-long-timeshift-TimeUnit-unit"><a href="#buffer-long-timespan-long-timeshift-TimeUnit-unit" class="headerlink" title="buffer(long timespan, long timeshift, TimeUnit unit)"></a>buffer(long timespan, long timeshift, TimeUnit unit)</h6><ul>
<li>源码分析<blockquote>
<p>默认使用computation线程调度</p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OperatorBufferWithTime.java</span><br><span class="line"></span><br><span class="line"><span class="title function_">if</span> <span class="params">(timespan == timeshift)</span> &#123;</span><br><span class="line">            <span class="type">ExactSubscriber</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExactSubscriber</span>(serialized, inner);</span><br><span class="line">            parent.add(inner);</span><br><span class="line">            child.add(parent);</span><br><span class="line">            parent.scheduleExact();</span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">InexactSubscriber</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InexactSubscriber</span>(serialized, inner);</span><br><span class="line">        parent.add(inner);</span><br><span class="line">        child.add(parent);</span><br><span class="line">        parent.startNewChunk();</span><br><span class="line">        parent.scheduleChunk();</span><br><span class="line"><span class="keyword">return</span> parent;</span><br></pre></td></tr></table></figure>

<ul>
<li>数据刷新时间和数据块创建时间一样时使用<code>ExactSubscriber</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">            List&lt;T&gt; toEmit = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                chunk.add(t);</span><br><span class="line">                <span class="keyword">if</span> (chunk.size() == count) &#123;</span><br><span class="line">                    toEmit = chunk;</span><br><span class="line">                    chunk = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (toEmit != <span class="literal">null</span>) &#123;</span><br><span class="line">                child.onNext(toEmit);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>反之使用<code>InexactSubscriber</code>，其使用<code>LinkedList</code>作为<code>chunk</code>数据结构。用于存储多余的数据。数据生成的速度大于处理速度</li>
</ul>
<h5 id="FlatMap"><a href="#FlatMap" class="headerlink" title="FlatMap"></a>FlatMap</h5><blockquote>
<p>转换消息成被观察对象，对map(func)的结果做merge</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable&lt;T&gt; <span class="title function_">merge</span><span class="params">(Observable&lt;? extends Observable&lt;? extends T&gt;&gt; source)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (source.getClass() == ScalarSynchronousObservable.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((ScalarSynchronousObservable&lt;T&gt;)source).scalarFlatMap((Func1)UtilityFunctions.identity());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> source.lift(OperatorMerge.&lt;T&gt;instance(<span class="literal">false</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OperatorMerge.java，合并多个Observable成一个</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;Observable&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt;&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; child) &#123;</span><br><span class="line">        MergeSubscriber&lt;T&gt; subscriber = <span class="keyword">new</span> <span class="title class_">MergeSubscriber</span>&lt;T&gt;(child, delayErrors, maxConcurrent);</span><br><span class="line">        MergeProducer&lt;T&gt; producer = <span class="keyword">new</span> <span class="title class_">MergeProducer</span>&lt;T&gt;(subscriber);</span><br><span class="line">        subscriber.producer = producer;</span><br><span class="line"></span><br><span class="line">        child.add(subscriber);</span><br><span class="line">        child.setProducer(producer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> subscriber;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> MergeSubscriber.java</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Observable&lt;? extends T&gt; t)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t == Observable.empty()) &#123;</span><br><span class="line">                emitEmpty();</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ScalarSynchronousObservable) &#123;</span><br><span class="line">                tryEmit(((ScalarSynchronousObservable&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt;)t).get());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                InnerSubscriber&lt;T&gt; inner = <span class="keyword">new</span> <span class="title class_">InnerSubscriber</span>&lt;T&gt;(<span class="built_in">this</span>, uniqueId++);</span><br><span class="line">                addInner(inner);</span><br><span class="line">                t.unsafeSubscribe(inner);</span><br><span class="line">                emit();</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>InnerSubscriber</code>，其内部会调用<code>tryEmit</code>。之后调用<code>emitLoop</code>，循环从唤醒队列中取出消息发出</li>
</ul>
<h5 id="GroupBy"><a href="#GroupBy" class="headerlink" title="GroupBy"></a>GroupBy</h5><blockquote>
<p>将源数据按特征分组，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">                  .groupBy(integer -&gt; integer % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">                  .subscribe(grouped -&gt; grouped.toList().subscribe(integers -&gt; System.out.println(integers + <span class="string">&quot; (Even: &quot;</span> + grouped.getKey() + <span class="string">&quot;)&quot;</span>)));</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">OperatorGroupBy.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; call(Subscriber&lt;? <span class="built_in">super</span> GroupedObservable&lt;K, V&gt;&gt; child) &#123;</span><br><span class="line">        <span class="keyword">final</span> GroupBySubscriber&lt;T, K, V&gt; parent; <span class="comment">// NOPMD</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parent = <span class="keyword">new</span> <span class="title class_">GroupBySubscriber</span>&lt;T, K, V&gt;(child, keySelector, valueSelector, bufferSize, delayError, mapFactory);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">//Can reach here because mapFactory.call() may throw in constructor of GroupBySubscriber</span></span><br><span class="line">            Exceptions.throwOrReport(ex, child);</span><br><span class="line">            Subscriber&lt;? <span class="built_in">super</span> T&gt; parent2 = Subscribers.empty();</span><br><span class="line">            parent2.unsubscribe();</span><br><span class="line">            <span class="keyword">return</span> parent2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        child.add(Subscriptions.create(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                parent.cancel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        child.setProducer(parent.producer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GroupBySubscriber.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">	K key;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    key = keySelector.call(t);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">	    unsubscribe();</span><br><span class="line">	    errorAll(a, q, ex);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (group == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// if the main has been cancelled, stop creating groups</span></span><br><span class="line">        <span class="comment">// and skip this value</span></span><br><span class="line">        <span class="keyword">if</span> (!cancelled.get()) &#123;</span><br><span class="line">            group = GroupedUnicast.createWith(key, bufferSize, <span class="built_in">this</span>, delayError);</span><br><span class="line">            groups.put(mapKey, group);</span><br><span class="line"></span><br><span class="line">            groupCount.getAndIncrement();</span><br><span class="line"></span><br><span class="line">            notNew = <span class="literal">false</span>;</span><br><span class="line">            q.offer(group);</span><br><span class="line">            drain();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    V v;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        v = valueSelector.call(t);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        unsubscribe();</span><br><span class="line">        errorAll(a, q, ex);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    group.onNext(v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用键选择器生成<code>key</code>，使用<code>key</code>创建<code>GroupedUnicast</code>存储起来。通过值选择器生成值并发出。</li>
</ul>
<h5 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h5><blockquote>
<p>与flatmap类似，flatmap多了merge步骤</p>
</blockquote>
<h5 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h5><blockquote>
<p>对新发出的信息与之前发出的消息一起做某种处理。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).scan((sum, value) -&gt; sum + value).subscribe(integer -&gt; System.out.println(<span class="string">&quot;Sum: &quot;</span> + integer));</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">Sum: <span class="number">1</span></span><br><span class="line">Sum: <span class="number">3</span></span><br><span class="line">Sum: <span class="number">6</span></span><br><span class="line">Sum: <span class="number">10</span></span><br><span class="line">Sum: <span class="number">15</span></span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">OperatorScan.java</span><br><span class="line"></span><br><span class="line"><span class="comment">//没有初始值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">    R v;</span><br><span class="line">    <span class="keyword">if</span> (!once) &#123;</span><br><span class="line">        once = <span class="literal">true</span>;</span><br><span class="line">        v = (R)t;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v = value;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">//使用之前的结果</span></span><br><span class="line">            v = accumulator.call(v, t);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            Exceptions.throwOrReport(e, child, t);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    value = v;</span><br><span class="line">    child.onNext(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//有初始值</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T currentValue)</span> &#123;</span><br><span class="line">    <span class="type">R</span> <span class="variable">v</span> <span class="operator">=</span> value;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        v = accumulator.call(v, currentValue);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        Exceptions.throwOrReport(e, <span class="built_in">this</span>, currentValue);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value = v;</span><br><span class="line">    ip.onNext(v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接收到消息，使用之前计算的结果和当前值做计算并存储</li>
</ul>
<h5 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h5><blockquote>
<p>与buffer类似，但其缓存后是以新的对象作为消息发出(Subject)</p>
</blockquote>
<h4 id="Filtering-Observables"><a href="#Filtering-Observables" class="headerlink" title="Filtering Observables"></a>Filtering Observables</h4><h5 id="Debounce"><a href="#Debounce" class="headerlink" title="Debounce"></a>Debounce</h5><blockquote>
<p>只发出经过特定时间从源消息接收到的消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).debounce(Observable::just).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br><span class="line"></span><br><span class="line">Observable.from(integers).debounce(<span class="number">1</span>, TimeUnit.SECONDS).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">OperatorDebounceWithTime.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> state.next(t);</span><br><span class="line">    serial.set(worker.schedule(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">            state.emit(index, s, self);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, timeout, unit));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>接收源消息自增。定时调用<code>emit</code>发送消息，如果源消息的发送速度快于当前调度时间，则这些事件会丢弃。事件发送结束时会发送最后一个消息</li>
</ul>
<h5 id="Distinct"><a href="#Distinct" class="headerlink" title="Distinct"></a>Distinct</h5><blockquote>
<p>过滤重复的消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>).distinct().subscribe(integer -&gt; System.out.println(<span class="string">&quot;integer: &quot;</span> + integer));</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">integer: <span class="number">1</span></span><br><span class="line">integer: <span class="number">2</span></span><br><span class="line">integer: <span class="number">3</span></span><br><span class="line">integer: <span class="number">4</span></span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">OperatorDistinct.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">    <span class="type">U</span> <span class="variable">key</span> <span class="operator">=</span> keySelector.call(t);</span><br><span class="line">    <span class="keyword">if</span> (keyMemory.add(key)) &#123;</span><br><span class="line">        child.onNext(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用一个<code>Set</code>来存储消息</li>
</ul>
<h5 id="ElementAt"><a href="#ElementAt" class="headerlink" title="ElementAt"></a>ElementAt</h5><blockquote>
<p>只发送第n个消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).elementAt(<span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OperatorElementAt.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (currentIndex++ == index) &#123;</span><br><span class="line">        child.onNext(value);</span><br><span class="line">        child.onCompleted();</span><br><span class="line">        unsubscribe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>只有当第n个消息才发送</li>
</ul>
<h5 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h5><blockquote>
<p>按特定条件过滤消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>).filter(integer -&gt; integer &gt; <span class="number">2</span>).subscribe(integer -&gt; System.out.println(<span class="string">&quot;integer: &quot;</span> + integer));</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">integer: <span class="number">3</span></span><br><span class="line">integer: <span class="number">4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeFilter.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = predicate.call(t);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(ex);</span><br><span class="line">        unsubscribe();</span><br><span class="line">        onError(OnErrorThrowable.addValueAsLastCause(ex, t));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        actual.onNext(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用选择器过滤消息</li>
</ul>
<h5 id="first"><a href="#first" class="headerlink" title="first"></a>first</h5><blockquote>
<p>发出第一个消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).first(integer -&gt; <span class="literal">false</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">可以决定第一个消息是否发出</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onError</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OperatorTake.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T i)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isUnsubscribed() &amp;&amp; count++ &lt; limit) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">stop</span> <span class="operator">=</span> count == limit;</span><br><span class="line">        child.onNext(i);</span><br><span class="line">        <span class="keyword">if</span> (stop &amp;&amp; !completed) &#123;</span><br><span class="line">            completed = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                child.onCompleted();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unsubscribe();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>只发出指定数量的消息</li>
</ul>
<h5 id="IgnoreElements"><a href="#IgnoreElements" class="headerlink" title="IgnoreElements"></a>IgnoreElements</h5><blockquote>
<p>不发出任何消息，但发出结束的通知，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).ignoreElements().subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="last"><a href="#last" class="headerlink" title="last"></a>last</h5><blockquote>
<p>只发出最后一个消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).last().subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">	<span class="comment">//存储最新的值</span></span><br><span class="line">    value = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> value;</span><br><span class="line">    <span class="keyword">if</span> (o == EMPTY) &#123;</span><br><span class="line">        complete();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">//结束时，发出最后一个消息</span></span><br><span class="line">        complete((T)o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结束时，发出最后的消息</li>
</ul>
<h5 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h5><blockquote>
<p>发出一段时间内最近的消息</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">OperatorSampleWithTime.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">    value.set(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">    emitIfNonEmpty();</span><br><span class="line">    subscriber.onCompleted();</span><br><span class="line">    unsubscribe();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">emitIfNonEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">localValue</span> <span class="operator">=</span> value.getAndSet(EMPTY_TOKEN);</span><br><span class="line">    <span class="keyword">if</span> (localValue != EMPTY_TOKEN) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">v</span> <span class="operator">=</span> (T)localValue;</span><br><span class="line">            subscriber.onNext(v);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            Exceptions.throwOrReport(e, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>存储最新的值，结束时发出最新的值</li>
</ul>
<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><blockquote>
<p>跳过n个消息不发送，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skip(<span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OperatorSkip.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (skipped &gt;= toSkip) &#123;</span><br><span class="line">        child.onNext(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        skipped += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>跳过n个消息</li>
</ul>
<h5 id="skipLast"><a href="#skipLast" class="headerlink" title="skipLast"></a>skipLast</h5><blockquote>
<p>跳过后n个消息不发送，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skipLast(<span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">OperatorSkipLast.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If count == 0, we do not need to put value into deque</span></span><br><span class="line">        <span class="comment">// and remove it at once. We can emit the value</span></span><br><span class="line">        <span class="comment">// directly.</span></span><br><span class="line">        subscriber.onNext(value);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (deque.size() == count) &#123;</span><br><span class="line">        subscriber.onNext(NotificationLite.&lt;T&gt;getValue(deque.removeFirst()));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    deque.offerLast(NotificationLite.next(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用双端队列存储消息，将前面的消息存入，当数量达到要求，从双端队列中取数据发送</li>
</ul>
<h5 id="Take-TakeLast"><a href="#Take-TakeLast" class="headerlink" title="Take, TakeLast"></a>Take, TakeLast</h5><blockquote>
<p>发送前n个消息</p>
</blockquote>
<ul>
<li>源码分析，前面已有</li>
</ul>
<h4 id="Combining-Observable"><a href="#Combining-Observable" class="headerlink" title="Combining Observable"></a>Combining Observable</h4><h5 id="And-x2F-Then-x2F-When"><a href="#And-x2F-Then-x2F-When" class="headerlink" title="And&#x2F;Then&#x2F;When"></a>And&#x2F;Then&#x2F;When</h5><blockquote>
<p>通过patter和plan合并多个消息源发出的数据集,不是rxjava核心库的一部分</p>
</blockquote>
<h5 id="CombineLast"><a href="#CombineLast" class="headerlink" title="CombineLast"></a>CombineLast</h5><blockquote>
<p>使用特定方法合并两个消息源最近的数据，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">MySubscriber</span> <span class="variable">subscriber</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySubscriber</span>();</span><br><span class="line">        subscriber.setCountDownLatch(countDownLatch);</span><br><span class="line">        Observable.combineLatest(Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS).take(<span class="number">5</span>), Observable.from(integers), (first, second) -&gt; first + second).subscribe(subscriber);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onNext value: <span class="number">9</span></span><br><span class="line">onNext value: <span class="number">10</span></span><br><span class="line">onNext value: <span class="number">11</span></span><br><span class="line">onNext value: <span class="number">12</span></span><br><span class="line">onCompleted</span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<ul>
<li><p>第一个消息源一秒钟发出一个消息，第二个消息源一次性发完，因此合并消息会合并最后一个消息</p>
</li>
<li><p>源码分析</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LatestCoordinator.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Observable&lt;? extends T&gt;[] sources)</span> &#123;</span><br><span class="line">    Subscriber&lt;T&gt;[] as = subscribers;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> as.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        as[i] = <span class="keyword">new</span> <span class="title class_">CombinerSubscriber</span>&lt;T, R&gt;(<span class="built_in">this</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    lazySet(<span class="number">0</span>); <span class="comment">// release array contents</span></span><br><span class="line">    actual.add(<span class="built_in">this</span>);</span><br><span class="line">    actual.setProducer(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cancelled) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ((Observable&lt;T&gt;)sources[i]).subscribe(as[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建多个<code>CombinerSubscriber</code>对应多个消息源。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">CombinerSubscriber.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">combine</span><span class="params">(Object value, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (!empty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; allSourcesFinished) &#123;</span><br><span class="line">        <span class="comment">//插入最新的数据</span></span><br><span class="line">            queue.offer(combinerSubscriber, latest.clone());</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span> &amp;&amp; error.get() != <span class="literal">null</span> &amp;&amp; (o == MISSING || !delayError)) &#123;</span><br><span class="line">            done = <span class="literal">true</span>; <span class="comment">// if this source completed without a value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	 drain()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">drain() &#123;</span><br><span class="line">	R v;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        v = combiner.call(array);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        cancelled = <span class="literal">true</span>;</span><br><span class="line">        cancel(q);</span><br><span class="line">        a.onError(ex);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    a.onNext(v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>收集最近的数据到<code>SpscLinkedArrayQueue</code>中</li>
</ul>
<h5 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h5><blockquote>
<p>只要一个数据在另一个数据定义的时间窗口内发出，合并两个数据源发出的数据</p>
</blockquote>
<h5 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h5><blockquote>
<p>根据时间轴合并多个数据源成一个，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="type">MySubscriber</span> <span class="variable">subscriber</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySubscriber</span>();</span><br><span class="line">    subscriber.setCountDownLatch(countDownLatch);</span><br><span class="line">    Observable.merge(Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS).take(<span class="number">5</span>), Observable.from(integers)).subscribe(subscriber);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="StartWith"><a href="#StartWith" class="headerlink" title="StartWith"></a>StartWith</h5><blockquote>
<p>开始发送数据前发送一系列指定的数据，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).startWith(<span class="number">100</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">100</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析，其使用的是<code>concat</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeConcatMap.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!queue.offer(NotificationLite.next(t))) &#123;</span><br><span class="line">        unsubscribe();</span><br><span class="line">        onError(<span class="keyword">new</span> <span class="title class_">MissingBackpressureException</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        drain();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>队列未满时，往队列里插入数据，之后调用<code>drain</code>消费数据</li>
</ul>
<h5 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h5><blockquote>
<p>转换多个数据源为单个数据源，使用最近数据转换，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers1).switchIfEmpty(Observable.from(integers)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h5><blockquote>
<p>按数据合并两个数据源，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Integer&gt; evens = Observable.just(<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>);</span><br><span class="line">        Observable&lt;Integer&gt; odds = Observable.just(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>);</span><br><span class="line">        Observable.zip(evens, odds, (v1, v2) -&gt; v1 + <span class="string">&quot; + &quot;</span> + v2 + <span class="string">&quot; is: &quot;</span> + (v1 + v2)).subscribe(System.out::println);</span><br><span class="line">        </span><br><span class="line">结果:</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> + <span class="number">1</span> is: <span class="number">3</span></span><br><span class="line"><span class="number">4</span> + <span class="number">3</span> is: <span class="number">7</span></span><br><span class="line"><span class="number">6</span> + <span class="number">5</span> is: <span class="number">11</span></span><br><span class="line"><span class="number">8</span> + <span class="number">7</span> is: <span class="number">15</span></span><br><span class="line"><span class="number">10</span> + <span class="number">9</span> is: <span class="number">19</span>        </span><br></pre></td></tr></table></figure>

<h4 id="Error-Handling-Operators"><a href="#Error-Handling-Operators" class="headerlink" title="Error Handling Operators"></a>Error Handling Operators</h4><h5 id="Catch"><a href="#Catch" class="headerlink" title="Catch"></a>Catch</h5><blockquote>
<p>从错误中恢复，继续执行，示例</p>
</blockquote>
<h6 id="onErrorReturn"><a href="#onErrorReturn" class="headerlink" title="onErrorReturn"></a>onErrorReturn</h6><blockquote>
<p>出现错误时，返回一个特定的值，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; integer / <span class="number">0</span>).onErrorReturn(throwable -&gt; <span class="number">0</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h6 id="onErrorResumeNext-onExceptionResumeNext"><a href="#onErrorResumeNext-onExceptionResumeNext" class="headerlink" title="onErrorResumeNext, onExceptionResumeNext"></a>onErrorResumeNext, onExceptionResumeNext</h6><blockquote>
<p>出现错误，构建另一个消息源，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; integer / <span class="number">0</span>).onErrorResumeNext(throwable -&gt; Observable.from(integers1)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: -<span class="number">1</span></span><br><span class="line">onNext value: -<span class="number">2</span></span><br><span class="line">onNext value: -<span class="number">3</span></span><br><span class="line">onNext value: -<span class="number">4</span></span><br><span class="line">onNext value: -<span class="number">5</span></span><br><span class="line">onNext value: -<span class="number">6</span></span><br><span class="line">onNext value: -<span class="number">7</span></span><br><span class="line">onNext value: -<span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(e);</span><br><span class="line">        RxJavaHooks.onError(e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    done = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        unsubscribe();</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;T&gt; next = <span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;T&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">                child.onNext(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                child.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                child.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProducer</span><span class="params">(Producer producer)</span> &#123;</span><br><span class="line">                pa.setProducer(producer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        serial.set(next);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">p</span> <span class="operator">=</span> produced;</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="number">0L</span>) &#123;</span><br><span class="line">            pa.produced(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Observable&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; resume = resumeFunction.call(e);</span><br><span class="line"></span><br><span class="line">        resume.unsafeSubscribe(next);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e2) &#123;</span><br><span class="line">        Exceptions.throwOrReport(e2, child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>出现错误，使用外部提供的方式产生新的消息源并发出</li>
</ul>
<h5 id="Retry"><a href="#Retry" class="headerlink" title="Retry"></a>Retry</h5><h6 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h6><blockquote>
<p>出现错误，重新订阅并重试，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (integer == a) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> integer;</span><br><span class="line">&#125;).retry(<span class="number">1</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>retry</code>也可以提供选择器来决定是否重试</li>
</ul>
<h6 id="retryWhen"><a href="#retryWhen" class="headerlink" title="retryWhen"></a>retryWhen</h6><blockquote>
<p>捕获错误，生成第二个消息源,并监听此消息源，如果此消息源发出消息，则重新订阅源消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">if</span> (integer == a) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> integer;</span><br><span class="line">        &#125;).retryWhen(observable -&gt; observable.zipWith(Observable.range(<span class="number">1</span>, <span class="number">3</span>), (n, i) -&gt; i).flatMap(i -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;delay retry by &quot;</span> + i + <span class="string">&quot; second(s)&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Observable.timer(i, TimeUnit.SECONDS);</span><br><span class="line">        &#125;)).toBlocking().forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<h4 id="Observable-Utility-Operators"><a href="#Observable-Utility-Operators" class="headerlink" title="Observable Utility Operators"></a>Observable Utility Operators</h4><h5 id="Delay"><a href="#Delay" class="headerlink" title="Delay"></a>Delay</h5><blockquote>
<p>延迟发出消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).delay(<span class="number">5</span>, TimeUnit.SECONDS).toBlocking().forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(<span class="keyword">final</span> T t)</span> &#123;</span><br><span class="line">    worker.schedule(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                child.onNext(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, delay, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>线程调度延时</li>
</ul>
<h5 id="Do"><a href="#Do" class="headerlink" title="Do"></a>Do</h5><blockquote>
<p>在可观察对象生命周期发生之前调用，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).doAfterTerminate(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;terminate&quot;</span>);</span><br><span class="line">&#125;).subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>

<h5 id="Materialize-x2F-Dematerialize"><a href="#Materialize-x2F-Dematerialize" class="headerlink" title="Materialize&#x2F;Dematerialize"></a>Materialize&#x2F;Dematerialize</h5><blockquote>
<p>对于发出的每个消息进行包装与拆包装</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).materialize().dematerialize().subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>

<h5 id="ObserveOn"><a href="#ObserveOn" class="headerlink" title="ObserveOn"></a>ObserveOn</h5><blockquote>
<p>指定观察者在哪个线程观察结果</p>
</blockquote>
<ul>
<li>源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ScalarSynchronousObservable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title function_">scalarScheduleOn</span><span class="params">(<span class="keyword">final</span> Scheduler scheduler)</span> &#123;</span><br><span class="line">    Func1&lt;Action0, Subscription&gt; onSchedule;</span><br><span class="line">    <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> EventLoopsScheduler) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EventLoopsScheduler</span> <span class="variable">els</span> <span class="operator">=</span> (EventLoopsScheduler) scheduler;</span><br><span class="line">        onSchedule = <span class="keyword">new</span> <span class="title class_">Func1</span>&lt;Action0, Subscription&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Subscription <span class="title function_">call</span><span class="params">(Action0 a)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> els.scheduleDirect(a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onSchedule = <span class="keyword">new</span> <span class="title class_">Func1</span>&lt;Action0, Subscription&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Subscription <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Action0 a)</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> Scheduler.<span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> scheduler.createWorker();</span><br><span class="line">                w.schedule(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            a.call();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            w.unsubscribe();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> w;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> <span class="title class_">ScalarAsyncOnSubscribe</span>&lt;T&gt;(t, onSchedule));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>区分<code>EventLoopsScheduler</code>和其他调度器。如果是<code>EventLoopsScheduler</code>直接调度，否则创建调度器,由调度器运行接收到的消息。解除调度器订阅</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OperatorObserveOn.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="built_in">super</span> T&gt; call(Subscriber&lt;? <span class="built_in">super</span> T&gt; child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> ImmediateScheduler) &#123;</span><br><span class="line">        <span class="comment">// avoid overhead, execute directly</span></span><br><span class="line">        <span class="keyword">return</span> child;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> TrampolineScheduler) &#123;</span><br><span class="line">        <span class="comment">// avoid overhead, execute directly</span></span><br><span class="line">        <span class="keyword">return</span> child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ObserveOnSubscriber&lt;T&gt; parent = <span class="keyword">new</span> <span class="title class_">ObserveOnSubscriber</span>&lt;T&gt;(scheduler, child, delayError, bufferSize);</span><br><span class="line">        parent.init();</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果调度器是<code>ImmediateScheduler(即时调度器)</code>或者<code>TrampolineScheduler(串行调度器)</code>则立即执行。否则创建<code>ObserveOnSubscriber</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ObserveOnSubscriber.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">schedule</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (counter.getAndIncrement() == <span class="number">0</span>) &#123;</span><br><span class="line">        recursiveScheduler.schedule(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (requestAmount != currentEmission) &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">done</span> <span class="operator">=</span> finished;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">v</span> <span class="operator">=</span> q.poll();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">empty</span> <span class="operator">=</span> v == <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checkTerminated(done, empty, localChild, q)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    localChild.onNext(NotificationLite.&lt;T&gt;getValue(v));</span><br><span class="line"></span><br><span class="line">    currentEmission++;</span><br><span class="line">    <span class="keyword">if</span> (currentEmission == limit) &#123;</span><br><span class="line">        requestAmount = BackpressureUtils.produced(requested, currentEmission);</span><br><span class="line">        request(currentEmission);</span><br><span class="line">        currentEmission = <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其中有个队列(<code>SpscAtomicArrayQueue</code>)，用于接收消息，开始循环从队列中取出消息，如果发送的消息数量和请求消息的数量一致，表示此次事件发送结束</li>
</ul>
<h5 id="Serialize"><a href="#Serialize" class="headerlink" title="Serialize"></a>Serialize</h5><blockquote>
<p>强制串行发送消息</p>
</blockquote>
<h5 id="SubscribeOn"><a href="#SubscribeOn" class="headerlink" title="SubscribeOn"></a>SubscribeOn</h5><blockquote>
<p>指定可观察对象在哪个线程上执行</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">inner.schedule(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;T&gt; s = <span class="keyword">new</span> <span class="title class_">Subscriber</span>&lt;T&gt;(subscriber) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span> &#123;</span><br><span class="line">                subscriber.onNext(t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    subscriber.onError(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    inner.unsubscribe();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    subscriber.onCompleted();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    inner.unsubscribe();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProducer</span><span class="params">(<span class="keyword">final</span> Producer p)</span> &#123;</span><br><span class="line">                subscriber.setProducer(<span class="keyword">new</span> <span class="title class_">Producer</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> n)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (t == Thread.currentThread()) &#123;</span><br><span class="line">                            p.request(n);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            inner.schedule(<span class="keyword">new</span> <span class="title class_">Action0</span>() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">                                    p.request(n);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        source.unsafeSubscribe(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>开启线程调度，从当前线程中发出消息到下一级订阅者</li>
</ul>
<h5 id="TimeInterval"><a href="#TimeInterval" class="headerlink" title="TimeInterval"></a>TimeInterval</h5><blockquote>
<p>将源消息源发出的消息转换成表示消息与消息直接的时间间隔,示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).timeInterval().subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">2</span>, value=<span class="number">0</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">1</span>, value=<span class="number">1</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">2</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">3</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">4</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">5</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">6</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">7</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">8</span>]</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<ul>
<li>源码分析</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T args)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">nowTimestamp</span> <span class="operator">=</span> scheduler.now();</span><br><span class="line">    subscriber.onNext(<span class="keyword">new</span> <span class="title class_">TimeInterval</span>&lt;T&gt;(nowTimestamp - lastTimestamp, args));</span><br><span class="line">    lastTimestamp = nowTimestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当前时间减去上次接收到消息的时间，封装成<code>TimeIntegerval</code></li>
</ul>
<h5 id="TimeOut"><a href="#TimeOut" class="headerlink" title="TimeOut"></a>TimeOut</h5><blockquote>
<p>如果在一定时间内没有发出消息，发出<code>error</code>通知</p>
</blockquote>
<h5 id="Timestamp"><a href="#Timestamp" class="headerlink" title="Timestamp"></a>Timestamp</h5><blockquote>
<p>给每个发出的消息带上时间戳,示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).timestamp().subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>

<h5 id="Using"><a href="#Using" class="headerlink" title="Using"></a>Using</h5><blockquote>
<p>创建可分配的资源，其与可观察对象具有一样的生命周期</p>
</blockquote>
<h4 id="Conditional-and-Boolean-Operators"><a href="#Conditional-and-Boolean-Operators" class="headerlink" title="Conditional and Boolean Operators"></a>Conditional and Boolean Operators</h4><h5 id="All"><a href="#All" class="headerlink" title="All"></a>All</h5><blockquote>
<p>规定是否所有的消息发出，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).all(integer -&gt; integer &lt; <span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="literal">false</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="Amb"><a href="#Amb" class="headerlink" title="Amb"></a>Amb</h5><blockquote>
<p>只发送多个消息源中最先产生消息的消息源，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.amb(Observable.from(integers).delay(<span class="number">2</span>, TimeUnit.SECONDS), Observable.from(integers1).delay(<span class="number">1</span>, TimeUnit.SECONDS))</span><br><span class="line">                  .toBlocking()</span><br><span class="line">                  .forEach(System.out::println);</span><br><span class="line">                  </span><br><span class="line">结果:</span><br><span class="line"><span class="number">0</span></span><br><span class="line">-<span class="number">1</span></span><br><span class="line">-<span class="number">2</span></span><br><span class="line">-<span class="number">3</span></span><br><span class="line">-<span class="number">4</span></span><br><span class="line">-<span class="number">5</span></span><br><span class="line">-<span class="number">6</span></span><br><span class="line">-<span class="number">7</span></span><br><span class="line">-<span class="number">8</span>  </span><br></pre></td></tr></table></figure>

<h5 id="Contain"><a href="#Contain" class="headerlink" title="Contain"></a>Contain</h5><blockquote>
<p>发出的消息是否包含某消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).contains(<span class="number">1</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="literal">true</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="DefaultIfEmpty"><a href="#DefaultIfEmpty" class="headerlink" title="DefaultIfEmpty"></a>DefaultIfEmpty</h5><blockquote>
<p>如果没有发出任何消息，发出默认消息,示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.empty().defaultIfEmpty(<span class="number">11</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">11</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="SequenceEqual"><a href="#SequenceEqual" class="headerlink" title="SequenceEqual"></a>SequenceEqual</h5><blockquote>
<p>两个消息源是否发出相同的消息,示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.sequenceEqual(Observable.from(integers), Observable.from(integers)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="literal">true</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="SkipUntil-TakeUntil"><a href="#SkipUntil-TakeUntil" class="headerlink" title="SkipUntil, TakeUntil"></a>SkipUntil, TakeUntil</h5><blockquote>
<p>丢弃&#x2F;发送第一个消息源在第二个消息源发出消息之前发出的消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skipUntil(Observable.from(integers1).delay(<span class="number">1</span>, TimeUnit.SECONDS)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h5 id="SkipWhile-TakeWhile"><a href="#SkipWhile-TakeWhile" class="headerlink" title="SkipWhile, TakeWhile"></a>SkipWhile, TakeWhile</h5><blockquote>
<p>丢弃&#x2F;发送消息直到某个条件变成false，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skipWhile(integer -&gt; integer &gt;= <span class="number">0</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>

<h4 id="Mathematical-and-Aggregate-Operators"><a href="#Mathematical-and-Aggregate-Operators" class="headerlink" title="Mathematical and Aggregate Operators"></a>Mathematical and Aggregate Operators</h4><h5 id="Average"><a href="#Average" class="headerlink" title="Average"></a>Average</h5><blockquote>
<p>发出消息的平均值，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MathObservable.from(Observable.from(integers)).averageInteger(integer -&gt; integer).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>

<h5 id="Concat"><a href="#Concat" class="headerlink" title="Concat"></a>Concat</h5><blockquote>
<p>拼接多个消息源，按顺序发送消息，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.concat(Observable.from(integers), Observable.from(integers1)).forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<h5 id="Count"><a href="#Count" class="headerlink" title="Count"></a>Count</h5><blockquote>
<p>统计发出消息的数量，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assertEquals(Integer.valueOf(integers.length), Observable.from(integers).count().toBlocking().single());</span><br></pre></td></tr></table></figure>

<h5 id="Max-x2F-Min"><a href="#Max-x2F-Min" class="headerlink" title="Max&#x2F;Min"></a>Max&#x2F;Min</h5><blockquote>
<p>获取消息中最大&#x2F;最小值，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assertEquals(integers[integers.length - <span class="number">1</span>], MathObservable.from(Observable.from(integers)).max((o1, o2) -&gt; o1 - o2).toBlocking().single());</span><br></pre></td></tr></table></figure>

<h5 id="Reduce-Sum"><a href="#Reduce-Sum" class="headerlink" title="Reduce, Sum"></a>Reduce, Sum</h5><blockquote>
<p>对每个发出的消息做操作，发送最终的值，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).reduce((integer, integer2) -&gt; integer + integer2).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line"><span class="number">36</span></span><br></pre></td></tr></table></figure>

<h4 id="Backpressure-Operators"><a href="#Backpressure-Operators" class="headerlink" title="Backpressure Operators"></a>Backpressure Operators</h4><ul>
<li>Buffer, Sample, Debounce, Window</li>
</ul>
<h4 id="Connectable-Observable-Operators"><a href="#Connectable-Observable-Operators" class="headerlink" title="Connectable Observable Operators"></a>Connectable Observable Operators</h4><h5 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h5><blockquote>
<p>连接<code>Observable</code>和<code>Subscribers</code>。可以指定连接几个<code>Subscriber</code>。只有当所有的<code>Subscriber</code>都订阅了才开始发送消息。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">run</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ConnectableObservable&lt;Integer&gt; co = Observable.defer(() -&gt; Observable.just(run.incrementAndGet())).publish();</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动连接，生成可观察对象</span></span><br><span class="line">   <span class="keyword">final</span> Observable&lt;Integer&gt; source = co.autoConnect();</span><br><span class="line"></span><br><span class="line">   assertEquals(<span class="number">0</span>, run.get());</span><br><span class="line"></span><br><span class="line">   TestSubscriber&lt;Integer&gt; ts1 = TestSubscriber.create();</span><br><span class="line">   <span class="comment">//订阅了一次</span></span><br><span class="line">   source.subscribe(ts1);</span><br><span class="line"></span><br><span class="line">   ts1.assertCompleted();</span><br><span class="line">   ts1.assertNoErrors();</span><br><span class="line">   ts1.assertValue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">   assertEquals(<span class="number">1</span>, run.get());</span><br><span class="line"></span><br><span class="line">   TestSubscriber&lt;Integer&gt; ts2 = TestSubscriber.create();</span><br><span class="line">   <span class="comment">//第二次订阅，这是无效的，因为默认只指定了一次订阅</span></span><br><span class="line">   source.subscribe(ts2);</span><br><span class="line"></span><br><span class="line">   ts2.assertNotCompleted();</span><br><span class="line">   ts2.assertNoErrors();</span><br><span class="line">   ts2.assertNoValues();</span><br><span class="line"></span><br><span class="line">   assertEquals(<span class="number">1</span>, run.get());</span><br></pre></td></tr></table></figure>

<h5 id="Publish"><a href="#Publish" class="headerlink" title="Publish"></a>Publish</h5><blockquote>
<p>将普通<code>Observable</code>转换成<code>ConnectableObservable</code>，示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">ConnectableObservable&lt;String&gt; o = Observable.create(<span class="keyword">new</span> <span class="title class_">Observable</span>.OnSubscribe&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> String&gt; observer)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            counter.incrementAndGet();</span><br><span class="line">            observer.onNext(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">            observer.onCompleted();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).publish();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">&quot;one&quot;</span>, v);</span><br><span class="line">    countDownLatch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe again</span></span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">&quot;one&quot;</span>, v);</span><br><span class="line">    countDownLatch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接，才能收到消息</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Subscription</span> <span class="variable">subscription</span> <span class="operator">=</span> o.connect();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!countDownLatch.await(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">        fail(<span class="string">&quot;subscriptions did not receive values&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    assertEquals(<span class="number">1</span>, counter.get());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    subscription.unsubscribe();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RefCount"><a href="#RefCount" class="headerlink" title="RefCount"></a>RefCount</h5><blockquote>
<p>让<code>ConnectTableObservable</code>表现像普通<code>Observable</code>。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">subscribeCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"><span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">nextCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"><span class="keyword">final</span> Observable&lt;Integer&gt; observable = Observable.from(integers)</span><br><span class="line">                                                 .doOnSubscribe(subscribeCount::incrementAndGet)</span><br><span class="line">                                                 .doOnNext(l -&gt; nextCount.incrementAndGet())</span><br><span class="line">                                                 .publish()</span><br><span class="line">                                                 .refCount();</span><br><span class="line"><span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">receivedCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"><span class="comment">//订阅一次,doOnNext会执行</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Subscription</span> <span class="variable">s1</span> <span class="operator">=</span> observable.subscribe(l -&gt; receivedCount.incrementAndGet());</span><br><span class="line"><span class="comment">//订阅第二次, doOnNext会执行</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Subscription</span> <span class="variable">s2</span> <span class="operator">=</span> observable.subscribe();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">50</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line">s2.unsubscribe();</span><br><span class="line">s1.unsubscribe();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;onNext Count: &quot;</span> + nextCount.get());</span><br><span class="line"></span><br><span class="line">assertEquals(nextCount.get(), receivedCount.get() * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="number">2</span>, subscribeCount.get());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>普通<code>Observable</code>和<code>ConnectTableObservable</code>区别在于，普通的<code>Observable</code>只要订阅，就会发送消息，而<code>ConnectTableObservable</code>会连接几个订阅者，如连接1各订阅者，但是订阅了两次，那么后面一次是不会执行的。</li>
</ul>
<h5 id="Replay-Cache"><a href="#Replay-Cache" class="headerlink" title="Replay, Cache"></a>Replay, Cache</h5><blockquote>
<p>确保所有的观察者看到相同的消息时序，虽然它们订阅的时候，消息源可能已经开始发送消息了。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">Observable&lt;String&gt; o = Observable.create(<span class="keyword">new</span> <span class="title class_">Observable</span>.OnSubscribe&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="built_in">super</span> String&gt; observer)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            counter.incrementAndGet();</span><br><span class="line">            System.out.println(<span class="string">&quot;published observable being executed&quot;</span>);</span><br><span class="line">            observer.onNext(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">            observer.onCompleted();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).replay().autoConnect();</span><br><span class="line"></span><br><span class="line"><span class="comment">// we then expect the following 2 subscriptions to get that same value</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe once</span></span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">&quot;one&quot;</span>, v);</span><br><span class="line">    System.out.println(<span class="string">&quot;v: &quot;</span> + v);</span><br><span class="line">    latch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe again</span></span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">&quot;one&quot;</span>, v);</span><br><span class="line">    System.out.println(<span class="string">&quot;v: &quot;</span> + v);</span><br><span class="line">    latch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!latch.await(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">    fail(<span class="string">&quot;subscriptions did not receive values&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">assertEquals(<span class="number">1</span>, counter.get());</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://reactivex.io/documentation/operators.html">ref</a></p>
<h4 id="Custom-Operator"><a href="#Custom-Operator" class="headerlink" title="Custom Operator"></a><a target="_blank" rel="noopener" href="https://github.com/ReactiveX/RxJava/wiki/Implementing-custom-operators-(draft)">Custom Operator</a></h4><h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><h5 id="基本流程图"><a href="#基本流程图" class="headerlink" title="基本流程图"></a>基本流程图</h5><p><img data-src="/./Observable.png" alt="Observable"></p>
<ul>
<li>流程分析:<ol>
<li>通过类方法<code>create</code>构造<code>Observable</code>对象。<code>create</code>内部使用<code>RxJavaHook</code>方法来创建<code>OnSubscribe</code>。</li>
<li>调用<code>subscribe(Subscriber)</code>方法，内部会将<code>Subscriber</code>转换成<code>SafeSubscriber</code>。然后调用<code>RxJavaHooks.onObservableStart(Observable, OnSubscribe).call(subscriber)</code>。这其实就是使用第一步设置的<code>OnSubscribe</code>调用<code>call</code>。上诉流程中<code>RxJavaHooks</code>其实就是对整个流程的一些关键步骤做<code>hook</code>以便可以由后续操作。这是最基本的<code>RxJava</code>流程</li>
</ol>
</li>
</ul>
<h5 id="通用流程图"><a href="#通用流程图" class="headerlink" title="通用流程图"></a>通用流程图</h5><p><img data-src="/./Operator.png" alt="Operator"></p>
<ul>
<li>流程分析<ol>
<li>当调用<code>subscribe</code>时会调用离它最近的<code>OnSubscribe</code>，如果是<code>Operator</code>的话。那就会调用最近的<code>OnSubscribeLift</code>的<code>call</code>。这时<code>RxJavaHooks</code>会调用<code>onObserveLift</code>的<code>call</code>产生新的订阅者。父类<code>OnSubscribe</code>会调用这个新的订阅者，并通过<code>call</code>将这个订阅者传给父类<code>OnSubscribe</code>中，在其中给子订阅者设置生产者<code>setProducer</code>，这时生产者会调用<code>request</code>。然后会在这里将消息发给子订阅者。</li>
<li>线程调度: <code>OperatorSubscribeOn</code>,将每个生产者产生的所有的数据单独放到一个<code>Runnable</code>当中运行。 <code>OperatorObserveOn</code>则是使用队列。来一个消息往队列里面插入，并要求队列开始执行。典型的多生产者但但消费者模型。<code>事件产生</code>使用<code>subscribeOn</code>来切换线程。而且只有第一个<code>subscribeOn</code>会生效。而事件加工和消费使用<code>observeonOn</code>来切换线程。影响的是后续的<code>Subscriber</code>。</li>
</ol>
</li>
</ul>
<h3 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h3><blockquote>
<p>Subject即可做<code>Observable</code>，也可以做<code>Observer</code>.示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">TestScheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestScheduler</span>();</span><br><span class="line"></span><br><span class="line">scheduler.advanceTimeTo(<span class="number">100</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">final</span> TestSubject&lt;Object&gt; subject = TestSubject.create(scheduler);</span><br><span class="line"><span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> mock(Observer.class);</span><br><span class="line">subject.subscribe(observer);</span><br><span class="line">subject.onNext(<span class="number">1</span>);</span><br><span class="line">scheduler.triggerActions();</span><br><span class="line"></span><br><span class="line">verify(observer, times(<span class="number">1</span>)).onNext(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>subject</code>作为<code>Observable</code>发出事件</li>
<li>默认有四种<code>Subject</code></li>
</ul>
<h4 id="AsyncSubject"><a href="#AsyncSubject" class="headerlink" title="AsyncSubject"></a>AsyncSubject</h4><blockquote>
<p>发出源消息的最后一个消息。必须在源消息发出<code>complete</code>之后。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AsyncSubject&lt;Object&gt; subject = AsyncSubject.create();</span><br><span class="line"><span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> mock(Observer.class);</span><br><span class="line">subject.subscribe(observer);</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">&quot;first&quot;</span>);</span><br><span class="line">subject.onNext(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">subject.onNext(<span class="string">&quot;third&quot;</span>);</span><br><span class="line"><span class="comment">//如果没有发出结束信号，那么AsyncSubject不会发出任何事件。反之，会发出最后一个事件</span></span><br><span class="line">subject.onCompleted();</span><br><span class="line"></span><br><span class="line"><span class="comment">//observer收到最后一个事件</span></span><br><span class="line">verify(observer, times(<span class="number">1</span>)).onNext(anyString());</span><br><span class="line">verify(observer, never()).onError(<span class="keyword">new</span> <span class="title class_">Throwable</span>());</span><br><span class="line"><span class="comment">//收到结束信号</span></span><br><span class="line">verify(observer, times(<span class="number">1</span>)).onCompleted();</span><br></pre></td></tr></table></figure>

<h4 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h4><blockquote>
<p>发送默认值之后发送剩余的事件 示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> BehaviorSubject&lt;Object&gt; subject = BehaviorSubject.create(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observerA</span> <span class="operator">=</span> mock(Observer.class);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observerB</span> <span class="operator">=</span> mock(Observer.class);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observerC</span> <span class="operator">=</span> mock(Observer.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">InOrder</span> <span class="variable">inOrder</span> <span class="operator">=</span> inOrder(observerA, observerB, observerC);</span><br><span class="line"></span><br><span class="line">subject.subscribe(observerA);</span><br><span class="line">subject.subscribe(observerB);    </span><br><span class="line"></span><br><span class="line">inOrder.verify(observerA).onNext(<span class="string">&quot;default&quot;</span>);</span><br><span class="line">inOrder.verify(observerB).onNext(<span class="string">&quot;default&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>default</code>事件会先于其他事件被发出</li>
</ul>
<h4 id="PublishSubject"><a href="#PublishSubject" class="headerlink" title="PublishSubject"></a>PublishSubject</h4><blockquote>
<p>发送从订阅时刻起的数据。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> PublishSubject&lt;Object&gt; subject = PublishSubject.create();</span><br><span class="line"><span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> mock(Observer.class);</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">subject.onNext(<span class="string">&quot;two&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//之后发送的消息，observer才能收到</span></span><br><span class="line">subject.subscribe(observer);</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">&quot;three&quot;</span>);</span><br><span class="line"></span><br><span class="line">verify(observer, never()).onNext(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">verify(observer, never()).onNext(<span class="string">&quot;two&quot;</span>);</span><br><span class="line">verify(observer, times(<span class="number">1</span>)).onNext(<span class="string">&quot;three&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h4><blockquote>
<p>发送所有的事件，不管什么时候订阅，与PublishSubject相反。示例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ReplaySubject&lt;Object&gt; subject = ReplaySubject.create();</span><br><span class="line"><span class="keyword">final</span> <span class="type">Observer</span> <span class="variable">observer</span> <span class="operator">=</span> mock(Observer.class);</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">subject.onNext(<span class="string">&quot;two&quot;</span>);</span><br><span class="line"></span><br><span class="line">subject.subscribe(observer);</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">&quot;three&quot;</span>);</span><br><span class="line"></span><br><span class="line">verify(observer, times(<span class="number">1</span>)).onNext(<span class="string">&quot;one&quot;</span>);</span><br><span class="line">verify(observer, times(<span class="number">1</span>)).onNext(<span class="string">&quot;two&quot;</span>);</span><br><span class="line">verify(observer, times(<span class="number">1</span>)).onNext(<span class="string">&quot;three&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Rxjava2-0"><a href="#Rxjava2-0" class="headerlink" title="Rxjava2.0"></a>Rxjava2.0</h3><blockquote>
<p>待续</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://xu6148152.github.io/2016/12/31/2016%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Binea">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/12/31/2016%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">2016总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2016-12-31 17:52:55 / Modified: 18:00:12" itemprop="dateCreated datePublished" datetime="2016-12-31T17:52:55+08:00">2016-12-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>2016年即将过去。在此对于过去一年自己所做的进行一次简单的总结。</p>
<h4 id="满意的地方"><a href="#满意的地方" class="headerlink" title="满意的地方"></a>满意的地方</h4><ul>
<li><code>github</code>坚持更新，有时间就会练习算法，对常用数据结构和算法进行了一次全面的复习</li>
<li>看了很多书。见识增加了很多。包括并不仅局限于下列书籍。但是，看得多，忘得也多，还是得多实践。<ul>
<li>Head First</li>
<li>Java 并发编程实战</li>
<li>Effective JavaScript</li>
<li>设计模式</li>
<li>深入理解java虚拟机高级特性</li>
</ul>
</li>
<li>坚持写博客。</li>
<li>技能树多项开发，主技能<code>Android开发, Java</code>,其余辅助技能<code>JavaScript</code>,<code>Python</code>，<code>Groovy</code>, <code>Kotlin</code>都多多少少有所涉猎。对于跨平台开发积累了一定的经验(RN)。</li>
<li>对于<code>Android</code>源码有进一步的理解</li>
<li>分析很多源码，但很多又忘了(尴尬)</li>
<li>开始使用<code>gitbook</code>来做总结</li>
</ul>
<h4 id="不满意的地方"><a href="#不满意的地方" class="headerlink" title="不满意的地方"></a>不满意的地方</h4><ul>
<li>书虽然看得很多，也学到很多新的知识，但是暂时没有可以应用的地方</li>
<li>对于大型项目的整体把控能力还有需要提高。</li>
<li>做了很多项目，但其实从项目本身获取到的技术提升并不多</li>
<li>生活上并没有什么大的改善，依然是死宅</li>
<li>分析表达能力需要接着提高</li>
</ul>
<h4 id="2017年的期待"><a href="#2017年的期待" class="headerlink" title="2017年的期待"></a>2017年的期待</h4><ul>
<li>继续拓展，深挖自己的技术，希望能够将自己所学到的技术都能应用到真实项目中</li>
<li>希望能够去一趟日本</li>
<li>能够接触更多与机器学习相关的东西</li>
<li>坚持写博客，坚持逛<code>github</code></li>
<li>每天再晚也要学一会</li>
<li>学习更多关于多媒体开发方面的知识</li>
<li>学习<code>K(Keep)P(Problem)T(Try)</code>总结</li>
<li>架构&#x2F;中间件的学习</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Binea</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
